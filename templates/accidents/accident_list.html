{% extends 'base.html' %}
{% load static %}

{% block title %}Accident List - AGNES Hotspot System{% endblock %}

{% block breadcrumb_items %}
<span> / Accidents</span>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --fatal-red: #DC143C;
        --injury-orange: #FFA500;
        --property-blue: #6C757D;
        --hotspot-red: #DC143C;
        --primary-blue: #003087;
        --success-green: #28A745;
    }

    .accident-list-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Hero Header */
    .page-hero {
        background: linear-gradient(135deg, #003087 0%, #0052CC 100%);
        color: white;
        padding: 35px;
        border-radius: 15px;
        margin-bottom: 25px;
        box-shadow: 0 4px 12px rgba(0, 48, 135, 0.2);
    }

    .page-hero h1 {
        font-size: 2.2rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .page-hero p {
        font-size: 1.1rem;
        opacity: 0.95;
        margin: 0;
    }

    .hero-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    /* Unified Filters Section - Modern Design */
    .filters-section {
        background: white;
        padding: 1.75rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        margin-bottom: 1.5rem;
        border: 1px solid #E5E7EB;
    }

    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }

    .filters-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
    }

    /* Search Input - Modern & Flat */
    .search-wrapper {
        position: relative;
        display: flex;
        gap: 0.75rem;
    }

    .search-input-wrapper {
        position: relative;
        flex: 1;
    }

    #searchInput {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
        background: white;
    }

    #searchInput:hover {
        border-color: #9CA3AF;
    }

    #searchInput:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08);
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        pointer-events: none;
    }

    .search-button {
        padding: 0.75rem 1.5rem;
        background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .search-button:hover {
        background: #0052CC;
        transform: translateY(-1px);
    }

    /* Filter Grid - Clean Layout */
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.25rem;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .filter-group label {
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
    }

    .filter-group select {
        padding: 0.625rem 0.875rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: white;
        cursor: pointer;
    }

    .filter-group select:hover {
        border-color: #9CA3AF;
    }

    .filter-group select:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08);
    }

    /* Quick Filters as Pills */
    .quick-filters {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #E5E7EB;
    }

    .quick-filter-btn {
        padding: 0.5rem 1rem;
        border: 1.5px solid #D1D5DB;
        background: white;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #374151;
    }

    .quick-filter-btn:hover {
        border-color: var(--primary-blue);
        background: #F9FAFB;
    }

    .quick-filter-btn.active {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .quick-filter-btn.fatal.active {
        background: var(--fatal-red);
        border-color: var(--fatal-red);
    }

    .quick-filter-btn.injury.active {
        background: var(--injury-orange);
        border-color: var(--injury-orange);
    }

    .quick-filter-btn.hotspot.active {
        background: var(--hotspot-red);
        border-color: var(--hotspot-red);
    }

    .quick-filter-btn.standalone.active {
        background: linear-gradient(135deg, #6C757D, #495057);
        border-color: #6C757D;
    }

    /* Active Filters Tags - Blue Theme */
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #E5E7EB;
    }

    .active-filters.hidden {
        display: none;
    }

    .filter-tag {
        background: #E8F0FE;
        color: #003087;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        border: 1px solid #BBDEFB;
    }

    .filter-tag button {
        background: none;
        border: none;
        color: var(--primary-blue);
        cursor: pointer;
        font-weight: 600;
        font-size: 1.125rem;
        line-height: 1;
        padding: 0;
        margin-left: 0.25rem;
        transition: all 0.2s;
    }

    .filter-tag button:hover {
        color: #0052CC;
    }

    /* Summary Cards - Flat & Clean */
    .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        text-align: center;
        transition: all 0.2s ease;
        border: 1px solid #E5E7EB;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stat-card.total .stat-value {
        color: var(--primary-blue);
    }

    .stat-card.fatal .stat-value {
        color: var(--fatal-red);
    }

    .stat-card.injury .stat-value {
        color: var(--injury-orange);
    }

    .stat-card.hotspot .stat-value {
        color: var(--hotspot-red);
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6B7280;
        margin: 0;
    }

    /* Modern Button Styles */
    .btn {
        padding: 0.625rem 1.25rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary-blue);
        color: white;
        border: 1px solid var(--primary-blue);
    }

    .btn-primary:hover {
        background: #0052CC;
        border-color: #0052CC;
        transform: translateY(-1px);
    }

    .btn-outline {
        background: white;
        color: #6B7280;
        border: 1.5px solid #D1D5DB;
    }

    .btn-outline:hover {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
    }

    /* View Controls */
    .view-controls {
        background: white;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .view-toggle {
        display: flex;
        gap: 5px;
        background: #F8F9FA;
        padding: 5px;
        border-radius: 8px;
    }

    .view-btn {
        padding: 8px 20px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .view-btn.active {
        background: var(--primary-blue);
        color: white;
    }

    .export-btn {
        padding: 8px 20px;
        background: var(--success-green);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .export-btn:hover {
        background: #218838;
        transform: translateY(-2px);
    }

    /* Pagination - Matching Hotspots */
    .pagination-container {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        border: 1px solid #E5E7EB;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .results-info {
        font-size: 0.875rem;
        color: #6B7280;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .pagination-controls a,
    .pagination-controls span {
        padding: 0.5rem 0.875rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .pagination-controls a {
        background: white;
        color: #374151;
        border: 1.5px solid #D1D5DB;
    }

    .pagination-controls a:hover {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
    }

    .pagination-controls a.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    .pagination-controls .page-info {
        color: #6B7280;
        padding: 0.5rem 0.75rem;
    }

    /* Card View */
    .accidents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .accident-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
        border-left: 5px solid;
    }

    .accident-card.fatal {
        border-left-color: var(--fatal-red);
    }

    .accident-card.injury {
        border-left-color: var(--injury-orange);
    }

    .accident-card.property {
        border-left-color: var(--property-blue);
    }

    .accident-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .card-header {
        padding: 15px 20px;
        background: #F8F9FA;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .severity-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .severity-badge.fatal {
        background: var(--fatal-red);
        color: white;
    }

    .severity-badge.injury {
        background: var(--injury-orange);
        color: white;
    }

    .severity-badge.property {
        background: var(--property-blue);
        color: white;
    }

    .hotspot-mini-badge {
        background: var(--hotspot-red);
        color: white;
        padding: 4px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .card-body {
        padding: 20px;
    }

    .card-date {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 12px;
    }

    .card-location {
        margin-bottom: 12px;
    }

    .card-location-title {
        font-weight: 700;
        font-size: 1.1rem;
        color: #333;
        margin-bottom: 5px;
    }

    .card-location-sub {
        color: #666;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .card-type {
        background: #F8F9FA;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 15px;
    }

    .card-actions {
        display: flex;
        gap: 10px;
    }

    .card-action-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        font-size: 0.9rem;
    }

    .btn-view {
        background: var(--primary-blue);
        color: white;
    }

    .btn-view:hover {
        background: #0052CC;
        transform: translateY(-2px);
    }

    .btn-map {
        background: var(--success-green);
        color: white;
    }

    .btn-map:hover {
        background: #218838;
        transform: translateY(-2px);
    }

    /* Table View */
    .accidents-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-bottom: 30px;
    }

    .table-responsive {
        overflow-x: auto;
        max-height: 700px;
    }

    .accidents-table {
        width: 100%;
        border-collapse: collapse;
    }

    .accidents-table thead {
        background: #F8F9FA;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .accidents-table th {
        padding: 15px 12px;
        text-align: left;
        font-weight: 700;
        color: #333;
        border-bottom: 2px solid #DEE2E6;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .accidents-table td {
        padding: 15px 12px;
        border-bottom: 1px solid #F1F3F5;
        vertical-align: middle;
    }

    .accidents-table tbody tr {
        transition: all 0.2s;
        cursor: pointer;
    }

    .accidents-table tbody tr:hover {
        background: #F8F9FA;
    }

    .severity-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    .severity-dot.fatal {
        background: var(--fatal-red);
        box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.2);
    }

    .severity-dot.injury {
        background: var(--injury-orange);
        box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.2);
    }

    .severity-dot.property {
        background: var(--property-blue);
        box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.2);
    }

    .table-actions {
        display: flex;
        gap: 5px;
    }

    .table-action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
    }

    .table-action-btn.view {
        background: #E3F2FD;
        color: var(--primary-blue);
    }

    .table-action-btn.view:hover {
        background: var(--primary-blue);
        color: white;
    }

    .table-action-btn.map {
        background: #E8F5E9;
        color: var(--success-green);
    }

    .table-action-btn.map:hover {
        background: var(--success-green);
        color: white;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6C757D;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }

    .empty-state h3 {
        margin-bottom: 10px;
        color: #495057;
    }

    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 30px;
    }

    .pagination {
        display: flex;
        gap: 5px;
        list-style: none;
        padding: 0;
    }

    .page-item {
        margin: 0;
    }

    .page-link {
        padding: 10px 16px;
        border: 2px solid #E9ECEF;
        background: white;
        color: var(--primary-blue);
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .page-link:hover {
        background: #F8F9FA;
        border-color: var(--primary-blue);
        transform: translateY(-2px);
    }

    .page-item.active .page-link {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .page-item.disabled .page-link {
        color: #ADB5BD;
        background: #F8F9FA;
        cursor: not-allowed;
        transform: none;
    }

    /* Loading Animation */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-blue);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .page-hero h1 {
            font-size: 1.6rem;
        }

        .accidents-grid {
            grid-template-columns: 1fr;
        }

        .quick-filters {
            justify-content: center;
        }

        .view-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .view-toggle {
            justify-content: center;
        }

        .search-box {
            flex-direction: column;
        }

        .stats-section {
            grid-template-columns: repeat(2, 1fr);
        }

        .filters-content {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .stats-section {
            grid-template-columns: 1fr;
        }

        .card-actions {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Municipality data
const municipalityData = {{ municipality_data_json|safe }};

// View toggle
let currentView = 'cards'; // Default to card view

function toggleView(view) {
    currentView = view;
    
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.target.closest('.view-btn').classList.add('active');
    
    const cardsView = document.getElementById('cardsView');
    const tableView = document.getElementById('tableView');
    
    if (view === 'cards') {
        cardsView.style.display = 'grid';
        tableView.style.display = 'none';
    } else {
        cardsView.style.display = 'none';
        tableView.style.display = 'block';
    }
}

// Search function
function performSearch() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    
    if (!searchValue) return;
    
    // Show loading
    document.querySelector('.loading-overlay').classList.add('active');
    
    // Redirect with search parameter
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('search', searchValue);
    window.location.href = currentUrl.toString();
}

// Quick filter
function applyQuickFilter(filterType) {
    // Remove active class from all buttons
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    event.target.closest('.quick-filter-btn').classList.add('active');
    
    // Build URL with filter parameter
    let url = new URL(window.location.href);
    url.search = ''; // Clear existing parameters
    
    switch(filterType) {
        case 'all':
            // No filter - show all
            break;
        case 'fatal':
            url.searchParams.set('fatal', 'true');
            break;
        case 'injury':
            url.searchParams.set('injury', 'true');
            break;
        case 'hotspot':
            url.searchParams.set('is_hotspot', 'true');
            break;
        case 'standalone':  // NEW CASE
            url.searchParams.set('no_hotspot', 'true');
            break;
    }
    
    // Redirect to filtered URL
    window.location.href = url.toString();
}

// Toggle advanced filters
function toggleAdvancedFilters() {
    const content = document.querySelector('.filters-content');
    const icon = document.querySelector('.filters-toggle i');
    
    content.classList.toggle('collapsed');
    icon.classList.toggle('fa-chevron-down');
    icon.classList.toggle('fa-chevron-up');
}

// Update municipalities
function updateMunicipalities() {
    const provinceSelect = document.getElementById('province');
    const municipalSelect = document.getElementById('municipal');
    const selectedProvince = provinceSelect.value;
    
    municipalSelect.innerHTML = '<option value="">All Municipalities</option>';
    
    if (selectedProvince && municipalityData[selectedProvince]) {
        municipalityData[selectedProvince].forEach(municipal => {
            if (municipal && municipal.trim()) {
                const option = document.createElement('option');
                option.value = municipal;
                option.textContent = municipal;
                
                const currentSelected = "{{ request.GET.municipal|escapejs }}";
                if (municipal === currentSelected) {
                    option.selected = true;
                }
                
                municipalSelect.appendChild(option);
            }
        });
    }
}

// Export to CSV
function exportToCSV() {
    const searchParams = new URLSearchParams(window.location.search);
    searchParams.set('export', 'csv');
    window.location.href = '{% url "accident_list" %}?' + searchParams.toString();
}

// Navigate to accident
function viewAccident(id) {
    window.location.href = `/accidents/${id}/`;
}

function viewOnMap(lat, lng) {
    window.location.href = `/map/?lat=${lat}&lng=${lng}&zoom=15`;
}

// Enter key for search
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
    
    // Initialize municipalities
    updateMunicipalities();
    
    // Province change handler
    const provinceSelect = document.getElementById('province');
    if (provinceSelect) {
        provinceSelect.addEventListener('change', updateMunicipalities);
    }
    
    // Set active quick filter based on URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('fatal')) {
        document.querySelector('[onclick*="fatal"]')?.classList.add('active');
    } else if (urlParams.get('injury')) {
        document.querySelector('[onclick*="injury"]')?.classList.add('active');
    } else if (urlParams.get('is_hotspot')) {
        document.querySelector('[onclick*="hotspot"]')?.classList.add('active');
    }

    // Display active filters
    displayActiveFilters();
});

// Display active filters from URL parameters
function displayActiveFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    const filterTagsContainer = document.getElementById('activeFiltersTags');

    let tagsHTML = '';
    let hasFilters = false;

    // Search filter
    const searchTerm = urlParams.get('search');
    if (searchTerm) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-search"></i> Search: "${searchTerm}"
                <button onclick="removeFilter('search')" title="Remove search">×</button>
            </div>
        `;
    }

    // Province filter
    const province = urlParams.get('province');
    if (province) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-map-marker-alt"></i> Province: ${province}
                <button onclick="removeFilter('province')" title="Remove province">×</button>
            </div>
        `;
    }

    // Municipal filter
    const municipal = urlParams.get('municipal');
    if (municipal) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-city"></i> Municipality: ${municipal}
                <button onclick="removeFilter('municipal')" title="Remove municipality">×</button>
            </div>
        `;
    }

    // Year filter
    const year = urlParams.get('year');
    if (year) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-calendar"></i> Year: ${year}
                <button onclick="removeFilter('year')" title="Remove year">×</button>
            </div>
        `;
    }

    // Fatal filter
    if (urlParams.get('fatal') === 'true') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-skull-crossbones"></i> Fatal Only
                <button onclick="removeFilter('fatal')" title="Remove fatal filter">×</button>
            </div>
        `;
    }

    // Injury filter
    if (urlParams.get('injury') === 'true') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-ambulance"></i> Injury Only
                <button onclick="removeFilter('injury')" title="Remove injury filter">×</button>
            </div>
        `;
    }

    // Hotspot filter
    if (urlParams.get('is_hotspot') === 'true') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-fire"></i> Hotspots Only
                <button onclick="removeFilter('is_hotspot')" title="Remove hotspot filter">×</button>
            </div>
        `;
    }

    // Standalone filter
    if (urlParams.get('is_hotspot') === 'false') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-map-marker-alt"></i> Standalone Only
                <button onclick="removeFilter('is_hotspot')" title="Remove standalone filter">×</button>
            </div>
        `;
    }

    // Show/hide filter section and update display
    if (hasFilters) {
        filterTagsContainer.innerHTML = tagsHTML;
        filterTagsContainer.classList.remove('hidden');
    } else {
        filterTagsContainer.innerHTML = '';
        filterTagsContainer.classList.add('hidden');
    }
}

// Auto-submit form when filters change
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners to filter dropdowns for auto-submit
    const provinceSelect = document.getElementById('province');
    const municipalSelect = document.getElementById('municipal');
    const yearSelect = document.getElementById('year');

    if (provinceSelect) {
        provinceSelect.addEventListener('change', function() {
            if (this.value) {
                document.getElementById('filterForm').submit();
            }
        });
    }

    if (municipalSelect) {
        municipalSelect.addEventListener('change', function() {
            if (this.value) {
                document.getElementById('filterForm').submit();
            }
        });
    }

    if (yearSelect) {
        yearSelect.addEventListener('change', function() {
            if (this.value) {
                document.getElementById('filterForm').submit();
            }
        });
    }

    // Display active filters on page load
    displayActiveFilters();
});

// Remove individual filter
function removeFilter(filterName) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.delete(filterName);

    // Show loading
    document.querySelector('.loading-overlay').classList.add('active');

    // Redirect to URL without this filter
    window.location.href = currentUrl.toString();
}

// Clear all filters
function clearAllFilters() {
    // Show loading
    document.querySelector('.loading-overlay').classList.add('active');

    // Get base URL without any parameters
    const baseUrl = window.location.pathname;
    window.location.href = baseUrl;
}
</script>
{% endblock %}

{% block content %}
<div class="accident-list-container">
    <!-- Loading Overlay -->
    <div class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Hero Header -->
    <div class="page-hero">
        <h1>
            <i class="fas fa-car-crash"></i>
            Accident Records
            <span class="hero-badge">{{ accidents.paginator.count }} Total</span>
        </h1>
        <p>Browse and analyze traffic accidents across Caraga Region</p>
    </div>

    <!-- Statistics -->
    <div class="stats-section">
        <div class="stat-card total">
            <div class="stat-value">{{ accidents.paginator.count }}</div>
            <div class="stat-label">Total Accidents</div>
        </div>
        <div class="stat-card fatal">
            <div class="stat-value">{{ fatal_count|default:0 }}</div>
            <div class="stat-label">Fatal</div>
        </div>
        <div class="stat-card injury">
            <div class="stat-value">{{ injury_count|default:0 }}</div>
            <div class="stat-label">Injuries</div>
        </div>
        <div class="stat-card hotspot">
            <div class="stat-value">{{ hotspot_count|default:0 }}</div>
            <div class="stat-label">Hotspots</div>
        </div>
    </div>

    <!-- Unified Search & Filters Section -->
    <div class="filters-section">
        <div class="filters-header">
            <h3>Search & Filter Accidents</h3>
            <button type="button" class="btn btn-outline btn-sm" onclick="clearAllFilters()">
                Clear All
            </button>
        </div>

        <!-- Search Bar -->
        <div style="margin-bottom: 1.25rem;">
            <label style="display: block; font-weight: 500; color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">
                Search Accidents
            </label>
            <div class="search-wrapper">
                <div class="search-input-wrapper">
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search by location, incident type, or barangay..."
                        value="{{ request.GET.search|default:'' }}"
                        onkeypress="if(event.key==='Enter') performSearch()"
                    >
                    <i class="fas fa-search search-icon"></i>
                </div>
                <button class="search-button" onclick="performSearch()">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>

        <!-- Filter Grid -->
        <form method="get" id="filterForm">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="province">Province</label>
                    <select name="province" id="province" onchange="updateMunicipalityDropdown()">
                        <option value="">All Provinces</option>
                        {% for province in provinces %}
                            <option value="{{ province }}" {% if request.GET.province == province %}selected{% endif %}>
                                {{ province }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="municipal">Municipality</label>
                    <select name="municipal" id="municipal">
                        <option value="">All Municipalities</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="year">Year</label>
                    <select name="year" id="year">
                        <option value="">All Years</option>
                        {% for year in years %}
                            <option value="{{ year }}" {% if request.GET.year == year %}selected{% endif %}>
                                {{ year }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>

        <!-- Quick Filters -->
        <div class="quick-filters">
            <button class="quick-filter-btn all {% if not is_fatal_view and not is_injury_view and not is_hotspot_view and not is_standalone_view %}active{% endif %}"
                    onclick="applyQuickFilter('all')">
                <i class="fas fa-th"></i> All
            </button>
            <button class="quick-filter-btn fatal {% if is_fatal_view %}active{% endif %}"
                    onclick="applyQuickFilter('fatal')">
                <i class="fas fa-skull-crossbones"></i> Fatal
            </button>
            <button class="quick-filter-btn injury {% if is_injury_view %}active{% endif %}"
                    onclick="applyQuickFilter('injury')">
                <i class="fas fa-ambulance"></i> Injury
            </button>
            <button class="quick-filter-btn hotspot {% if is_hotspot_view %}active{% endif %}"
                    onclick="applyQuickFilter('hotspot')">
                <i class="fas fa-fire"></i> Hotspots
            </button>
            <button class="quick-filter-btn standalone {% if is_standalone_view %}active{% endif %}"
                    onclick="applyQuickFilter('standalone')">
                <i class="fas fa-map-marker-alt"></i> Standalone
            </button>
        </div>

        <!-- Active Filters -->
        <div class="active-filters" id="activeFiltersTags">
            <!-- Filter tags will be added here dynamically -->
        </div>
    </div>

    <!-- Pagination & Results Info -->
    <div class="pagination-container">
        <div class="results-info">
            Showing {{ accidents.start_index }}-{{ accidents.end_index }} of {{ accidents.paginator.count }} accidents
        </div>
        <div class="pagination-controls">
            {% if accidents.has_previous %}
                <a href="?page={{ accidents.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.province %}&province={{ request.GET.province }}{% endif %}{% if request.GET.municipal %}&municipal={{ request.GET.municipal }}{% endif %}{% if request.GET.year %}&year={{ request.GET.year }}{% endif %}">
                    ← Previous
                </a>
            {% else %}
                <span class="disabled">← Previous</span>
            {% endif %}

            <span class="page-info">
                Page {{ accidents.number }} of {{ accidents.paginator.num_pages }}
            </span>

            {% if accidents.has_next %}
                <a href="?page={{ accidents.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.province %}&province={{ request.GET.province }}{% endif %}{% if request.GET.municipal %}&municipal={{ request.GET.municipal }}{% endif %}{% if request.GET.year %}&year={{ request.GET.year }}{% endif %}">
                    Next →
                </a>
            {% else %}
                <span class="disabled">Next →</span>
            {% endif %}
        </div>
    </div>

    <!-- View Controls -->
    <div class="view-controls">
        <div class="view-toggle">
            <button class="view-btn active" onclick="toggleView('cards')">
                <i class="fas fa-th-large"></i> Cards
            </button>
            <button class="view-btn" onclick="toggleView('table')">
                <i class="fas fa-table"></i> Table
            </button>
        </div>
        <div>
            <button class="export-btn" onclick="exportToCSV()">
                <i class="fas fa-download"></i> Export CSV
            </button>
        </div>
    </div>

    <!-- Card View -->
    <div id="cardsView" class="accidents-grid">
        {% for accident in accidents %}
        <div class="accident-card {% if accident.victim_killed %}fatal{% elif accident.victim_injured %}injury{% else %}property{% endif %}">
            <div class="card-header">
                <span class="severity-badge {% if accident.victim_killed %}fatal{% elif accident.victim_injured %}injury{% else %}property{% endif %}">
                    {% if accident.victim_killed %}
                        <i class="fas fa-skull-crossbones"></i> FATAL
                    {% elif accident.victim_injured %}
                        <i class="fas fa-user-injured"></i> INJURY
                    {% else %}
                        <i class="fas fa-car"></i> PROPERTY
                    {% endif %}
                </span>
                {% if accident.is_hotspot %}
                <span class="hotspot-mini-badge">
                    <i class="fas fa-fire"></i> HOTSPOT
                </span>
                {% endif %}
            </div>
            
            <div class="card-body">
                <div class="card-date">
                    <i class="fas fa-calendar"></i>
                    <strong>{{ accident.date_committed|date:"M d, Y" }}</strong>
                    <span>•</span>
                    <i class="fas fa-clock"></i>
                    <span>{{ accident.time_committed|time:"g:i A" }}</span>
                </div>
                
                <div class="card-location">
                    <div class="card-location-title">{{ accident.barangay }}</div>
                    <div class="card-location-sub">
                        <i class="fas fa-map-marker-alt"></i>
                        {{ accident.municipal }}, {{ accident.province }}
                    </div>
                </div>
                
                <div class="card-type">
                    <i class="fas fa-info-circle"></i>
                    {{ accident.incident_type|truncatewords:5 }}
                </div>
                
                <div class="card-actions">
                    <button class="card-action-btn btn-view" onclick="viewAccident({{ accident.pk }})">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button class="card-action-btn btn-map" onclick="viewOnMap({{ accident.latitude }}, {{ accident.longitude }})">
                        <i class="fas fa-map"></i> Map
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-search"></i>
            <h3>No accidents found</h3>
            <p>Try adjusting your filters or search criteria</p>
        </div>
        {% endfor %}
    </div>

    <!-- Table View (Hidden by default) -->
    <div id="tableView" class="accidents-table-container" style="display: none;">
        <div class="table-responsive">
            <table class="accidents-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">Severity</th>
                        <th style="width: 15%;">Date & Time</th>
                        <th style="width: 25%;">Location</th>
                        <th style="width: 20%;">Incident Type</th>
                        <th style="width: 10%;" class="text-center">Casualties</th>
                        <th style="width: 10%;" class="text-center">Hotspot</th>
                        <th style="width: 15%;" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for accident in accidents %}
                    <tr onclick="viewAccident({{ accident.pk }})">
                        <td>
                            <span class="severity-dot {% if accident.victim_killed %}fatal{% elif accident.victim_injured %}injury{% else %}property{% endif %}"></span>
                        </td>
                        <td>
                            <div style="font-weight: 600;">{{ accident.date_committed|date:"M d, Y" }}</div>
                            <small style="color: #666;">{{ accident.time_committed|time:"g:i A" }}</small>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #333;">{{ accident.barangay }}</div>
                            <small style="color: #666;">{{ accident.municipal }}, {{ accident.province }}</small>
                        </td>
                        <td>
                            <span style="font-size: 0.9rem;">{{ accident.incident_type|truncatewords:4 }}</span>
                        </td>
                        <td class="text-center">
                            <span style="font-weight: 700; color: {% if accident.victim_killed %}var(--fatal-red){% elif accident.victim_injured %}var(--injury-orange){% else %}#6c757d{% endif %}">
                                {{ accident.victim_count|default:0 }}
                            </span>
                        </td>
                        <td class="text-center">
                            {% if accident.is_hotspot %}
                            <i class="fas fa-fire" style="color: var(--hotspot-red);"></i>
                            {% else %}
                            <span style="color: #ccc;">—</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="table-actions" onclick="event.stopPropagation()">
                                <button class="table-action-btn view" onclick="viewAccident({{ accident.pk }})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="table-action-btn map" onclick="viewOnMap({{ accident.latitude }}, {{ accident.longitude }})">
                                    <i class="fas fa-map"></i> Map
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <h3>No accidents found</h3>
                                <p>Try adjusting your filters or search criteria</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if accidents.has_other_pages %}
    <div class="pagination-container">
        <ul class="pagination">
            {% if accidents.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ accidents.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="fas fa-chevron-left"></i> Previous
                </span>
            </li>
            {% endif %}

            {% for i in accidents.paginator.page_range %}
                {% if accidents.number == i %}
                <li class="page-item active">
                    <span class="page-link">{{ i }}</span>
                </li>
                {% elif i > accidents.number|add:'-3' and i < accidents.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        {{ i }}
                    </a>
                </li>
                {% endif %}
            {% endfor %}

            {% if accidents.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ accidents.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">
                    Next <i class="fas fa-chevron-right"></i>
                </span>
            </li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}