{% extends 'base.html' %}
{% load static %}

{% block title %}Accident List - AGNES Hotspot System{% endblock %}

{% block breadcrumb_items %}
<span> / Accidents</span>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --fatal-red: #DC143C;
        --injury-orange: #FFA500;
        --property-blue: #6C757D;
        --hotspot-red: #DC143C;
        --primary-blue: #003087;
        --success-green: #28A745;
    }

    .accident-list-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Hero Header */
    .page-hero {
        background: linear-gradient(135deg, #003087 0%, #0052CC 100%);
        color: white;
        padding: 35px;
        border-radius: 15px;
        margin-bottom: 25px;
        box-shadow: 0 4px 12px rgba(0, 48, 135, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .page-hero-content {
        flex: 1;
        min-width: 300px;
    }

    .page-hero h1 {
        font-size: 2.2rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .page-hero p {
        font-size: 1.1rem;
        opacity: 0.95;
        margin: 0;
    }

    .hero-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    .hero-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .hero-actions .btn {
        padding: 12px 24px;
        font-size: 0.95rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        border: none;
        cursor: pointer;
    }

    .hero-actions .btn-outline-light {
        background: transparent;
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.8);
    }

    .hero-actions .btn-outline-light:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: white;
        transform: translateY(-2px);
    }

    /* Unified Filters Section - Modern Design */
    .filters-section {
        background: white;
        padding: 1.75rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        margin-bottom: 1.5rem;
        border: 1px solid #E5E7EB;
    }

    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }

    .filters-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
    }

    /* Search Input - Modern & Flat */
    .search-wrapper {
        position: relative;
        display: flex;
        gap: 0.75rem;
    }

    .search-input-wrapper {
        position: relative;
        flex: 1;
    }

    #searchInput {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
        background: white;
    }

    #searchInput:hover {
        border-color: #9CA3AF;
    }

    #searchInput:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08);
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        pointer-events: none;
    }

    .search-button {
        padding: 0.75rem 1.5rem;
        background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .search-button:hover {
        background: #0052CC;
        transform: translateY(-1px);
    }

    /* Filter Grid - Clean Layout */
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.25rem;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .filter-group label {
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
    }

    .filter-group select {
        padding: 0.625rem 0.875rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: white;
        cursor: pointer;
    }

    .filter-group select:hover {
        border-color: #9CA3AF;
    }

    .filter-group select:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08);
    }

    /* Quick Filters as Pills */
    .quick-filters {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #E5E7EB;
    }

    .quick-filter-btn {
        padding: 0.5rem 1rem;
        border: 1.5px solid #D1D5DB;
        background: white;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #374151;
    }

    .quick-filter-btn:hover {
        border-color: var(--primary-blue);
        background: #F9FAFB;
    }

    .quick-filter-btn.active {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .quick-filter-btn.fatal.active {
        background: var(--fatal-red);
        border-color: var(--fatal-red);
    }

    .quick-filter-btn.injury.active {
        background: var(--injury-orange);
        border-color: var(--injury-orange);
    }

    .quick-filter-btn.hotspot.active {
        background: var(--hotspot-red);
        border-color: var(--hotspot-red);
    }

    .quick-filter-btn.standalone.active {
        background: linear-gradient(135deg, #6C757D, #495057);
        border-color: #6C757D;
    }

    /* Active Filters Tags - Blue Theme */
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #E5E7EB;
    }

    .active-filters.hidden {
        display: none;
    }

    .filter-tag {
        background: #E8F0FE;
        color: #003087;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        border: 1px solid #BBDEFB;
    }

    .filter-tag button {
        background: none;
        border: none;
        color: var(--primary-blue);
        cursor: pointer;
        font-weight: 600;
        font-size: 1.125rem;
        line-height: 1;
        padding: 0;
        margin-left: 0.25rem;
        transition: all 0.2s;
    }

    .filter-tag button:hover {
        color: #0052CC;
    }

    /* Summary Cards - Flat & Clean */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .summary-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        text-align: center;
        transition: all 0.2s ease;
        border: 1px solid #E5E7EB;
    }

    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .summary-card h3 {
        font-size: 2rem;
        color: var(--primary-blue);
        margin-bottom: 0.5rem;
        font-weight: 700;
    }

    .summary-card p {
        color: #6B7280;
        font-size: 0.875rem;
        margin: 0;
    }

    /* Modern Button Styles */
    .btn {
        padding: 0.625rem 1.25rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary-blue);
        color: white;
        border: 1px solid var(--primary-blue);
    }

    .btn-primary:hover {
        background: #0052CC;
        border-color: #0052CC;
        transform: translateY(-1px);
    }

    .btn-outline {
        background: white;
        color: #6B7280;
        border: 1.5px solid #D1D5DB;
    }

    .btn-outline:hover {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
    }

    /* View Toggle - Flat Design */
    .view-toggle {
        display: flex;
        background: #F3F4F6;
        border-radius: 6px;
        padding: 0.25rem;
        margin-bottom: 1rem;
        border: 1px solid #E5E7EB;
    }

    .view-option {
        flex: 1;
        padding: 0.5rem 1rem;
        text-align: center;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6B7280;
        border: none;
        background: transparent;
    }

    .view-option.active {
        background: var(--primary-blue);
        color: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    /* Pagination - Matching Hotspots */
    .pagination-container {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        margin-bottom: 1rem;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 1rem;
        border: 1px solid #E5E7EB;
    }

    .pagination-info {
        color: #6B7280;
        font-size: 0.875rem;
        justify-self: start;
    }

    .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: center;
        justify-self: center;
    }

    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #pageInfo {
        padding: 0 1rem;
        font-weight: 600;
        color: #111827;
        font-size: 0.875rem;
    }

    #itemsPerPage {
        padding: 0.5rem 0.75rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
        justify-self: end;
    }

    /* Accidents Grid - Matching Hotspots */
    .accidents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    /* List View Styles */
    .accidents-grid.view-list {
        grid-template-columns: 1fr;
    }

    .accident-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        overflow: hidden;
        transition: all 0.2s ease;
        border: 1px solid var(--border-light);
        border-left: 3px solid;
        position: relative;
    }

    .accident-card.fatal {
        border-left-color: var(--fatal-red);
    }

    .accident-card.injury {
        border-left-color: var(--injury-orange);
    }

    .accident-card.property {
        border-left-color: var(--property-blue);
    }

    .accident-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .accident-card.view-list {
        display: flex;
        min-height: auto;
    }

    .accident-card.view-list .card-header {
        flex: 0 0 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .accident-card.view-list .card-body {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        align-items: center;
    }

    .accident-card.view-list .card-actions {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 0.5rem;
    }

    .card-header {
        padding: 15px 20px;
        background: #F8F9FA;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .severity-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .severity-badge.fatal {
        background: var(--fatal-red);
        color: white;
    }

    .severity-badge.injury {
        background: var(--injury-orange);
        color: white;
    }

    .severity-badge.property {
        background: var(--property-blue);
        color: white;
    }

    .hotspot-mini-badge {
        background: var(--hotspot-red);
        color: white;
        padding: 4px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .card-body {
        padding: 20px;
    }

    .card-date {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 12px;
    }

    .card-location {
        margin-bottom: 12px;
    }

    .card-location-title {
        font-weight: 700;
        font-size: 1.1rem;
        color: #333;
        margin-bottom: 5px;
    }

    .card-location-sub {
        color: #666;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .card-type {
        background: #F8F9FA;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 15px;
    }

    .card-actions {
        display: flex;
        gap: 10px;
    }

    .card-action-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        font-size: 0.9rem;
    }

    .btn-view {
        background: var(--primary-blue);
        color: white;
    }

    .btn-view:hover {
        background: #0052CC;
        transform: translateY(-2px);
    }

    .btn-map {
        background: var(--success-green);
        color: white;
    }

    .btn-map:hover {
        background: #218838;
        transform: translateY(-2px);
    }

    /* Table View */
    .accidents-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-bottom: 30px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .table-responsive.scrollable {
        max-height: 700px;
    }

    .accidents-table {
        width: 100%;
        border-collapse: collapse;
    }

    .accidents-table thead {
        background: #F8F9FA;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .accidents-table th {
        padding: 15px 12px;
        text-align: left;
        font-weight: 700;
        color: #333;
        border-bottom: 2px solid #DEE2E6;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .accidents-table td {
        padding: 15px 12px;
        border-bottom: 1px solid #F1F3F5;
        vertical-align: middle;
    }

    .accidents-table tbody tr {
        transition: all 0.2s;
        cursor: pointer;
    }

    .accidents-table tbody tr:hover {
        background: #F8F9FA;
    }

    .severity-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    .severity-dot.fatal {
        background: var(--fatal-red);
        box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.2);
    }

    .severity-dot.injury {
        background: var(--injury-orange);
        box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.2);
    }

    .severity-dot.property {
        background: var(--property-blue);
        box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.2);
    }

    .table-actions {
        display: flex;
        gap: 5px;
    }

    .table-action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
    }

    .table-action-btn.view {
        background: #E3F2FD;
        color: var(--primary-blue);
    }

    .table-action-btn.view:hover {
        background: var(--primary-blue);
        color: white;
    }

    .table-action-btn.map {
        background: #E8F5E9;
        color: var(--success-green);
    }

    .table-action-btn.map:hover {
        background: var(--success-green);
        color: white;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6C757D;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }

    .empty-state h3 {
        margin-bottom: 10px;
        color: #495057;
    }

    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 30px;
    }

    .pagination {
        display: flex;
        gap: 5px;
        list-style: none;
        padding: 0;
    }

    .page-item {
        margin: 0;
    }

    .page-link {
        padding: 10px 16px;
        border: 2px solid #E9ECEF;
        background: white;
        color: var(--primary-blue);
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .page-link:hover {
        background: #F8F9FA;
        border-color: var(--primary-blue);
        transform: translateY(-2px);
    }

    .page-item.active .page-link {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .page-item.disabled .page-link {
        color: #ADB5BD;
        background: #F8F9FA;
        cursor: not-allowed;
        transform: none;
    }

    /* Loading Animation */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-blue);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .page-hero h1 {
            font-size: 1.6rem;
        }

        .accidents-grid {
            grid-template-columns: 1fr;
        }

        .quick-filters {
            justify-content: center;
        }

        .view-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .view-toggle {
            justify-content: center;
        }

        .search-box {
            flex-direction: column;
        }

        .stats-section {
            grid-template-columns: repeat(2, 1fr);
        }

        .filters-content {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .stats-section {
            grid-template-columns: 1fr;
        }

        .card-actions {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Municipality data
const municipalityData = {{ municipality_data_json|safe }};

// Pagination state
let currentPage = 1;
let itemsPerPage = 12;

// View toggle
function switchView(viewType) {
    const container = document.getElementById('accidentsContainer');
    const cards = container.getElementsByClassName('accident-card');
    const options = document.querySelectorAll('.view-option');

    options.forEach(opt => opt.classList.remove('active'));
    event.target.classList.add('active');

    container.className = 'accidents-grid';
    if (viewType === 'list') {
        container.classList.add('view-list');
        Array.from(cards).forEach(card => card.classList.add('view-list'));
    } else {
        Array.from(cards).forEach(card => card.classList.remove('view-list'));
    }
}

// Search function
function performSearch() {
    applyClientSideFilters();
}

function applyClientSideFilters() {
    const cards = Array.from(document.getElementsByClassName('accident-card'));
    const searchTerm = document.getElementById('hotspotSearch').value.toLowerCase().trim();
    const provinceFilter = document.getElementById('province').value.toLowerCase();
    const municipalFilter = document.getElementById('municipal').value.toLowerCase();
    const yearFilter = document.getElementById('year').value;

    let visibleCount = 0;

    cards.forEach(card => {
        // You'll need to add data attributes to cards for filtering
        const location = (card.querySelector('.card-location-title')?.textContent || '').toLowerCase();
        const municipal = (card.querySelector('.card-location-sub')?.textContent || '').toLowerCase();

        const searchMatch = searchTerm === '' || location.includes(searchTerm) || municipal.includes(searchTerm);
        const provinceMatch = provinceFilter === '' || municipal.includes(provinceFilter);
        const municipalMatch = municipalFilter === '' || municipal.includes(municipalFilter);

        const allMatch = searchMatch && provinceMatch && municipalMatch;

        if (allMatch) {
            card.setAttribute('data-search-visible', 'true');
            visibleCount++;
        } else {
            card.setAttribute('data-search-visible', 'false');
        }
    });

    currentPage = 1;
    updatePagination();
}

// Quick filter
function applyQuickFilter(filterType) {
    // Remove active class from all buttons
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    event.target.closest('.quick-filter-btn').classList.add('active');
    
    // Build URL with filter parameter
    let url = new URL(window.location.href);
    url.search = ''; // Clear existing parameters
    
    switch(filterType) {
        case 'all':
            // No filter - show all
            break;
        case 'fatal':
            url.searchParams.set('fatal', 'true');
            break;
        case 'injury':
            url.searchParams.set('injury', 'true');
            break;
        case 'hotspot':
            url.searchParams.set('is_hotspot', 'true');
            break;
        case 'standalone':  // NEW CASE
            url.searchParams.set('no_hotspot', 'true');
            break;
    }
    
    // Redirect to filtered URL
    window.location.href = url.toString();
}

// Toggle advanced filters
function toggleAdvancedFilters() {
    const content = document.querySelector('.filters-content');
    const icon = document.querySelector('.filters-toggle i');
    
    content.classList.toggle('collapsed');
    icon.classList.toggle('fa-chevron-down');
    icon.classList.toggle('fa-chevron-up');
}

// Update municipalities
function updateMunicipalities() {
    const provinceSelect = document.getElementById('province');
    const municipalSelect = document.getElementById('municipal');
    const selectedProvince = provinceSelect.value;
    
    municipalSelect.innerHTML = '<option value="">All Municipalities</option>';
    
    if (selectedProvince && municipalityData[selectedProvince]) {
        municipalityData[selectedProvince].forEach(municipal => {
            if (municipal && municipal.trim()) {
                const option = document.createElement('option');
                option.value = municipal;
                option.textContent = municipal;
                
                const currentSelected = "{{ request.GET.municipal|escapejs }}";
                if (municipal === currentSelected) {
                    option.selected = true;
                }
                
                municipalSelect.appendChild(option);
            }
        });
    }
}

// Export to CSV
function exportToCSV() {
    const searchParams = new URLSearchParams(window.location.search);
    searchParams.set('export', 'csv');
    window.location.href = '{% url "accident_list" %}?' + searchParams.toString();
}

// Navigate to accident
function viewAccident(id) {
    window.location.href = `/accidents/${id}/`;
}

function viewOnMap(lat, lng) {
    window.location.href = `/map/?lat=${lat}&lng=${lng}&zoom=15`;
}

// Enter key for search
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
    
    // Initialize municipalities
    updateMunicipalities();
    
    // Province change handler
    const provinceSelect = document.getElementById('province');
    if (provinceSelect) {
        provinceSelect.addEventListener('change', updateMunicipalities);
    }
    
    // Set active quick filter based on URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('fatal')) {
        document.querySelector('[onclick*="fatal"]')?.classList.add('active');
    } else if (urlParams.get('injury')) {
        document.querySelector('[onclick*="injury"]')?.classList.add('active');
    } else if (urlParams.get('is_hotspot')) {
        document.querySelector('[onclick*="hotspot"]')?.classList.add('active');
    }

    // Display active filters
    displayActiveFilters();
});

// Display active filters from URL parameters
function displayActiveFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    const filterTagsContainer = document.getElementById('activeFiltersTags');

    let tagsHTML = '';
    let hasFilters = false;

    // Search filter
    const searchTerm = urlParams.get('search');
    if (searchTerm) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-search"></i> Search: "${searchTerm}"
                <button onclick="removeFilter('search')" title="Remove search">√ó</button>
            </div>
        `;
    }

    // Province filter
    const province = urlParams.get('province');
    if (province) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-map-marker-alt"></i> Province: ${province}
                <button onclick="removeFilter('province')" title="Remove province">√ó</button>
            </div>
        `;
    }

    // Municipal filter
    const municipal = urlParams.get('municipal');
    if (municipal) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-city"></i> Municipality: ${municipal}
                <button onclick="removeFilter('municipal')" title="Remove municipality">√ó</button>
            </div>
        `;
    }

    // Year filter
    const year = urlParams.get('year');
    if (year) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-calendar"></i> Year: ${year}
                <button onclick="removeFilter('year')" title="Remove year">√ó</button>
            </div>
        `;
    }

    // Fatal filter
    if (urlParams.get('fatal') === 'true') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-skull-crossbones"></i> Fatal Only
                <button onclick="removeFilter('fatal')" title="Remove fatal filter">√ó</button>
            </div>
        `;
    }

    // Injury filter
    if (urlParams.get('injury') === 'true') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-ambulance"></i> Injury Only
                <button onclick="removeFilter('injury')" title="Remove injury filter">√ó</button>
            </div>
        `;
    }

    // Hotspot filter
    if (urlParams.get('is_hotspot') === 'true') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-fire"></i> Hotspots Only
                <button onclick="removeFilter('is_hotspot')" title="Remove hotspot filter">√ó</button>
            </div>
        `;
    }

    // Standalone filter
    if (urlParams.get('is_hotspot') === 'false') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-map-marker-alt"></i> Standalone Only
                <button onclick="removeFilter('is_hotspot')" title="Remove standalone filter">√ó</button>
            </div>
        `;
    }

    // Show/hide filter section and update display
    if (hasFilters) {
        filterTagsContainer.innerHTML = tagsHTML;
        filterTagsContainer.classList.remove('hidden');
    } else {
        filterTagsContainer.innerHTML = '';
        filterTagsContainer.classList.add('hidden');
    }
}

// Auto-submit form when filters change
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners to filter dropdowns for auto-submit
    const provinceSelect = document.getElementById('province');
    const municipalSelect = document.getElementById('municipal');
    const yearSelect = document.getElementById('year');

    if (provinceSelect) {
        provinceSelect.addEventListener('change', function() {
            if (this.value) {
                document.getElementById('filterForm').submit();
            }
        });
    }

    if (municipalSelect) {
        municipalSelect.addEventListener('change', function() {
            if (this.value) {
                document.getElementById('filterForm').submit();
            }
        });
    }

    if (yearSelect) {
        yearSelect.addEventListener('change', function() {
            if (this.value) {
                document.getElementById('filterForm').submit();
            }
        });
    }

    // Display active filters on page load
    displayActiveFilters();
});

// Remove individual filter
function removeFilter(filterName) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.delete(filterName);

    // Show loading
    document.querySelector('.loading-overlay').classList.add('active');

    // Redirect to URL without this filter
    window.location.href = currentUrl.toString();
}

// Clear all filters
function clearAllFilters() {
    // Show loading
    document.querySelector('.loading-overlay').classList.add('active');

    // Get base URL without any parameters
    const baseUrl = window.location.pathname;
    window.location.href = baseUrl;
}

// ===== CLIENT-SIDE PAGINATION FUNCTIONS =====

function updatePagination() {
    const cards = Array.from(document.getElementsByClassName('accident-card'));
    const searchVisibleCards = cards.filter(card => card.getAttribute('data-search-visible') !== 'false');

    const totalItems = searchVisibleCards.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;

    cards.forEach(card => card.style.display = 'none');

    searchVisibleCards.forEach((card, index) => {
        if (index >= startIndex && index < endIndex) {
            card.style.display = '';
        }
    });

    // Update pagination info with correct item ranges
    const showingStart = totalItems > 0 ? startIndex + 1 : 0;
    const showingEnd = Math.min(endIndex, totalItems);

    document.getElementById('showingStart').textContent = showingStart;
    document.getElementById('showingEnd').textContent = showingEnd;
    document.getElementById('totalCount').textContent = totalItems;
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;

    document.getElementById('prevPage').disabled = currentPage <= 1;
    document.getElementById('nextPage').disabled = currentPage >= totalPages;
}

function initializeAccidentCards() {
    const cards = document.getElementsByClassName('accident-card');
    Array.from(cards).forEach(card => {
        card.setAttribute('data-search-visible', 'true');
    });
}

function changePage(direction) {
    currentPage += direction;
    updatePagination();

    const filtersSection = document.querySelector('.filters-section');
    if (filtersSection) {
        filtersSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function changeItemsPerPage() {
    itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
    currentPage = 1;
    updatePagination();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeAccidentCards();
    updatePagination();
});
</script>
{% endblock %}

{% block content %}
<div class="accident-list-container">
    <!-- Loading Overlay -->
    <div class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Hero Header -->
    <div class="page-hero">
        <div class="page-hero-content">
            <h1>
                <i class="fas fa-car-crash"></i>
                Accident Records
                <span class="hero-badge">{{ accidents.paginator.count }} Total</span>
            </h1>
            <p>Browse and analyze traffic accidents across Caraga Region</p>
        </div>
        <div class="hero-actions">
            <button class="btn btn-outline-light" onclick="exportToCSV()">
                <i class="fas fa-download"></i>
                Export CSV
            </button>
        </div>
    </div>

    <!-- View Toggle -->
    <div class="view-toggle">
        <div class="view-option active" onclick="switchView('grid')">üìä Grid View</div>
        <div class="view-option" onclick="switchView('list')">üìã List View</div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card">
            <h3>{{ accidents.paginator.count }}</h3>
            <p>Total Accidents</p>
        </div>
        <div class="summary-card">
            <h3>{{ fatal_count|default:0 }}</h3>
            <p>Fatal</p>
        </div>
        <div class="summary-card">
            <h3>{{ injury_count|default:0 }}</h3>
            <p>Injuries</p>
        </div>
        <div class="summary-card">
            <h3>{{ hotspot_count|default:0 }}</h3>
            <p>Hotspots</p>
        </div>
    </div>

    <!-- Enhanced Filters Section -->
    <div class="filters-section">
        <div class="filters-header">
            <h3>Search & Filter Accidents</h3>
            <button type="button" class="btn btn-outline btn-sm" onclick="clearAllFilters()">
                Clear All
            </button>
        </div>

        <!-- Search Bar -->
        <div style="margin-bottom: 1.25rem;">
            <label style="display: block; font-weight: 500; color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">
                Search Accidents
            </label>
            <div style="display: flex; gap: 0.5rem;">
                <div style="position: relative; flex: 1;">
                    <input type="text"
                           id="hotspotSearch"
                           placeholder="Search by location, incident type, or barangay..."
                           onkeypress="if(event.key==='Enter') performSearch()">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <button onclick="performSearch()" class="btn btn-primary" style="padding: 0.75rem 1.75rem; white-space: nowrap;">
                    üîç Search
                </button>
            </div>
        </div>

        <!-- Filter Grid -->
        <div class="filters-grid">
            <div class="filter-group">
                <label for="province">Province</label>
                <select name="province" id="province" onchange="updateMunicipalityDropdown(); applyClientSideFilters();">
                    <option value="">All Provinces</option>
                    {% for province in provinces %}
                        <option value="{{ province }}">{{ province }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="municipal">Municipality</label>
                <select name="municipal" id="municipal" onchange="applyClientSideFilters()">
                    <option value="">All Municipalities</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="year">Year</label>
                <select name="year" id="year" onchange="applyClientSideFilters()">
                    <option value="">All Years</option>
                    {% for year in years %}
                        <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Active Filters Display -->
        <div class="active-filters" id="activeFilters">
            <!-- Active filters displayed dynamically -->
        </div>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination-container">
        <div class="pagination-info">
            Showing <span id="showingStart">1</span>-<span id="showingEnd">12</span> of <span id="totalCount">{{ accidents.paginator.count }}</span> accidents
        </div>
        <div class="pagination-controls">
            <button id="prevPage" onclick="changePage(-1)" class="btn btn-outline btn-sm" disabled>
                ‚Üê Previous
            </button>
            <span id="pageInfo">Page 1</span>
            <button id="nextPage" onclick="changePage(1)" class="btn btn-outline btn-sm">
                Next ‚Üí
            </button>
        </div>
        <select id="itemsPerPage" onchange="changeItemsPerPage()">
            <option value="12">12 per page</option>
            <option value="24">24 per page</option>
            <option value="48">48 per page</option>
            <option value="999999">Show all</option>
        </select>
    </div>

    <!-- Accidents Grid -->
    <div class="accidents-grid" id="accidentsContainer">
        {% for accident in accidents %}
        <div class="accident-card {% if accident.victim_killed %}fatal{% elif accident.victim_injured %}injury{% else %}property{% endif %}">
            <div class="card-header">
                <span class="severity-badge {% if accident.victim_killed %}fatal{% elif accident.victim_injured %}injury{% else %}property{% endif %}">
                    {% if accident.victim_killed %}
                        <i class="fas fa-skull-crossbones"></i> FATAL
                    {% elif accident.victim_injured %}
                        <i class="fas fa-user-injured"></i> INJURY
                    {% else %}
                        <i class="fas fa-car"></i> PROPERTY
                    {% endif %}
                </span>
                {% if accident.is_hotspot %}
                <span class="hotspot-mini-badge">
                    <i class="fas fa-fire"></i> HOTSPOT
                </span>
                {% endif %}
            </div>
            
            <div class="card-body">
                <div class="card-date">
                    <i class="fas fa-calendar"></i>
                    <strong>{{ accident.date_committed|date:"M d, Y" }}</strong>
                    <span>‚Ä¢</span>
                    <i class="fas fa-clock"></i>
                    <span>{{ accident.time_committed|time:"g:i A" }}</span>
                </div>
                
                <div class="card-location">
                    <div class="card-location-title">{{ accident.barangay }}</div>
                    <div class="card-location-sub">
                        <i class="fas fa-map-marker-alt"></i>
                        {{ accident.municipal }}, {{ accident.province }}
                    </div>
                </div>
                
                <div class="card-type">
                    <i class="fas fa-info-circle"></i>
                    {{ accident.incident_type|truncatewords:5 }}
                </div>
                
                <div class="card-actions">
                    <button class="card-action-btn btn-view" onclick="viewAccident({{ accident.pk }})">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button class="card-action-btn btn-map" onclick="viewOnMap({{ accident.latitude }}, {{ accident.longitude }})">
                        <i class="fas fa-map"></i> Map
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-search"></i>
            <h3>No accidents found</h3>
            <p>Try adjusting your filters or search criteria</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}