{% extends 'base.html' %}
{% load static %}

{% block title %}Accident List - AGNES Hotspot System{% endblock %}

{% block breadcrumb_items %}
<span> / Accidents</span>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --fatal-red: #DC143C;
        --injury-orange: #FFA500;
        --property-blue: #6C757D;
        --hotspot-red: #DC143C;
        --primary-blue: #003087;
        --success-green: #28A745;
    }

    .accident-list-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Hero Header */
    .page-hero {
        background: linear-gradient(135deg, #003087 0%, #0052CC 100%);
        color: white;
        padding: 35px;
        border-radius: 15px;
        margin-bottom: 25px;
        box-shadow: 0 4px 12px rgba(0, 48, 135, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .page-hero-content {
        flex: 1;
        min-width: 300px;
    }

    .page-hero h1 {
        font-size: 2.2rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .page-hero p {
        font-size: 1.1rem;
        opacity: 0.95;
        margin: 0;
    }

    .hero-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    .hero-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .hero-actions .btn {
        padding: 12px 24px;
        font-size: 0.95rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        border: none;
        cursor: pointer;
    }

    .hero-actions .btn-outline-light {
        background: transparent;
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.8);
    }

    .hero-actions .btn-outline-light:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: white;
        transform: translateY(-2px);
    }

    /* Unified Filters Section - Modern Design */
    .filters-section {
        background: white;
        padding: 1.75rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        margin-bottom: 1.5rem;
        border: 1px solid #E5E7EB;
        border-top: 2px solid var(--primary-blue);
    }

    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }

    .filters-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
    }

    /* Search Input - Modern & Flat */
    .search-wrapper {
        position: relative;
        display: flex;
        gap: 0.75rem;
    }

    .search-input-wrapper {
        position: relative;
        flex: 1;
    }

    #searchInput {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
        background: white;
    }

    #searchInput:hover {
        border-color: #9CA3AF;
    }

    #searchInput:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08);
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        pointer-events: none;
    }

    .search-button {
        padding: 0.75rem 1.5rem;
        background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .search-button:hover {
        background: #0052CC;
        transform: translateY(-1px);
    }

    /* Search Input - Modern & Flat */
    #hotspotSearch {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
        background: white;
    }

    #hotspotSearch:hover {
        border-color: #9CA3AF;
    }

    #hotspotSearch:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08);
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        pointer-events: none;
    }

    /* Quick Search Buttons */
    .quick-search-btn {
        padding: 0.4rem 0.875rem;
        font-size: 0.8125rem;
        font-weight: 600;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .quick-search-btn.fatal {
        background: var(--fatal-red);
    }

    .quick-search-btn.injury {
        background: var(--injury-orange);
    }

    .quick-search-btn.property {
        background: var(--property-blue);
    }

    .quick-search-btn.standalone {
        background: #10B981;
    }

    .quick-search-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        filter: brightness(1.1);
    }

    .quick-search-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    .quick-search-btn i {
        font-size: 0.75rem;
    }

    /* Filter Grid - Clean Layout (matching analytics - 5 columns) */
    .filters-grid {
        display: grid;
        grid-template-columns: 1.1fr 1.2fr 0.8fr 1fr 1fr;
        gap: 0.75rem;
        margin-top: 1.25rem;
        align-items: end;
    }

    @media (max-width: 1200px) {
        .filters-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .filters-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .filters-grid {
            grid-template-columns: 1fr;
        }
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        margin: 0;
    }

    .filter-group label {
        font-weight: 500;
        color: #374151;
        font-size: 0.8rem;
    }

    .filter-group select,
    .filter-group input[type="date"] {
        padding: 0.5rem 0.75rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.85rem;
        transition: all 0.2s ease;
        background: white;
        cursor: pointer;
    }

    .filter-group select:hover,
    .filter-group input[type="date"]:hover {
        border-color: #9CA3AF;
    }

    .filter-group select:focus,
    .filter-group input[type="date"]:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08);
    }

    /* Date selector inputs */
    .date-selector {
        transition: all 0.2s ease;
    }

    .date-selector:hover {
        border-color: #9CA3AF !important;
    }

    .date-selector:focus {
        outline: none;
        border-color: var(--primary-blue) !important;
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08) !important;
    }

    /* Quick Filters as Pills */
    .quick-filters {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #E5E7EB;
    }

    .quick-filter-btn {
        padding: 0.5rem 1rem;
        border: 1.5px solid #D1D5DB;
        background: white;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #374151;
    }

    .quick-filter-btn:hover {
        border-color: var(--primary-blue);
        background: #F9FAFB;
    }

    .quick-filter-btn.active {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .quick-filter-btn.fatal.active {
        background: var(--fatal-red);
        border-color: var(--fatal-red);
    }

    .quick-filter-btn.injury.active {
        background: var(--injury-orange);
        border-color: var(--injury-orange);
    }

    .quick-filter-btn.hotspot.active {
        background: var(--hotspot-red);
        border-color: var(--hotspot-red);
    }

    .quick-filter-btn.standalone.active {
        background: linear-gradient(135deg, #6C757D, #495057);
        border-color: #6C757D;
    }

    /* Active Filters Tags - Blue Theme */
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #E5E7EB;
    }

    .active-filters.hidden {
        display: none;
    }

    .filter-tag {
        background: #E8F0FE;
        color: #003087;
        padding: 0.5rem 0.875rem;
        border-radius: 8px;
        font-size: 0.8125rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        border: 1px solid #BBDEFB;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 48, 135, 0.1);
    }

    .filter-tag:hover {
        box-shadow: 0 2px 6px rgba(0, 48, 135, 0.2);
        transform: translateY(-1px);
        border-color: #003087;
    }

    .filter-icon {
        font-size: 1rem;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .filter-content {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .filter-tag button {
        background: none;
        border: none;
        color: var(--primary-blue);
        cursor: pointer;
        font-weight: 600;
        font-size: 1.125rem;
        line-height: 1;
        padding: 0;
        margin-left: 0.25rem;
        border-radius: 4px;
        transition: all 0.3s ease;
        width: 22px;
        height: 22px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .filter-tag button:hover {
        background: var(--primary-blue);
        color: white;
        transform: scale(1.2) rotate(90deg);
        box-shadow: 0 2px 6px rgba(0, 48, 135, 0.3);
    }

    /* Active Filters Tags - Blue Theme */
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #E5E7EB;
    }

    .active-filters.hidden {
        display: none;
    }

    .filter-tag {
        background: #E8F0FE;
        color: #003087;
        padding: 0.5rem 0.875rem;
        border-radius: 8px;
        font-size: 0.8125rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        border: 1px solid #BBDEFB;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 48, 135, 0.1);
    }

    .filter-tag:hover {
        box-shadow: 0 2px 6px rgba(0, 48, 135, 0.2);
        transform: translateY(-1px);
        border-color: #003087;
    }

    .filter-icon {
        font-size: 1rem;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .filter-content {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .filter-tag button {
        background: none;
        border: none;
        color: var(--primary-blue);
        cursor: pointer;
        font-weight: 600;
        font-size: 1.125rem;
        line-height: 1;
        padding: 0;
        margin-left: 0.25rem;
        border-radius: 4px;
        transition: all 0.3s ease;
        width: 22px;
        height: 22px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .filter-tag button:hover {
        background: var(--primary-blue);
        color: white;
        transform: scale(1.2) rotate(90deg);
        box-shadow: 0 2px 6px rgba(0, 48, 135, 0.3);
    }

    /* Summary Cards - Flat & Clean */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .summary-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        text-align: center;
        transition: all 0.2s ease;
        border: 1px solid #E5E7EB;
    }

    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .summary-card h3 {
        font-size: 2rem;
        color: var(--primary-blue);
        margin-bottom: 0.5rem;
        font-weight: 700;
    }

    .summary-card p {
        color: #6B7280;
        font-size: 0.875rem;
        margin: 0;
    }

    /* Modern Button Styles */
    .btn {
        padding: 0.625rem 1.25rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary-blue);
        color: white;
        border: 1px solid var(--primary-blue);
    }

    .btn-primary:hover {
        background: #0052CC;
        border-color: #0052CC;
        transform: translateY(-1px);
    }

    .btn-outline {
        background: white;
        color: #6B7280;
        border: 1.5px solid #D1D5DB;
    }

    .btn-outline:hover {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
    }

    /* View Toggle - Flat Design (Mini Size) */
    .view-toggle {
        display: flex;
        background: #F3F4F6;
        border-radius: 6px;
        padding: 0.15rem;
        margin-bottom: 0.75rem;
        border: 1px solid #E5E7EB;
    }

    .view-option {
        flex: 1;
        padding: 0.3rem 0.75rem;
        text-align: center;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.8rem;
        font-weight: 500;
        color: #6B7280;
        border: 2px solid transparent;
        background: transparent;
        position: relative;
        overflow: hidden;
    }

    .view-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s ease;
    }

    .view-option.active::before {
        left: 100%;
    }

    .view-option:hover:not(.active) {
        border-color: #003087;
        color: #003087;
        background: rgba(0, 48, 135, 0.05);
        transform: translateY(-1px);
    }

    .view-option.active {
        background: var(--primary-blue);
        color: white;
        box-shadow: 0 2px 8px rgba(0, 48, 135, 0.25);
        border-color: var(--primary-blue);
        transform: scale(1.02);
    }

    /* Pagination - Modern Flat (matching hotspots exactly) */
    .pagination-container {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        border: 1px solid #E5E7EB;
        border-top: 2px solid var(--primary-blue);
        position: relative;
    }

    .pagination-info {
        color: #6B7280;
        font-size: 0.875rem;
        flex: 1;
    }

    .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
    }

    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #pageInfo {
        padding: 0 1rem;
        font-weight: 600;
        color: #111827;
        font-size: 0.875rem;
    }

    #itemsPerPage {
        padding: 0.5rem 0.75rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
    }

    /* Accidents Grid - Matching Hotspots */
    .accidents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .accident-card {
        background: white;
        border-radius: 8px;
        border: 1px solid #E5E7EB;
        border-left: 3px solid #003087;
        overflow: hidden;
        transition: all 0.2s ease;
        position: relative;
    }

    .accident-card:hover {
        border-color: #D1D5DB;
        border-left-color: #003087;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .card-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #003087 0%, #0052CC 100%);
        border-bottom: 1px solid #F0F1F3;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .severity-badge {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 4px;
        color: white;
    }

    .severity-badge.fatal {
        background: var(--fatal-red);
    }

    .severity-badge.injury {
        background: var(--injury-orange);
    }

    .severity-badge.property {
        background: var(--property-blue);
    }

    .hotspot-mini-badge {
        background: #FEF3C7;
        color: #92400E;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.3px;
        border: 1px solid #FDE68A;
    }

    .hotspot-mini-badge i {
        color: #D97706;
        font-size: 0.75rem;
    }

    .card-body {
        padding: 20px;
    }

    .card-date {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #9CA3AF;
        font-size: 0.875rem;
        margin-bottom: 14px;
    }

    .card-date i {
        color: #D1D5DB;
        font-size: 0.8rem;
    }

    .card-date strong {
        color: #374151;
        font-weight: 500;
    }

    .card-location {
        margin-bottom: 14px;
    }

    .card-location-title {
        font-weight: 600;
        font-size: 1.05rem;
        color: #111827;
        margin-bottom: 4px;
    }

    .card-location-sub {
        color: #6B7280;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .card-location-sub i {
        color: #9CA3AF;
        font-size: 0.75rem;
    }

    .card-type {
        background: transparent;
        padding: 0;
        border-radius: 0;
        font-size: 0.875rem;
        color: #6B7280;
        margin-bottom: 16px;
        line-height: 1.5;
    }

    .card-type i {
        color: #D1D5DB;
        margin-right: 6px;
        font-size: 0.75rem;
    }

    .card-actions {
        display: flex;
        gap: 8px;
        padding-top: 14px;
        border-top: 1px solid #F3F4F6;
    }

    .card-action-btn {
        flex: 1;
        padding: 9px 12px;
        border: 1px solid #E5E7EB;
        background: white;
        color: #374151;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .card-action-btn i {
        font-size: 0.8rem;
        color: #6B7280;
    }

    .card-action-btn:hover {
        background: #F9FAFB;
        border-color: #D1D5DB;
    }

    /* Card View Button - View */
    .card-action-btn.btn-view {
        background: #E3F2FD;
        color: var(--primary-blue);
        border-color: #BBDEFB;
    }

    .card-action-btn.btn-view i {
        color: var(--primary-blue);
    }

    .card-action-btn.btn-view:hover {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .card-action-btn.btn-view:hover i {
        color: white;
    }

    /* Card View Button - Map */
    .card-action-btn.btn-map {
        background: #E8F5E9;
        color: var(--success-green);
        border-color: #C8E6C9;
    }

    .card-action-btn.btn-map i {
        color: var(--success-green);
    }

    .card-action-btn.btn-map:hover {
        background: var(--success-green);
        color: white;
        border-color: var(--success-green);
    }

    .card-action-btn.btn-map:hover i {
        color: white;
    }

    /* Table View */
    .accidents-table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-bottom: 30px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .table-responsive.scrollable {
        max-height: 700px;
    }

    .accidents-table {
        width: 100%;
        border-collapse: collapse;
    }

    .accidents-table thead {
        background: #F8F9FA;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .accidents-table th {
        padding: 15px 12px;
        text-align: left;
        font-weight: 700;
        color: #333;
        border-bottom: 2px solid #DEE2E6;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .accidents-table td {
        padding: 15px 12px;
        border-bottom: 1px solid #F1F3F5;
        vertical-align: middle;
    }

    .accidents-table tbody tr {
        transition: all 0.2s;
        cursor: pointer;
    }

    .accidents-table tbody tr:hover {
        background: #F8F9FA;
    }

    .severity-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    .severity-dot.fatal {
        background: var(--fatal-red);
        box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.2);
    }

    .severity-dot.injury {
        background: var(--injury-orange);
        box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.2);
    }

    .severity-dot.property {
        background: var(--property-blue);
        box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.2);
    }

    .table-actions {
        display: flex;
        gap: 5px;
    }

    .table-action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
    }

    .table-action-btn.view {
        background: #E3F2FD;
        color: var(--primary-blue);
    }

    .table-action-btn.view:hover {
        background: var(--primary-blue);
        color: white;
    }

    .table-action-btn.map {
        background: #E8F5E9;
        color: var(--success-green);
    }

    .table-action-btn.map:hover {
        background: var(--success-green);
        color: white;
    }

    .text-center {
        text-align: center;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6C757D;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }

    .empty-state h3 {
        margin-bottom: 10px;
        color: #495057;
    }

    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 30px;
    }

    .pagination {
        display: flex;
        gap: 5px;
        list-style: none;
        padding: 0;
    }

    .page-item {
        margin: 0;
    }

    .page-link {
        padding: 10px 16px;
        border: 2px solid #E9ECEF;
        background: white;
        color: var(--primary-blue);
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .page-link:hover {
        background: #F8F9FA;
        border-color: var(--primary-blue);
        transform: translateY(-2px);
    }

    .page-item.active .page-link {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .page-item.disabled .page-link {
        color: #ADB5BD;
        background: #F8F9FA;
        cursor: not-allowed;
        transform: none;
    }

    /* Loading Animation - PNP Theme (Same as Hotspot) */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(0, 48, 135, 0.5) 0%, rgba(0, 32, 96, 0.6) 100%);
        backdrop-filter: blur(5px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner-container {
        position: relative;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .spinner-logo {
        position: absolute;
        width: 45px;
        height: 45px;
        z-index: 1;
        animation: pulse 2s ease-in-out infinite;
    }

    .spinner-logo img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        filter: drop-shadow(0 2px 4px rgba(0, 48, 135, 0.3));
    }

    .spinner {
        border: 5px solid rgba(0, 48, 135, 0.1);
        border-top: 5px solid #003087;
        border-right: 5px solid #DC143C;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        animation: spin 1s linear infinite;
    }

    .spinner-inner {
        position: absolute;
        top: 12px;
        left: 12px;
        border: 3px solid rgba(255, 215, 0, 0.3);
        border-top: 3px solid #FFD700;
        border-radius: 50%;
        width: 56px;
        height: 56px;
        animation: spin 1.5s linear infinite reverse;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.9; }
    }

    /* Accident Modal */
    .accident-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        animation: fadeIn 0.3s ease;
    }

    .accident-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        position: relative;
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
        overflow: hidden;
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: transparent;
        border: none;
        font-size: 1.5rem;
        color: #6B7280;
        cursor: pointer;
        z-index: 10;
        transition: color 0.2s;
    }

    .modal-close:hover {
        color: #DC143C;
    }

    .modal-header {
        background: linear-gradient(135deg, #003087 0%, #0052CC 100%);
        color: white;
        padding: 1.5rem 2rem;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .modal-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }

    .modal-info-item {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
    }

    .modal-info-item > i {
        color: #003087;
        font-size: 1.25rem;
        margin-top: 0.25rem;
    }

    .modal-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #6B7280;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .modal-value {
        font-size: 0.95rem;
        color: #111827;
        font-weight: 500;
    }

    .modal-footer {
        padding: 1.5rem 2rem;
        background: #F9FAFB;
        border-top: 1px solid #E5E7EB;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }

    .modal-btn.btn-map {
        background: #10B981;
        color: white;
    }

    .modal-btn.btn-map:hover {
        background: #059669;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .modal-btn.btn-detail {
        background: var(--primary-blue);
        color: white;
    }

    .modal-btn.btn-detail:hover {
        background: #002070;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 48, 135, 0.3);
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .page-hero h1 {
            font-size: 1.6rem;
        }

        .accidents-grid {
            grid-template-columns: 1fr;
        }

        .quick-filters {
            justify-content: center;
        }

        .view-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .view-toggle {
            justify-content: center;
        }

        .search-box {
            flex-direction: column;
        }

        .stats-section {
            grid-template-columns: repeat(2, 1fr);
        }

        .modal-content {
            width: 95%;
            max-height: 90vh;
        }

        .modal-info-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            flex-direction: column;
            gap: 0.75rem;
        }

        .modal-btn {
            width: 100%;
            justify-content: center;
        }

        .filters-content {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .stats-section {
            grid-template-columns: 1fr;
        }

        .card-actions {
            flex-direction: column;
        }
    }

    /* Chart Modal Base Styles */
    .chart-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.75);
        z-index: 10000;
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
    }

    .chart-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chart-modal-content {
        background: white;
        border-radius: 16px;
        padding: 0;
        width: 90%;
        max-width: 420px;
        max-height: 90vh;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        overflow: hidden;
        animation: slideUp 0.4s ease;
        display: flex;
        flex-direction: column;
    }

    .chart-modal-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        flex-shrink: 0;
    }

    .chart-modal-header h3 {
        margin: 0;
        color: var(--primary-blue);
        font-size: 1.125rem;
        font-weight: 600;
        flex: 1;
    }

    .chart-modal-close {
        background: white;
        border: 1px solid var(--border-light);
        width: 36px;
        height: 36px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.25rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-weight: 300;
    }

    .chart-modal-close:hover {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Date Selection Modal Styles */
    .date-modal-body {
        padding: 0.75rem;
        overflow-y: auto;
        max-height: calc(90vh - 120px);
    }

    /* Date Range Tabs - Mini Size */
    .date-range-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.6rem;
    }

    .date-tab {
        flex: 1;
        background: var(--bg-light);
        border: 2px solid var(--border-light);
        border-radius: 6px;
        padding: 0.35rem 0.6rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.1rem;
    }

    .date-tab:hover {
        border-color: var(--primary-blue);
        background: white;
    }

    .date-tab.active {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
    }

    .tab-label {
        font-size: 0.625rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        opacity: 0.85;
        line-height: 1;
    }

    .tab-value {
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        line-height: 1.2;
    }

    /* Date Modal Alert - Beautiful & Clean */
    .date-modal-alert {
        background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
        border-left: 4px solid #FF9800;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideDown 0.3s ease;
        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.15);
    }

    .date-modal-alert .alert-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
        line-height: 1;
    }

    .date-modal-alert .alert-message {
        font-size: 0.875rem;
        color: #E65100;
        line-height: 1.4;
        font-weight: 500;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Calendar Container - Compact */
    .calendar-container {
        background: white;
        border-radius: 8px;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.4rem;
        gap: 0.4rem;
    }

    .calendar-nav {
        background: var(--bg-light);
        border: none;
        width: 26px;
        height: 26px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--primary-blue);
        transition: all 0.2s ease;
        font-size: 0.75rem;
        flex-shrink: 0;
    }

    .calendar-nav:hover {
        background: var(--primary-blue);
        color: white;
        transform: scale(1.05);
    }

    .calendar-title {
        display: flex;
        gap: 0.4rem;
        flex: 1;
    }

    .calendar-select {
        flex: 1;
        padding: 0.3rem 0.4rem;
        border: 2px solid var(--border-light);
        border-radius: 5px;
        font-weight: 600;
        color: var(--primary-blue);
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
    }

    .calendar-select:hover {
        border-color: var(--primary-blue);
    }

    .calendar-select:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 2px rgba(0, 48, 135, 0.1);
    }

    /* Calendar Grid - Compact */
    .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.15rem;
        margin-bottom: 0.25rem;
    }

    .weekday {
        text-align: center;
        font-size: 0.625rem;
        font-weight: 600;
        color: var(--text-secondary);
        padding: 0.2rem 0;
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.15rem;
    }

    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 5px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
        border: 2px solid transparent;
        min-height: 30px;
        max-height: 38px;
    }

    .calendar-day:hover {
        background: var(--bg-light);
        border-color: var(--primary-blue);
    }

    .calendar-day.other-month {
        color: var(--text-secondary);
        opacity: 0.25;
    }

    .calendar-day.selected {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
        font-weight: 600;
    }

    .calendar-day.today {
        border-color: var(--primary-blue);
        font-weight: 600;
    }

    .calendar-day.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .calendar-day.disabled:hover {
        background: white;
        border-color: transparent;
    }

    /* Modal Actions - Mini Buttons */
    .date-modal-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.5rem;
        border-top: 1px solid var(--border-light);
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary-blue);
        color: white;
        border: 2px solid var(--primary-blue);
        padding: 0.35rem 0.9rem;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
    }

    .btn-primary:hover {
        background: #002060;
        border-color: #002060;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(0, 48, 135, 0.3);
    }

    .btn-outline {
        background: white;
        color: var(--primary-blue);
        border: 2px solid var(--border-light);
        padding: 0.35rem 0.9rem;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
    }

    /* Responsive adjustments for smaller screens */
    @media (max-width: 768px) {
        #dateModal .chart-modal-content {
            width: 95%;
            max-width: 100%;
        }

        .date-modal-body {
            padding: 0.75rem;
        }

        .date-tab {
            padding: 0.5rem;
            min-height: 55px;
        }

        .tab-label {
            font-size: 0.65rem;
        }

        .tab-value {
            font-size: 0.8rem;
        }

        .calendar-container {
            padding: 0.75rem;
        }

        .calendar-day {
            min-height: 35px;
            max-height: 45px;
            font-size: 0.8rem;
        }
    }

    @media (max-width: 480px) {
        .date-modal-body {
            padding: 1rem;
        }

        .calendar-container {
            padding: 1rem;
        }

        .date-modal-actions {
            flex-direction: column;
            gap: 0.5rem;
        }

        .date-modal-actions > * {
            width: 100%;
        }

        .date-modal-actions > div {
            display: flex;
            gap: 0.5rem;
        }

        .date-modal-actions button {
            flex: 1;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Municipality data
const municipalityData = {{ municipality_data_json|safe }};

// No client-side pagination state needed - server handles everything

// View toggle
function switchView(viewType) {
    const cardsView = document.getElementById('cardsView');
    const tableView = document.getElementById('tableView');
    const options = document.querySelectorAll('.view-option');

    options.forEach(opt => opt.classList.remove('active'));
    event.target.classList.add('active');

    if (viewType === 'cards') {
        cardsView.style.display = 'block';
        tableView.style.display = 'none';
    } else {
        cardsView.style.display = 'none';
        tableView.style.display = 'block';
    }
}

// ===== SMOOTH PAGE UPDATES WITHOUT RELOAD =====

function showLoading() {
    document.querySelector('.loading-overlay').classList.add('active');
}

function hideLoading() {
    document.querySelector('.loading-overlay').classList.remove('active');
}

function updatePageContent(url, pushState = true, forcedScrollPosition = null) {
    // Use forced scroll position if provided, otherwise save current position
    const scrollPosition = forcedScrollPosition !== null ? forcedScrollPosition :
                          (window.pageYOffset || document.documentElement.scrollTop);
    console.log('ðŸ”µ Saving scroll position:', scrollPosition, forcedScrollPosition !== null ? '(forced)' : '(auto)');

    // Disable smooth scrolling temporarily
    const htmlElement = document.documentElement;
    const originalScrollBehavior = htmlElement.style.scrollBehavior;
    htmlElement.style.scrollBehavior = 'auto';

    showLoading();

    fetch(url)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Update accidents container (both cards and table view)
            const newCardsView = doc.getElementById('cardsView');
            const newTableView = doc.getElementById('tableView');
            const currentCardsView = document.getElementById('cardsView');
            const currentTableView = document.getElementById('tableView');

            if (newCardsView && currentCardsView) {
                currentCardsView.innerHTML = newCardsView.innerHTML;
            }
            if (newTableView && currentTableView) {
                currentTableView.innerHTML = newTableView.innerHTML;
            }

            // Update pagination
            const newPagination = doc.querySelector('.pagination-container');
            const currentPagination = document.querySelector('.pagination-container');
            if (newPagination && currentPagination) {
                currentPagination.innerHTML = newPagination.innerHTML;
            }

            // Update summary cards
            const newSummaryCards = doc.querySelector('.summary-cards');
            const currentSummaryCards = document.querySelector('.summary-cards');
            if (newSummaryCards && currentSummaryCards) {
                currentSummaryCards.innerHTML = newSummaryCards.innerHTML;
            }

            // Update filter dropdowns to match URL parameters
            const urlParams = new URLSearchParams(new URL(url).search);
            const perPageParam = urlParams.get('per_page') || '100';
            const provinceParam = urlParams.get('province') || '';
            const municipalParam = urlParams.get('municipal') || '';
            const yearParam = urlParams.get('year') || '';
            const searchParam = urlParams.get('search') || '';

            document.getElementById('itemsPerPage').value = perPageParam;
            document.getElementById('province').value = provinceParam;

            // Update municipalities based on selected province
            updateMunicipalityDropdown();

            // Then set the municipal value after updating the dropdown
            document.getElementById('municipal').value = municipalParam;
            document.getElementById('year').value = yearParam;
            document.getElementById('hotspotSearch').value = searchParam;

            // Update browser URL without reload FIRST
            if (pushState) {
                history.pushState({}, '', url);
            }

            // Update active filters badges AFTER URL is updated
            updateActiveFilters();

            // Aggressively restore scroll position BEFORE hiding loading
            window.scrollTo(0, scrollPosition);
            document.documentElement.scrollTop = scrollPosition;
            document.body.scrollTop = scrollPosition;
            console.log('ðŸŸ¢ Restoring scroll position (immediate):', scrollPosition);

            hideLoading();

            // Continue restoring scroll position after hiding loading
            setTimeout(() => {
                window.scrollTo(0, scrollPosition);
                document.documentElement.scrollTop = scrollPosition;
                document.body.scrollTop = scrollPosition;
                console.log('ðŸŸ¡ Restoring scroll position (50ms):', scrollPosition);
            }, 50);

            setTimeout(() => {
                window.scrollTo(0, scrollPosition);
                document.documentElement.scrollTop = scrollPosition;
                document.body.scrollTop = scrollPosition;
                htmlElement.style.scrollBehavior = originalScrollBehavior;
                console.log('ðŸŸ  Restoring scroll position (100ms):', scrollPosition);
            }, 100);

            setTimeout(() => {
                window.scrollTo(0, scrollPosition);
                console.log('ðŸ”´ Final scroll restoration (200ms):', scrollPosition);
            }, 200);
        })
        .catch(error => {
            console.error('Error loading content:', error);
            // Fallback to normal page load if fetch fails
            window.location.href = url;
        });
}

// Quick search function for category buttons
function quickSearch(keyword) {
    document.getElementById('hotspotSearch').value = keyword;
    performSearch();
}

// Search function - Smooth update without reload
function performSearch() {
    const searchValue = document.getElementById('hotspotSearch').value.trim();
    const currentUrl = new URL(window.location.href);

    if (searchValue) {
        currentUrl.searchParams.set('search', searchValue);
    } else {
        currentUrl.searchParams.delete('search');
    }

    // Keep existing filters
    const province = document.getElementById('province').value;
    const municipal = document.getElementById('municipal').value;
    const year = document.getElementById('year').value;

    if (province) currentUrl.searchParams.set('province', province);
    if (municipal) currentUrl.searchParams.set('municipal', municipal);
    if (year) currentUrl.searchParams.set('year', year);

    // Reset to first page
    currentUrl.searchParams.delete('page');

    // Smooth update instead of reload
    updatePageContent(currentUrl.toString());
}

function applyServerSideFilters() {
    const currentUrl = new URL(window.location.href);

    // Get filter values
    const searchValue = document.getElementById('hotspotSearch').value.trim();
    const province = document.getElementById('province').value;
    const municipal = document.getElementById('municipal').value;
    const year = document.getElementById('year').value;
    const dateFrom = document.getElementById('date_from').value;
    const dateTo = document.getElementById('date_to').value;

    // Update URL parameters
    if (searchValue) {
        currentUrl.searchParams.set('search', searchValue);
    } else {
        currentUrl.searchParams.delete('search');
    }

    if (province) {
        currentUrl.searchParams.set('province', province);
    } else {
        currentUrl.searchParams.delete('province');
    }

    if (municipal) {
        currentUrl.searchParams.set('municipal', municipal);
    } else {
        currentUrl.searchParams.delete('municipal');
    }

    if (year) {
        currentUrl.searchParams.set('year', year);
    } else {
        currentUrl.searchParams.delete('year');
    }

    if (dateFrom) {
        currentUrl.searchParams.set('date_from', dateFrom);
    } else {
        currentUrl.searchParams.delete('date_from');
    }

    if (dateTo) {
        currentUrl.searchParams.set('date_to', dateTo);
    } else {
        currentUrl.searchParams.delete('date_to');
    }

    // Reset to first page when filters change
    currentUrl.searchParams.delete('page');

    // Smooth update instead of reload
    updatePageContent(currentUrl.toString());
}

function updateActiveFilters() {
    const activeFilters = document.getElementById('activeFilters');
    const urlParams = new URLSearchParams(window.location.search);

    // Get or initialize filter order tracking
    let filterOrder = JSON.parse(sessionStorage.getItem('accidentFilterOrder') || '[]');

    // Define all possible filters with their icons and display info
    const filterConfig = {
        'search': {
            icon: '<i class="fas fa-magnifying-glass"></i>',
            label: 'Search',
            getValue: () => urlParams.get('search') || null
        },
        'province': {
            icon: '<i class="fa-solid fa-landmark"></i>',
            label: 'Province',
            getValue: () => urlParams.get('province') || null
        },
        'municipal': {
            icon: '<i class="fa-solid fa-city"></i>',
            label: 'Municipality',
            getValue: () => urlParams.get('municipal') || null
        },
        'year': {
            icon: '<i class="fa-regular fa-calendar-days"></i>',
            label: 'Year',
            getValue: () => urlParams.get('year') || null
        },
        'date_from': {
            icon: '<i class="fa-regular fa-calendar-check"></i>',
            label: 'From',
            getValue: () => urlParams.get('date_from') || null
        },
        'date_to': {
            icon: '<i class="fa-regular fa-calendar-days"></i>',
            label: 'To',
            getValue: () => urlParams.get('date_to') || null
        }
    };

    // Collect active filters
    const activeFiltersList = [];
    for (const [filterName, config] of Object.entries(filterConfig)) {
        const value = config.getValue();
        if (value) {
            // Track order: add to filterOrder if not already there
            if (!filterOrder.includes(filterName)) {
                filterOrder.push(filterName);
            }
            activeFiltersList.push({
                name: filterName,
                icon: config.icon,
                label: config.label,
                value: value,
                order: filterOrder.indexOf(filterName)
            });
        }
    }

    // Remove filters from order that are no longer active
    filterOrder = filterOrder.filter(name => activeFiltersList.some(f => f.name === name));
    sessionStorage.setItem('accidentFilterOrder', JSON.stringify(filterOrder));

    // Sort by order (earliest first, left to right)
    activeFiltersList.sort((a, b) => a.order - b.order);

    // Build HTML
    let activeFiltersHTML = '';
    for (const filter of activeFiltersList) {
        const displayValue = filter.name === 'search' ? `"${filter.value}"` : filter.value;
        activeFiltersHTML += `<div class="filter-tag">
            <span class="filter-icon">${filter.icon}</span>
            <span class="filter-content"><strong>${filter.label}:</strong> ${displayValue}</span>
            <button onclick="removeServerFilter('${filter.name}')">Ã—</button>
        </div>`;
    }

    activeFilters.innerHTML = activeFiltersHTML;
    if (activeFiltersHTML) {
        activeFilters.classList.remove('hidden');
    } else {
        activeFilters.classList.add('hidden');
        // Clear order when no filters
        sessionStorage.removeItem('accidentFilterOrder');
    }
}

function removeServerFilter(filterName) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.delete(filterName);
    currentUrl.searchParams.delete('page'); // Reset to first page

    // Clear the corresponding input field
    if (filterName === 'date_from') {
        document.getElementById('date_from').value = '';
    } else if (filterName === 'date_to') {
        document.getElementById('date_to').value = '';
    } else if (filterName === 'province') {
        document.getElementById('province').value = '';
    } else if (filterName === 'municipal') {
        document.getElementById('municipal').value = '';
    } else if (filterName === 'year') {
        document.getElementById('year').value = '';
    }

    // Smooth update instead of reload
    updatePageContent(currentUrl.toString());
}

// Quick filter
function applyQuickFilter(filterType) {
    // Remove active class from all buttons
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    event.target.closest('.quick-filter-btn').classList.add('active');
    
    // Build URL with filter parameter
    let url = new URL(window.location.href);
    url.search = ''; // Clear existing parameters
    
    switch(filterType) {
        case 'all':
            // No filter - show all
            break;
        case 'fatal':
            url.searchParams.set('fatal', 'true');
            break;
        case 'injury':
            url.searchParams.set('injury', 'true');
            break;
        case 'hotspot':
            url.searchParams.set('is_hotspot', 'true');
            break;
        case 'standalone':  // NEW CASE
            url.searchParams.set('no_hotspot', 'true');
            break;
    }
    
    // Redirect to filtered URL
    window.location.href = url.toString();
}

// Toggle advanced filters
function toggleAdvancedFilters() {
    const content = document.querySelector('.filters-content');
    const icon = document.querySelector('.filters-toggle i');
    
    content.classList.toggle('collapsed');
    icon.classList.toggle('fa-chevron-down');
    icon.classList.toggle('fa-chevron-up');
}

// Update municipalities based on selected province
function updateMunicipalityDropdown() {
    const provinceSelect = document.getElementById('province');
    const municipalitySelect = document.getElementById('municipal');
    const selectedProvince = provinceSelect.value;

    municipalitySelect.value = '';
    municipalitySelect.innerHTML = '<option value="">All Municipalities</option>';

    let municipalitiesToShow = selectedProvince ?
        (municipalityData[selectedProvince] || []) :
        [];

    municipalitiesToShow.forEach(function(mun) {
        const option = document.createElement('option');
        option.value = mun;
        option.textContent = mun;
        municipalitySelect.appendChild(option);
    });
}

// Export to CSV
function exportToCSV() {
    const searchParams = new URLSearchParams(window.location.search);
    searchParams.set('export', 'csv');
    window.location.href = '{% url "accident_list" %}?' + searchParams.toString();
}

// Navigate to accident
function viewAccident(id) {
    window.location.href = `/accidents/${id}/`;
}

function viewOnMap(lat, lng, accidentId) {
    if (accidentId) {
        window.location.href = `/map/?lat=${lat}&lng=${lng}&zoom=16&accident_id=${accidentId}&single=true&source=list`;
    } else {
        window.location.href = `/map/?lat=${lat}&lng=${lng}&zoom=15`;
    }
}

// Accident Modal Functions
let currentAccidentData = {};

function openAccidentModal(id, date, time, barangay, municipal, province, incidentType, isFatal, isInjury, isHotspot, lat, lng, street, victimCount, placeType, vehicle, station, clusterId) {
    currentAccidentData = { id, lat, lng };

    const modal = document.getElementById('accidentModal');

    // Populate modal content
    document.getElementById('modalDate').textContent = date;
    document.getElementById('modalTime').textContent = time;
    document.getElementById('modalLocation').textContent = `${barangay}, ${municipal}, ${province}`;
    document.getElementById('modalStreet').textContent = street || 'N/A';
    document.getElementById('modalIncidentType').textContent = incidentType;
    document.getElementById('modalVictims').textContent = `${victimCount} victim(s)`;
    document.getElementById('modalPlaceType').textContent = placeType || 'Road/Highway';
    document.getElementById('modalVehicle').textContent = vehicle || 'Not specified';
    document.getElementById('modalStation').textContent = station || 'Not specified';
    document.getElementById('modalCluster').textContent = clusterId || '-';

    // Add badges
    let badgesHTML = '';
    if (isFatal) {
        badgesHTML += '<span class="severity-badge fatal"><i class="fas fa-skull-crossbones"></i> Fatal</span>';
    } else if (isInjury) {
        badgesHTML += '<span class="severity-badge injury"><i class="fas fa-user-injured"></i> Injury</span>';
    } else {
        badgesHTML += '<span class="severity-badge property"><i class="fas fa-car"></i> Property</span>';
    }

    if (isHotspot) {
        badgesHTML += '<span class="hotspot-mini-badge"><i class="fas fa-fire"></i> Hotspot</span>';
    }

    document.getElementById('modalBadges').innerHTML = badgesHTML;

    // Set button actions - Updated to show only this accident on map
    document.getElementById('modalMapBtn').onclick = function() {
        window.location.href = `/map/?lat=${lat}&lng=${lng}&zoom=16&accident_id=${id}&single=true&source=list`;
    };

    document.getElementById('modalDetailBtn').onclick = function() {
        window.location.href = `/accidents/${id}/`;
    };

    // Show modal
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeAccidentModal() {
    const modal = document.getElementById('accidentModal');
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAccidentModal();
    }
});

// Enter key for search
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
    
    // Initialize municipalities
    updateMunicipalities();
    
    // Province change handler
    const provinceSelect = document.getElementById('province');
    if (provinceSelect) {
        provinceSelect.addEventListener('change', updateMunicipalities);
    }
    
    // Set active quick filter based on URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('fatal')) {
        document.querySelector('[onclick*="fatal"]')?.classList.add('active');
    } else if (urlParams.get('injury')) {
        document.querySelector('[onclick*="injury"]')?.classList.add('active');
    } else if (urlParams.get('is_hotspot')) {
        document.querySelector('[onclick*="hotspot"]')?.classList.add('active');
    }

    // Display active filters
    displayActiveFilters();
});

// Display active filters from URL parameters
function displayActiveFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    const filterTagsContainer = document.getElementById('activeFiltersTags');

    let tagsHTML = '';
    let hasFilters = false;

    // Search filter
    const searchTerm = urlParams.get('search');
    if (searchTerm) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-search"></i> Search: "${searchTerm}"
                <button onclick="removeFilter('search')" title="Remove search">Ã—</button>
            </div>
        `;
    }

    // Province filter
    const province = urlParams.get('province');
    if (province) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-map-marker-alt"></i> Province: ${province}
                <button onclick="removeFilter('province')" title="Remove province">Ã—</button>
            </div>
        `;
    }

    // Municipal filter
    const municipal = urlParams.get('municipal');
    if (municipal) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-city"></i> Municipality: ${municipal}
                <button onclick="removeFilter('municipal')" title="Remove municipality">Ã—</button>
            </div>
        `;
    }

    // Year filter
    const year = urlParams.get('year');
    if (year) {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-calendar"></i> Year: ${year}
                <button onclick="removeFilter('year')" title="Remove year">Ã—</button>
            </div>
        `;
    }

    // Fatal filter
    if (urlParams.get('fatal') === 'true') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-skull-crossbones"></i> Fatal Only
                <button onclick="removeFilter('fatal')" title="Remove fatal filter">Ã—</button>
            </div>
        `;
    }

    // Injury filter
    if (urlParams.get('injury') === 'true') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-ambulance"></i> Injury Only
                <button onclick="removeFilter('injury')" title="Remove injury filter">Ã—</button>
            </div>
        `;
    }

    // Hotspot filter
    if (urlParams.get('is_hotspot') === 'true') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-fire"></i> Hotspots Only
                <button onclick="removeFilter('is_hotspot')" title="Remove hotspot filter">Ã—</button>
            </div>
        `;
    }

    // Standalone filter
    if (urlParams.get('is_hotspot') === 'false') {
        hasFilters = true;
        tagsHTML += `
            <div class="filter-tag">
                <i class="fas fa-map-marker-alt"></i> Standalone Only
                <button onclick="removeFilter('is_hotspot')" title="Remove standalone filter">Ã—</button>
            </div>
        `;
    }

    // Show/hide filter section and update display
    if (hasFilters) {
        filterTagsContainer.innerHTML = tagsHTML;
        filterTagsContainer.classList.remove('hidden');
    } else {
        filterTagsContainer.innerHTML = '';
        filterTagsContainer.classList.add('hidden');
    }
}

// Filter changes are handled by inline onchange="applyServerSideFilters()"
// in the HTML elements for smooth AJAX updates
document.addEventListener('DOMContentLoaded', function() {

    // Display active filters on page load
    displayActiveFilters();
});

// Remove individual filter
function removeFilter(filterName) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.delete(filterName);

    // Update page content via AJAX (no page reload)
    updatePageContent(currentUrl.toString());
}

// Clear all filters - Smooth update to base URL
function clearAllFilters() {
    // CRITICAL: Save scroll position BEFORE clearing inputs
    // Clearing inputs can trigger auto-scroll behavior
    const savedScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    console.log('ðŸ’¾ Scroll BEFORE clearing inputs:', savedScrollPosition);

    // Clear all filter inputs
    document.getElementById('province').value = '';
    document.getElementById('municipal').value = '';
    document.getElementById('year').value = '';
    document.getElementById('hotspotSearch').value = '';
    document.getElementById('date_from').value = '';
    document.getElementById('date_to').value = '';
    document.getElementById('date_from_display').value = '';
    document.getElementById('date_to_display').value = '';

    console.log('ðŸ” Scroll AFTER clearing inputs:', window.pageYOffset || document.documentElement.scrollTop);

    // Update page content via AJAX (no page reload), passing saved scroll position
    updatePageContent(window.location.pathname, true, savedScrollPosition);
}

// ===== SERVER-SIDE PAGINATION FUNCTIONS =====

function navigateToPage(pageNumber) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('page', pageNumber);

    // Smooth update instead of reload
    updatePageContent(currentUrl.toString());
}

function changeItemsPerPage() {
    const perPage = document.getElementById('itemsPerPage').value;
    const currentUrl = new URL(window.location.href);

    // Update per_page parameter
    currentUrl.searchParams.set('per_page', perPage);
    // Reset to first page when changing items per page
    currentUrl.searchParams.delete('page');

    // Smooth update instead of reload
    updatePageContent(currentUrl.toString());
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load filter values from URL parameters
    const urlParams = new URLSearchParams(window.location.search);

    const searchParam = urlParams.get('search') || '';
    const provinceParam = urlParams.get('province') || '';
    const municipalParam = urlParams.get('municipal') || '';
    const yearParam = urlParams.get('year') || '';
    const perPageParam = urlParams.get('per_page') || '100';

    // Set form values from URL
    if (searchParam) {
        document.getElementById('hotspotSearch').value = searchParam;
    }
    if (provinceParam) {
        document.getElementById('province').value = provinceParam;
    }
    if (municipalParam) {
        document.getElementById('municipal').value = municipalParam;
    }
    if (yearParam) {
        document.getElementById('year').value = yearParam;
    }

    // Set items per page dropdown from URL
    document.getElementById('itemsPerPage').value = perPageParam;

    // Update municipality dropdown based on selected province
    updateMunicipalityDropdown();

    // Restore municipal value after dropdown update
    if (municipalParam) {
        document.getElementById('municipal').value = municipalParam;
    }

    // Display active filter badges
    updateActiveFilters();
});

// Date Selection Modal Variables
let currentEditingDate = 'from'; // 'from' or 'to'
let tempFromDate = null;
let tempToDate = null;
let currentCalendarMonth = new Date().getMonth();
let currentCalendarYear = new Date().getFullYear();

// Date Selection Modal Functions
function openDateModal(dateType = 'from') {
    const modal = document.getElementById('dateModal');
    currentEditingDate = dateType;

    // Hide any previous alerts
    hideDateAlert();

    // Load current values
    const fromDate = document.getElementById('date_from').value;
    const toDate = document.getElementById('date_to').value;

    tempFromDate = fromDate ? new Date(fromDate) : null;
    tempToDate = toDate ? new Date(toDate) : null;

    // Update tab display
    updateTabDisplay();

    // Set active tab
    switchDateTab(dateType);

    // Initialize calendar to existing date or current date
    const existingDate = dateType === 'from' ? tempFromDate : tempToDate;
    if (existingDate) {
        currentCalendarMonth = existingDate.getMonth();
        currentCalendarYear = existingDate.getFullYear();
    } else {
        const now = new Date();
        currentCalendarMonth = now.getMonth();
        currentCalendarYear = now.getFullYear();
    }

    // Populate year dropdown
    populateYearDropdown();

    // Render calendar
    renderCalendar();

    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeDateModal() {
    const modal = document.getElementById('dateModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
    hideDateAlert();
}

function showDateAlert(message) {
    const alert = document.getElementById('dateModalAlert');
    const messageEl = document.getElementById('dateAlertMessage');
    messageEl.textContent = message;
    alert.style.display = 'flex';
}

function hideDateAlert() {
    const alert = document.getElementById('dateModalAlert');
    alert.style.display = 'none';
}

function switchDateTab(dateType) {
    currentEditingDate = dateType;
    hideDateAlert();

    document.getElementById('fromTab').classList.toggle('active', dateType === 'from');
    document.getElementById('toTab').classList.toggle('active', dateType === 'to');

    const existingDate = dateType === 'from' ? tempFromDate : tempToDate;
    if (existingDate) {
        currentCalendarMonth = existingDate.getMonth();
        currentCalendarYear = existingDate.getFullYear();
        document.getElementById('calendarMonth').value = currentCalendarMonth;
        document.getElementById('calendarYear').value = currentCalendarYear;
    }

    renderCalendar();
}

function updateTabDisplay() {
    const fromTabValue = document.getElementById('fromTabValue');
    const toTabValue = document.getElementById('toTabValue');

    fromTabValue.textContent = tempFromDate ? formatDisplayDate(tempFromDate) : 'Not set';
    toTabValue.textContent = tempToDate ? formatDisplayDate(tempToDate) : 'Not set';
}

function formatDate(date) {
    if (!date) return '';
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function formatDisplayDate(date) {
    if (!date) return '';
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
}

function populateYearDropdown() {
    const yearSelect = document.getElementById('calendarYear');
    yearSelect.innerHTML = '';

    const currentYear = new Date().getFullYear();
    for (let year = currentYear - 10; year <= currentYear + 5; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentCalendarYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
}

function updateCalendarDate() {
    const monthSelect = document.getElementById('calendarMonth');
    const yearSelect = document.getElementById('calendarYear');

    currentCalendarMonth = parseInt(monthSelect.value);
    currentCalendarYear = parseInt(yearSelect.value);

    const newDate = new Date(currentCalendarYear, currentCalendarMonth, 1);

    if (currentEditingDate === 'from') {
        tempFromDate = newDate;
    } else {
        tempToDate = newDate;
    }

    updateTabDisplay();
    renderCalendar();
    hideDateAlert();
}

function renderCalendar() {
    const monthSelect = document.getElementById('calendarMonth');
    const yearSelect = document.getElementById('calendarYear');

    currentCalendarMonth = parseInt(monthSelect.value);
    currentCalendarYear = parseInt(yearSelect.value);

    const daysContainer = document.getElementById('calendarDays');
    daysContainer.innerHTML = '';

    const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
    const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
    const prevLastDay = new Date(currentCalendarYear, currentCalendarMonth, 0);

    const firstDayOfWeek = firstDay.getDay();
    const daysInMonth = lastDay.getDate();
    const daysInPrevMonth = prevLastDay.getDate();

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Previous month days
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const dayElement = createDayElement(day, true);
        daysContainer.appendChild(dayElement);
    }

    // Current month days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDate = new Date(currentCalendarYear, currentCalendarMonth, day);
        const dayElement = createDayElement(day, false, dayDate);
        daysContainer.appendChild(dayElement);
    }

    // Next month days
    const totalCells = daysContainer.children.length;
    const remainingCells = 42 - totalCells;
    for (let day = 1; day <= remainingCells; day++) {
        const dayElement = createDayElement(day, true);
        daysContainer.appendChild(dayElement);
    }
}

function createDayElement(day, isOtherMonth, fullDate = null) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    dayElement.textContent = day;

    if (isOtherMonth) {
        dayElement.classList.add('other-month');
        return dayElement;
    }

    if (fullDate) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (fullDate.getTime() === today.getTime()) {
            dayElement.classList.add('today');
        }

        const selectedDate = currentEditingDate === 'from' ? tempFromDate : tempToDate;
        if (selectedDate) {
            const selected = new Date(selectedDate);
            selected.setHours(0, 0, 0, 0);
            if (fullDate.getTime() === selected.getTime()) {
                dayElement.classList.add('selected');
            }
        }

        dayElement.addEventListener('click', () => selectDate(fullDate));
    }

    return dayElement;
}

function selectDate(date) {
    if (currentEditingDate === 'from') {
        tempFromDate = date;
    } else {
        tempToDate = date;
    }

    hideDateAlert();
    updateTabDisplay();
    renderCalendar();
}

function changeMonth(delta) {
    currentCalendarMonth += delta;

    if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
    } else if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
    }

    document.getElementById('calendarMonth').value = currentCalendarMonth;
    document.getElementById('calendarYear').value = currentCalendarYear;

    renderCalendar();
}

function clearAllDates() {
    tempFromDate = null;
    tempToDate = null;
    updateTabDisplay();
    renderCalendar();
}

function applyDates() {
    // Validation: At least one date must be set
    if (!tempFromDate && !tempToDate) {
        showDateAlert('Please select at least one date. You cannot apply with both dates cleared.');
        return;
    }

    // Update hidden inputs
    document.getElementById('date_from').value = tempFromDate ? formatDate(tempFromDate) : '';
    document.getElementById('date_to').value = tempToDate ? formatDate(tempToDate) : '';

    // Update display inputs
    document.getElementById('date_from_display').value = tempFromDate ? formatDisplayDate(tempFromDate) : '';
    document.getElementById('date_to_display').value = tempToDate ? formatDisplayDate(tempToDate) : '';

    // Close modal
    closeDateModal();

    // Apply server-side filters
    applyServerSideFilters();
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDateModal();
    }
});

// Close date modal on background click
document.getElementById('dateModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeDateModal();
    }
});
</script>
{% endblock %}

{% block content %}
<div class="accident-list-container">
    <!-- Loading Overlay (PNP Theme - Same as Hotspot) -->
    <div class="loading-overlay">
        <div class="spinner-container">
            <div class="spinner-logo">
                <img src="{% static 'images/pnp-logo.png' %}" alt="PNP Logo">
            </div>
            <div class="spinner"></div>
            <div class="spinner-inner"></div>
        </div>
    </div>

    <!-- Hero Header -->
    <div class="page-hero">
        <div class="page-hero-content">
            <h1>
                <i class="fas fa-car-crash"></i>
                Accident Records
                <span class="hero-badge">{{ accidents.paginator.count }} Total</span>
            </h1>
            <p>Browse and analyze traffic accidents across Caraga Region</p>
        </div>
        <div class="hero-actions">
            <button class="btn btn-outline-light" onclick="exportToCSV()">
                <i class="fas fa-download"></i>
                Export CSV
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card">
            <h3>{{ accidents.paginator.count }}</h3>
            <p>Total Accidents</p>
        </div>
        <div class="summary-card">
            <h3>{{ fatal_count|default:0 }}</h3>
            <p>Fatal</p>
        </div>
        <div class="summary-card">
            <h3>{{ injury_count|default:0 }}</h3>
            <p>Injuries</p>
        </div>
        <div class="summary-card">
            <h3>{{ hotspot_count|default:0 }}</h3>
            <p>Hotspots</p>
        </div>
    </div>

    <!-- Enhanced Filters Section -->
    <div class="filters-section" id="search-section">
        <div class="filters-header">
            <h3>Search & Filter Accidents</h3>
            <button type="button" class="btn btn-outline btn-sm" onclick="clearAllFilters()">
                Clear All
            </button>
        </div>

        <!-- Search Bar -->
        <div style="margin-bottom: 1.25rem;">
            <label style="display: block; font-weight: 500; color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">
                Search Accidents
            </label>
            <div style="display: flex; gap: 0.5rem;">
                <div style="position: relative; flex: 1;">
                    <input type="text"
                           id="hotspotSearch"
                           placeholder="Search by location, severity, incident type, or barangay..."
                           onkeypress="if(event.key==='Enter') performSearch()">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <button onclick="performSearch()" class="btn btn-primary" style="padding: 0.75rem 1.75rem; white-space: nowrap;">
                    ðŸ” Search
                </button>
            </div>

            <!-- Quick Search Buttons -->
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.75rem;">
                <button onclick="quickSearch('Fatal')" class="quick-search-btn fatal">
                    <i class="fas fa-skull-crossbones"></i> Fatal
                </button>
                <button onclick="quickSearch('Injury')" class="quick-search-btn injury">
                    <i class="fas fa-user-injured"></i> Injury
                </button>
                <button onclick="quickSearch('Property Damage')" class="quick-search-btn property">
                    <i class="fas fa-car-crash"></i> Property Damage
                </button>
                <button onclick="quickSearch('Not Hotspot')" class="quick-search-btn standalone">
                    <i class="fas fa-circle-dot"></i> Standalone
                </button>
            </div>
        </div>

        <!-- Filter Grid -->
        <div class="filters-grid">
            <div class="filter-group">
                <label for="province">Province</label>
                <select name="province" id="province" onchange="updateMunicipalityDropdown(); applyServerSideFilters();">
                    <option value="">All Provinces</option>
                    {% for province in provinces %}
                        <option value="{{ province }}">{{ province }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="municipal">Municipality</label>
                <select name="municipal" id="municipal" onchange="applyServerSideFilters()">
                    <option value="">All Municipalities</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="year">Year</label>
                <select name="year" id="year" onchange="applyServerSideFilters()">
                    <option value="">All Years</option>
                    {% for year in years %}
                        <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="date_from">From</label>
                <input type="text" readonly class="form-control date-selector" id="date_from_display" placeholder="Start" onclick="openDateModal('from')" style="cursor: pointer; background: white; font-size: 0.85rem; padding: 0.375rem 0.5rem; border: 1.5px solid #D1D5DB; border-radius: 6px; width: 100%;">
                <input type="hidden" name="date_from" id="date_from">
            </div>

            <div class="filter-group">
                <label for="date_to">To</label>
                <input type="text" readonly class="form-control date-selector" id="date_to_display" placeholder="End" onclick="openDateModal('to')" style="cursor: pointer; background: white; font-size: 0.85rem; padding: 0.375rem 0.5rem; border: 1.5px solid #D1D5DB; border-radius: 6px; width: 100%;">
                <input type="hidden" name="date_to" id="date_to">
            </div>
        </div>

        <!-- Active Filters Display -->
        <div class="active-filters" id="activeFilters">
            <!-- Active filters displayed dynamically -->
        </div>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination-container">
        <div class="pagination-info">
            Showing {{ accidents.start_index }}-{{ accidents.end_index }} of {{ accidents.paginator.count }} accidents
        </div>
        <div class="pagination-controls">
            {% if accidents.has_previous %}
                <button onclick="navigateToPage('{{ accidents.previous_page_number }}')" class="btn btn-outline btn-sm">
                    â† Previous
                </button>
            {% else %}
                <button class="btn btn-outline btn-sm" disabled>â† Previous</button>
            {% endif %}

            <span id="pageInfo">Page {{ accidents.number }} of {{ accidents.paginator.num_pages }}</span>

            {% if accidents.has_next %}
                <button onclick="navigateToPage('{{ accidents.next_page_number }}')" class="btn btn-outline btn-sm">
                    Next â†’
                </button>
            {% else %}
                <button class="btn btn-outline btn-sm" disabled>Next â†’</button>
            {% endif %}
        </div>
        <select id="itemsPerPage" onchange="changeItemsPerPage()">
            <option value="12">12 per page</option>
            <option value="24">24 per page</option>
            <option value="48">48 per page</option>
            <option value="100">100 per page</option>
            <option value="500">500 per page</option>
        </select>
    </div>

    <!-- View Toggle -->
    <div class="view-toggle">
        <button class="view-option active" onclick="switchView('cards')">ðŸ“Š Cards View</button>
        <button class="view-option" onclick="switchView('table')">ðŸ“‹ Table View</button>
    </div>

    <!-- Cards View -->
    <div id="cardsView">
        <div class="accidents-grid" id="accidentsContainer">
            {% for accident in accidents %}
            <div class="accident-card" onclick="openAccidentModal({{ accident.pk }}, '{{ accident.date_committed|date:"M d, Y" }}', '{{ accident.time_committed|time:"g:i A" }}', '{{ accident.barangay }}', '{{ accident.municipal }}', '{{ accident.province }}', '{{ accident.incident_type }}', {{ accident.victim_killed|yesno:"true,false" }}, {{ accident.victim_injured|yesno:"true,false" }}, {{ accident.is_hotspot|yesno:"true,false" }}, {{ accident.latitude }}, {{ accident.longitude }}, '{{ accident.street|default:"N/A" }}', {{ accident.victim_count|default:0 }}, '{{ accident.type_of_place|default:"Road/Highway" }}', '{{ accident.vehicle_kind|default:"Not specified" }}', '{{ accident.station|default:"Not specified" }}', '{{ accident.cluster_id|default:"-" }}')" style="cursor: pointer;">
                <div class="card-header">
                    <span class="severity-badge {% if accident.victim_killed %}fatal{% elif accident.victim_injured %}injury{% else %}property{% endif %}">
                        {% if accident.victim_killed %}
                            <i class="fas fa-skull-crossbones"></i> Fatal
                        {% elif accident.victim_injured %}
                            <i class="fas fa-user-injured"></i> Injury
                        {% else %}
                            <i class="fas fa-car"></i> Property
                        {% endif %}
                    </span>
                    {% if accident.is_hotspot %}
                    <span class="hotspot-mini-badge">
                        <i class="fas fa-fire"></i> Hotspot
                    </span>
                    {% endif %}
                </div>

                <div class="card-body">
                    <div class="card-date">
                        <i class="fas fa-calendar"></i>
                        <strong>{{ accident.date_committed|date:"M d, Y" }}</strong>
                        <span>â€¢</span>
                        <i class="fas fa-clock"></i>
                        <span>{{ accident.time_committed|time:"g:i A" }}</span>
                    </div>

                    <div class="card-location">
                        <div class="card-location-title">{{ accident.barangay }}</div>
                        <div class="card-location-sub">
                            <i class="fas fa-map-marker-alt"></i>
                            {{ accident.municipal }}, {{ accident.province }}
                        </div>
                    </div>

                    <div class="card-type">
                        <i class="fas fa-info-circle"></i>
                        {{ accident.incident_type|truncatewords:5 }}
                    </div>

                    <div class="card-actions">
                        <button class="card-action-btn btn-view" onclick="event.stopPropagation(); viewAccident({{ accident.pk }})">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="card-action-btn btn-map" onclick="event.stopPropagation(); viewOnMap({{ accident.latitude }}, {{ accident.longitude }}, {{ accident.pk }})">
                            <i class="fas fa-map"></i> Map
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state" style="grid-column: 1 / -1;">
                <i class="fas fa-search"></i>
                <h3>No accidents found</h3>
                <p>Try adjusting your filters or search criteria</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Table View -->
    <div id="tableView" class="accidents-table-container" style="display: none;">
        <div id="tableResponsive" class="table-responsive scrollable">
            <table class="accidents-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">Severity</th>
                        <th style="width: 15%;">Date & Time</th>
                        <th style="width: 25%;">Location</th>
                        <th style="width: 20%;">Incident Type</th>
                        <th style="width: 10%;" class="text-center">Casualties</th>
                        <th style="width: 10%;" class="text-center">Hotspot</th>
                        <th style="width: 15%;" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for accident in accidents %}
                    <tr onclick="viewAccident({{ accident.pk }})">
                        <td>
                            <span class="severity-dot {% if accident.victim_killed %}fatal{% elif accident.victim_injured %}injury{% else %}property{% endif %}"></span>
                        </td>
                        <td>
                            <div style="font-weight: 600;">{{ accident.date_committed|date:"M d, Y" }}</div>
                            <small style="color: #666;">{{ accident.time_committed|time:"g:i A" }}</small>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #333;">{{ accident.barangay }}</div>
                            <small style="color: #666;">{{ accident.municipal }}, {{ accident.province }}</small>
                        </td>
                        <td>
                            <span style="font-size: 0.9rem;">{{ accident.incident_type|truncatewords:4 }}</span>
                        </td>
                        <td class="text-center">
                            <span style="font-weight: 700; color: {% if accident.victim_killed %}var(--fatal-red){% elif accident.victim_injured %}var(--injury-orange){% else %}#6c757d{% endif %}">
                                {{ accident.victim_count|default:0 }}
                            </span>
                        </td>
                        <td class="text-center">
                            {% if accident.is_hotspot %}
                            <i class="fas fa-fire" style="color: var(--hotspot-red);"></i>
                            {% else %}
                            <span style="color: #ccc;">â€”</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="table-actions" onclick="event.stopPropagation()">
                                <button class="table-action-btn view" onclick="viewAccident({{ accident.pk }})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="table-action-btn map" onclick="viewOnMap({{ accident.latitude }}, {{ accident.longitude }})">
                                    <i class="fas fa-map"></i> Map
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <h3>No accidents found</h3>
                                <p>Try adjusting your filters or search criteria</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Accident Details Modal -->
<div id="accidentModal" class="accident-modal">
    <div class="modal-overlay" onclick="closeAccidentModal()"></div>
    <div class="modal-content">
        <button class="modal-close" onclick="closeAccidentModal()">
            <i class="fas fa-times"></i>
        </button>

        <div class="modal-header">
            <h2 id="modalTitle">Accident Details</h2>
            <div id="modalBadges" class="modal-badges"></div>
        </div>

        <div class="modal-body">
            <div class="modal-info-grid">
                <div class="modal-info-item">
                    <i class="fas fa-calendar"></i>
                    <div>
                        <div class="modal-label">Date</div>
                        <div class="modal-value" id="modalDate"></div>
                    </div>
                </div>

                <div class="modal-info-item">
                    <i class="fas fa-clock"></i>
                    <div>
                        <div class="modal-label">Time</div>
                        <div class="modal-value" id="modalTime"></div>
                    </div>
                </div>

                <div class="modal-info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <div>
                        <div class="modal-label">Location</div>
                        <div class="modal-value" id="modalLocation"></div>
                    </div>
                </div>

                <div class="modal-info-item">
                    <i class="fas fa-road"></i>
                    <div>
                        <div class="modal-label">Street</div>
                        <div class="modal-value" id="modalStreet"></div>
                    </div>
                </div>

                <div class="modal-info-item">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <div class="modal-label">Incident Type</div>
                        <div class="modal-value" id="modalIncidentType"></div>
                    </div>
                </div>

                <div class="modal-info-item">
                    <i class="fas fa-users"></i>
                    <div>
                        <div class="modal-label">Victims</div>
                        <div class="modal-value" id="modalVictims"></div>
                    </div>
                </div>

                <div class="modal-info-item">
                    <i class="fas fa-building"></i>
                    <div>
                        <div class="modal-label">Place Type</div>
                        <div class="modal-value" id="modalPlaceType"></div>
                    </div>
                </div>

                <div class="modal-info-item">
                    <i class="fas fa-car"></i>
                    <div>
                        <div class="modal-label">Vehicle(s)</div>
                        <div class="modal-value" id="modalVehicle"></div>
                    </div>
                </div>

                <div class="modal-info-item">
                    <i class="fas fa-shield-alt"></i>
                    <div>
                        <div class="modal-label">Police Station</div>
                        <div class="modal-value" id="modalStation"></div>
                    </div>
                </div>

                <div class="modal-info-item">
                    <i class="fas fa-layer-group"></i>
                    <div>
                        <div class="modal-label">Cluster ID</div>
                        <div class="modal-value" id="modalCluster"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="modal-btn btn-map" id="modalMapBtn">
                <i class="fas fa-map-marked-alt"></i> View on Map
            </button>
            <button class="modal-btn btn-detail" id="modalDetailBtn">
                <i class="fas fa-file-alt"></i> View Details
            </button>
        </div>
    </div>
</div>

<!-- Date Selection Modal (must be outside container) -->
<div class="chart-modal" id="dateModal">
    <div class="chart-modal-content">
        <div class="chart-modal-header">
            <h3>ðŸ“… Select Date Range</h3>
            <button class="chart-modal-close" onclick="closeDateModal()">Ã—</button>
        </div>
        <div class="date-modal-body">
            <!-- Date Range Tabs -->
            <div class="date-range-tabs">
                <button class="date-tab active" onclick="switchDateTab('from')" id="fromTab">
                    <span class="tab-label">From Date</span>
                    <span class="tab-value" id="fromTabValue">Not set</span>
                </button>
                <button class="date-tab" onclick="switchDateTab('to')" id="toTab">
                    <span class="tab-label">To Date</span>
                    <span class="tab-value" id="toTabValue">Not set</span>
                </button>
            </div>

            <!-- Mini Alert (hidden by default) -->
            <div class="date-modal-alert" id="dateModalAlert" style="display: none;">
                <div class="alert-icon">âš ï¸</div>
                <div class="alert-message" id="dateAlertMessage"></div>
            </div>

            <!-- Calendar Container -->
            <div class="calendar-container">
                <!-- Calendar Header (Month/Year Selector) -->
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeMonth(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="calendar-title">
                        <select id="calendarMonth" class="calendar-select" onchange="updateCalendarDate()">
                            <option value="0">January</option>
                            <option value="1">February</option>
                            <option value="2">March</option>
                            <option value="3">April</option>
                            <option value="4">May</option>
                            <option value="5">June</option>
                            <option value="6">July</option>
                            <option value="7">August</option>
                            <option value="8">September</option>
                            <option value="9">October</option>
                            <option value="10">November</option>
                            <option value="11">December</option>
                        </select>
                        <select id="calendarYear" class="calendar-select" onchange="updateCalendarDate()">
                            <!-- Years will be populated by JavaScript -->
                        </select>
                    </div>
                    <button class="calendar-nav" onclick="changeMonth(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-weekdays">
                    <div class="weekday">Su</div>
                    <div class="weekday">Mo</div>
                    <div class="weekday">Tu</div>
                    <div class="weekday">We</div>
                    <div class="weekday">Th</div>
                    <div class="weekday">Fr</div>
                    <div class="weekday">Sa</div>
                </div>
                <div class="calendar-days" id="calendarDays">
                    <!-- Days will be populated by JavaScript -->
                </div>
            </div>

            <!-- Modal Actions -->
            <div class="date-modal-actions">
                <button class="btn btn-outline" onclick="clearAllDates()">
                    <i class="fas fa-eraser"></i> Clear All
                </button>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-outline" onclick="closeDateModal()">
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="applyDates()">
                        <i class="fas fa-check"></i> Apply
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}