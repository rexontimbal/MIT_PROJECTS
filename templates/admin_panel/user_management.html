{% extends 'admin_panel/base.html' %}

{% block title %}User Management{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="admin-page-header">
    <div>
        <h1 class="admin-page-title">
            <i class="fas fa-users"></i>
            User Management
        </h1>
        <div class="admin-breadcrumb">
            <a href="{% url 'admin_panel:dashboard' %}"><i class="fas fa-tachometer-alt"></i> Admin</a>
            <span>/</span>
            <span>Users</span>
        </div>
    </div>
    <a href="{% url 'admin_panel:user_create' %}" class="btn btn-primary">
        <i class="fas fa-user-plus"></i>
        Create New User
    </a>
</div>

<!-- Messages (handled by notification system in base.html) -->
{% if messages %}
    <div style="display: none;">
    {% for message in messages %}
        <!-- {{ message.tags }}: {{ message }} -->
    {% endfor %}
    </div>
{% endif %}

<!-- Filters Card -->
<div class="admin-card" style="margin-bottom: 1.5rem;">
    <form method="get" action="">
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="search">Search Users</label>
                <input type="text" name="search" id="search" class="form-control" placeholder="Username, name, email, badge..." value="{{ search_query }}">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="role">Filter by Role</label>
                <select name="role" id="role" class="form-control">
                    <option value="">All Roles</option>
                    {% for value, label in roles %}
                    <option value="{{ value }}" {% if role_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="status">Filter by Status</label>
                <select name="status" id="status" class="form-control">
                    <option value="">All Status</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                    <option value="staff" {% if status_filter == 'staff' %}selected{% endif %}>Staff</option>
                    <option value="superuser" {% if status_filter == 'superuser' %}selected{% endif %}>Superuser</option>
                </select>
            </div>

            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                <a href="{% url 'admin_panel:users' %}" class="btn btn-secondary">
                    <i class="fas fa-redo"></i>
                    Reset
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Results Summary -->
<div style="margin-bottom: 1rem; color: var(--text-light);">
    <i class="fas fa-info-circle"></i>
    Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ total_count }} user{{ total_count|pluralize }}
</div>

<!-- Users Table -->
<div class="admin-table-container">
    <table class="admin-table">
        <thead>
            <tr>
                <th style="width: 60px;">Photo</th>
                <th>Username</th>
                <th>Name</th>
                <th>Badge</th>
                <th>Rank</th>
                <th>Role</th>
                <th>Station</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in page_obj %}
            <tr>
                <td>
                    {% if user.profile and user.profile.profile_picture %}
                    <img src="{{ user.profile.profile_picture.url }}" alt="{{ user.username }}"
                         style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid var(--primary-blue);">
                    {% else %}
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-blue); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;">
                        {{ user.username|first|upper }}
                    </div>
                    {% endif %}
                </td>
                <td>
                    <strong>{{ user.username }}</strong>
                    <br>
                    <small style="color: var(--text-light);">{{ user.email|default:"No email" }}</small>
                </td>
                <td>{{ user.get_full_name|default:"-" }}</td>
                <td>
                    {% if user.profile %}
                    <span class="badge badge-secondary">{{ user.profile.badge_number|default:"-" }}</span>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if user.profile %}
                    {{ user.profile.get_rank_display }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if user.profile and user.profile.role %}
                        {% if user.profile.role == 'super_admin' %}
                        <span class="badge badge-superadmin"><i class="fas fa-crown"></i> Super Admin</span>
                        {% elif user.profile.role == 'regional_director' %}
                        <span class="badge badge-primary"><i class="fas fa-user-tie"></i> Regional Director</span>
                        {% elif user.profile.role == 'provincial_chief' %}
                        <span class="badge badge-teal"><i class="fas fa-user-shield"></i> Provincial Chief</span>
                        {% elif user.profile.role == 'station_commander' %}
                        <span class="badge badge-bluegray"><i class="fas fa-user-cog"></i> Station Commander</span>
                        {% elif user.profile.role == 'traffic_officer' %}
                        <span class="badge badge-secondary"><i class="fas fa-traffic-light"></i> Traffic Officer</span>
                        {% elif user.profile.role == 'data_encoder' %}
                        <span class="badge badge-secondary"><i class="fas fa-keyboard"></i> Data Encoder</span>
                        {% endif %}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if user.profile %}
                    {{ user.profile.station|default:"-" }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if user.is_active %}
                    <span class="badge badge-success" id="status-badge-{{ user.id }}"><i class="fas fa-check-circle"></i> Active</span>
                    {% else %}
                    <span class="badge badge-danger" id="status-badge-{{ user.id }}"><i class="fas fa-times-circle"></i> Inactive</span>
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="{% url 'admin_panel:user_detail' user.id %}" class="btn btn-sm btn-primary" title="View/Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button
                            onclick="toggleUserActive({{ user.id }}, '{{ user.username }}', {{ user.is_active|lower }})"
                            class="btn btn-sm {% if user.is_active %}btn-danger{% else %}btn-success{% endif %}"
                            title="{% if user.is_active %}Deactivate{% else %}Activate{% endif %}"
                            id="toggle-btn-{{ user.id }}">
                            <i class="fas {% if user.is_active %}fa-ban{% else %}fa-check{% endif %}"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-light);">
                    <i class="fas fa-users" style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 0.5rem;"></i>
                    No users found
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="pagination">
    {% if page_obj.has_previous %}
    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
        <i class="fas fa-angle-double-left"></i>
    </a>
    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
        <i class="fas fa-angle-left"></i>
    </a>
    {% endif %}

    <span class="current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
        <i class="fas fa-angle-right"></i>
    </a>
    <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
        <i class="fas fa-angle-double-right"></i>
    </a>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<style>
/* Confirmation Modal Styles */
.confirm-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 80px;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.confirm-modal-overlay.show {
    opacity: 1;
}

.confirm-modal {
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 450px;
    width: 90%;
    transform: translateY(-30px);
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    overflow: hidden;
}

.confirm-modal-overlay.show .confirm-modal {
    transform: translateY(0);
}

.confirm-modal-header {
    padding: 24px;
    background: linear-gradient(135deg, #003087 0%, #0047AB 100%);
    color: white;
    display: flex;
    align-items: center;
    gap: 12px;
}

.confirm-modal-header i {
    font-size: 24px;
}

.confirm-modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.confirm-modal-body {
    padding: 24px;
}

.confirm-modal-body p {
    margin: 0 0 8px 0;
    color: #374151;
    font-size: 15px;
    line-height: 1.6;
}

.confirm-modal-user {
    background: #F3F4F6;
    padding: 12px 16px;
    border-radius: 8px;
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.confirm-modal-user i {
    color: #003087;
    font-size: 18px;
}

.confirm-modal-user strong {
    color: #003087;
    font-size: 16px;
}

.confirm-modal-footer {
    padding: 16px 24px;
    background: #F9FAFB;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    border-top: 1px solid #E5E7EB;
}

.confirm-modal-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.confirm-modal-btn-cancel {
    background: white;
    color: #6B7280;
    border: 1px solid #D1D5DB;
}

.confirm-modal-btn-cancel:hover {
    background: #F9FAFB;
    border-color: #9CA3AF;
}

.confirm-modal-btn-confirm {
    background: #EF4444;
    color: white;
}

.confirm-modal-btn-confirm:hover {
    background: #DC2626;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.confirm-modal-btn-confirm.activate {
    background: #10B981;
}

.confirm-modal-btn-confirm.activate:hover {
    background: #059669;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

/* Center Notification Styles */
.center-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    z-index: 10001;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 15px;
    font-weight: 500;
    min-width: 320px;
    max-width: 500px;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.center-notification.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

.center-notification.success {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    color: white;
}

.center-notification.warning {
    background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    color: white;
}

.center-notification.error {
    background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
    color: white;
}

.center-notification i {
    font-size: 20px;
}

.center-notification-content {
    flex: 1;
}
</style>

<script>
// Custom centered notification
function showCenterNotification(message, type = 'success', duration = 4000) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `center-notification ${type}`;

    const icons = {
        success: 'fa-check-circle',
        warning: 'fa-exclamation-circle',
        error: 'fa-times-circle'
    };

    notification.innerHTML = `
        <i class="fas ${icons[type]}"></i>
        <div class="center-notification-content">${message}</div>
    `;

    document.body.appendChild(notification);

    // Animate in
    requestAnimationFrame(() => {
        notification.classList.add('show');
    });

    // Auto remove after duration
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.remove();
        }, 400);
    }, duration);
}

// Custom confirmation modal
function showConfirmModal(options) {
    return new Promise((resolve) => {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'confirm-modal-overlay';

        // Create modal
        const modal = document.createElement('div');
        modal.className = 'confirm-modal';

        const actionClass = options.isActivate ? 'activate' : '';
        const actionIcon = options.isActivate ? 'fa-check-circle' : 'fa-exclamation-triangle';

        modal.innerHTML = `
            <div class="confirm-modal-header">
                <i class="fas ${actionIcon}"></i>
                <h3>${options.title}</h3>
            </div>
            <div class="confirm-modal-body">
                <p>${options.message}</p>
                <div class="confirm-modal-user">
                    <i class="fas fa-user-circle"></i>
                    <strong>${options.username}</strong>
                </div>
            </div>
            <div class="confirm-modal-footer">
                <button class="confirm-modal-btn confirm-modal-btn-cancel" onclick="closeConfirmModal(false)">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button class="confirm-modal-btn confirm-modal-btn-confirm ${actionClass}" onclick="closeConfirmModal(true)">
                    <i class="fas ${options.isActivate ? 'fa-check' : 'fa-ban'}"></i>
                    ${options.confirmText}
                </button>
            </div>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Animate in
        requestAnimationFrame(() => {
            overlay.classList.add('show');
        });

        // Store resolve function globally
        window.confirmModalResolve = resolve;

        // Close on overlay click
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeConfirmModal(false);
            }
        });
    });
}

function closeConfirmModal(confirmed) {
    const overlay = document.querySelector('.confirm-modal-overlay');
    if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => {
            overlay.remove();
            if (window.confirmModalResolve) {
                window.confirmModalResolve(confirmed);
                window.confirmModalResolve = null;
            }
        }, 300);
    }
}

async function toggleUserActive(userId, username, isActive) {
    const action = isActive ? 'deactivate' : 'activate';
    const actionTitle = isActive ? 'Deactivate User' : 'Activate User';
    const actionMessage = isActive
        ? 'This will prevent the user from logging in and accessing the system.'
        : 'This will allow the user to log in and access the system.';

    const confirmed = await showConfirmModal({
        title: actionTitle,
        message: actionMessage,
        username: username,
        confirmText: action.charAt(0).toUpperCase() + action.slice(1),
        isActivate: !isActive
    });

    if (!confirmed) {
        return;
    }

    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                     document.querySelector('[name=csrf-token]')?.content;

    fetch(`/admin-panel/users/${userId}/toggle-active/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update button
            const btn = document.getElementById(`toggle-btn-${userId}`);
            const statusBadge = document.getElementById(`status-badge-${userId}`);
            const newIsActive = data.is_active;

            if (btn) {
                if (newIsActive) {
                    // Active - show red deactivate button
                    btn.className = 'btn btn-sm btn-danger';
                    btn.title = 'Deactivate';
                    btn.innerHTML = '<i class="fas fa-ban"></i>';
                } else {
                    // Inactive - show green activate button
                    btn.className = 'btn btn-sm btn-success';
                    btn.title = 'Activate';
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                }

                // Update the onclick to reflect new state
                btn.setAttribute('onclick', `toggleUserActive(${userId}, '${username}', ${newIsActive})`);
            }

            if (statusBadge) {
                if (newIsActive) {
                    statusBadge.className = 'badge badge-success';
                    statusBadge.innerHTML = '<i class="fas fa-check-circle"></i> Active';
                } else {
                    statusBadge.className = 'badge badge-danger';
                    statusBadge.innerHTML = '<i class="fas fa-times-circle"></i> Inactive';
                }
            }

            // Show beautiful centered notification
            const status = newIsActive ? 'activated' : 'deactivated';
            showCenterNotification(
                `User "${username}" ${status} successfully!`,
                newIsActive ? 'success' : 'warning',
                4000
            );
        } else {
            showCenterNotification(
                data.error || 'Failed to update user status',
                'error',
                5000
            );
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showCenterNotification(
            'An error occurred while updating user status',
            'error',
            5000
        );
    });
}
</script>
{% endblock %}
