{% extends 'admin_panel/base.html' %}

{% block title %}User Management{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="admin-page-header">
    <div>
        <h1 class="admin-page-title">
            <i class="fas fa-users"></i>
            User Management
        </h1>
        <div class="admin-breadcrumb">
            <a href="{% url 'admin_panel:dashboard' %}"><i class="fas fa-tachometer-alt"></i> Admin</a>
            <span>/</span>
            <span>Users</span>
        </div>
    </div>
    <a href="{% url 'admin_panel:user_create' %}" class="btn btn-primary">
        <i class="fas fa-user-plus"></i>
        Create New User
    </a>
</div>

<!-- Messages -->
{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        <i class="fas fa-info-circle"></i>
        {{ message }}
    </div>
    {% endfor %}
{% endif %}

<!-- Filters Card -->
<div class="admin-card" style="margin-bottom: 1.5rem;">
    <form method="get" action="">
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="search">Search Users</label>
                <input type="text" name="search" id="search" class="form-control" placeholder="Username, name, email, badge..." value="{{ search_query }}">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="role">Filter by Role</label>
                <select name="role" id="role" class="form-control">
                    <option value="">All Roles</option>
                    {% for value, label in roles %}
                    <option value="{{ value }}" {% if role_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="status">Filter by Status</label>
                <select name="status" id="status" class="form-control">
                    <option value="">All Status</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                    <option value="staff" {% if status_filter == 'staff' %}selected{% endif %}>Staff</option>
                    <option value="superuser" {% if status_filter == 'superuser' %}selected{% endif %}>Superuser</option>
                </select>
            </div>

            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                <a href="{% url 'admin_panel:users' %}" class="btn btn-secondary">
                    <i class="fas fa-redo"></i>
                    Reset
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Results Summary -->
<div style="margin-bottom: 1rem; color: var(--text-light);">
    <i class="fas fa-info-circle"></i>
    Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ total_count }} user{{ total_count|pluralize }}
</div>

<!-- Users Table -->
<div class="admin-table-container">
    <table class="admin-table">
        <thead>
            <tr>
                <th>Username</th>
                <th>Name</th>
                <th>Badge</th>
                <th>Rank</th>
                <th>Role</th>
                <th>Station</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in page_obj %}
            <tr>
                <td>
                    <strong>{{ user.username }}</strong>
                    <br>
                    <small style="color: var(--text-light);">{{ user.email|default:"No email" }}</small>
                </td>
                <td>{{ user.get_full_name|default:"-" }}</td>
                <td>
                    {% if user.profile %}
                    <span class="badge badge-secondary">{{ user.profile.badge_number|default:"-" }}</span>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if user.profile %}
                    {{ user.profile.get_rank_display }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if user.profile %}
                    <span class="badge badge-info">{{ user.profile.get_role_display }}</span>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if user.profile %}
                    {{ user.profile.station|default:"-" }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                        {% if user.is_active %}
                        <span class="badge badge-success"><i class="fas fa-check-circle"></i> Active</span>
                        {% else %}
                        <span class="badge badge-danger"><i class="fas fa-times-circle"></i> Inactive</span>
                        {% endif %}

                        {% if user.is_superuser %}
                        <span class="badge badge-danger"><i class="fas fa-crown"></i> Superuser</span>
                        {% elif user.is_staff %}
                        <span class="badge badge-warning"><i class="fas fa-user-shield"></i> Staff</span>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="{% url 'admin_panel:user_detail' user.id %}" class="btn btn-sm btn-primary" title="View/Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button
                            onclick="toggleUserActive({{ user.id }}, '{{ user.username }}', {{ user.is_active|lower }})"
                            class="btn btn-sm {% if user.is_active %}btn-danger{% else %}btn-success{% endif %}"
                            title="{% if user.is_active %}Deactivate{% else %}Activate{% endif %}"
                            id="toggle-btn-{{ user.id }}">
                            <i class="fas {% if user.is_active %}fa-ban{% else %}fa-check{% endif %}"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-light);">
                    <i class="fas fa-users" style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 0.5rem;"></i>
                    No users found
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="pagination">
    {% if page_obj.has_previous %}
    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
        <i class="fas fa-angle-double-left"></i>
    </a>
    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
        <i class="fas fa-angle-left"></i>
    </a>
    {% endif %}

    <span class="current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
        <i class="fas fa-angle-right"></i>
    </a>
    <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
        <i class="fas fa-angle-double-right"></i>
    </a>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
function toggleUserActive(userId, username, isActive) {
    const action = isActive ? 'deactivate' : 'activate';
    const confirmMsg = `Are you sure you want to ${action} user "${username}"?`;

    if (!confirm(confirmMsg)) {
        return;
    }

    fetch(`/admin-panel/users/${userId}/toggle-active/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}
</script>
{% endblock %}
