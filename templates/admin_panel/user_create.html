{% extends 'admin_panel/base.html' %}

{% block title %}Create New User{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="admin-page-header">
    <div>
        <h1 class="admin-page-title">
            <i class="fas fa-user-plus"></i>
            Create New User
        </h1>
        <div class="admin-breadcrumb">
            <a href="{% url 'admin_panel:dashboard' %}"><i class="fas fa-tachometer-alt"></i> Admin</a>
            <span>/</span>
            <a href="{% url 'admin_panel:users' %}">Users</a>
            <span>/</span>
            <span>Create</span>
        </div>
    </div>
    <a href="{% url 'admin_panel:users' %}" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i>
        Back to Users
    </a>
</div>

<!-- Messages (handled by notification system in base.html) -->
{% if messages %}
    <div style="display: none;">
    {% for message in messages %}
        <!-- {{ message.tags }}: {{ message }} -->
    {% endfor %}
    </div>
{% endif %}

<div style="max-width: 900px; margin: 0 auto;">
    <form method="post" enctype="multipart/form-data" onsubmit="return validateForm()">
        {% csrf_token %}

        <!-- Account Details -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-user"></i>
                    Account Details
                </h2>
            </div>

            <div class="form-group">
                <label class="form-label" for="username">Username <span style="color: var(--accent-red);">*</span></label>
                <input type="text" name="username" id="username" class="form-control" required>
                <small style="color: var(--text-light);">Must be unique. Letters, digits, and @/./+/-/_ only.</small>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label" for="password">Password <span style="color: var(--accent-red);">*</span></label>
                    <input type="password" name="password" id="password" class="form-control" required minlength="8">
                    <small style="color: var(--text-light);">At least 8 characters long.</small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirm_password">Confirm Password <span style="color: var(--accent-red);">*</span></label>
                    <input type="password" name="confirm_password" id="confirm_password" class="form-control" required minlength="8">
                    <small style="color: var(--text-light);">Re-type the password.</small>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label" for="first_name">First Name <span style="color: var(--accent-red);">*</span></label>
                    <input type="text" name="first_name" id="first_name" class="form-control" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="last_name">Last Name <span style="color: var(--accent-red);">*</span></label>
                    <input type="text" name="last_name" id="last_name" class="form-control" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="email">Email Address</label>
                <input type="email" name="email" id="email" class="form-control">
            </div>

            <div class="form-group">
                <label class="form-label" for="profile_picture">Profile Picture</label>

                <!-- Modern Drag & Drop Area -->
                <div id="profilePictureUpload" style="
                    border: 2px dashed var(--border-color);
                    border-radius: 16px;
                    padding: 2rem;
                    text-align: center;
                    background: var(--gray-50);
                    transition: all 0.3s ease;
                    cursor: pointer;
                    position: relative;
                    overflow: hidden;
                "
                onclick="document.getElementById('profile_picture').click()"
                ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)"
                ondrop="handleDrop(event)">

                    <!-- Empty State -->
                    <div id="emptyState">
                        <div style="
                            width: 80px;
                            height: 80px;
                            margin: 0 auto 1rem;
                            background: linear-gradient(135deg, #003087 0%, #0047BB 100%);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 8px 16px rgba(0, 48, 135, 0.2);
                        ">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: white;"></i>
                        </div>
                        <p style="margin: 0; font-weight: 600; font-size: 1.125rem; color: var(--text-dark);">Upload Profile Picture</p>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Click to browse or drag and drop</p>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--text-light);">JPG, PNG • Max 5MB</p>
                    </div>

                    <!-- Hidden File Input -->
                    <input type="file"
                           name="profile_picture"
                           id="profile_picture"
                           class="form-control"
                           accept="image/*"
                           onchange="previewProfilePicture(event)"
                           style="display: none;">
                </div>

                <!-- New Picture Preview -->
                <div id="image-preview" style="
                    margin-top: 1rem;
                    display: none;
                    padding: 1.5rem;
                    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%);
                    border: 2px solid rgba(16, 185, 129, 0.3);
                    border-radius: 12px;
                    text-align: center;
                ">
                    <p style="
                        margin: 0 0 1rem 0;
                        font-weight: 600;
                        color: #065f46;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 0.5rem;
                    ">
                        <i class="fas fa-check-circle"></i>
                        New Picture Selected
                    </p>
                    <img id="preview-img" style="
                        width: 120px;
                        height: 120px;
                        object-fit: cover;
                        border-radius: 50%;
                        border: 4px solid white;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        margin-bottom: 1rem;
                    ">
                    <p style="margin: 0; font-size: 0.875rem; color: #065f46;">
                        Click "Create User" to upload this picture
                    </p>
                </div>
            </div>
        </div>

        <!-- PNP Profile -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-shield-alt"></i>
                    PNP Profile
                </h2>
            </div>

            <div class="form-group">
                <label class="form-label" for="badge_number">Badge Number <span style="color: var(--accent-red);">*</span></label>
                <input type="text" name="badge_number" id="badge_number" class="form-control" required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label" for="rank">Rank <span style="color: var(--accent-red);">*</span></label>
                    <select name="rank" id="rank" class="form-control" required>
                        {% for value, label in ranks %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="role">Role <span style="color: var(--accent-red);">*</span></label>
                    <select name="role" id="role" class="form-control" required>
                        {% for value, label in roles %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label" for="region">Region <span style="color: var(--accent-red);">*</span></label>
                    <input type="text" name="region" id="region" class="form-control" value="Caraga" readonly style="background: #f5f5f5;">
                </div>

                <div class="form-group">
                    <label class="form-label" for="province">Province <span style="color: var(--accent-red);">*</span></label>
                    <select name="province" id="province" class="form-control" required onchange="updateStations()">
                        <option value="">-- Select Province --</option>
                        <option value="Agusan del Norte">Agusan del Norte</option>
                        <option value="Agusan del Sur">Agusan del Sur</option>
                        <option value="Butuan City">Butuan City</option>
                        <option value="Dinagat Islands">Dinagat Islands</option>
                        <option value="Surigao del Norte">Surigao del Norte</option>
                        <option value="Surigao del Sur">Surigao del Sur</option>
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label" for="station">Station <span style="color: var(--accent-red);">*</span></label>
                    <select name="station" id="station" class="form-control" required>
                        <option value="">-- Select Province First --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="unit">Unit</label>
                    <input type="text" name="unit" id="unit" class="form-control" placeholder="e.g., Traffic Management Unit">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label" for="mobile_number">
                        Mobile Number
                        <small style="color: var(--text-light); font-weight: 400;">(Format: 63+XXXXXXXXXX)</small>
                    </label>
                    <input type="text"
                           name="mobile_number"
                           id="mobile_number"
                           class="form-control"
                           placeholder="63+9XXXXXXXXX"
                           maxlength="13">
                </div>

                <div class="form-group">
                    <label class="form-label" for="phone_number">
                        Phone Number
                        <small style="color: var(--text-light); font-weight: 400;">(Format: 63+XXXXXXXXXX)</small>
                    </label>
                    <input type="text"
                           name="phone_number"
                           id="phone_number"
                           class="form-control"
                           placeholder="63+9XXXXXXXXX"
                           maxlength="13">
                </div>
            </div>
        </div>

        <!-- Permissions Info -->
        <div class="admin-card" style="background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%); border-left: 4px solid #003087;">
            <div style="display: flex; align-items: start; gap: 1rem;">
                <i class="fas fa-info-circle" style="font-size: 24px; color: #003087; margin-top: 2px;"></i>
                <div>
                    <h3 style="margin: 0 0 0.5rem 0; color: #003087; font-size: 16px; font-weight: 600;">
                        <i class="fas fa-shield-alt"></i> Role-Based Access Control
                    </h3>
                    <p style="margin: 0; color: #374151; line-height: 1.6;">
                        Permissions are automatically assigned based on the selected <strong>Role</strong>:
                    </p>
                    <ul style="margin: 0.75rem 0 0 0; padding-left: 1.5rem; color: #374151; line-height: 1.8;">
                        <li><strong style="color: #003087;">Super Admin</strong> → Full access to Django Admin and Admin Panel</li>
                        <li><strong style="color: #0047AB;">Regional Director</strong> → Access to Admin Panel only</li>
                        <li><strong style="color: #6B7280;">Other Roles</strong> → View profile only</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <a href="{% url 'admin_panel:users' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </a>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-user-plus"></i>
                Create User
            </button>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Caraga Region Police Stations Database (Real PNP Data)
const stationsByProvince = {
    'Agusan del Norte': [
        'Santiago MPS',
        'Las Nieves MPS',
        'Remedios T Romualdes MPS',
        'Buenavista MPS',
        'Jabonga MPS',
        'Cabadbaran City PS',
        'Tubay MPS',
        'Kitcharao MPS',
        'Magallanes MPS',
        'Nasipit MPS',
        'Carmen MPS'
    ],
    'Agusan del Sur': [
        'Bayugan CPS',
        'Prosperidad MPS',
        'San Francisco MPS',
        'Rosario MPS',
        'La Paz MPS',
        'Bunawan MPS',
        'Veruela MPS',
        'Loreto MPS',
        'Sibagat MPS',
        'San Luis MPS',
        'Esperanza MPS',
        'Talacogon MPS',
        'Sta Josefa MPS'
    ],
    'Butuan City': [
        'Butuan City PS 1',
        'Butuan City PS 2',
        'Butuan City PS 3',
        'Butuan City PS 4',
        'Butuan City PS 5'
    ],
    'Dinagat Islands': [
        'San Jose MPS',
        'Libjo MPS',
        'Dinagat MPS',
        'Loreto MPS',
        'Basilisa MPS',
        'Tubajon MPS'
    ],
    'Surigao del Norte': [
        'Placer MPS',
        'Gen. Luna MPS',
        'Sison MPS',
        'Surigao City PS',
        'Mainit MPS',
        'Gigaquit MPS',
        'Malimono MPS',
        'Claver MPS',
        'Bacuag MPS',
        'Taganaan MPS',
        'Dapa MPS',
        'Alegria MPS',
        'Del Carmen MPS',
        'Sta. Monica MPS',
        'Tubod MPS',
        'San Isidro MPS',
        'Burgos MPS',
        'Socorro MPS',
        'San Francisco MPS',
        'Pilar MPS',
        'San Benito MPS'
    ],
    'Surigao del Sur': [
        'Bislig City PS',
        'Hinatuan MPS',
        'Lingig MPS',
        'Tago MPS',
        'Lianga MPS',
        'Tandag City PS',
        'Barobo MPS',
        'Cortes MPS',
        'Lanuza MPS',
        'Cantilan MPS',
        'Tagbina MPS',
        'Marihatag MPS',
        'Carascal MPS',
        'San Agustin MPS',
        'Madrid MPS',
        'Bayabas MPS',
        'San Miguel MPS',
        'Carmen MPS'
    ]
};

// Update stations dropdown based on selected province
function updateStations() {
    const provinceSelect = document.getElementById('province');
    const stationSelect = document.getElementById('station');
    const selectedProvince = provinceSelect.value;

    // Clear current options
    stationSelect.innerHTML = '<option value="">-- Select Station --</option>';

    if (selectedProvince && stationsByProvince[selectedProvince]) {
        // Add stations for selected province
        stationsByProvince[selectedProvince].forEach(station => {
            const option = document.createElement('option');
            option.value = station;
            option.textContent = station;
            stationSelect.appendChild(option);
        });
    } else {
        stationSelect.innerHTML = '<option value="">-- Select Province First --</option>';
    }
}

// Password validation
function validateForm() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;

    if (password !== confirmPassword) {
        alert('Passwords do not match! Please make sure both password fields are identical.');
        document.getElementById('confirm_password').focus();
        return false;
    }

    if (password.length < 8) {
        alert('Password must be at least 8 characters long!');
        document.getElementById('password').focus();
        return false;
    }

    return true;
}

// Visual feedback for password matching
document.addEventListener('DOMContentLoaded', function() {
    const password = document.getElementById('password');
    const confirmPassword = document.getElementById('confirm_password');

    function checkPasswordMatch() {
        if (confirmPassword.value === '') {
            confirmPassword.style.borderColor = '';
            return;
        }

        if (password.value === confirmPassword.value) {
            confirmPassword.style.borderColor = '#28a745';
            confirmPassword.style.borderWidth = '2px';
        } else {
            confirmPassword.style.borderColor = '#dc3545';
            confirmPassword.style.borderWidth = '2px';
        }
    }

    password.addEventListener('input', checkPasswordMatch);
    confirmPassword.addEventListener('input', checkPasswordMatch);
});

// =========================================
// DRAG & DROP HANDLERS
// =========================================
function handleDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    const uploadArea = document.getElementById('profilePictureUpload');
    uploadArea.style.borderColor = '#003087';
    uploadArea.style.background = 'rgba(0, 48, 135, 0.05)';
    uploadArea.style.transform = 'scale(1.02)';
}

function handleDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    const uploadArea = document.getElementById('profilePictureUpload');
    uploadArea.style.borderColor = 'var(--border-color)';
    uploadArea.style.background = 'var(--gray-50)';
    uploadArea.style.transform = 'scale(1)';
}

function handleDrop(event) {
    event.preventDefault();
    event.stopPropagation();

    const uploadArea = document.getElementById('profilePictureUpload');
    uploadArea.style.borderColor = 'var(--border-color)';
    uploadArea.style.background = 'var(--gray-50)';
    uploadArea.style.transform = 'scale(1)';

    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const fileInput = document.getElementById('profile_picture');
        fileInput.files = files;

        // Trigger preview
        const changeEvent = new Event('change', { bubbles: true });
        fileInput.dispatchEvent(changeEvent);
    }
}

// Profile picture preview
function previewProfilePicture(event) {
    const file = event.target.files[0];
    if (file) {
        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size too large! Maximum 5MB allowed.');
            event.target.value = '';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            return;
        }

        // Check file type
        if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file!');
            event.target.value = '';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-img').src = e.target.result;
            document.getElementById('image-preview').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('image-preview').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
    }
}

// =========================================
// PHILIPPINE PHONE NUMBER FORMATTING
// =========================================
function formatPhilippineNumber(input) {
    let value = input.value;

    // Remove all non-digit characters except + at the beginning
    let digitsOnly = value.replace(/[^\d+]/g, '');

    // If user clears the field, set to '63+'
    if (!digitsOnly || digitsOnly === '') {
        input.value = '63+';
        return;
    }

    // If user types without 63+, add it
    if (!digitsOnly.startsWith('63+')) {
        if (digitsOnly.startsWith('63')) {
            // User typed 63 without +, add the +
            digitsOnly = '63+' + digitsOnly.substring(2);
        } else if (digitsOnly.startsWith('0')) {
            // User typed 0 (like 09123456789), convert to 63+9123456789
            digitsOnly = '63+' + digitsOnly.substring(1);
        } else if (digitsOnly.startsWith('+63')) {
            // User typed +63, convert to 63+
            digitsOnly = '63+' + digitsOnly.substring(3);
        } else {
            // User typed other numbers, prepend 63+
            digitsOnly = '63+' + digitsOnly;
        }
    }

    // Extract the prefix and the actual number
    let prefix = '63+';
    let numberPart = digitsOnly.substring(3); // Get everything after '63+'

    // Remove any non-digit characters from numberPart
    numberPart = numberPart.replace(/\D/g, '');

    // Limit to 10 digits after '63+'
    if (numberPart.length > 10) {
        numberPart = numberPart.substring(0, 10);
    }

    // Set the formatted value
    input.value = prefix + numberPart;
}

// Apply to mobile number field
const mobileNumberInput = document.getElementById('mobile_number');
if (mobileNumberInput) {
    // Initialize with 63+ if empty
    if (!mobileNumberInput.value || mobileNumberInput.value.trim() === '') {
        mobileNumberInput.value = '63+';
    } else {
        // Format existing value
        formatPhilippineNumber(mobileNumberInput);
    }

    // Format on input
    mobileNumberInput.addEventListener('input', function() {
        formatPhilippineNumber(this);
    });

    // Prevent deletion of '63+' prefix
    mobileNumberInput.addEventListener('keydown', function(e) {
        const cursorPos = this.selectionStart;

        // Prevent backspace/delete if cursor is at position 0-3 (within '63+')
        if ((e.key === 'Backspace' || e.key === 'Delete') && cursorPos <= 3) {
            e.preventDefault();
        }

        // Prevent cursor from moving before position 3
        setTimeout(() => {
            if (this.selectionStart < 3) {
                this.setSelectionRange(3, 3);
            }
        }, 0);
    });

    // Prevent cursor from being placed before '63+'
    mobileNumberInput.addEventListener('click', function() {
        if (this.selectionStart < 3) {
            this.setSelectionRange(3, 3);
        }
    });

    // Focus at the end when field is focused
    mobileNumberInput.addEventListener('focus', function() {
        setTimeout(() => {
            this.setSelectionRange(this.value.length, this.value.length);
        }, 0);
    });
}

// Apply to phone number field
const phoneNumberInput = document.getElementById('phone_number');
if (phoneNumberInput) {
    // Initialize with 63+ if empty
    if (!phoneNumberInput.value || phoneNumberInput.value.trim() === '') {
        phoneNumberInput.value = '63+';
    } else {
        // Format existing value
        formatPhilippineNumber(phoneNumberInput);
    }

    // Format on input
    phoneNumberInput.addEventListener('input', function() {
        formatPhilippineNumber(this);
    });

    // Prevent deletion of '63+' prefix
    phoneNumberInput.addEventListener('keydown', function(e) {
        const cursorPos = this.selectionStart;

        // Prevent backspace/delete if cursor is at position 0-3 (within '63+')
        if ((e.key === 'Backspace' || e.key === 'Delete') && cursorPos <= 3) {
            e.preventDefault();
        }

        // Prevent cursor from moving before position 3
        setTimeout(() => {
            if (this.selectionStart < 3) {
                this.setSelectionRange(3, 3);
            }
        }, 0);
    });

    // Prevent cursor from being placed before '63+'
    phoneNumberInput.addEventListener('click', function() {
        if (this.selectionStart < 3) {
            this.setSelectionRange(3, 3);
        }
    });

    // Focus at the end when field is focused
    phoneNumberInput.addEventListener('focus', function() {
        setTimeout(() => {
            this.setSelectionRange(this.value.length, this.value.length);
        }, 0);
    });
}
</script>
{% endblock %}
