{% extends 'admin_panel/base.html' %}

{% block title %}Audit Logs{% endblock %}

{% block content %}
<style>
    .filter-section {
        display: grid;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .filter-section-title {
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--text-dark);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
        padding: 0 0 0.5rem 0;
        border-bottom: 2px solid var(--primary-light);
        display: inline-block;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        align-items: end;
    }

    .filter-actions {
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .filter-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--primary-light);
        border: 1px solid var(--primary);
        color: var(--primary);
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .filter-tag i {
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .filter-tag i:hover {
        opacity: 1;
    }
</style>

<!-- Page Header -->
<div class="admin-page-header">
    <div>
        <h1 class="admin-page-title">
            <i class="fas fa-clipboard-list"></i>
            Audit Logs
        </h1>
        <div class="admin-breadcrumb">
            <a href="{% url 'admin_panel:dashboard' %}"><i class="fas fa-tachometer-alt"></i> Admin</a>
            <span>/</span>
            <span>Audit Logs</span>
        </div>
    </div>
</div>

<!-- Search & Filters Card -->
<div class="admin-card" style="margin-bottom: 1.5rem;">
    <form method="get" action="">
        <!-- Search Section -->
        <div class="filter-section">
            <div class="filter-section-title">
                <i class="fas fa-search"></i> Search
            </div>
            <div class="form-group">
                <input type="text" name="search" id="search" class="form-control"
                       placeholder="Search by description, username, or IP address..."
                       value="{{ search_query }}"
                       style="padding: 0.75rem 1rem; font-size: 0.95rem;">
            </div>
        </div>

        <!-- Date Range Section -->
        <div class="filter-section">
            <div class="filter-section-title">
                <i class="fas fa-calendar-alt"></i> Date Range
            </div>
            <div class="filter-row">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="date_from">From</label>
                    <input type="date" name="date_from" id="date_from" class="form-control"
                           value="{{ date_from }}">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="date_to">To</label>
                    <input type="date" name="date_to" id="date_to" class="form-control"
                           value="{{ date_to }}">
                </div>
            </div>
        </div>

        <!-- Category Filters Section -->
        <div class="filter-section">
            <div class="filter-section-title">
                <i class="fas fa-filter"></i> Filters
            </div>
            <div class="filter-row">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="action">Action Type</label>
                    <select name="action" id="action" class="form-control">
                        <option value="">All Actions</option>
                        {% for value, label in action_choices %}
                        <option value="{{ value }}" {% if action_filter == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="severity">Severity</label>
                    <select name="severity" id="severity" class="form-control">
                        <option value="">All Severities</option>
                        <option value="info" {% if severity_filter == 'info' %}selected{% endif %}>
                            <i class="fas fa-info-circle"></i> Information
                        </option>
                        <option value="warning" {% if severity_filter == 'warning' %}selected{% endif %}>
                            <i class="fas fa-exclamation-triangle"></i> Warning
                        </option>
                        <option value="critical" {% if severity_filter == 'critical' %}selected{% endif %}>
                            <i class="fas fa-exclamation-circle"></i> Critical
                        </option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" for="status">Status</label>
                    <select name="status" id="status" class="form-control">
                        <option value="">All Results</option>
                        <option value="success" {% if status_filter == 'success' %}selected{% endif %}>
                            ✓ Successful
                        </option>
                        <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>
                            ✗ Failed
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="filter-actions" style="margin-top: 1.5rem;">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i>
                Apply Filters
            </button>
            <a href="{% url 'admin_panel:audit_logs' %}" class="btn btn-secondary">
                <i class="fas fa-redo"></i>
                Reset
            </a>
        </div>
    </form>

    <!-- Active Filters Display -->
    {% if search_query or action_filter or severity_filter or status_filter or date_from or date_to %}
    <div class="active-filters" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
        <span style="font-size: 0.875rem; font-weight: 600; color: var(--text-light); align-self: center;">Active Filters:</span>

        {% if search_query %}
        <span class="filter-tag">
            <i class="fas fa-search"></i> "{{ search_query }}"
        </span>
        {% endif %}

        {% if action_filter %}
        <span class="filter-tag">
            <i class="fas fa-tasks"></i>
            {% for value, label in action_choices %}
                {% if value == action_filter %}{{ label }}{% endif %}
            {% endfor %}
        </span>
        {% endif %}

        {% if severity_filter %}
        <span class="filter-tag">
            <i class="fas fa-exclamation"></i>
            {{ severity_filter|title }}
        </span>
        {% endif %}

        {% if status_filter %}
        <span class="filter-tag">
            {% if status_filter == 'success' %}
                <i class="fas fa-check-circle"></i> Successful
            {% else %}
                <i class="fas fa-times-circle"></i> Failed
            {% endif %}
        </span>
        {% endif %}

        {% if date_from or date_to %}
        <span class="filter-tag">
            <i class="fas fa-calendar"></i>
            {% if date_from %}{{ date_from }}{% endif %}
            {% if date_from and date_to %} → {% endif %}
            {% if date_to %}{{ date_to }}{% endif %}
        </span>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Results Summary -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div style="color: var(--text-light); font-size: 0.95rem;">
        <i class="fas fa-info-circle"></i>
        <strong>{{ total_count }}</strong> log{{ total_count|pluralize }} found
        {% if page_obj.paginator.num_pages > 1 %}
        • Showing page <strong>{{ page_obj.number }}</strong> of <strong>{{ page_obj.paginator.num_pages }}</strong>
        {% endif %}
    </div>
</div>

<!-- Logs Table -->
<div class="admin-table-container">
    <table class="admin-table">
        <thead>
            <tr>
                <th style="width: 150px;">
                    <i class="fas fa-clock"></i> Timestamp
                </th>
                <th style="width: 150px;">
                    <i class="fas fa-user"></i> User
                </th>
                <th style="width: 120px;">
                    <i class="fas fa-tasks"></i> Action
                </th>
                <th style="flex: 1;">
                    <i class="fas fa-file-alt"></i> Description
                </th>
                <th style="width: 130px;">
                    <i class="fas fa-globe"></i> IP Address
                </th>
                <th style="width: 70px;">
                    <i class="fas fa-check"></i> Status
                </th>
            </tr>
        </thead>
        <tbody>
            {% for log in page_obj %}
            <tr>
                <td style="white-space: nowrap; font-size: 0.85rem;">
                    <strong>{{ log.timestamp|date:"M d, Y" }}</strong>
                    <br>
                    <small style="color: var(--text-light);">{{ log.timestamp|time:"H:i:s" }}</small>
                </td>
                <td>
                    <strong style="color: var(--primary);">{{ log.user.get_full_name|default:log.username }}</strong>
                    <br>
                    <small style="color: var(--text-light);">@{{ log.username }}</small>
                </td>
                <td>
                    <span class="badge {% if log.severity == 'critical' %}badge-danger{% elif log.severity == 'warning' %}badge-warning{% else %}badge-info{% endif %}"
                          title="Severity: {{ log.severity|upper }}">
                        {{ log.action|title }}
                    </span>
                </td>
                <td style="font-size: 0.9rem;">
                    {{ log.action_description }}
                    {% if log.station or log.province %}
                    <br>
                    <small style="color: var(--text-light);">
                        <i class="fas fa-map-marker-alt"></i>
                        {% if log.station %}{{ log.station }}{% endif %}
                        {% if log.station and log.province %}, {% endif %}
                        {% if log.province %}{{ log.province }}{% endif %}
                    </small>
                    {% endif %}
                </td>
                <td style="font-family: 'Courier New', monospace; font-size: 0.85rem; color: var(--text-light);">
                    {{ log.ip_address }}
                </td>
                <td style="text-align: center;">
                    {% if log.success %}
                    <span class="badge badge-success" title="Action succeeded">
                        <i class="fas fa-check"></i> Success
                    </span>
                    {% else %}
                    <span class="badge badge-danger" title="Action failed{% if log.error_message %}: {{ log.error_message }}{% endif %}">
                        <i class="fas fa-times"></i> Failed
                    </span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 3rem 2rem; color: var(--text-light);">
                    <div style="font-size: 2rem; opacity: 0.3; margin-bottom: 1rem;">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <p style="font-size: 0.95rem; margin: 0;">
                        No audit logs found matching your filters
                    </p>
                    <p style="font-size: 0.85rem; margin: 0.5rem 0 0 0;">
                        Try adjusting your search criteria or <a href="{% url 'admin_panel:audit_logs' %}" style="color: var(--primary);">clear all filters</a>
                    </p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="pagination" style="margin-top: 2rem;">
    {% if page_obj.has_previous %}
    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" title="First Page">
        <i class="fas fa-angle-double-left"></i>
    </a>
    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" title="Previous Page">
        <i class="fas fa-angle-left"></i>
    </a>
    {% endif %}

    <span class="current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" title="Next Page">
        <i class="fas fa-angle-right"></i>
    </a>
    <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" title="Last Page">
        <i class="fas fa-angle-double-right"></i>
    </a>
    {% endif %}
</div>
{% endif %}

{% endblock %}
