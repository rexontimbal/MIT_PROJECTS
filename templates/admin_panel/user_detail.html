{% extends 'admin_panel/base.html' %}

{% block title %}User: {{ target_user.username }}{% endblock %}

{% block content %}
<style>
    /* =========================================
       PHILIPPINE PHONE NUMBER INPUT STYLING
       ========================================= */
    .phone-input-group {
        display: flex;
        align-items: stretch;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        overflow: hidden;
        background: white;
        transition: border-color 0.3s ease;
    }

    .phone-input-group:focus-within {
        border-color: #003087;
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.1);
    }

    .phone-prefix-area {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        background: #f9fafb;
        border-right: 1px solid #d1d5db;
        font-weight: 600;
        color: #003087;
        min-width: max-content;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .phone-input-field {
        flex: 1;
        border: none;
        padding: 0.75rem 1rem;
        padding-left: 0.75rem;
        font-size: 1rem;
        font-weight: 500;
        letter-spacing: 0.05em;
        outline: none;
        background: white;
        color: #1f2937;
    }

    .phone-input-field:hover {
        color: #1f2937;
    }

    .phone-input-field:focus {
        background: white;
        color: #1f2937;
    }

    .phone-input-field::placeholder {
        color: #9ca3af;
    }

    /* Validation error state */
    .phone-input-group.error {
        border-color: #ef4444;
    }

    .phone-input-group.error:focus-within {
        border-color: #dc2626;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
</style>
<!-- Page Header -->
<div class="admin-page-header">
    <div>
        <h1 class="admin-page-title">
            <i class="fas fa-user"></i>
            {{ target_user.get_full_name|default:target_user.username }}
        </h1>
        <div class="admin-breadcrumb">
            <a href="{% url 'admin_panel:dashboard' %}"><i class="fas fa-tachometer-alt"></i> Admin</a>
            <span>/</span>
            <a href="{% url 'admin_panel:users' %}">Users</a>
            <span>/</span>
            <span>{{ target_user.username }}</span>
        </div>
    </div>
    <a href="{% url 'admin_panel:users' %}" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i>
        Back to Users
    </a>
</div>

<!-- Messages (handled by notification system in base.html) -->
{% if messages %}
    <div style="display: none;">
    {% for message in messages %}
        <!-- {{ message.tags }}: {{ message }} -->
    {% endfor %}
    </div>
{% endif %}

<!-- Superuser Warning -->
{% if target_user.is_superuser %}
<div class="alert alert-warning" style="margin-bottom: var(--space-6);">
    <i class="fas fa-shield-alt"></i>
    <div>
        <strong>Protected Account:</strong> This is a superuser account. For security, you'll be asked to confirm your password before making changes.
    </div>
</div>
{% endif %}

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
    <!-- Main Content -->
    <div>
        <!-- Basic Information -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-id-card"></i>
                    Basic Information
                    {% if target_user.is_superuser %}
                    <span class="badge badge-danger" style="margin-left: var(--space-2);">
                        <i class="fas fa-crown"></i> SUPERUSER
                    </span>
                    {% endif %}
                </h2>
            </div>

            <form method="post" enctype="multipart/form-data" id="basicInfoForm" onsubmit="return handleSuperuserSubmit(event, this, 'basicInfoForm')">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_basic">

                <div class="form-group">
                    <label class="form-label" for="username">
                        Username
                    </label>
                    <div>
                        <input type="text"
                               name="username"
                               id="username"
                               class="form-control"
                               value="{{ target_user.username }}"
                               data-original="{{ target_user.username }}"
                               {% if not user.is_superuser or user.profile.role != 'super_admin' %}disabled{% endif %}>
                        <small style="color: var(--text-light); display: block; margin-top: var(--space-2);">
                            {% if user.is_superuser and user.profile.role == 'super_admin' %}
                                Password confirmation will be required when saving changes.
                            {% else %}
                                Username editing is restricted to Super Admin accounts only
                            {% endif %}
                        </small>
                    </div>
                </div>

                <!-- Password Reset Section (For Super Admin Users) -->
                {% if user.is_superuser and user.profile.role == 'super_admin' %}
                <div class="form-group">
                    <label class="form-label">
                        Password
                        <span class="badge badge-warning" style="margin-left: var(--space-2); font-size: 0.75rem;">
                            <i class="fas fa-shield-alt"></i> Super Admin Only
                        </span>
                    </label>
                    <div style="display: flex; gap: var(--space-3); align-items: center;">
                        <input type="password" class="form-control" value="••••••••••••" disabled style="flex: 1;">
                        <button type="button" class="btn btn-warning btn-sm" onclick="openResetPasswordModal()" style="margin-top: 0;">
                            <i class="fas fa-key"></i>
                            Reset Password
                        </button>
                    </div>
                    <small style="color: var(--text-light); display: block; margin-top: var(--space-2);">
                        You can reset this user's password (your password will be required for confirmation)
                    </small>
                </div>
                {% endif %}

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="first_name">First Name</label>
                        <input type="text" name="first_name" id="first_name" class="form-control" value="{{ target_user.first_name }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="last_name">Last Name</label>
                        <input type="text" name="last_name" id="last_name" class="form-control" value="{{ target_user.last_name }}">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">Email Address</label>
                    <input type="email" name="email" id="email" class="form-control" value="{{ target_user.email }}">
                </div>

                <div class="form-group">
                    <label class="form-label" for="profile_picture">Profile Picture</label>

                    <!-- Modern Drag & Drop Area -->
                    <div id="profilePictureUpload" style="
                        border: 2px dashed var(--border-color);
                        border-radius: 16px;
                        padding: 2rem;
                        text-align: center;
                        background: var(--gray-50);
                        transition: all 0.3s ease;
                        cursor: pointer;
                        position: relative;
                        overflow: hidden;
                    "
                    onclick="document.getElementById('profile_picture').click()"
                    ondragover="handleDragOver(event)"
                    ondragleave="handleDragLeave(event)"
                    ondrop="handleDrop(event)">

                        {% if profile.profile_picture %}
                        <!-- Current Picture Display -->
                        <div id="currentPicture" style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                            <div style="position: relative;">
                                <img src="{{ profile.profile_picture.url }}"
                                     alt="Profile Picture"
                                     style="width: 120px;
                                            height: 120px;
                                            object-fit: cover;
                                            border-radius: 50%;
                                            border: 4px solid white;
                                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <div style="
                                    position: absolute;
                                    bottom: 0;
                                    right: 0;
                                    background: var(--pnp-blue);
                                    color: white;
                                    width: 36px;
                                    height: 36px;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    border: 3px solid white;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                                ">
                                    <i class="fas fa-camera"></i>
                                </div>
                            </div>
                            <div>
                                <p style="margin: 0; font-weight: 600; color: var(--text-primary);">Click or drag to change</p>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--text-light);">JPG, PNG • Max 5MB</p>
                            </div>
                            <label style="
                                display: inline-flex;
                                align-items: center;
                                gap: 0.5rem;
                                padding: 0.5rem 1rem;
                                background: rgba(239, 68, 68, 0.1);
                                border: 1px solid rgba(239, 68, 68, 0.3);
                                border-radius: 8px;
                                cursor: pointer;
                                transition: all 0.2s;
                                color: #991b1b;
                                font-size: 0.875rem;
                                font-weight: 500;
                            "
                            onmouseover="this.style.background='rgba(239, 68, 68, 0.15)'"
                            onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'"
                            onclick="event.stopPropagation()">
                                <input type="checkbox" name="remove_picture" value="1" style="margin: 0;">
                                <i class="fas fa-trash-alt"></i>
                                <span>Remove Picture</span>
                            </label>
                        </div>
                        {% else %}
                        <!-- Empty State -->
                        <div id="emptyState">
                            <div style="
                                width: 80px;
                                height: 80px;
                                margin: 0 auto 1rem;
                                background: linear-gradient(135deg, var(--pnp-blue) 0%, #0047BB 100%);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 8px 16px rgba(0, 48, 135, 0.2);
                            ">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: white;"></i>
                            </div>
                            <p style="margin: 0; font-weight: 600; font-size: 1.125rem; color: var(--text-primary);">Upload Profile Picture</p>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Click to browse or drag and drop</p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--text-light);">JPG, PNG • Max 5MB</p>
                        </div>
                        {% endif %}

                        <!-- Hidden File Input -->
                        <input type="file"
                               name="profile_picture"
                               id="profile_picture"
                               class="form-control"
                               accept="image/*"
                               onchange="previewProfilePicture(event)"
                               style="display: none;">
                    </div>

                    <!-- New Picture Preview -->
                    <div id="image-preview" style="
                        margin-top: 1rem;
                        display: none;
                        padding: 1.5rem;
                        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%);
                        border: 2px solid rgba(16, 185, 129, 0.3);
                        border-radius: 12px;
                        text-align: center;
                    ">
                        <p style="
                            margin: 0 0 1rem 0;
                            font-weight: 600;
                            color: #065f46;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 0.5rem;
                        ">
                            <i class="fas fa-check-circle"></i>
                            New Picture Preview
                        </p>
                        <img id="preview-img" style="
                            width: 120px;
                            height: 120px;
                            object-fit: cover;
                            border-radius: 50%;
                            border: 4px solid white;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        ">
                        <p style="margin: 1rem 0 0 0; font-size: 0.875rem; color: var(--text-light);">
                            <i class="fas fa-info-circle"></i> Click "Save Basic Info" to upload
                        </p>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Basic Info
                </button>
            </form>
        </div>

        <!-- PNP Profile -->
        {% if profile %}
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-shield-alt"></i>
                    PNP Profile
                </h2>
            </div>

            <form method="post" id="profileForm" onsubmit="return handleSuperuserSubmit(event, this, 'profileForm')">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_profile">

                <div class="form-group">
                    <label class="form-label" for="badge_number">Badge Number</label>
                    <input type="text" name="badge_number" id="badge_number" class="form-control" value="{{ profile.badge_number }}">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="rank">Rank</label>
                        <select name="rank" id="rank" class="form-control">
                            {% for value, label in ranks %}
                            <option value="{{ value }}" {% if profile.rank == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="role">Role</label>
                        <select name="role" id="role" class="form-control">
                            {% for value, label in roles %}
                            <option value="{{ value }}" {% if profile.role == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="region">Region</label>
                        <input type="text" name="region" id="region" class="form-control" value="Caraga" readonly style="background: #f5f5f5;">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="province">Province</label>
                        <select name="province" id="province" class="form-control" onchange="updateStations()">
                            <option value="">-- Select Province --</option>
                            <option value="Agusan del Norte" {% if profile.province == 'Agusan del Norte' %}selected{% endif %}>Agusan del Norte</option>
                            <option value="Agusan del Sur" {% if profile.province == 'Agusan del Sur' %}selected{% endif %}>Agusan del Sur</option>
                            <option value="Butuan City" {% if profile.province == 'Butuan City' %}selected{% endif %}>Butuan City</option>
                            <option value="Dinagat Islands" {% if profile.province == 'Dinagat Islands' %}selected{% endif %}>Dinagat Islands</option>
                            <option value="Surigao del Norte" {% if profile.province == 'Surigao del Norte' %}selected{% endif %}>Surigao del Norte</option>
                            <option value="Surigao del Sur" {% if profile.province == 'Surigao del Sur' %}selected{% endif %}>Surigao del Sur</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="station">Station</label>
                        <select name="station" id="station" class="form-control">
                            <option value="">-- Select Province First --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="unit">Unit</label>
                        <input type="text" name="unit" id="unit" class="form-control" value="{{ profile.unit }}">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="mobile_number">
                        Mobile Number
                        <small style="color: var(--text-light); font-weight: 400;">(10-digit format: 917 555 0123)</small>
                    </label>
                    <div class="phone-input-group" id="mobileNumberGroup">
                        <div class="phone-prefix-area">+63</div>
                        <input type="text"
                               name="mobile_number"
                               id="mobile_number"
                               class="form-control phone-input-field"
                               value="{{ profile.mobile_number }}"
                               placeholder="917 555 0123"
                               maxlength="18"
                               inputmode="numeric"
                               required>
                    </div>
                    <small id="mobileNumberHint" style="color: var(--text-light); display: none; margin-top: 0.5rem;">
                        <i class="fas fa-info-circle"></i> Please enter exactly 10 digits
                    </small>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Profile
                </button>
            </form>
        </div>
        {% endif %}

        <!-- Account Status & Role-Based Permissions -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-lock"></i>
                    Account Status & Permissions
                </h2>
            </div>

            <!-- Role-Based Permissions Info -->
            <div style="background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%); padding: 1rem; border-radius: 8px; border-left: 4px solid #003087; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <i class="fas fa-info-circle" style="font-size: 18px; color: #003087; margin-top: 2px;"></i>
                    <div>
                        <strong style="color: #003087; display: block; margin-bottom: 0.25rem;">Role-Based Access Control</strong>
                        <p style="margin: 0; color: #374151; font-size: 14px; line-height: 1.5;">
                            Access permissions are automatically managed based on the user's <strong>Role</strong>:
                        </p>
                        <div style="margin-top: 0.5rem; font-size: 13px; color: #374151;">
                            {% if profile %}
                                {% if profile.role == 'super_admin' %}
                                <div style="padding: 0.5rem; background: rgba(0, 48, 135, 0.1); border-radius: 6px; margin-top: 0.5rem;">
                                    <i class="fas fa-crown" style="color: #003087;"></i>
                                    <strong style="color: #003087;">Super Admin</strong> → Full access to Django Admin & Admin Panel
                                </div>
                                {% elif profile.role == 'regional_director' %}
                                <div style="padding: 0.5rem; background: rgba(0, 71, 171, 0.1); border-radius: 6px; margin-top: 0.5rem;">
                                    <i class="fas fa-user-shield" style="color: #0047AB;"></i>
                                    <strong style="color: #0047AB;">Regional Director</strong> → Access to Admin Panel only
                                </div>
                                {% else %}
                                <div style="padding: 0.5rem; background: rgba(107, 114, 128, 0.1); border-radius: 6px; margin-top: 0.5rem;">
                                    <i class="fas fa-user" style="color: #6B7280;"></i>
                                    <strong style="color: #6B7280;">{{ profile.get_role_display }}</strong> → View profile only
                                </div>
                                {% endif %}
                            {% endif %}
                            <small style="display: block; margin-top: 0.5rem; color: #6B7280;">
                                To change access level, update the user's Role in the PNP Profile section above.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Status Form -->
            <form method="post" id="permissionsForm" onsubmit="return handleSuperuserSubmit(event, this, 'permissionsForm')">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_permissions">

                <div style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; border-radius: 8px; border: 2px solid {% if target_user.is_active %}#10B981{% else %}#EF4444{% endif %}; background: {% if target_user.is_active %}rgba(16, 185, 129, 0.05){% else %}rgba(239, 68, 68, 0.05){% endif %};">
                        <input type="checkbox" name="is_active" {% if target_user.is_active %}checked{% endif %} style="width: 20px; height: 20px;">
                        <div>
                            <strong style="color: var(--text-dark);">
                                <i class="fas {% if target_user.is_active %}fa-check-circle{% else %}fa-times-circle{% endif %}" style="color: {% if target_user.is_active %}#10B981{% else %}#EF4444{% endif %};"></i>
                                Active Account
                            </strong>
                            <br>
                            <small style="color: var(--text-light);">
                                {% if target_user.is_active %}
                                User can log in and access the system
                                {% else %}
                                User is currently blocked from logging in
                                {% endif %}
                            </small>
                        </div>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Update Status
                </button>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <div>
        <!-- User Info -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-info-circle"></i>
                    Account Info
                </h2>
            </div>

            <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.9rem;">
                <div>
                    <strong style="color: var(--text-light);">Last Login:</strong>
                    <br>
                    {{ target_user.last_login|date:"M d, Y H:i"|default:"Never" }}
                </div>

                <div>
                    <strong style="color: var(--text-light);">Date Joined:</strong>
                    <br>
                    {{ target_user.date_joined|date:"M d, Y H:i" }}
                </div>

                <div>
                    <strong style="color: var(--text-light);">User ID:</strong>
                    <br>
                    #{{ target_user.id }}
                </div>

                {% if profile %}
                <div>
                    <strong style="color: var(--text-light);">Last Password Change:</strong>
                    <br>
                    {{ profile.password_changed_at|date:"M d, Y"|default:"Unknown" }}
                </div>

                <div>
                    <strong style="color: var(--text-light);">Failed Login Attempts:</strong>
                    <br>
                    <span class="badge {% if profile.failed_login_attempts > 0 %}badge-warning{% else %}badge-success{% endif %}">
                        {{ profile.failed_login_attempts }}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="admin-card">
    <div class="admin-card-header">
        <h2 class="admin-card-title">
            <i class="fas fa-history"></i>
            Recent Activity
        </h2>
    </div>

    <div class="admin-table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Action</th>
                    <th>Description</th>
                    <th>IP Address</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for log in recent_logs %}
                <tr>
                    <td style="white-space: nowrap;">{{ log.timestamp|date:"M d, Y H:i" }}</td>
                    <td>
                        <span class="badge {% if log.severity == 'critical' %}badge-danger{% elif log.severity == 'warning' %}badge-warning{% else %}badge-info{% endif %}">
                            {{ log.action|title }}
                        </span>
                    </td>
                    <td>{{ log.action_description|truncatewords:15 }}</td>
                    <td><small>{{ log.ip_address }}</small></td>
                    <td>
                        {% if log.success %}
                        <span class="badge badge-success"><i class="fas fa-check"></i></span>
                        {% else %}
                        <span class="badge badge-danger"><i class="fas fa-times"></i></span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; color: var(--text-light);">No activity recorded</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Caraga Region Police Stations Database (Real PNP Data)
const stationsByProvince = {
    'Agusan del Norte': ['Santiago MPS', 'Las Nieves MPS', 'Remedios T Romualdes MPS', 'Buenavista MPS', 'Jabonga MPS', 'Cabadbaran City PS', 'Tubay MPS', 'Kitcharao MPS', 'Magallanes MPS', 'Nasipit MPS', 'Carmen MPS'],
    'Agusan del Sur': ['Bayugan CPS', 'Prosperidad MPS', 'San Francisco MPS', 'Rosario MPS', 'La Paz MPS', 'Bunawan MPS', 'Veruela MPS', 'Loreto MPS', 'Sibagat MPS', 'San Luis MPS', 'Esperanza MPS', 'Talacogon MPS', 'Sta Josefa MPS'],
    'Butuan City': ['Butuan City PS 1', 'Butuan City PS 2', 'Butuan City PS 3', 'Butuan City PS 4', 'Butuan City PS 5'],
    'Dinagat Islands': ['San Jose MPS', 'Libjo MPS', 'Dinagat MPS', 'Loreto MPS', 'Basilisa MPS', 'Tubajon MPS'],
    'Surigao del Norte': ['Placer MPS', 'Gen. Luna MPS', 'Sison MPS', 'Surigao City PS', 'Mainit MPS', 'Gigaquit MPS', 'Malimono MPS', 'Claver MPS', 'Bacuag MPS', 'Taganaan MPS', 'Dapa MPS', 'Alegria MPS', 'Del Carmen MPS', 'Sta. Monica MPS', 'Tubod MPS', 'San Isidro MPS', 'Burgos MPS', 'Socorro MPS', 'San Francisco MPS', 'Pilar MPS', 'San Benito MPS'],
    'Surigao del Sur': ['Bislig City PS', 'Hinatuan MPS', 'Lingig MPS', 'Tago MPS', 'Lianga MPS', 'Tandag City PS', 'Barobo MPS', 'Cortes MPS', 'Lanuza MPS', 'Cantilan MPS', 'Tagbina MPS', 'Marihatag MPS', 'Carascal MPS', 'San Agustin MPS', 'Madrid MPS', 'Bayabas MPS', 'San Miguel MPS', 'Carmen MPS']
};

// Update stations dropdown
function updateStations() {
    const provinceSelect = document.getElementById('province');
    const stationSelect = document.getElementById('station');
    const selectedProvince = provinceSelect.value;
    const currentStation = '{{ profile.station }}';

    stationSelect.innerHTML = '<option value="">-- Select Station --</option>';

    if (selectedProvince && stationsByProvince[selectedProvince]) {
        stationsByProvince[selectedProvince].forEach(station => {
            const option = document.createElement('option');
            option.value = station;
            option.textContent = station;
            if (station === currentStation) {
                option.selected = true;
            }
            stationSelect.appendChild(option);
        });
    }
}

// Initialize station dropdown on page load
document.addEventListener('DOMContentLoaded', function() {
    updateStations();
});

// Profile picture preview
function previewProfilePicture(event) {
    const file = event.target.files[0];
    if (file) {
        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showNotification('File size too large! Maximum 5MB allowed.', 'error', 5000);
            event.target.value = '';
            document.getElementById('image-preview').style.display = 'none';
            return;
        }

        // Check file type
        if (!file.type.startsWith('image/')) {
            showNotification('Please select a valid image file!', 'error', 5000);
            event.target.value = '';
            document.getElementById('image-preview').style.display = 'none';
            return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-img').src = e.target.result;
            document.getElementById('image-preview').style.display = 'block';
            document.getElementById('image-preview').style.animation = 'slideDown 0.3s ease';
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('image-preview').style.display = 'none';
    }
}

// Drag & Drop Handlers
function handleDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    const uploadArea = document.getElementById('profilePictureUpload');
    uploadArea.style.borderColor = 'var(--pnp-blue)';
    uploadArea.style.background = 'rgba(0, 48, 135, 0.05)';
    uploadArea.style.transform = 'scale(1.02)';
}

function handleDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    const uploadArea = document.getElementById('profilePictureUpload');
    uploadArea.style.borderColor = 'var(--border-color)';
    uploadArea.style.background = 'var(--gray-50)';
    uploadArea.style.transform = 'scale(1)';
}

function handleDrop(event) {
    event.preventDefault();
    event.stopPropagation();

    const uploadArea = document.getElementById('profilePictureUpload');
    uploadArea.style.borderColor = 'var(--border-color)';
    uploadArea.style.background = 'var(--gray-50)';
    uploadArea.style.transform = 'scale(1)';

    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const fileInput = document.getElementById('profile_picture');
        fileInput.files = files;

        // Trigger preview
        const changeEvent = new Event('change', { bubbles: true });
        fileInput.dispatchEvent(changeEvent);

        showNotification('Image selected! Click "Save Basic Info" to upload.', 'success', 4000);
    }
}

// =========================================
// PHILIPPINE PHONE NUMBER FORMATTING
// =========================================
// Valid Philippine mobile prefixes
const philippineMobilePrefixes = [
    '905', '906', '907', '908', '909', // Globe
    '910', '911', '912', '913', '914', '915', '916', '917', // Smart/TNT
    '918', '919', // Smart
    '920', '921', '922', '923', '924', '925', '926', '927', '928', '929', // Dito
    '930', '931', '932', '933', '934', '935', '936', '937', '938', '939', // Various operators
    '940', '941', '942', '943', '944', '945', '946', '947', '948', '949'  // Various operators
];

function formatPhilippineNumber(input) {
    let value = input.value;

    // Remove all non-digit characters
    let digitsOnly = value.replace(/\D/g, '');

    // If user clears the field, return empty
    if (!digitsOnly) {
        input.value = '';
        return;
    }

    // Convert different formats to standard 10-digit format
    if (digitsOnly.startsWith('63')) {
        // User typed 63... format, remove the 63
        digitsOnly = digitsOnly.substring(2);
    }

    if (digitsOnly.startsWith('0')) {
        // User typed 0... format (domestic), remove the leading 0
        digitsOnly = digitsOnly.substring(1);
    }

    // Limit to 10 digits (mobile prefix 3 digits + local number 7 digits)
    if (digitsOnly.length > 10) {
        digitsOnly = digitsOnly.substring(0, 10);
    }

    // Pad with leading zeros if less than 10 digits
    while (digitsOnly.length < 10) {
        digitsOnly = '0' + digitsOnly;
    }

    // Extract mobile prefix (first 3 digits) and local number (last 7 digits)
    const mobilePrefix = digitsOnly.substring(0, 3);
    const localNumber = digitsOnly.substring(3, 10);

    // Format with spaces: 917 555 0123 (without +63, it's in the prefix area)
    const formatted = `${mobilePrefix} ${localNumber.substring(0, 3)} ${localNumber.substring(3)}`;

    input.value = formatted;

    // Validate and show warning if prefix is not recognized
    const isValidPrefix = philippineMobilePrefixes.includes(mobilePrefix);
    if (input.value.length > 0 && digitsOnly.length === 10 && !isValidPrefix) {
        console.warn(`Warning: "${mobilePrefix}" is not a recognized Philippine mobile prefix`);
    }
}

// Apply to mobile number field
const mobileNumberInput = document.getElementById('mobile_number');
const mobileNumberGroup = document.getElementById('mobileNumberGroup');
const mobileNumberHint = document.getElementById('mobileNumberHint');

if (mobileNumberInput) {
    // Format existing value on page load
    if (mobileNumberInput.value && mobileNumberInput.value.trim() !== '') {
        formatPhilippineNumber(mobileNumberInput);
    }

    // Format on input
    mobileNumberInput.addEventListener('input', function() {
        formatPhilippineNumber(this);
        // Clear error state while typing
        mobileNumberGroup.classList.remove('error');
        mobileNumberHint.style.display = 'none';
    });

    // Handle backspace to maintain format
    mobileNumberInput.addEventListener('keydown', function(e) {
        // Allow standard key operations
        if (['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key)) {
            setTimeout(() => {
                if (this.value) {
                    formatPhilippineNumber(this);
                } else {
                    formatPhilippineNumber(this);
                }
            }, 0);
        }
    });

    // Focus at the end when field is focused
    mobileNumberInput.addEventListener('focus', function() {
        setTimeout(() => {
            this.setSelectionRange(this.value.length, this.value.length);
        }, 0);
    });

    // Validate before blur
    mobileNumberInput.addEventListener('blur', function() {
        validateMobileNumber(this);
    });
}

// Validation function
function validateMobileNumber(input) {
    const digitsOnly = input.value.replace(/\D/g, '');

    if (input.value.trim() === '') {
        // Empty field is allowed (optional field)
        mobileNumberGroup.classList.remove('error');
        mobileNumberHint.style.display = 'none';
        return true;
    }

    if (digitsOnly.length !== 10) {
        // Invalid length
        mobileNumberGroup.classList.add('error');
        mobileNumberHint.style.display = 'block';
        return false;
    }

    // Valid
    mobileNumberGroup.classList.remove('error');
    mobileNumberHint.style.display = 'none';
    return true;
}

// Form submission validation
const profileForm = document.getElementById('profileForm');
if (profileForm) {
    profileForm.addEventListener('submit', function(e) {
        const mobileValue = mobileNumberInput.value.trim();

        // If field has value, validate it
        if (mobileValue !== '') {
            const digitsOnly = mobileValue.replace(/\D/g, '');

            if (digitsOnly.length !== 10) {
                e.preventDefault();
                // Keep focus in the field
                mobileNumberInput.focus();
                mobileNumberInput.setSelectionRange(mobileNumberInput.value.length, mobileNumberInput.value.length);

                // Show error state
                mobileNumberGroup.classList.add('error');
                mobileNumberHint.style.display = 'block';

                // Show popup alert
                showNotification('Please enter exactly 10 digits for the mobile number (e.g., 917 555 0123)', 'error', 5000);

                return false;
            }
        }

        // Valid, allow form submission
        mobileNumberGroup.classList.remove('error');
        mobileNumberHint.style.display = 'none';
        return true;
    });
}


// =========================================
// SUPERUSER PROTECTION FLAG
// =========================================
// Set global flag so base.html handleSuperuserSubmit knows if editing superuser
const isSuperuser = {{ target_user.is_superuser|lower }};
</script>
{% endblock %}
