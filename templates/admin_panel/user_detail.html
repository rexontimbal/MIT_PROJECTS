{% extends 'admin_panel/base.html' %}

{% block title %}User: {{ target_user.username }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="admin-page-header">
    <div>
        <h1 class="admin-page-title">
            <i class="fas fa-user"></i>
            {{ target_user.get_full_name|default:target_user.username }}
        </h1>
        <div class="admin-breadcrumb">
            <a href="{% url 'admin_panel:dashboard' %}"><i class="fas fa-tachometer-alt"></i> Admin</a>
            <span>/</span>
            <a href="{% url 'admin_panel:users' %}">Users</a>
            <span>/</span>
            <span>{{ target_user.username }}</span>
        </div>
    </div>
    <a href="{% url 'admin_panel:users' %}" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i>
        Back to Users
    </a>
</div>

<!-- Messages -->
{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        <i class="fas fa-info-circle"></i>
        {{ message }}
    </div>
    {% endfor %}
{% endif %}

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
    <!-- Main Content -->
    <div>
        <!-- Basic Information -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-id-card"></i>
                    Basic Information
                </h2>
            </div>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_basic">

                <div class="form-group">
                    <label class="form-label" for="username">Username</label>
                    <input type="text" id="username" class="form-control" value="{{ target_user.username }}" disabled>
                    <small style="color: var(--text-light);">Username cannot be changed</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="first_name">First Name</label>
                        <input type="text" name="first_name" id="first_name" class="form-control" value="{{ target_user.first_name }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="last_name">Last Name</label>
                        <input type="text" name="last_name" id="last_name" class="form-control" value="{{ target_user.last_name }}">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">Email Address</label>
                    <input type="email" name="email" id="email" class="form-control" value="{{ target_user.email }}">
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Basic Info
                </button>
            </form>
        </div>

        <!-- PNP Profile -->
        {% if profile %}
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-shield-alt"></i>
                    PNP Profile
                </h2>
            </div>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_profile">

                <div class="form-group">
                    <label class="form-label" for="badge_number">Badge Number</label>
                    <input type="text" name="badge_number" id="badge_number" class="form-control" value="{{ profile.badge_number }}">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="rank">Rank</label>
                        <select name="rank" id="rank" class="form-control">
                            {% for value, label in ranks %}
                            <option value="{{ value }}" {% if profile.rank == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="role">Role</label>
                        <select name="role" id="role" class="form-control">
                            {% for value, label in roles %}
                            <option value="{{ value }}" {% if profile.role == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="region">Region</label>
                        <input type="text" name="region" id="region" class="form-control" value="Caraga" readonly style="background: #f5f5f5;">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="province">Province</label>
                        <select name="province" id="province" class="form-control" onchange="updateStations()">
                            <option value="">-- Select Province --</option>
                            <option value="Agusan del Norte" {% if profile.province == 'Agusan del Norte' %}selected{% endif %}>Agusan del Norte</option>
                            <option value="Agusan del Sur" {% if profile.province == 'Agusan del Sur' %}selected{% endif %}>Agusan del Sur</option>
                            <option value="Surigao del Norte" {% if profile.province == 'Surigao del Norte' %}selected{% endif %}>Surigao del Norte</option>
                            <option value="Surigao del Sur" {% if profile.province == 'Surigao del Sur' %}selected{% endif %}>Surigao del Sur</option>
                            <option value="Dinagat Islands" {% if profile.province == 'Dinagat Islands' %}selected{% endif %}>Dinagat Islands</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="station">Station</label>
                        <select name="station" id="station" class="form-control">
                            <option value="">-- Select Province First --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="unit">Unit</label>
                        <input type="text" name="unit" id="unit" class="form-control" value="{{ profile.unit }}">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="mobile_number">Mobile Number</label>
                        <input type="text" name="mobile_number" id="mobile_number" class="form-control" value="{{ profile.mobile_number }}">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="phone_number">Phone Number</label>
                        <input type="text" name="phone_number" id="phone_number" class="form-control" value="{{ profile.phone_number }}">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Profile
                </button>
            </form>
        </div>
        {% endif %}

        <!-- Permissions -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-lock"></i>
                    Permissions & Status
                </h2>
            </div>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_permissions">

                <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" name="is_active" {% if target_user.is_active %}checked{% endif %} style="width: 20px; height: 20px;">
                        <div>
                            <strong style="color: var(--text-dark);">Active Account</strong>
                            <br>
                            <small style="color: var(--text-light);">User can log in and access the system</small>
                        </div>
                    </label>

                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" name="is_staff" {% if target_user.is_staff %}checked{% endif %} style="width: 20px; height: 20px;">
                        <div>
                            <strong style="color: var(--text-dark);">Staff Status</strong>
                            <br>
                            <small style="color: var(--text-light);">User can access admin panel</small>
                        </div>
                    </label>

                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" name="is_superuser" {% if target_user.is_superuser %}checked{% endif %} style="width: 20px; height: 20px;">
                        <div>
                            <strong style="color: var(--text-dark);">Superuser Status</strong>
                            <br>
                            <small style="color: var(--text-light);">Full system access - use with caution!</small>
                        </div>
                    </label>
                </div>

                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-shield-alt"></i>
                    Update Permissions
                </button>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <div>
        <!-- Quick Actions -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-bolt"></i>
                    Quick Actions
                </h2>
            </div>

            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <button onclick="resetPassword()" class="btn btn-warning" style="justify-content: center;">
                    <i class="fas fa-key"></i>
                    Reset Password
                </button>

                <button onclick="toggleActive()" class="btn {% if target_user.is_active %}btn-danger{% else %}btn-success{% endif %}" style="justify-content: center;">
                    <i class="fas {% if target_user.is_active %}fa-ban{% else %}fa-check{% endif %}"></i>
                    {% if target_user.is_active %}Deactivate Account{% else %}Activate Account{% endif %}
                </button>
            </div>
        </div>

        <!-- User Info -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h2 class="admin-card-title">
                    <i class="fas fa-info-circle"></i>
                    Account Info
                </h2>
            </div>

            <div style="display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.9rem;">
                <div>
                    <strong style="color: var(--text-light);">Last Login:</strong>
                    <br>
                    {{ target_user.last_login|date:"M d, Y H:i"|default:"Never" }}
                </div>

                <div>
                    <strong style="color: var(--text-light);">Date Joined:</strong>
                    <br>
                    {{ target_user.date_joined|date:"M d, Y H:i" }}
                </div>

                <div>
                    <strong style="color: var(--text-light);">User ID:</strong>
                    <br>
                    #{{ target_user.id }}
                </div>

                {% if profile %}
                <div>
                    <strong style="color: var(--text-light);">Last Password Change:</strong>
                    <br>
                    {{ profile.password_changed_at|date:"M d, Y"|default:"Unknown" }}
                </div>

                <div>
                    <strong style="color: var(--text-light);">Failed Login Attempts:</strong>
                    <br>
                    <span class="badge {% if profile.failed_login_attempts > 0 %}badge-warning{% else %}badge-success{% endif %}">
                        {{ profile.failed_login_attempts }}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="admin-card">
    <div class="admin-card-header">
        <h2 class="admin-card-title">
            <i class="fas fa-history"></i>
            Recent Activity
        </h2>
    </div>

    <div class="admin-table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Action</th>
                    <th>Description</th>
                    <th>IP Address</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for log in recent_logs %}
                <tr>
                    <td style="white-space: nowrap;">{{ log.timestamp|date:"M d, Y H:i" }}</td>
                    <td>
                        <span class="badge {% if log.severity == 'critical' %}badge-danger{% elif log.severity == 'warning' %}badge-warning{% else %}badge-info{% endif %}">
                            {{ log.action|title }}
                        </span>
                    </td>
                    <td>{{ log.action_description|truncatewords:15 }}</td>
                    <td><small>{{ log.ip_address }}</small></td>
                    <td>
                        {% if log.success %}
                        <span class="badge badge-success"><i class="fas fa-check"></i></span>
                        {% else %}
                        <span class="badge badge-danger"><i class="fas fa-times"></i></span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; color: var(--text-light);">No activity recorded</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Caraga Region Police Stations Database (Real PNP Data)
const stationsByProvince = {
    'Agusan del Norte': ['Santiago MPS', 'Las Nieves MPS', 'Remedios T Romualdes MPS', 'Buenavista MPS', 'Jabonga MPS', 'Cabadbaran City PS', 'Tubay MPS', 'Kitcharao MPS', 'Magallanes MPS', 'Nasipit MPS', 'Carmen MPS', 'Butuan City PS 1', 'Butuan City PS 2', 'Butuan City PS 3', 'Butuan City PS 4', 'Butuan City PS 5'],
    'Agusan del Sur': ['Bayugan CPS', 'Prosperidad MPS', 'San Francisco MPS', 'Rosario MPS', 'La Paz MPS', 'Bunawan MPS', 'Veruela MPS', 'Loreto MPS', 'Sibagat MPS', 'San Luis MPS', 'Esperanza MPS', 'Talacogon MPS', 'Sta Josefa MPS'],
    'Surigao del Norte': ['Placer MPS', 'Gen. Luna MPS', 'Sison MPS', 'Surigao City PS', 'Mainit MPS', 'Gigaquit MPS', 'Malimono MPS', 'Claver MPS', 'Bacuag MPS', 'Taganaan MPS', 'Dapa MPS', 'Alegria MPS', 'Del Carmen MPS', 'Sta. Monica MPS', 'Tubod MPS', 'San Isidro MPS', 'Burgos MPS', 'Socorro MPS', 'San Francisco MPS', 'Pilar MPS', 'San Benito MPS'],
    'Surigao del Sur': ['Bislig City PS', 'Hinatuan MPS', 'Lingig MPS', 'Tago MPS', 'Lianga MPS', 'Tandag City PS', 'Barobo MPS', 'Cortes MPS', 'Lanuza MPS', 'Cantilan MPS', 'Tagbina MPS', 'Marihatag MPS', 'Carascal MPS', 'San Agustin MPS', 'Madrid MPS', 'Bayabas MPS', 'San Miguel MPS', 'Carmen MPS'],
    'Dinagat Islands': ['San Jose MPS', 'Libjo MPS', 'Dinagat MPS', 'Loreto MPS', 'Basilisa MPS', 'Tubajon MPS']
};

// Update stations dropdown
function updateStations() {
    const provinceSelect = document.getElementById('province');
    const stationSelect = document.getElementById('station');
    const selectedProvince = provinceSelect.value;
    const currentStation = '{{ profile.station }}';

    stationSelect.innerHTML = '<option value="">-- Select Station --</option>';

    if (selectedProvince && stationsByProvince[selectedProvince]) {
        stationsByProvince[selectedProvince].forEach(station => {
            const option = document.createElement('option');
            option.value = station;
            option.textContent = station;
            if (station === currentStation) {
                option.selected = true;
            }
            stationSelect.appendChild(option);
        });
    }
}

// Initialize station dropdown on page load
document.addEventListener('DOMContentLoaded', function() {
    updateStations();
});

function resetPassword() {
    const newPassword = prompt('Enter new password for {{ target_user.username }}:');

    if (!newPassword) {
        return;
    }

    if (newPassword.length < 8) {
        alert('Password must be at least 8 characters long');
        return;
    }

    if (!confirm(`Reset password for {{ target_user.username }}?\n\nThe user will be required to change this password on next login.`)) {
        return;
    }

    fetch('/admin-panel/users/{{ target_user.id }}/reset-password/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ new_password: newPassword })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Password reset successfully!');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

function toggleActive() {
    const isActive = {{ target_user.is_active|lower }};
    const action = isActive ? 'deactivate' : 'activate';

    if (!confirm(`Are you sure you want to ${action} this account?`)) {
        return;
    }

    fetch('/admin-panel/users/{{ target_user.id }}/toggle-active/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}
</script>
{% endblock %}
