{% extends 'admin_panel/base.html' %}

{% block title %}CSV Data Import{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="admin-page-header">
    <div>
        <h1 class="admin-page-title">
            <i class="fas fa-file-upload"></i>
            CSV Data Import
        </h1>
        <div class="admin-breadcrumb">
            <a href="{% url 'admin_panel:dashboard' %}"><i class="fas fa-home"></i> Admin</a>
            <span>/</span>
            <span>CSV Import</span>
        </div>
    </div>
    <div>
        <a href="{% url 'admin_panel:data_view' %}" class="btn btn-outline">
            <i class="fas fa-database"></i>
            View Data
        </a>
    </div>
</div>

<!-- Statistics Grid -->
<div class="stats-grid" style="margin-bottom: 2rem;">
    <div class="stat-card green">
        <div class="stat-header">
            <span class="stat-title">Total Accidents</span>
            <i class="fas fa-database stat-icon"></i>
        </div>
        <div class="stat-value">{{ total_accidents|default:0 }}</div>
        <div class="stat-label">Records in database</div>
    </div>

    <div class="stat-card blue">
        <div class="stat-header">
            <span class="stat-title">Recent Imports</span>
            <i class="fas fa-history stat-icon"></i>
        </div>
        <div class="stat-value">{{ recent_imports.count }}</div>
        <div class="stat-label">Last 10 imports</div>
    </div>

    <div class="stat-card orange">
        <div class="stat-header">
            <span class="stat-title">File Format</span>
            <i class="fas fa-file-csv stat-icon"></i>
        </div>
        <div class="stat-value">.CSV</div>
        <div class="stat-label">Max size: 50MB</div>
    </div>
</div>

<!-- Upload Section -->
<div class="admin-card" style="margin-bottom: 2rem;">
    <div class="admin-card-header">
        <h2 class="admin-card-title">
            <i class="fas fa-cloud-upload-alt"></i>
            Upload CSV File
        </h2>
    </div>

    <div style="padding: 2rem;">
        <!-- Upload Instructions -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; display: flex; align-items: center;">
                <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                CSV File Requirements
            </h3>
            <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                <li>File must have <strong>.csv</strong> extension</li>
                <li>Maximum file size: <strong>50MB</strong></li>
                <li>Required columns: dateCommitted, lat, lng, province, municipal</li>
                <li>Encoding: UTF-8, CP1252, or Latin-1</li>
                <li>Invalid coordinates will be approximated based on location</li>
            </ul>
        </div>

        <!-- Upload Form -->
        <form method="post" action="{% url 'admin_panel:csv_upload_process' %}" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}

            <!-- File Upload Zone -->
            <div id="dropZone" style="border: 3px dashed #d1d5db; border-radius: 12px; padding: 3rem 2rem; text-align: center; background: #f9fafb; transition: all 0.3s; cursor: pointer; margin-bottom: 1.5rem;">
                <input type="file" name="csv_file" id="csvFile" accept=".csv" required style="display: none;">

                <div id="uploadPrompt">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 4rem; color: #9ca3af; margin-bottom: 1rem;"></i>
                    <h3 style="color: #374151; margin-bottom: 0.5rem;">Drop CSV file here or click to browse</h3>
                    <p style="color: #6b7280; margin: 0;">Supports .csv files up to 50MB</p>
                </div>

                <div id="fileSelected" style="display: none;">
                    <i class="fas fa-file-csv" style="font-size: 4rem; color: #10b981; margin-bottom: 1rem;"></i>
                    <h3 id="fileName" style="color: #374151; margin-bottom: 0.5rem;"></h3>
                    <p id="fileSize" style="color: #6b7280; margin: 0 0 1rem 0;"></p>
                    <button type="button" onclick="resetFile()" class="btn btn-outline" style="display: inline-flex;">
                        <i class="fas fa-times"></i>
                        Remove File
                    </button>
                </div>
            </div>

            <!-- Progress Bar (hidden initially) -->
            <div id="progressContainer" style="display: none; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: var(--text-dark);">Uploading...</span>
                    <span id="progressText" style="color: var(--text-light);">0%</span>
                </div>
                <div style="background: #e5e7eb; border-radius: 9999px; height: 8px; overflow: hidden;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button type="submit" class="btn btn-primary" style="min-width: 200px;" id="uploadBtn" disabled>
                    <i class="fas fa-upload"></i>
                    Import Data
                </button>
                <button type="button" onclick="resetFile()" class="btn btn-outline">
                    <i class="fas fa-redo"></i>
                    Reset
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Recent Imports -->
{% if recent_imports %}
<div class="admin-card">
    <div class="admin-card-header">
        <h2 class="admin-card-title">
            <i class="fas fa-history"></i>
            Recent Imports
        </h2>
    </div>

    <div class="admin-table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Date & Time</th>
                    <th>User</th>
                    <th>Description</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for log in recent_imports %}
                <tr>
                    <td>{{ log.timestamp|date:"M d, Y H:i" }}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user-circle" style="color: var(--primary);"></i>
                            {{ log.user.username }}
                        </div>
                    </td>
                    <td>{{ log.description }}</td>
                    <td>
                        {% if log.success %}
                        <span class="badge badge-success">
                            <i class="fas fa-check-circle"></i>
                            Success
                        </span>
                        {% else %}
                        <span class="badge badge-danger">
                            <i class="fas fa-exclamation-circle"></i>
                            Failed
                        </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<style>
#dropZone:hover {
    border-color: #667eea;
    background: #f3f4f6;
}

#dropZone.drag-over {
    border-color: #667eea;
    background: #eef2ff;
    transform: scale(1.02);
}
</style>

<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('csvFile');
const uploadPrompt = document.getElementById('uploadPrompt');
const fileSelected = document.getElementById('fileSelected');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');
const uploadBtn = document.getElementById('uploadBtn');
const uploadForm = document.getElementById('uploadForm');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');

// Click to browse
dropZone.addEventListener('click', () => {
    fileInput.click();
});

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone when dragging over it
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('drag-over');
    }, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('drag-over');
    }, false);
});

// Handle dropped files
dropZone.addEventListener('drop', (e) => {
    const dt = e.dataTransfer;
    const files = dt.files;
    fileInput.files = files;
    handleFileSelect();
});

// Handle file selection via browse
fileInput.addEventListener('change', handleFileSelect);

function handleFileSelect() {
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];

        // Validate file type
        if (!file.name.endsWith('.csv')) {
            alert('Please select a CSV file (.csv extension required)');
            resetFile();
            return;
        }

        // Validate file size (50MB)
        const maxSize = 50 * 1024 * 1024;
        if (file.size > maxSize) {
            alert(`File too large. Maximum size is 50MB. Your file is ${(file.size / (1024 * 1024)).toFixed(1)}MB`);
            resetFile();
            return;
        }

        // Show file info
        fileName.textContent = file.name;
        fileSize.textContent = `Size: ${(file.size / (1024 * 1024)).toFixed(2)} MB`;

        uploadPrompt.style.display = 'none';
        fileSelected.style.display = 'block';
        uploadBtn.disabled = false;
    }
}

function resetFile() {
    fileInput.value = '';
    uploadPrompt.style.display = 'block';
    fileSelected.style.display = 'none';
    uploadBtn.disabled = true;
}

// Handle form submission with progress simulation
uploadForm.addEventListener('submit', (e) => {
    // Show progress
    progressContainer.style.display = 'block';
    uploadBtn.disabled = true;

    // Simulate progress (since we can't track server-side processing easily)
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90; // Stop at 90%

        progressBar.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
    }, 200);

    // Clear interval on page unload (form submission)
    window.addEventListener('beforeunload', () => {
        clearInterval(interval);
    });
});
</script>
{% endblock %}
