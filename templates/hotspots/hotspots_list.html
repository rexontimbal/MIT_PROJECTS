{% extends 'base.html' %}
{% load static %}

{% block title %}Accident Hotspots{% endblock %}

{% block breadcrumb_items %}
<span> / Hotspots</span>
{% endblock %}

{% block extra_css %}
<style>
    /* ===== MODERN FLAT UI STYLING ===== */

    .hotspots-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    /* Clean Search & Filters Section */
    .filters-section {
        background: white;
        padding: 1.75rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        margin-bottom: 1.5rem;
        border: 1px solid #E5E7EB;
    }

    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }

    .filters-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
    }

    /* Search Input - Modern & Flat */
    #hotspotSearch {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
        background: white;
    }

    #hotspotSearch:hover {
        border-color: #9CA3AF;
    }

    #hotspotSearch:focus {
        outline: none;
        border-color: #003087;
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08);
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        pointer-events: none;
    }

    /* Filter Grid - Clean Layout */
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.25rem;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .filter-group label {
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
    }

    .filter-group select {
        padding: 0.625rem 0.875rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: white;
        cursor: pointer;
    }

    .filter-group select:hover {
        border-color: #9CA3AF;
    }

    .filter-group select:focus {
        outline: none;
        border-color: #003087;
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08);
    }

    /* Active Filters Tags */
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #E5E7EB;
    }

    .filter-tag {
        background: #EFF6FF;
        color: #1E40AF;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        border: 1px solid #DBEAFE;
    }

    .filter-tag button {
        background: none;
        border: none;
        color: #1E40AF;
        cursor: pointer;
        font-weight: 600;
        font-size: 1.125rem;
        line-height: 1;
        padding: 0;
        margin-left: 0.25rem;
        transition: color 0.2s;
    }

    .filter-tag button:hover {
        color: #1E3A8A;
    }

    /* Summary Cards - Flat & Clean */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .summary-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        text-align: center;
        transition: all 0.2s ease;
        border: 1px solid #E5E7EB;
    }

    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .summary-card h3 {
        font-size: 2rem;
        color: #003087;
        margin-bottom: 0.5rem;
        font-weight: 700;
    }

    .summary-card p {
        color: #6B7280;
        font-size: 0.875rem;
        margin: 0;
    }

    /* Hotspot Cards - Flat Modern Design */
    .hotspots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.25rem;
        margin-bottom: 2rem;
    }

    .hotspot-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        overflow: hidden;
        transition: all 0.2s ease;
        border: 1px solid #E5E7EB;
        border-left: 3px solid #DC143C;
        position: relative;
    }

    .hotspot-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .hotspot-header {
        background: #FFA500;
        color: white;
        padding: 1.25rem;
        position: relative;
    }

    .hotspot-title {
        font-size: 1.125rem;
        font-weight: 700;
        margin: 0 0 0.75rem 0;
    }

    .risk-badge {
        padding: 0.375rem 0.875rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }

    .risk-critical { background: #DC143C; color: white; }
    .risk-high { background: #F59E0B; color: white; }
    .risk-medium { background: #10B981; color: white; }
    .risk-low { background: #6B7280; color: white; }

    .hotspot-body {
        padding: 1.25rem;
    }

    .hotspot-stat {
        display: flex;
        justify-content: space-between;
        padding: 0.625rem 0;
        border-bottom: 1px solid #E5E7EB;
    }

    .hotspot-stat:last-of-type {
        border-bottom: none;
    }

    .stat-label {
        color: #6B7280;
        font-size: 0.875rem;
    }

    .stat-value {
        font-weight: 600;
        color: #111827;
    }

    .severity-meter {
        margin-top: 1rem;
    }

    .severity-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: #374151;
    }

    .severity-bar {
        height: 8px;
        background: #E5E7EB;
        border-radius: 4px;
        overflow: hidden;
    }

    .severity-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .severity-low { background: #10B981; }
    .severity-medium { background: #F59E0B; }
    .severity-high { background: #DC143C; }

    .hotspot-actions {
        padding: 1rem 1.25rem;
        background: #F9FAFB;
        display: flex;
        gap: 0.5rem;
        border-top: 1px solid #E5E7EB;
    }

    /* Modern Flat Buttons */
    .btn {
        padding: 0.625rem 1.25rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: #003087;
        color: white;
        border: 1px solid #003087;
    }

    .btn-primary:hover {
        background: #002366;
        transform: translateY(-1px);
    }

    .btn-outline {
        background: white;
        color: #374151;
        border: 1.5px solid #D1D5DB;
    }

    .btn-outline:hover {
        background: #003087;
        border-color: #003087;
        color: white;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
    }

    /* View Toggle - Flat Design */
    .view-toggle {
        display: flex;
        background: #F3F4F6;
        border-radius: 6px;
        padding: 0.25rem;
        margin-bottom: 1rem;
        border: 1px solid #E5E7EB;
    }

    .view-option {
        flex: 1;
        padding: 0.5rem 1rem;
        text-align: center;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6B7280;
    }

    .view-option.active {
        background: #003087;
        color: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    /* Results Summary - Clean */
    .results-summary {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        margin-bottom: 1rem;
        border: 1px solid #E5E7EB;
    }

    .results-summary-text {
        color: #374151;
        font-size: 0.9375rem;
        font-weight: 500;
    }

    .results-summary-text span {
        color: #003087;
        font-weight: 600;
    }

    /* Pagination - Modern Flat */
    .pagination-container {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        border: 1px solid #E5E7EB;
    }

    .pagination-info {
        color: #6B7280;
        font-size: 0.875rem;
    }

    .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #pageInfo {
        padding: 0 1rem;
        font-weight: 600;
        color: #111827;
        font-size: 0.875rem;
    }

    #itemsPerPage {
        padding: 0.5rem 0.75rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
    }

    /* Loading & Empty States */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #E5E7EB;
        border-top: 2px solid #003087;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .empty-state, .no-results {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        border: 1px solid #E5E7EB;
    }

    .empty-state h3, .no-results h4 {
        color: #374151;
        margin-bottom: 0.75rem;
    }

    .empty-state p, .no-results p {
        color: #6B7280;
        margin-bottom: 1rem;
    }

    /* Municipality Tooltip */
    .municipality-hover {
        cursor: help;
        position: relative;
        border-bottom: 1px dotted #9CA3AF;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .municipality-hover:hover {
        color: #003087;
        border-bottom-color: #003087;
    }

    .info-icon {
        opacity: 0.6;
        transition: opacity 0.2s;
    }

    .municipality-hover:hover .info-icon {
        opacity: 1;
    }

    .municipality-hover::after {
        content: attr(data-municipalities);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #1F2937;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        white-space: normal;
        max-width: 300px;
        text-align: center;
        line-height: 1.4;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        z-index: 1000;
        margin-bottom: 0.5rem;
    }

    .municipality-hover:hover::after {
        opacity: 1;
    }

    /* List View Styles */
    .hotspots-grid.view-list {
        grid-template-columns: 1fr;
    }

    .hotspot-card.view-list {
        display: flex;
        min-height: auto;
    }

    .hotspot-card.view-list .hotspot-header {
        flex: 0 0 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .hotspot-card.view-list .hotspot-body {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        align-items: center;
    }

    .hotspot-card.view-list .hotspot-actions {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 0.5rem;
    }

    .hotspot-card.view-list .severity-meter {
        margin-top: 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .hotspots-grid {
            grid-template-columns: 1fr;
        }

        .hotspots-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .filters-grid {
            grid-template-columns: 1fr;
        }

        .pagination-container {
            flex-direction: column;
            align-items: stretch;
        }

        .pagination-controls {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="hotspots-header">
    <div>
        <h2 style="color: #111827; font-size: 1.75rem; font-weight: 700; margin: 0 0 0.5rem 0;">üî¥ Accident Hotspots</h2>
        <p style="color: #6B7280; margin: 0;">High-risk areas identified by AGNES clustering algorithm ‚Ä¢ {{ hotspots.count }} hotspots detected</p>
    </div>
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
        <button class="btn btn-outline" onclick="window.location.href='{% url 'map_view' %}'">
            <span>üó∫Ô∏è</span> View on Map
        </button>
        <button class="btn btn-primary" onclick="exportHotspots()">
            <span>üì•</span> Export Report
        </button>
    </div>
</div>

<!-- View Toggle -->
<div class="view-toggle">
    <div class="view-option active" onclick="switchView('grid')">üìä Grid View</div>
    <div class="view-option" onclick="switchView('list')">üìã List View</div>
</div>

<!-- Summary Cards -->
<div class="summary-cards">
    <div class="summary-card">
        <h3>{{ hotspots.count }}</h3>
        <p>Total Hotspots</p>
    </div>
    <div class="summary-card">
        <h3>{{ total_accidents }}</h3>
        <p>Total Accidents</p>
    </div>
    <div class="summary-card">
        <h3>{{ total_casualties }}</h3>
        <p>Total Casualties</p>
    </div>
    <div class="summary-card">
        <h3>{{ critical_count }}</h3>
        <p>Critical Severity (70+)</p>
    </div>
</div>

<!-- Enhanced Filters Section -->
<div class="filters-section">
    <div class="filters-header">
        <h3>Search & Filter Hotspots</h3>
        <button type="button" class="btn btn-outline btn-sm" onclick="clearAllFiltersAndSearch()">
            Clear All
        </button>
    </div>

    <!-- Search Bar -->
    <div style="margin-bottom: 1.25rem;">
        <label style="display: block; font-weight: 500; color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">
            Search Hotspots
        </label>
        <div style="display: flex; gap: 0.5rem;">
            <div style="position: relative; flex: 1;">
                <input type="text"
                       id="hotspotSearch"
                       placeholder="Search by location, cluster ID, or municipality..."
                       onkeypress="if(event.key==='Enter') performSearch()">
                <i class="fas fa-search search-icon"></i>
            </div>
            <button onclick="performSearch()" class="btn btn-primary" style="padding: 0.75rem 1.75rem; white-space: nowrap;">
                üîç Search
            </button>
        </div>
    </div>

    <!-- Filter Grid -->
    <div class="filters-grid">
        <div class="filter-group">
            <label for="province">Province</label>
            <select name="province" id="province" onchange="updateMunicipalityDropdown(); applyClientSideFilters();">
                <option value="">All Provinces</option>
                {% for prov in provinces %}
                <option value="{{ prov }}">{{ prov }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="municipality">Municipality</label>
            <select name="municipality" id="municipality" onchange="applyClientSideFilters()">
                <option value="">All Municipalities</option>
                {% for mun in municipalities %}
                <option value="{{ mun }}">{{ mun }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="min_severity">Minimum Severity</label>
            <select name="min_severity" id="min_severity" onchange="applyClientSideFilters()">
                <option value="">All Levels</option>
                <option value="70">Critical (70+)</option>
                <option value="50">High (50+)</option>
                <option value="30">Medium (30+)</option>
                <option value="0">Low (0+)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="min_accidents">Minimum Accidents</label>
            <select name="min_accidents" id="min_accidents" onchange="applyClientSideFilters()">
                <option value="">All Sizes</option>
                <option value="50">50+ accidents</option>
                <option value="20">20+ accidents</option>
                <option value="10">10+ accidents</option>
                <option value="5">5+ accidents</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="sort_by">Sort By</label>
            <select name="sort_by" id="sort_by" onchange="handleSortChange()">
                <option value="">Default Order</option>
                <option value="severity">Severity (High to Low)</option>
                <option value="accidents">Accidents (Most to Least)</option>
            </select>
        </div>
    </div>

    <!-- Active Filters Display -->
    <div class="active-filters" id="activeFilters">
        <!-- Active filters displayed dynamically -->
    </div>
</div>

<!-- Results Summary -->
<div class="results-summary">
    <div class="results-summary-text">
        Page <span id="currentlyShowing">0</span> of <span id="totalFiltered">{{ hotspots.count }}</span> items
    </div>
</div>

<!-- Pagination Controls -->
<div class="pagination-container">
    <div class="pagination-info">
        Page <span id="showingCount">0</span> of <span id="totalCount">{{ hotspots.count }}</span> items
    </div>
    <div class="pagination-controls">
        <button id="prevPage" onclick="changePage(-1)" class="btn btn-outline btn-sm" disabled>
            ‚Üê Previous
        </button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage" onclick="changePage(1)" class="btn btn-outline btn-sm">
            Next ‚Üí
        </button>
    </div>
    <select id="itemsPerPage" onchange="changeItemsPerPage()">
        <option value="12">12 per page</option>
        <option value="24">24 per page</option>
        <option value="48">48 per page</option>
        <option value="999999">Show all</option>
    </select>
</div>

<!-- Hotspots Grid -->
<div class="hotspots-grid" id="hotspotsContainer">
    {% for hotspot in hotspots %}
    <div class="hotspot-card"
        data-severity="{{ hotspot.severity_score }}"
        data-accidents="{{ hotspot.accident_count }}"
        data-casualties="{{ hotspot.total_casualties }}"
        data-provinces="{{ hotspot.provinces|join:',' }}"
        data-municipalities="{{ hotspot.municipalities|join:', ' }}"
        data-cluster="{{ hotspot.cluster_id }}"
        data-location="{{ hotspot.primary_location }}">
        <div class="hotspot-header">
            <h3 class="hotspot-title">{{ hotspot.primary_location }}</h3>
            <div style="margin-top: 0.5rem;">
                <span class="risk-badge {% if hotspot.severity_score >= 70 %}risk-critical{% elif hotspot.severity_score >= 50 %}risk-high{% elif hotspot.severity_score >= 30 %}risk-medium{% else %}risk-low{% endif %}">
                    {% if hotspot.severity_score >= 70 %}CRITICAL
                    {% elif hotspot.severity_score >= 50 %}HIGH
                    {% elif hotspot.severity_score >= 30 %}MEDIUM
                    {% else %}LOW{% endif %} RISK
                </span>
            </div>
        </div>

        <div class="hotspot-body">
            <div class="hotspot-stat">
                <span class="stat-label">Cluster ID</span>
                <span class="stat-value">#{{ hotspot.cluster_id }}</span>
            </div>
            <div class="hotspot-stat">
                <span class="stat-label">Total Accidents</span>
                <span class="stat-value">{{ hotspot.accident_count }}</span>
            </div>
            <div class="hotspot-stat">
                <span class="stat-label">Total Casualties</span>
                <span class="stat-value">{{ hotspot.total_casualties }}</span>
            </div>
            <div class="hotspot-stat">
                <span class="stat-label">Fatal Accidents</span>
                <span class="stat-value" style="color: #DC143C;">
                    {{ hotspot.killed_count|default:"0" }}
                </span>
            </div>
            <div class="hotspot-stat">
                <span class="stat-label">Municipalities</span>
                <span class="stat-value municipality-hover"
                      data-municipalities="Areas: {{ hotspot.municipalities|join:', ' }}">
                    <strong>{{ hotspot.municipalities|length }}</strong> area{% if hotspot.municipalities|length > 1 %}s{% endif %}
                    <span class="info-icon">üîç</span>
                </span>
            </div>

            <div class="severity-meter">
                <div class="severity-label">
                    <span>Severity Score</span>
                    <strong>{{ hotspot.severity_score|floatformat:1 }}/100</strong>
                </div>
                <div class="severity-bar">
                    <div class="severity-fill {% if hotspot.severity_score >= 70 %}severity-high{% elif hotspot.severity_score >= 40 %}severity-medium{% else %}severity-low{% endif %}"
                         style="width: {{ hotspot.severity_score }}%">
                    </div>
                </div>
            </div>
        </div>

        <div class="hotspot-actions">
            <a href="{% url 'hotspot_detail' hotspot.cluster_id %}" class="btn btn-primary btn-sm">
                View Details
            </a>
            <button class="btn btn-outline btn-sm" onclick="viewOnMap({{ hotspot.center_latitude }}, {{ hotspot.center_longitude }})">
                Show on Map
            </button>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <h3>No hotspots found</h3>
        <p>Try running the clustering algorithm or adjusting your filters.</p>
        <button class="btn btn-primary" onclick="window.location.href='/admin/accidents/clusteringjob/'">
            Run Clustering
        </button>
    </div>
    {% endfor %}
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,0.2);">
        <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 1rem;"></div>
        <p style="margin: 0; color: #374151;">Loading hotspots...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Province to Municipality mapping
    const provinceMunicipalityMap = {{ province_municipality_map|safe }};
    const allMunicipalities = {{ municipalities|safe }};

    // Pagination state
    let currentPage = 1;
    let itemsPerPage = 12;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeHotspotCards();
        updatePagination();
        updateActiveFilters();
    });

    // CASCADE FILTERING - Update municipality dropdown
    function updateMunicipalityDropdown() {
        const provinceSelect = document.getElementById('province');
        const municipalitySelect = document.getElementById('municipality');
        const selectedProvince = provinceSelect.value;

        municipalitySelect.value = '';
        municipalitySelect.innerHTML = '<option value="">All Municipalities</option>';

        let municipalitiesToShow = selectedProvince ?
            (provinceMunicipalityMap[selectedProvince] || []) :
            allMunicipalities;

        municipalitiesToShow.forEach(function(mun) {
            const option = document.createElement('option');
            option.value = mun;
            option.textContent = mun;
            municipalitySelect.appendChild(option);
        });
    }

    // CLIENT-SIDE FILTERING
    function applyClientSideFilters() {
        const cards = Array.from(document.getElementsByClassName('hotspot-card'));
        const searchTerm = document.getElementById('hotspotSearch').value.toLowerCase().trim();
        const provinceFilter = document.getElementById('province').value.toLowerCase();
        const severityFilter = document.getElementById('min_severity').value;
        const accidentsFilter = document.getElementById('min_accidents').value;
        const municipalityFilter = document.getElementById('municipality').value.toLowerCase();

        let visibleCount = 0;

        cards.forEach(card => {
            const location = (card.getAttribute('data-location') || '').toLowerCase();
            const clusterId = (card.getAttribute('data-cluster') || '').toString().toLowerCase();
            const municipalities = (card.getAttribute('data-municipalities') || '').toLowerCase();
            const provinces = (card.getAttribute('data-provinces') || '').toLowerCase();
            const severity = parseFloat(card.getAttribute('data-severity')) || 0;
            const accidents = parseInt(card.getAttribute('data-accidents')) || 0;

            const searchMatch = searchTerm === '' ||
                              location.includes(searchTerm) ||
                              clusterId.includes(searchTerm) ||
                              municipalities.includes(searchTerm) ||
                              provinces.includes(searchTerm);

            const provinceMatch = provinceFilter === '' || provinces.includes(provinceFilter);
            const severityMatch = severityFilter === '' || severity >= parseFloat(severityFilter);
            const accidentsMatch = accidentsFilter === '' || accidents >= parseInt(accidentsFilter);
            const municipalityMatch = municipalityFilter === '' || municipalities.includes(municipalityFilter);

            const allMatch = searchMatch && provinceMatch && severityMatch && accidentsMatch && municipalityMatch;

            if (allMatch) {
                card.setAttribute('data-search-visible', 'true');
                visibleCount++;
            } else {
                card.setAttribute('data-search-visible', 'false');
            }
        });

        if (visibleCount === 0) {
            showNoResultsMessage('your filters');
        } else {
            hideNoResultsMessage();
        }

        updateActiveFilters();
        currentPage = 1;
        updatePagination();
    }

    function clearAllFiltersAndSearch() {
        document.getElementById('hotspotSearch').value = '';
        document.getElementById('province').value = '';
        document.getElementById('min_severity').value = '';
        document.getElementById('min_accidents').value = '';
        document.getElementById('municipality').value = '';
        const sortDropdown = document.getElementById('sort_by');
        const wasSorted = sortDropdown.value !== '';
        sortDropdown.value = '';

        updateMunicipalityDropdown();

        const cards = document.getElementsByClassName('hotspot-card');
        Array.from(cards).forEach(card => {
            card.setAttribute('data-search-visible', 'true');
        });

        hideNoResultsMessage();
        updateActiveFilters();
        currentPage = 1;

        if (wasSorted) {
            window.location.reload();
        } else {
            updatePagination();
        }
    }

    function handleSortChange() {
        const sortValue = document.getElementById('sort_by').value;

        if (!sortValue) {
            window.location.reload();
            return;
        }

        const container = document.getElementById('hotspotsContainer');
        const cards = Array.from(container.getElementsByClassName('hotspot-card'));

        // Sort cards based on selected criteria
        cards.sort((a, b) => {
            if (sortValue === 'accidents') {
                return parseInt(b.getAttribute('data-accidents')) - parseInt(a.getAttribute('data-accidents'));
            } else if (sortValue === 'severity') {
                return parseFloat(b.getAttribute('data-severity')) - parseFloat(a.getAttribute('data-severity'));
            }
            return 0;
        });

        // Re-append cards in sorted order
        cards.forEach(card => container.appendChild(card));

        // Reset to page 1 and update display
        currentPage = 1;
        updatePagination();
        updateActiveFilters();

        // Scroll to top of hotspots grid to show sorted results
        const filtersSection = document.querySelector('.filters-section');
        if (filtersSection) {
            filtersSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function updateActiveFilters() {
        const activeFilters = document.getElementById('activeFilters');
        const searchTerm = document.getElementById('hotspotSearch').value.trim();
        const province = document.getElementById('province').value;
        const minSeverity = document.getElementById('min_severity').value;
        const minAccidents = document.getElementById('min_accidents').value;
        const municipality = document.getElementById('municipality').value;
        const sortBy = document.getElementById('sort_by').value;

        let activeFiltersHTML = '';

        if (searchTerm) {
            activeFiltersHTML += `<div class="filter-tag">
                Search: "${searchTerm}"
                <button onclick="removeSearchFilter()">√ó</button>
            </div>`;
        }

        if (province) {
            activeFiltersHTML += `<div class="filter-tag">
                Province: ${province}
                <button onclick="removeFilter('province')">√ó</button>
            </div>`;
        }

        if (municipality) {
            activeFiltersHTML += `<div class="filter-tag">
                Municipality: ${municipality}
                <button onclick="removeFilter('municipality')">√ó</button>
            </div>`;
        }

        if (minSeverity) {
            let level = 'All';
            if (minSeverity === '70') level = 'Critical (70+)';
            else if (minSeverity === '50') level = 'High (50+)';
            else if (minSeverity === '30') level = 'Medium (30+)';
            else if (minSeverity === '0') level = 'Low (0+)';

            activeFiltersHTML += `<div class="filter-tag">
                Min Severity: ${level}
                <button onclick="removeFilter('min_severity')">√ó</button>
            </div>`;
        }

        if (minAccidents) {
            activeFiltersHTML += `<div class="filter-tag">
                Min Accidents: ${minAccidents}+
                <button onclick="removeFilter('min_accidents')">√ó</button>
            </div>`;
        }

        if (sortBy) {
            const sortLabel = sortBy === 'accidents' ? 'Sorted by Accidents' : 'Sorted by Severity';
            activeFiltersHTML += `<div class="filter-tag">
                ${sortLabel}
                <button onclick="removeFilter('sort_by')">√ó</button>
            </div>`;
        }

        activeFilters.innerHTML = activeFiltersHTML;
    }

    function removeSearchFilter() {
        document.getElementById('hotspotSearch').value = '';
        applyClientSideFilters();
    }

    function removeFilter(filterName) {
        document.getElementById(filterName).value = '';

        if (filterName === 'province') {
            updateMunicipalityDropdown();
        }

        if (filterName === 'sort_by') {
            window.location.reload();
            return;
        }

        applyClientSideFilters();
    }

    function initializeHotspotCards() {
        const cards = document.getElementsByClassName('hotspot-card');
        Array.from(cards).forEach(card => {
            card.setAttribute('data-search-visible', 'true');
        });
    }

    function performSearch() {
        applyClientSideFilters();
    }

    function updatePagination() {
        const cards = Array.from(document.getElementsByClassName('hotspot-card'));
        const searchVisibleCards = cards.filter(card => card.getAttribute('data-search-visible') !== 'false');

        const totalItems = searchVisibleCards.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;

        cards.forEach(card => card.style.display = 'none');

        searchVisibleCards.forEach((card, index) => {
            if (index >= startIndex && index < endIndex) {
                card.style.display = '';
            }
        });

        document.getElementById('currentlyShowing').textContent = currentPage;
        document.getElementById('totalFiltered').textContent = totalPages || 1;
        document.getElementById('showingCount').textContent = Math.min(endIndex, totalItems);
        document.getElementById('totalCount').textContent = totalItems;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;

        document.getElementById('prevPage').disabled = currentPage <= 1;
        document.getElementById('nextPage').disabled = currentPage >= totalPages;
    }

    function changePage(direction) {
        currentPage += direction;
        updatePagination();

        const filtersSection = document.querySelector('.filters-section');
        if (filtersSection) {
            filtersSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function changeItemsPerPage() {
        itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
        currentPage = 1;
        updatePagination();
    }

    function switchView(viewType) {
        const container = document.getElementById('hotspotsContainer');
        const cards = container.getElementsByClassName('hotspot-card');
        const options = document.querySelectorAll('.view-option');

        options.forEach(opt => opt.classList.remove('active'));
        event.target.classList.add('active');

        container.className = 'hotspots-grid';
        if (viewType === 'list') {
            container.classList.add('view-list');
            Array.from(cards).forEach(card => card.classList.add('view-list'));
        } else {
            Array.from(cards).forEach(card => card.classList.remove('view-list'));
        }
    }

    function viewOnMap(lat, lng) {
        window.location.href = `/map/?lat=${lat}&lng=${lng}&zoom=13`;
    }

    function exportHotspots() {
        const data = [
            {% for hotspot in hotspots %}
            {
                'Rank': {{ forloop.counter }},
                'Cluster ID': {{ hotspot.cluster_id }},
                'Location': '{{ hotspot.primary_location }}',
                'Accidents': {{ hotspot.accident_count }},
                'Casualties': {{ hotspot.total_casualties }},
                'Fatal Accidents': {{ hotspot.killed_count|default:0 }},
                'Severity': {{ hotspot.severity_score|floatformat:1 }},
                'Municipalities': '{{ hotspot.municipalities|join:", " }}',
                'Latitude': {{ hotspot.center_latitude }},
                'Longitude': {{ hotspot.center_longitude }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        if (typeof AGNESSystem !== 'undefined') {
            AGNESSystem.exportToCSV(data, 'accident_hotspots_report.csv');
            AGNESSystem.showNotification('Hotspots exported successfully', 'success');
        } else {
            const csv = convertToCSV(data);
            downloadCSV(csv, 'accident_hotspots_report.csv');
        }
    }

    function showNoResultsMessage(searchTerm) {
        let noResultsDiv = document.getElementById('noResultsMessage');
        if (!noResultsDiv) {
            noResultsDiv = document.createElement('div');
            noResultsDiv.id = 'noResultsMessage';
            noResultsDiv.className = 'no-results';
            noResultsDiv.innerHTML = `
                <h4>üîç No hotspots found</h4>
                <p>No hotspots match "<strong>${searchTerm}</strong>"</p>
                <p style="font-size: 0.875rem; color: #6B7280; margin-top: 0.5rem;">
                    Try searching by location name, cluster ID, or municipality
                </p>
            `;
            document.getElementById('hotspotsContainer').appendChild(noResultsDiv);
        } else {
            noResultsDiv.innerHTML = `
                <h4>üîç No hotspots found</h4>
                <p>No hotspots match "<strong>${searchTerm}</strong>"</p>
                <p style="font-size: 0.875rem; color: #6B7280; margin-top: 0.5rem;">
                    Try searching by location name, cluster ID, or municipality
                </p>
            `;
        }
    }

    function hideNoResultsMessage() {
        const noResultsDiv = document.getElementById('noResultsMessage');
        if (noResultsDiv) {
            noResultsDiv.remove();
        }
    }

    function convertToCSV(data) {
        if (!data || data.length === 0) return '';

        const headers = Object.keys(data[0]);
        const csvRows = [headers.join(',')];

        for (const row of data) {
            const values = headers.map(header => {
                const value = row[header];
                return `"${value}"`;
            });
            csvRows.push(values.join(','));
        }

        return csvRows.join('\n');
    }

    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}
