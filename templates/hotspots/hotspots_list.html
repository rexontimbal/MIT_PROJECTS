{% extends 'base.html' %}
{% load static %}

{% block title %}Accident Hotspots{% endblock %}

{% block breadcrumb_items %}
<span> / Hotspots</span>
{% endblock %}

{% block extra_css %}
<style>
    /* ===== COHESIVE COLOR SCHEME FOR HOTSPOTS ===== */
    :root {
        /* Primary Colors - Danger/Warning Theme */
        --hotspot-primary: #DC143C;      /* Crimson Red - Critical */
        --hotspot-secondary: #F59E0B;    /* Amber - Warning */
        --hotspot-accent: #FF6B35;       /* Coral - Highlights */
        --hotspot-safe: #10B981;         /* Emerald - Low severity */

        /* Neutral Colors */
        --text-primary: #111827;         /* Dark Gray */
        --text-secondary: #6B7280;       /* Medium Gray */
        --border-light: #E5E7EB;         /* Light Gray */
        --border-medium: #D1D5DB;        /* Medium Border */
        --bg-light: #F9FAFB;             /* Very Light Background */

        /* Button Colors */
        --btn-primary-bg: #DC143C;
        --btn-primary-hover: #B01030;
        --btn-outline-border: #D1D5DB;
        --btn-outline-hover: #DC143C;
    }

    /* ===== MODERN FLAT UI STYLING ===== */

    /* Hero Header */
    .page-hero {
        background: linear-gradient(135deg, var(--hotspot-primary) 0%, var(--hotspot-accent) 100%);
        color: white;
        padding: 35px;
        border-radius: 15px;
        margin-bottom: 25px;
        box-shadow: 0 4px 12px rgba(220, 20, 60, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .page-hero-content {
        flex: 1;
        min-width: 300px;
    }

    .page-hero h1 {
        font-size: 2.2rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .page-hero p {
        font-size: 1.1rem;
        opacity: 0.95;
        margin: 0;
    }

    .hero-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    .hero-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .hero-actions .btn {
        padding: 12px 24px;
        font-size: 0.95rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        border: none;
        cursor: pointer;
    }

    .hero-actions .btn-light {
        background: rgba(255, 255, 255, 0.95);
        color: var(--hotspot-primary);
        border: 2px solid transparent;
    }

    .hero-actions .btn-light:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .hero-actions .btn-outline-light {
        background: transparent;
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.8);
    }

    .hero-actions .btn-outline-light:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: white;
        transform: translateY(-2px);
    }

    .hotspots-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    /* Clean Search & Filters Section */
    .filters-section {
        background: white;
        padding: 1.75rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        margin-bottom: 1.5rem;
        border: 1px solid #E5E7EB;
        border-top: 2px solid var(--hotspot-primary);
    }

    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }

    .filters-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
    }

    /* Search Input - Modern & Flat */
    #hotspotSearch {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.9375rem;
        transition: all 0.2s ease;
        background: white;
    }

    #hotspotSearch:hover {
        border-color: #9CA3AF;
    }

    #hotspotSearch:focus {
        outline: none;
        border-color: var(--hotspot-primary);
        box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.08);
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6B7280;
        pointer-events: none;
    }

    /* Filter Grid - Clean Layout */
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.25rem;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .filter-group label {
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
    }

    .filter-group select {
        padding: 0.625rem 0.875rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: white;
        cursor: pointer;
    }

    .filter-group select:hover {
        border-color: #9CA3AF;
    }

    .filter-group select:focus {
        outline: none;
        border-color: var(--hotspot-primary);
        box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.08);
    }

    /* Active Filters Tags */
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #E5E7EB;
    }

    .filter-tag {
        background: #FEE2E2;
        color: #991B1B;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        border: 1px solid #FECACA;
    }

    .filter-tag button {
        background: none;
        border: none;
        color: var(--hotspot-primary);
        cursor: pointer;
        font-weight: 600;
        font-size: 1.125rem;
        line-height: 1;
        padding: 0;
        margin-left: 0.25rem;
        border-radius: 4px;
        transition: all 0.3s ease;
        width: 22px;
        height: 22px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .filter-tag button:hover {
        background: var(--hotspot-primary);
        color: white;
        transform: scale(1.2) rotate(90deg);
        box-shadow: 0 2px 6px rgba(220, 20, 60, 0.3);
    }

    /* Summary Cards - Flat & Clean */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .summary-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        text-align: center;
        transition: all 0.2s ease;
        border: 1px solid #E5E7EB;
    }

    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .summary-card h3 {
        font-size: 2rem;
        color: var(--hotspot-primary);
        margin-bottom: 0.5rem;
        font-weight: 700;
    }

    .summary-card p {
        color: #6B7280;
        font-size: 0.875rem;
        margin: 0;
    }

    /* Hotspot Cards - Flat Modern Design */
    .hotspots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .hotspot-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        overflow: hidden;
        transition: all 0.2s ease;
        border: 1px solid var(--border-light);
        border-left: 3px solid var(--hotspot-primary);
        position: relative;
    }

    .hotspot-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .hotspot-header {
        background: linear-gradient(135deg, var(--hotspot-primary) 0%, var(--hotspot-accent) 100%);
        color: white;
        padding: 0.875rem 1rem;
        position: relative;
    }

    .hotspot-title {
        font-size: 1rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
    }

    .risk-badge {
        padding: 0.25rem 0.625rem;
        border-radius: 4px;
        font-size: 0.688rem;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }

    .risk-critical {
        background: rgba(255, 255, 255, 0.95);
        color: #B8112C;
        border: 2px solid rgba(255, 255, 255, 0.95);
        font-weight: 700;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
    }
    .risk-high {
        background: rgba(245, 158, 11, 0.95);
        color: white;
        font-weight: 700;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    .risk-medium {
        background: rgba(16, 185, 129, 0.95);
        color: white;
        font-weight: 700;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    .risk-low {
        background: rgba(107, 114, 128, 0.95);
        color: white;
        font-weight: 700;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .hotspot-body {
        padding: 0.875rem 1rem;
    }

    .hotspot-stat {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #E5E7EB;
    }

    .hotspot-stat:last-of-type {
        border-bottom: none;
    }

    .stat-label {
        color: #6B7280;
        font-size: 0.813rem;
    }

    .stat-value {
        font-weight: 600;
        color: #111827;
        font-size: 0.813rem;
    }

    .severity-meter {
        margin-top: 0.75rem;
    }

    .severity-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.375rem;
        font-size: 0.813rem;
        color: #374151;
    }

    .severity-bar {
        height: 6px;
        background: #E5E7EB;
        border-radius: 3px;
        overflow: hidden;
    }

    .severity-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .severity-low { background: #10B981; }
    .severity-medium { background: #F59E0B; }
    .severity-high { background: #DC143C; }

    .hotspot-actions {
        padding: 0.75rem 1rem;
        background: #F9FAFB;
        display: flex;
        gap: 0.5rem;
        border-top: 1px solid #E5E7EB;
    }

    /* Modern Flat Buttons */
    .btn {
        padding: 0.625rem 1.25rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--btn-primary-bg);
        color: white;
        border: 1px solid var(--btn-primary-bg);
    }

    .btn-primary:hover {
        background: var(--btn-primary-hover);
        border-color: var(--btn-primary-hover);
        transform: translateY(-1px);
    }

    .btn-outline {
        background: white;
        color: var(--text-secondary);
        border: 1.5px solid var(--btn-outline-border);
    }

    .btn-outline:hover {
        background: var(--btn-outline-hover);
        border-color: var(--btn-outline-hover);
        color: white;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
    }

    /* View Toggle - Mini Compact Design */
    .view-toggle {
        display: flex;
        background: #F3F4F6;
        border-radius: 6px;
        padding: 0.15rem;
        margin-bottom: 0.75rem;
        border: 1px solid #E5E7EB;
    }

    .view-option {
        flex: 1;
        padding: 0.3rem 0.75rem;
        text-align: center;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.8rem;
        font-weight: 500;
        color: #6B7280;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .view-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s ease;
    }

    .view-option.active::before {
        left: 100%;
    }

    .view-option:hover:not(.active) {
        border-color: var(--hotspot-primary);
        color: var(--hotspot-primary);
        background: rgba(220, 20, 60, 0.05);
        transform: translateY(-1px);
    }

    .view-option.active {
        background: var(--hotspot-primary);
        color: white;
        box-shadow: 0 2px 8px rgba(220, 20, 60, 0.25);
        border-color: var(--hotspot-primary);
        transform: scale(1.02);
    }

    /* Results Summary - Clean */
    .results-summary {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        margin-bottom: 1rem;
        border: 1px solid #E5E7EB;
    }

    .results-summary-text {
        color: #374151;
        font-size: 0.9375rem;
        font-weight: 500;
    }

    .results-summary-text span {
        color: #003087;
        font-weight: 600;
    }

    /* Pagination - Modern Flat */
    .pagination-container {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        border: 1px solid #E5E7EB;
        border-top: 2px solid var(--hotspot-primary);
    }

    .pagination-info {
        color: #6B7280;
        font-size: 0.875rem;
    }

    .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #pageInfo {
        padding: 0 1rem;
        font-weight: 600;
        color: #111827;
        font-size: 0.875rem;
    }

    #itemsPerPage {
        padding: 0.5rem 0.75rem;
        border: 1.5px solid #D1D5DB;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
    }

    /* Loading & Empty States */
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #E5E7EB;
        border-top: 2px solid #003087;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .empty-state, .no-results {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        border: 1px solid #E5E7EB;
    }

    .empty-state h3, .no-results h4 {
        color: #374151;
        margin-bottom: 0.75rem;
    }

    .empty-state p, .no-results p {
        color: #6B7280;
        margin-bottom: 1rem;
    }

    /* Municipality Tooltip */
    .municipality-hover {
        cursor: help;
        position: relative;
        border-bottom: 1px dotted #9CA3AF;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .municipality-hover:hover {
        color: #003087;
        border-bottom-color: #003087;
    }

    .info-icon {
        opacity: 0.6;
        transition: opacity 0.2s;
    }

    .municipality-hover:hover .info-icon {
        opacity: 1;
    }

    .municipality-hover::after {
        content: attr(data-municipalities);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #1F2937;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        white-space: normal;
        max-width: 300px;
        text-align: center;
        line-height: 1.4;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        z-index: 1000;
        margin-bottom: 0.5rem;
    }

    .municipality-hover:hover::after {
        opacity: 1;
    }

    /* List View Styles */
    .hotspots-grid.view-list {
        grid-template-columns: 1fr;
    }

    .hotspot-card.view-list {
        display: flex;
        min-height: auto;
    }

    .hotspot-card.view-list .hotspot-header {
        flex: 0 0 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .hotspot-card.view-list .hotspot-body {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        align-items: center;
    }

    .hotspot-card.view-list .hotspot-actions {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 0.5rem;
    }

    .hotspot-card.view-list .severity-meter {
        margin-top: 0;
    }

    /* ===== HOTSPOT MODAL STYLES ===== */
    .hotspot-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(4px);
        animation: fadeIn 0.3s ease;
    }

    .hotspot-modal.show {
        display: flex;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 580px;
        max-height: 92vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        position: relative;
        animation: slideUp 0.4s ease;
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: white;
        border: none;
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.2s ease;
        z-index: 10;
        color: #6B7280;
    }

    .modal-close:hover {
        background: #F3F4F6;
        color: #111827;
        transform: rotate(90deg);
    }

    .modal-header {
        background: linear-gradient(135deg, var(--hotspot-primary) 0%, var(--hotspot-accent) 100%);
        color: white;
        padding: 1.5rem 1.25rem 1.25rem;
        border-radius: 12px 12px 0 0;
        position: relative;
    }

    .modal-title {
        font-size: 1.35rem;
        font-weight: 700;
        margin: 0 0 0.75rem 0;
        padding-right: 2.5rem;
    }

    .modal-badge {
        padding: 0.375rem 0.875rem;
        border-radius: 6px;
        font-size: 0.813rem;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
    }

    .modal-body {
        padding: 1.25rem;
    }

    .modal-stat-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-bottom: 1.25rem;
    }

    .modal-stat-card {
        background: #F9FAFB;
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid #E5E7EB;
    }

    .modal-stat-label {
        color: #6B7280;
        font-size: 0.813rem;
        margin-bottom: 0.375rem;
        display: block;
    }

    .modal-stat-value {
        font-size: 1.35rem;
        font-weight: 700;
        color: #111827;
    }

    .modal-stat-value.critical {
        color: #DC143C;
    }

    .modal-section {
        margin-bottom: 1.25rem;
    }

    .modal-section-title {
        font-size: 0.9375rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.625rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-municipalities {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .modal-municipality-tag {
        background: #E8F0FE;
        color: #003087;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.813rem;
        font-weight: 500;
    }

    .modal-severity {
        background: #F9FAFB;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #E5E7EB;
    }

    .modal-severity-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.625rem;
        font-size: 0.9375rem;
        color: #374151;
        font-weight: 500;
    }

    .modal-severity-score {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--hotspot-primary);
    }

    .modal-severity-bar {
        height: 10px;
        background: #E5E7EB;
        border-radius: 6px;
        overflow: hidden;
    }

    .modal-severity-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.6s ease;
    }

    .modal-actions {
        padding: 1rem 1.25rem;
        background: #F9FAFB;
        border-top: 1px solid #E5E7EB;
        display: flex;
        gap: 0.75rem;
        border-radius: 0 0 12px 12px;
    }

    .modal-btn {
        flex: 1;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .modal-btn-primary {
        background: var(--hotspot-primary);
        color: white;
    }

    .modal-btn-primary:hover {
        background: var(--btn-primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 20, 60, 0.3);
    }

    .modal-btn-secondary {
        background: white;
        color: #374151;
        border: 2px solid #D1D5DB;
    }

    .modal-btn-secondary:hover {
        background: #F9FAFB;
        border-color: #9CA3AF;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .page-hero h1 {
            font-size: 1.6rem;
        }

        .hotspots-grid {
            grid-template-columns: 1fr;
        }

        .hotspots-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .filters-grid {
            grid-template-columns: 1fr;
        }

        .pagination-container {
            flex-direction: column;
            align-items: stretch;
        }

        .pagination-controls {
            justify-content: center;
        }

        .modal-content {
            width: 95%;
            max-height: 95vh;
        }

        .modal-header {
            padding: 1.25rem 1rem 1rem;
        }

        .modal-title {
            font-size: 1.2rem;
            margin-bottom: 0.625rem;
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-stat-grid {
            grid-template-columns: 1fr;
            gap: 0.625rem;
            margin-bottom: 1rem;
        }

        .modal-stat-card {
            padding: 0.625rem;
        }

        .modal-stat-value {
            font-size: 1.25rem;
        }

        .modal-section {
            margin-bottom: 1rem;
        }

        .modal-severity {
            padding: 0.875rem;
        }

        .modal-severity-score {
            font-size: 1.35rem;
        }

        .modal-actions {
            padding: 0.875rem 1rem;
            flex-direction: column;
        }

        .modal-btn {
            padding: 0.75rem 1rem;
        }
    }

    /* ===== SIMPLE LOADING SPINNER (Analytics Style) ===== */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(0, 48, 135, 0.5) 0%, rgba(0, 32, 96, 0.6) 100%);
        backdrop-filter: blur(5px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner-container {
        position: relative;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .spinner-logo {
        position: absolute;
        width: 45px;
        height: 45px;
        z-index: 1;
        animation: pulse 2s ease-in-out infinite;
    }

    .spinner-logo img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        filter: drop-shadow(0 2px 4px rgba(0, 48, 135, 0.3));
    }

    .spinner {
        border: 5px solid rgba(0, 48, 135, 0.1);
        border-top: 5px solid #003087;
        border-right: 5px solid #DC143C;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        animation: spin 1s linear infinite;
    }

    .spinner-inner {
        position: absolute;
        top: 12px;
        left: 12px;
        border: 3px solid rgba(255, 215, 0, 0.3);
        border-top: 3px solid #FFD700;
        border-radius: 50%;
        width: 56px;
        height: 56px;
        animation: spin 1.5s linear infinite reverse;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.9; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Simple Loading Spinner -->
<div class="loading-overlay">
    <div class="spinner-container">
        <div class="spinner-logo">
            <img src="{% static 'images/pnp-logo.png' %}" alt="PNP Logo">
        </div>
        <div class="spinner"></div>
        <div class="spinner-inner"></div>
    </div>
</div>

<!-- Hero Header -->
<div class="page-hero">
    <div class="page-hero-content">
        <h1>
            <i class="fas fa-exclamation-triangle"></i>
            Accident Hotspots
            <span class="hero-badge">{{ hotspots.count }} Detected</span>
        </h1>
        <p>High-risk areas identified by AGNES clustering algorithm across Caraga Region</p>
    </div>
    <div class="hero-actions">
        <button class="btn btn-light" onclick="window.location.href='{% url 'map_view' %}'">
            <i class="fas fa-map-marked-alt"></i>
            View on Map
        </button>
        <button class="btn btn-outline-light" onclick="exportHotspots()">
            <i class="fas fa-download"></i>
            Export Report
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="summary-cards">
    <div class="summary-card">
        <h3>{{ hotspots.count }}</h3>
        <p>Total Hotspots</p>
    </div>
    <div class="summary-card">
        <h3>{{ total_accidents }}</h3>
        <p>Total Accidents</p>
    </div>
    <div class="summary-card">
        <h3>{{ total_casualties }}</h3>
        <p>Total Casualties</p>
    </div>
    <div class="summary-card">
        <h3>{{ critical_count }}</h3>
        <p>Critical Severity (70+)</p>
    </div>
</div>

<!-- Enhanced Filters Section -->
<div class="filters-section">
    <div class="filters-header">
        <h3>Search & Filter Hotspots</h3>
        <button type="button" class="btn btn-outline btn-sm" onclick="clearAllFiltersAndSearch()">
            Clear All
        </button>
    </div>

    <!-- Search Bar -->
    <div style="margin-bottom: 1.25rem;">
        <label style="display: block; font-weight: 500; color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">
            Search Hotspots
        </label>
        <div style="display: flex; gap: 0.5rem;">
            <div style="position: relative; flex: 1;">
                <input type="text"
                       id="hotspotSearch"
                       placeholder="Search by location, cluster ID, or municipality..."
                       onkeypress="if(event.key==='Enter') performSearch()">
                <i class="fas fa-search search-icon"></i>
            </div>
            <button onclick="performSearch()" class="btn btn-primary" style="padding: 0.75rem 1.75rem; white-space: nowrap;">
                üîç Search
            </button>
        </div>
    </div>

    <!-- Filter Grid -->
    <div class="filters-grid">
        <div class="filter-group">
            <label for="province">Province</label>
            <select name="province" id="province" onchange="updateMunicipalityDropdown(); applyClientSideFilters();">
                <option value="">All Provinces</option>
                {% for prov in provinces %}
                <option value="{{ prov }}">{{ prov }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="municipality">Municipality</label>
            <select name="municipality" id="municipality" onchange="applyClientSideFilters()">
                <option value="">All Municipalities</option>
                {% for mun in municipalities %}
                <option value="{{ mun }}">{{ mun }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="min_severity">Minimum Severity</label>
            <select name="min_severity" id="min_severity" onchange="applyClientSideFilters()">
                <option value="">All Levels</option>
                <option value="70">Critical (70+)</option>
                <option value="50">High (50+)</option>
                <option value="30">Medium (30+)</option>
                <option value="0">Low (0+)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="min_accidents">Minimum Accidents</label>
            <select name="min_accidents" id="min_accidents" onchange="applyClientSideFilters()">
                <option value="">All Sizes</option>
                <option value="50">50+ accidents</option>
                <option value="20">20+ accidents</option>
                <option value="10">10+ accidents</option>
                <option value="5">5+ accidents</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="sort_by">Sort By</label>
            <select name="sort_by" id="sort_by" onchange="handleSortChange()">
                <option value="">Default Order</option>
                <option value="severity">Severity (High to Low)</option>
                <option value="accidents">Accidents (Most to Least)</option>
            </select>
        </div>
    </div>

    <!-- Active Filters Display -->
    <div class="active-filters" id="activeFilters">
        <!-- Active filters displayed dynamically -->
    </div>
</div>

<!-- Pagination Controls -->
<div class="pagination-container">
    <div class="pagination-info">
        Showing <span id="showingStart">1</span>-<span id="showingEnd">12</span> of <span id="totalCount">{{ hotspots.count }}</span> hotspots
    </div>
    <div class="pagination-controls">
        <button id="prevPage" onclick="changePage(-1)" class="btn btn-outline btn-sm" disabled>
            ‚Üê Previous
        </button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage" onclick="changePage(1)" class="btn btn-outline btn-sm">
            Next ‚Üí
        </button>
    </div>
    <select id="itemsPerPage" onchange="changeItemsPerPage()">
        <option value="12">12 per page</option>
        <option value="24">24 per page</option>
        <option value="48">48 per page</option>
        <option value="999999">Show all</option>
    </select>
</div>

<!-- View Toggle (Mini) -->
<div class="view-toggle">
    <div class="view-option active" onclick="switchView('grid')">üìä Grid View</div>
    <div class="view-option" onclick="switchView('list')">üìã List View</div>
</div>

<!-- Hotspots Grid -->
<div class="hotspots-grid" id="hotspotsContainer">
    {% for hotspot in hotspots %}
    <div class="hotspot-card"
        data-severity="{{ hotspot.severity_score }}"
        data-accidents="{{ hotspot.accident_count }}"
        data-casualties="{{ hotspot.total_casualties }}"
        data-provinces="{{ hotspot.provinces|join:',' }}"
        data-municipalities="{{ hotspot.municipalities|join:', ' }}"
        data-cluster="{{ hotspot.cluster_id }}"
        data-location="{{ hotspot.primary_location }}"
        data-killed="{{ hotspot.killed_count|default:'0' }}"
        data-lat="{{ hotspot.center_latitude }}"
        data-lng="{{ hotspot.center_longitude }}"
        onclick="openHotspotModal(this)"
        style="cursor: pointer;"
        title="Click to view details">
        <div class="hotspot-header">
            <h3 class="hotspot-title">{{ hotspot.primary_location }}</h3>
            <div style="margin-top: 0.5rem;">
                <span class="risk-badge {% if hotspot.severity_score >= 70 %}risk-critical{% elif hotspot.severity_score >= 50 %}risk-high{% elif hotspot.severity_score >= 30 %}risk-medium{% else %}risk-low{% endif %}">
                    {% if hotspot.severity_score >= 70 %}CRITICAL
                    {% elif hotspot.severity_score >= 50 %}HIGH
                    {% elif hotspot.severity_score >= 30 %}MEDIUM
                    {% else %}LOW{% endif %} RISK
                </span>
            </div>
        </div>

        <div class="hotspot-body">
            <div class="hotspot-stat">
                <span class="stat-label">Cluster ID</span>
                <span class="stat-value">#{{ hotspot.cluster_id }}</span>
            </div>
            <div class="hotspot-stat">
                <span class="stat-label">Total Accidents</span>
                <span class="stat-value">{{ hotspot.accident_count }}</span>
            </div>
            <div class="hotspot-stat">
                <span class="stat-label">Total Casualties</span>
                <span class="stat-value">{{ hotspot.total_casualties }}</span>
            </div>
            <div class="hotspot-stat">
                <span class="stat-label">Fatal Accidents</span>
                <span class="stat-value" style="color: #DC143C;">
                    {{ hotspot.killed_count|default:"0" }}
                </span>
            </div>
            <div class="hotspot-stat">
                <span class="stat-label">Municipalities</span>
                <span class="stat-value municipality-hover"
                      data-municipalities="Areas: {{ hotspot.municipalities|join:', ' }}">
                    <strong>{{ hotspot.municipalities|length }}</strong> area{% if hotspot.municipalities|length > 1 %}s{% endif %}
                    <span class="info-icon">üîç</span>
                </span>
            </div>

            <div class="severity-meter">
                <div class="severity-label">
                    <span>Severity Score</span>
                    <strong>{{ hotspot.severity_score|floatformat:1 }}/100</strong>
                </div>
                <div class="severity-bar">
                    <div class="severity-fill {% if hotspot.severity_score >= 70 %}severity-high{% elif hotspot.severity_score >= 40 %}severity-medium{% else %}severity-low{% endif %}"
                         style="width: {{ hotspot.severity_score }}%">
                    </div>
                </div>
            </div>
        </div>

        <div class="hotspot-actions">
            <a href="{% url 'hotspot_detail' hotspot.cluster_id %}" class="btn btn-primary btn-sm" onclick="event.stopPropagation()">
                View Details
            </a>
            <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); viewOnMap({{ hotspot.cluster_id }}, 'list')">
                Show on Map
            </button>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <h3>No hotspots found</h3>
        <p>Try running the clustering algorithm or adjusting your filters.</p>
        <button class="btn btn-primary" onclick="window.location.href='/admin/accidents/clusteringjob/'">
            Run Clustering
        </button>
    </div>
    {% endfor %}
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,0.2);">
        <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 1rem;"></div>
        <p style="margin: 0; color: #374151;">Loading hotspots...</p>
    </div>
</div>

<!-- Hotspot Details Modal -->
<div id="hotspotModal" class="hotspot-modal" onclick="closeHotspotModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeHotspotModal()">&times;</button>

        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Loading...</h2>
            <span class="modal-badge risk-critical" id="modalBadge">CRITICAL RISK</span>
        </div>

        <div class="modal-body">
            <!-- Statistics Grid -->
            <div class="modal-stat-grid">
                <div class="modal-stat-card">
                    <span class="modal-stat-label">Cluster ID</span>
                    <div class="modal-stat-value" id="modalClusterId">#0</div>
                </div>
                <div class="modal-stat-card">
                    <span class="modal-stat-label">Total Accidents</span>
                    <div class="modal-stat-value" id="modalAccidents">0</div>
                </div>
                <div class="modal-stat-card">
                    <span class="modal-stat-label">Total Casualties</span>
                    <div class="modal-stat-value" id="modalCasualties">0</div>
                </div>
                <div class="modal-stat-card">
                    <span class="modal-stat-label">Fatal Accidents</span>
                    <div class="modal-stat-value critical" id="modalKilled">0</div>
                </div>
            </div>

            <!-- Municipalities Section -->
            <div class="modal-section">
                <h3 class="modal-section-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Affected Municipalities
                </h3>
                <div class="modal-municipalities" id="modalMunicipalities">
                    <!-- Municipalities will be dynamically inserted -->
                </div>
            </div>

            <!-- Severity Score Section -->
            <div class="modal-section">
                <h3 class="modal-section-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Severity Assessment
                </h3>
                <div class="modal-severity">
                    <div class="modal-severity-label">
                        <span>Overall Severity Score</span>
                        <span class="modal-severity-score" id="modalSeverityScore">0/100</span>
                    </div>
                    <div class="modal-severity-bar">
                        <div class="modal-severity-fill severity-high" id="modalSeverityFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="modal-btn modal-btn-primary" id="modalViewDetails">
                <i class="fas fa-info-circle"></i>
                View Full Details
            </button>
            <button class="modal-btn modal-btn-secondary" id="modalViewMap">
                <i class="fas fa-map"></i>
                Show on Map
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Province to Municipality mapping
    const provinceMunicipalityMap = {{ province_municipality_map|safe }};
    const allMunicipalities = {{ municipalities|safe }};

    // Pagination state
    let currentPage = 1;
    let itemsPerPage = 12;

    // Modal data storage
    let currentModalData = null;

    // Loading overlay functions
    function showLoading() {
        document.querySelector('.loading-overlay').classList.add('active');
    }

    function hideLoading() {
        document.querySelector('.loading-overlay').classList.remove('active');
    }

    // Update summary cards based on filtered/visible hotspots
    function updateSummaryCards() {
        const cards = Array.from(document.getElementsByClassName('hotspot-card'));
        const visibleCards = cards.filter(card => card.getAttribute('data-search-visible') === 'true');

        // Calculate stats from visible cards
        let totalHotspots = visibleCards.length;
        let totalAccidents = 0;
        let totalCasualties = 0;
        let criticalCount = 0;

        visibleCards.forEach(card => {
            const accidents = parseInt(card.getAttribute('data-accidents')) || 0;
            const casualties = parseInt(card.getAttribute('data-casualties')) || 0;
            const severity = parseFloat(card.getAttribute('data-severity')) || 0;

            totalAccidents += accidents;
            totalCasualties += casualties;
            if (severity >= 70) {
                criticalCount++;
            }
        });

        // Update the summary card values with smooth animation
        const summaryCards = document.querySelectorAll('.summary-card h3');
        if (summaryCards.length >= 4) {
            animateNumber(summaryCards[0], totalHotspots);
            animateNumber(summaryCards[1], totalAccidents);
            animateNumber(summaryCards[2], totalCasualties);
            animateNumber(summaryCards[3], criticalCount);
        }

        // Also update the hero badge
        const heroBadge = document.querySelector('.hero-badge');
        if (heroBadge) {
            heroBadge.textContent = `${totalHotspots} Detected`;
        }
    }

    // Animate number changes smoothly
    function animateNumber(element, newValue) {
        const currentValue = parseInt(element.textContent) || 0;
        if (currentValue === newValue) return;

        const duration = 300; // ms
        const steps = 20;
        const stepValue = (newValue - currentValue) / steps;
        const stepDuration = duration / steps;
        let step = 0;

        const interval = setInterval(() => {
            step++;
            const value = Math.round(currentValue + (stepValue * step));
            element.textContent = value;

            if (step >= steps) {
                element.textContent = newValue;
                clearInterval(interval);
            }
        }, stepDuration);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeHotspotCards();
        updatePagination();
        updateActiveFilters();

        // Prevent body scroll when modal is open
        const modal = document.getElementById('hotspotModal');
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeHotspotModal();
            }
        });

        // ESC key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeHotspotModal();
            }
        });
    });

    // ===== MODAL FUNCTIONS =====

    function openHotspotModal(cardElement) {
        // Prevent card click from triggering on button clicks
        if (event && (event.target.tagName === 'A' || event.target.tagName === 'BUTTON')) {
            event.stopPropagation();
            return;
        }

        const modal = document.getElementById('hotspotModal');
        const data = {
            location: cardElement.getAttribute('data-location'),
            cluster: cardElement.getAttribute('data-cluster'),
            severity: parseFloat(cardElement.getAttribute('data-severity')),
            accidents: parseInt(cardElement.getAttribute('data-accidents')),
            casualties: parseInt(cardElement.getAttribute('data-casualties')),
            killed: parseInt(cardElement.getAttribute('data-killed')),
            municipalities: cardElement.getAttribute('data-municipalities'),
            lat: parseFloat(cardElement.getAttribute('data-lat')),
            lng: parseFloat(cardElement.getAttribute('data-lng'))
        };

        currentModalData = data;
        populateModal(data);

        // Show modal with animation
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeHotspotModal(event) {
        if (event) {
            event.stopPropagation();
        }

        const modal = document.getElementById('hotspotModal');
        modal.classList.remove('show');
        document.body.style.overflow = '';
        currentModalData = null;
    }

    function populateModal(data) {
        // Set title
        document.getElementById('modalTitle').textContent = data.location;

        // Set cluster ID
        document.getElementById('modalClusterId').textContent = '#' + data.cluster;

        // Set statistics
        document.getElementById('modalAccidents').textContent = data.accidents.toLocaleString();
        document.getElementById('modalCasualties').textContent = data.casualties.toLocaleString();
        document.getElementById('modalKilled').textContent = data.killed.toLocaleString();

        // Set severity badge and score
        const badge = document.getElementById('modalBadge');
        const severityScore = document.getElementById('modalSeverityScore');
        const severityFill = document.getElementById('modalSeverityFill');

        let badgeClass = 'modal-badge ';
        let badgeText = '';

        if (data.severity >= 70) {
            badgeClass += 'risk-critical';
            badgeText = 'CRITICAL RISK';
            severityFill.className = 'modal-severity-fill severity-high';
        } else if (data.severity >= 50) {
            badgeClass += 'risk-high';
            badgeText = 'HIGH RISK';
            severityFill.className = 'modal-severity-fill severity-medium';
        } else if (data.severity >= 30) {
            badgeClass += 'risk-medium';
            badgeText = 'MEDIUM RISK';
            severityFill.className = 'modal-severity-fill severity-medium';
        } else {
            badgeClass += 'risk-low';
            badgeText = 'LOW RISK';
            severityFill.className = 'modal-severity-fill severity-low';
        }

        badge.className = badgeClass;
        badge.textContent = badgeText;
        severityScore.textContent = data.severity.toFixed(1) + '/100';

        // Animate severity bar
        setTimeout(() => {
            severityFill.style.width = data.severity + '%';
        }, 100);

        // Set municipalities
        const municipalitiesContainer = document.getElementById('modalMunicipalities');
        const municipalities = data.municipalities.split(', ').filter(m => m.trim());

        municipalitiesContainer.innerHTML = '';
        municipalities.forEach(mun => {
            const tag = document.createElement('span');
            tag.className = 'modal-municipality-tag';
            tag.textContent = mun.trim();
            municipalitiesContainer.appendChild(tag);
        });

        // Set button actions
        const viewDetailsBtn = document.getElementById('modalViewDetails');
        const viewMapBtn = document.getElementById('modalViewMap');

        viewDetailsBtn.onclick = function() {
            window.location.href = `/hotspots/${data.cluster}/`;
        };

        viewMapBtn.onclick = function() {
            window.location.href = `/map/?cluster_id=${data.cluster}&source=list`;
        };
    }

    // CASCADE FILTERING - Update municipality dropdown
    function updateMunicipalityDropdown() {
        const provinceSelect = document.getElementById('province');
        const municipalitySelect = document.getElementById('municipality');
        const selectedProvince = provinceSelect.value;

        // Save the currently selected municipality BEFORE clearing
        const currentlySelectedMunicipality = municipalitySelect.value;

        // Clear the dropdown
        municipalitySelect.value = '';
        municipalitySelect.innerHTML = '<option value="">All Municipalities</option>';

        // Determine which municipalities to show
        let municipalitiesToShow = selectedProvince ?
            (provinceMunicipalityMap[selectedProvince] || []) :
            allMunicipalities;

        // Rebuild the dropdown
        municipalitiesToShow.forEach(function(mun) {
            const option = document.createElement('option');
            option.value = mun;
            option.textContent = mun;
            municipalitySelect.appendChild(option);
        });

        // SMART PRESERVATION: If the previously selected municipality exists in the new list, keep it selected
        if (currentlySelectedMunicipality && municipalitiesToShow.includes(currentlySelectedMunicipality)) {
            municipalitySelect.value = currentlySelectedMunicipality;
            console.log('‚úÖ Municipality preserved:', currentlySelectedMunicipality, 'is in', selectedProvince);
        } else if (currentlySelectedMunicipality) {
            console.log('‚ùå Municipality cleared:', currentlySelectedMunicipality, 'not in', selectedProvince);
        }
    }

    // CLIENT-SIDE FILTERING
    function applyClientSideFilters() {
        // Show loading overlay
        showLoading();

        // Use setTimeout to allow UI to update before heavy processing
        setTimeout(() => {
            const cards = Array.from(document.getElementsByClassName('hotspot-card'));
            const searchTerm = document.getElementById('hotspotSearch').value.toLowerCase().trim();
            const provinceFilter = document.getElementById('province').value.toLowerCase();
            const severityFilter = document.getElementById('min_severity').value;
            const accidentsFilter = document.getElementById('min_accidents').value;
            const municipalityFilter = document.getElementById('municipality').value.toLowerCase();

            let visibleCount = 0;

            cards.forEach(card => {
                const location = (card.getAttribute('data-location') || '').toLowerCase();
                const clusterId = (card.getAttribute('data-cluster') || '').toString().toLowerCase();
                const municipalities = (card.getAttribute('data-municipalities') || '').toLowerCase();
                const provinces = (card.getAttribute('data-provinces') || '').toLowerCase();
                const severity = parseFloat(card.getAttribute('data-severity')) || 0;
                const accidents = parseInt(card.getAttribute('data-accidents')) || 0;

                const searchMatch = searchTerm === '' ||
                                  location.includes(searchTerm) ||
                                  clusterId.includes(searchTerm) ||
                                  municipalities.includes(searchTerm) ||
                                  provinces.includes(searchTerm);

                const provinceMatch = provinceFilter === '' || provinces.includes(provinceFilter);
                const severityMatch = severityFilter === '' || severity >= parseFloat(severityFilter);
                const accidentsMatch = accidentsFilter === '' || accidents >= parseInt(accidentsFilter);
                const municipalityMatch = municipalityFilter === '' || municipalities.includes(municipalityFilter);

                const allMatch = searchMatch && provinceMatch && severityMatch && accidentsMatch && municipalityMatch;

                if (allMatch) {
                    card.setAttribute('data-search-visible', 'true');
                    visibleCount++;
                } else {
                    card.setAttribute('data-search-visible', 'false');
                }
            });

            if (visibleCount === 0) {
                showNoResultsMessage('your filters');
            } else {
                hideNoResultsMessage();
            }

            updateActiveFilters();
            currentPage = 1;
            updatePagination();

            // Update summary cards with new filtered values
            updateSummaryCards();

            // Hide loading overlay after a short delay for smooth animation
            setTimeout(() => {
                hideLoading();
            }, 300);
        }, 50);
    }

    function clearAllFiltersAndSearch() {
        // Show loading
        showLoading();

        setTimeout(() => {
            document.getElementById('hotspotSearch').value = '';
            document.getElementById('province').value = '';
            document.getElementById('min_severity').value = '';
            document.getElementById('min_accidents').value = '';
            document.getElementById('municipality').value = '';
            const sortDropdown = document.getElementById('sort_by');
            const wasSorted = sortDropdown.value !== '';
            sortDropdown.value = '';

            updateMunicipalityDropdown();

            const cards = document.getElementsByClassName('hotspot-card');
            Array.from(cards).forEach(card => {
                card.setAttribute('data-search-visible', 'true');
            });

            hideNoResultsMessage();
            updateActiveFilters();
            currentPage = 1;

            if (wasSorted) {
                window.location.reload();
            } else {
                updatePagination();
                // Update summary cards to show all data
                updateSummaryCards();

                // Hide loading
                setTimeout(() => {
                    hideLoading();
                }, 300);
            }
        }, 50);
    }

    function handleSortChange() {
        const sortValue = document.getElementById('sort_by').value;

        if (!sortValue) {
            window.location.reload();
            return;
        }

        const container = document.getElementById('hotspotsContainer');
        const cards = Array.from(container.getElementsByClassName('hotspot-card'));

        // Sort cards based on selected criteria
        cards.sort((a, b) => {
            if (sortValue === 'accidents') {
                return parseInt(b.getAttribute('data-accidents')) - parseInt(a.getAttribute('data-accidents'));
            } else if (sortValue === 'severity') {
                return parseFloat(b.getAttribute('data-severity')) - parseFloat(a.getAttribute('data-severity'));
            }
            return 0;
        });

        // Add fade-out effect before reordering
        cards.forEach(card => {
            card.style.transition = 'opacity 0.2s ease';
            card.style.opacity = '0.3';
        });

        // Re-append cards in sorted order with delay for visual effect
        setTimeout(() => {
            cards.forEach(card => container.appendChild(card));

            // Fade cards back in
            setTimeout(() => {
                cards.forEach(card => {
                    card.style.opacity = '1';
                });
            }, 50);

            // Highlight severity meters briefly to show what was sorted
            if (sortValue === 'severity') {
                setTimeout(() => {
                    const severityMeters = document.querySelectorAll('.severity-meter');
                    severityMeters.forEach(meter => {
                        meter.style.transition = 'all 0.3s ease';
                        meter.style.backgroundColor = 'rgba(0, 48, 135, 0.08)';
                        meter.style.borderRadius = '6px';
                        meter.style.padding = '0.5rem';
                        meter.style.marginTop = '0.5rem';
                    });

                    // Remove highlight after 2 seconds
                    setTimeout(() => {
                        severityMeters.forEach(meter => {
                            meter.style.backgroundColor = '';
                            meter.style.padding = '';
                            meter.style.marginTop = '';
                        });
                    }, 2000);
                }, 100);
            }

            // Reset to page 1 and update display
            currentPage = 1;
            updatePagination();
            updateActiveFilters();

            // Scroll to top of hotspots grid to show sorted results
            const filtersSection = document.querySelector('.filters-section');
            if (filtersSection) {
                filtersSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // Show notification to user
            const sortLabel = sortValue === 'severity' ? 'Severity Score (High to Low)' : 'Total Accidents (High to Low)';
            showSortNotification(`Sorted by: ${sortLabel}`);
        }, 200);
    }

    // Add notification function for sort feedback
    function showSortNotification(message) {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #003087 0%, #0047ab 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,48,135,0.3);
            z-index: 10000;
            font-weight: 600;
            font-size: 0.9rem;
            animation: slideDown 0.3s ease-out;
        `;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.transition = 'all 0.3s ease';
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(-50%) translateY(-10px)';
            setTimeout(() => notification.remove(), 300);
        }, 2500);
    }

    function updateActiveFilters() {
        const activeFilters = document.getElementById('activeFilters');
        const searchTerm = document.getElementById('hotspotSearch').value.trim();
        const province = document.getElementById('province').value;
        const minSeverity = document.getElementById('min_severity').value;
        const minAccidents = document.getElementById('min_accidents').value;
        const municipality = document.getElementById('municipality').value;
        const sortBy = document.getElementById('sort_by').value;

        let activeFiltersHTML = '';

        if (searchTerm) {
            activeFiltersHTML += `<div class="filter-tag">
                Search: "${searchTerm}"
                <button onclick="removeSearchFilter()">√ó</button>
            </div>`;
        }

        if (province) {
            activeFiltersHTML += `<div class="filter-tag">
                Province: ${province}
                <button onclick="removeFilter('province')">√ó</button>
            </div>`;
        }

        if (municipality) {
            activeFiltersHTML += `<div class="filter-tag">
                Municipality: ${municipality}
                <button onclick="removeFilter('municipality')">√ó</button>
            </div>`;
        }

        if (minSeverity) {
            let level = 'All';
            if (minSeverity === '70') level = 'Critical (70+)';
            else if (minSeverity === '50') level = 'High (50+)';
            else if (minSeverity === '30') level = 'Medium (30+)';
            else if (minSeverity === '0') level = 'Low (0+)';

            activeFiltersHTML += `<div class="filter-tag">
                Min Severity: ${level}
                <button onclick="removeFilter('min_severity')">√ó</button>
            </div>`;
        }

        if (minAccidents) {
            activeFiltersHTML += `<div class="filter-tag">
                Min Accidents: ${minAccidents}+
                <button onclick="removeFilter('min_accidents')">√ó</button>
            </div>`;
        }

        if (sortBy) {
            const sortLabel = sortBy === 'accidents' ? 'Sorted by Accidents' : 'Sorted by Severity';
            activeFiltersHTML += `<div class="filter-tag">
                ${sortLabel}
                <button onclick="removeFilter('sort_by')">√ó</button>
            </div>`;
        }

        activeFilters.innerHTML = activeFiltersHTML;
    }

    function removeSearchFilter() {
        document.getElementById('hotspotSearch').value = '';
        applyClientSideFilters();
    }

    function removeFilter(filterName) {
        document.getElementById(filterName).value = '';

        // Don't update municipality dropdown when removing province
        // This preserves the municipality filter if it was set
        // Only update municipality dropdown when province changes (not when removed)

        // For sort_by, just reapply filters instead of reloading the page
        // This preserves all other active filters

        applyClientSideFilters();
    }

    function initializeHotspotCards() {
        const cards = document.getElementsByClassName('hotspot-card');
        Array.from(cards).forEach(card => {
            card.setAttribute('data-search-visible', 'true');
        });
    }

    function performSearch() {
        applyClientSideFilters();
    }

    function updatePagination() {
        const cards = Array.from(document.getElementsByClassName('hotspot-card'));
        const searchVisibleCards = cards.filter(card => card.getAttribute('data-search-visible') !== 'false');

        const totalItems = searchVisibleCards.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;

        cards.forEach(card => card.style.display = 'none');

        searchVisibleCards.forEach((card, index) => {
            if (index >= startIndex && index < endIndex) {
                card.style.display = '';
            }
        });

        // Update pagination info with correct item ranges
        const showingStart = totalItems > 0 ? startIndex + 1 : 0;
        const showingEnd = Math.min(endIndex, totalItems);

        document.getElementById('showingStart').textContent = showingStart;
        document.getElementById('showingEnd').textContent = showingEnd;
        document.getElementById('totalCount').textContent = totalItems;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;

        document.getElementById('prevPage').disabled = currentPage <= 1;
        document.getElementById('nextPage').disabled = currentPage >= totalPages;
    }

    function changePage(direction) {
        currentPage += direction;
        updatePagination();

        const filtersSection = document.querySelector('.filters-section');
        if (filtersSection) {
            filtersSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function changeItemsPerPage() {
        itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
        currentPage = 1;
        updatePagination();
    }

    function switchView(viewType) {
        const container = document.getElementById('hotspotsContainer');
        const cards = container.getElementsByClassName('hotspot-card');
        const options = document.querySelectorAll('.view-option');

        options.forEach(opt => opt.classList.remove('active'));
        event.target.classList.add('active');

        container.className = 'hotspots-grid';
        if (viewType === 'list') {
            container.classList.add('view-list');
            Array.from(cards).forEach(card => card.classList.add('view-list'));
        } else {
            Array.from(cards).forEach(card => card.classList.remove('view-list'));
        }
    }

    function viewOnMap(clusterId, source = 'list') {
        window.location.href = `/map/?cluster_id=${clusterId}&source=${source}`;
    }

    function exportHotspots() {
        const data = [
            {% for hotspot in hotspots %}
            {
                'Rank': {{ forloop.counter }},
                'Cluster ID': {{ hotspot.cluster_id }},
                'Location': '{{ hotspot.primary_location }}',
                'Accidents': {{ hotspot.accident_count }},
                'Casualties': {{ hotspot.total_casualties }},
                'Fatal Accidents': {{ hotspot.killed_count|default:0 }},
                'Severity': {{ hotspot.severity_score|floatformat:1 }},
                'Municipalities': '{{ hotspot.municipalities|join:", " }}',
                'Latitude': {{ hotspot.center_latitude }},
                'Longitude': {{ hotspot.center_longitude }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        if (typeof AGNESSystem !== 'undefined') {
            AGNESSystem.exportToCSV(data, 'accident_hotspots_report.csv');
            AGNESSystem.showNotification('Hotspots exported successfully', 'success');
        } else {
            const csv = convertToCSV(data);
            downloadCSV(csv, 'accident_hotspots_report.csv');
        }
    }

    function showNoResultsMessage(searchTerm) {
        let noResultsDiv = document.getElementById('noResultsMessage');
        if (!noResultsDiv) {
            noResultsDiv = document.createElement('div');
            noResultsDiv.id = 'noResultsMessage';
            noResultsDiv.className = 'no-results';
            noResultsDiv.innerHTML = `
                <h4>üîç No hotspots found</h4>
                <p>No hotspots match "<strong>${searchTerm}</strong>"</p>
                <p style="font-size: 0.875rem; color: #6B7280; margin-top: 0.5rem;">
                    Try searching by location name, cluster ID, or municipality
                </p>
            `;
            document.getElementById('hotspotsContainer').appendChild(noResultsDiv);
        } else {
            noResultsDiv.innerHTML = `
                <h4>üîç No hotspots found</h4>
                <p>No hotspots match "<strong>${searchTerm}</strong>"</p>
                <p style="font-size: 0.875rem; color: #6B7280; margin-top: 0.5rem;">
                    Try searching by location name, cluster ID, or municipality
                </p>
            `;
        }
    }

    function hideNoResultsMessage() {
        const noResultsDiv = document.getElementById('noResultsMessage');
        if (noResultsDiv) {
            noResultsDiv.remove();
        }
    }

    function convertToCSV(data) {
        if (!data || data.length === 0) return '';

        const headers = Object.keys(data[0]);
        const csvRows = [headers.join(',')];

        for (const row of data) {
            const values = headers.map(header => {
                const value = row[header];
                return `"${value}"`;
            });
            csvRows.push(values.join(','));
        }

        return csvRows.join('\n');
    }

    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}
