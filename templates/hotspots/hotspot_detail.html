{% extends 'base.html' %}
{% load static %}

{% block title %}Hotspot #{{ hotspot.cluster_id }}{% endblock %}

{% block breadcrumb_items %}
<span> / <a href="{% url 'hotspots' %}" style="color: inherit; text-decoration: none;">Hotspots</a> / Cluster #{{ hotspot.cluster_id }}</span>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --hotspot-primary: #DC143C;
        --hotspot-accent: #FF6B35;
        --hotspot-secondary: #F59E0B;
        --primary-blue: #003087;
        --text-dark: #111827;
        --text-secondary: #6B7280;
        --border-light: #E5E7EB;
        --bg-light: #F9FAFB;
    }

    .detail-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    /* Header with gradient matching list page */
    .detail-header {
        background: linear-gradient(135deg, var(--hotspot-primary) 0%, var(--hotspot-accent) 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(220, 20, 60, 0.2);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 2rem;
    }

    .header-info h1 {
        margin: 0 0 0.5rem 0;
        font-size: 2rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .header-info p {
        margin: 0 0 1rem 0;
        font-size: 1rem;
        opacity: 0.95;
    }

    .severity-badge {
        background: white;
        color: var(--hotspot-primary);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
        font-size: 0.9rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .risk-badge-detail {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.813rem;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
        margin-left: 0.5rem;
    }

    .risk-critical-detail {
        background: white;
        color: #B8112C;
        border: 2px solid rgba(255,255,255,0.3);
    }

    .risk-high-detail {
        background: var(--hotspot-secondary);
        color: white;
    }

    .risk-medium-detail {
        background: #10B981;
        color: white;
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-direction: column;
    }

    .action-btn {
        background: white;
        color: var(--primary-blue);
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        background: var(--primary-blue);
        color: white;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        border: 1px solid var(--border-light);
        transition: all 0.2s ease;
    }

    .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .stat-card-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--hotspot-primary);
        margin: 0 0 1rem 0;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #FFE5E5;
        font-size: 1.125rem;
        font-weight: 600;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.625rem 0;
        border-bottom: 1px solid var(--border-light);
    }

    .stat-item:last-child {
        border-bottom: none;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .stat-value {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.9375rem;
    }

    .stat-value-large {
        color: var(--hotspot-primary);
        font-size: 1.25rem;
    }

    .stat-value-warning {
        color: var(--hotspot-secondary);
    }

    /* Content Sections */
    .content-section {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        border: 1px solid var(--border-light);
        margin-bottom: 2rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }

    .section-title {
        color: var(--primary-blue);
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Table Styling */
    .accidents-table {
        width: 100%;
        border-collapse: collapse;
        overflow: hidden;
    }

    .accidents-table thead {
        background: linear-gradient(135deg, var(--hotspot-primary) 0%, var(--hotspot-accent) 100%);
        color: white;
    }

    .accidents-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
    }

    .accidents-table th:hover {
        background: rgba(255,255,255,0.1);
    }

    .accidents-table tbody tr {
        border-bottom: 1px solid var(--border-light);
        transition: background 0.2s ease;
    }

    .accidents-table tbody tr:hover {
        background: #F9FAFB;
    }

    .accidents-table td {
        padding: 0.875rem 1rem;
        font-size: 0.875rem;
    }

    .casualty-badge {
        padding: 0.375rem 0.875rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.813rem;
        display: inline-block;
    }

    .casualty-fatal {
        background: #FFE5E5;
        color: var(--hotspot-primary);
    }

    .casualty-injury {
        background: #FFF3CD;
        color: #856404;
    }

    .casualty-property {
        background: #E8F5E9;
        color: #2E7D32;
    }

    /* Recommendations Box */
    .recommendations {
        background: linear-gradient(135deg, #E8F0FE 0%, #F8F9FA 100%);
        padding: 1.5rem;
        border-radius: 12px;
        border-left: 4px solid var(--primary-blue);
        margin-top: 2rem;
    }

    .recommendations h3 {
        color: var(--primary-blue);
        margin: 0 0 1rem 0;
        font-size: 1.125rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .recommendations ul {
        margin: 0;
        padding-left: 1.5rem;
        line-height: 1.8;
    }

    .recommendations li {
        margin-bottom: 0.75rem;
        color: var(--text-dark);
    }

    .recommendations li strong {
        color: var(--primary-blue);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .header-content {
            flex-direction: column;
        }

        .header-actions {
            flex-direction: row;
            width: 100%;
        }

        .action-btn {
            flex: 1;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .header-info h1 {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="detail-container">

    <!-- Header -->
    <div class="detail-header">
        <div class="header-content">
            <div class="header-info">
                <h1>
                    <span>üî¥</span>
                    <span>{{ hotspot.primary_location }}</span>
                    <span class="risk-badge-detail {% if hotspot.severity_score >= 70 %}risk-critical-detail{% elif hotspot.severity_score >= 50 %}risk-high-detail{% else %}risk-medium-detail{% endif %}">
                        {% if hotspot.severity_score >= 70 %}CRITICAL{% elif hotspot.severity_score >= 50 %}HIGH{% else %}MEDIUM{% endif %} RISK
                    </span>
                </h1>
                <p>Cluster #{{ hotspot.cluster_id }} ‚Ä¢ High-Risk Accident Zone</p>
                <div class="severity-badge">
                    <span>‚ö°</span>
                    <span>Severity Score: {{ hotspot.severity_score|floatformat:1 }}/100</span>
                </div>
            </div>
            <div class="header-actions">
                <button onclick="window.location.href='/map/?cluster_id={{ hotspot.cluster_id }}&source=detail'" class="action-btn">
                    <span>üó∫Ô∏è</span>
                    <span>View on Map</span>
                </button>
                <button onclick="exportAccidents()" class="action-btn">
                    <span>üì•</span>
                    <span>Export CSV</span>
                </button>
                <button onclick="window.print()" class="action-btn">
                    <span>üñ®Ô∏è</span>
                    <span>Print Report</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">

        <!-- Location Card -->
        <div class="stat-card">
            <h3 class="stat-card-header">
                <span>üìç</span>
                <span>Location Information</span>
            </h3>
            <div class="stat-item">
                <span class="stat-label">Primary Location</span>
                <span class="stat-value">{{ hotspot.primary_location }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Coordinates</span>
                <span class="stat-value" style="font-size: 0.813rem;">{{ hotspot.center_latitude|floatformat:4 }}¬∞N, {{ hotspot.center_longitude|floatformat:4 }}¬∞E</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Municipalities</span>
                <span class="stat-value">{{ hotspot.municipalities|join:", " }}</span>
            </div>
        </div>

        <!-- Statistics Card -->
        <div class="stat-card">
            <h3 class="stat-card-header">
                <span>üìä</span>
                <span>Accident Statistics</span>
            </h3>
            <div class="stat-item">
                <span class="stat-label">Total Accidents</span>
                <span class="stat-value stat-value-large">{{ hotspot.accident_count }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total Casualties</span>
                <span class="stat-value">{{ hotspot.total_casualties }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Fatal Accidents</span>
                <span class="stat-value stat-value-large">{{ total_killed }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Injury Accidents</span>
                <span class="stat-value stat-value-warning">{{ total_injured }}</span>
            </div>
        </div>

        <!-- Time Period Card -->
        <div class="stat-card">
            <h3 class="stat-card-header">
                <span>üìÖ</span>
                <span>Time Period</span>
            </h3>
            <div class="stat-item">
                <span class="stat-label">From</span>
                <span class="stat-value">{{ hotspot.date_range_start|date:"M d, Y" }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">To</span>
                <span class="stat-value">{{ hotspot.date_range_end|date:"M d, Y" }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Duration</span>
                <span class="stat-value">{{ date_span }} days</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Last Updated</span>
                <span class="stat-value" style="font-size: 0.813rem;">{{ hotspot.computed_at|date:"M d, Y" }}</span>
            </div>
        </div>
    </div>

    <!-- Accident Trend Chart -->
    <div class="content-section">
        <h3 class="section-title">
            <span>üìà</span>
            <span>Accident Trend Over Time (Last 12 Months)</span>
        </h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <!-- Map -->
    <div class="content-section">
        <h3 class="section-title">
            <span>üó∫Ô∏è</span>
            <span>Location Map</span>
        </h3>
        <div id="hotspotMap" style="height: 450px; border-radius: 8px;"></div>
    </div>

    <!-- Accidents Table -->
    <div class="content-section">
        <div class="section-header">
            <h3 class="section-title">
                <span>üìã</span>
                <span>Accidents in This Hotspot{% if showing_count < total_accidents %} (Showing {{ showing_count }} of {{ total_accidents }}){% else %} ({{ total_accidents }}){% endif %}</span>
            </h3>
            <a href="{% url 'hotspots' %}" class="action-btn" style="padding: 0.5rem 1rem; font-size: 0.813rem;">
                <span>‚Üê</span>
                <span>Back to Hotspots</span>
            </a>
        </div>

        <div style="overflow-x: auto;">
            <table id="accidentsTable" class="accidents-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">
                            Date <span style="font-size: 0.7rem; opacity: 0.7;">‚ñº‚ñ≤</span>
                        </th>
                        <th onclick="sortTable(1)">
                            Time <span style="font-size: 0.7rem; opacity: 0.7;">‚ñº‚ñ≤</span>
                        </th>
                        <th onclick="sortTable(2)">
                            Location <span style="font-size: 0.7rem; opacity: 0.7;">‚ñº‚ñ≤</span>
                        </th>
                        <th onclick="sortTable(3)">
                            Type <span style="font-size: 0.7rem; opacity: 0.7;">‚ñº‚ñ≤</span>
                        </th>
                        <th onclick="sortTable(4)">
                            Casualties <span style="font-size: 0.7rem; opacity: 0.7;">‚ñº‚ñ≤</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="accidentsTableBody">
                    {% for accident in accidents %}
                    <tr data-date="{{ accident.date_committed|date:'Y-m-d' }}" data-casualties="{{ accident.victim_count }}">
                        <td>{{ accident.date_committed|date:"M d, Y" }}</td>
                        <td>{{ accident.time_committed|time:"g:i A" }}</td>
                        <td>{{ accident.barangay }}, {{ accident.municipal }}</td>
                        <td>{{ accident.incident_type|truncatewords:5 }}</td>
                        <td>
                            {% if accident.victim_killed %}
                                <span class="casualty-badge casualty-fatal">
                                    {{ accident.victim_count }} killed
                                </span>
                            {% elif accident.victim_injured %}
                                <span class="casualty-badge casualty-injury">
                                    {{ accident.victim_count }} injured
                                </span>
                            {% else %}
                                <span class="casualty-badge casualty-property">
                                    Property damage
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                            No accidents found in this hotspot.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="recommendations">
        <h3>
            <span>üí°</span>
            <span>Recommended Actions</span>
        </h3>
        <ul>
            <li><strong>Increase Patrol Frequency:</strong> Deploy traffic enforcers during peak hours</li>
            <li><strong>Infrastructure Review:</strong> Assess road conditions, signage, and lighting in this area</li>
            <li><strong>Speed Enforcement:</strong> Install speed cameras or conduct regular speed checks</li>
            <li><strong>Public Awareness:</strong> Inform motorists about this high-risk location</li>
            <li><strong>Multi-Agency Coordination:</strong> Work with {{ hotspot.municipalities|join:" and " }} for joint road safety initiatives</li>
        </ul>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Trend Chart
    createTrendChart();
    
    // Initialize Map
    try {
        const map = L.map('hotspotMap').setView([{{ hotspot.center_latitude }}, {{ hotspot.center_longitude }}], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        // Add hotspot boundary circle (lighter, in background)
        const circle = L.circle([{{ hotspot.center_latitude }}, {{ hotspot.center_longitude }}], {
            color: '#FFA500',
            fillColor: '#FFA500',
            fillOpacity: 0.15,
            radius: {{ hotspot.accident_count }} * 30,
            weight: 2,
            opacity: 0.5
        }).addTo(map);

        circle.bindPopup(`
            <div style="padding: 0.5rem;">
                <strong>Hotspot #{{ hotspot.cluster_id }}</strong><br>
                {{ hotspot.primary_location }}<br>
                <strong>{{ hotspot.accident_count }}</strong> accidents<br>
                Severity: <strong>{{ hotspot.severity_score|floatformat:1 }}</strong>/100
            </div>
        `);

        // Add individual accident markers with color coding
        const accidents = {{ accidents_json|safe }};
        const hotspotCenter = [{{ hotspot.center_latitude }}, {{ hotspot.center_longitude }}];
        const circleRadius = {{ hotspot.accident_count }} * 30; // in meters

        const markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });

        // Helper function to calculate distance between two points
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        let accidentsInCircle = 0;
        accidents.forEach(function(accident) {
            // Calculate distance from accident to hotspot center
            const distance = getDistance(
                hotspotCenter[0], hotspotCenter[1],
                accident.latitude, accident.longitude
            );

            // Only show accidents within the circle boundary
            if (distance <= circleRadius) {
                accidentsInCircle++;

                // Determine marker color based on severity
                let markerColor = '#3388ff'; // Default blue
                let severity = 'Property Damage';

                if (accident.victim_killed) {
                    markerColor = '#DC143C'; // Red for fatal
                    severity = 'Fatal';
                } else if (accident.victim_injured) {
                    markerColor = '#FFA500'; // Orange for injury
                    severity = 'Injury';
                }

                // Create custom icon
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                });

                const marker = L.marker([accident.latitude, accident.longitude], {
                    icon: customIcon
                });

                marker.bindPopup(`
                    <div style="padding: 0.5rem; min-width: 200px;">
                        <strong style="color: ${markerColor};">${severity} Accident</strong><br>
                        <strong>Date:</strong> ${accident.date_committed}<br>
                        <strong>Location:</strong> ${accident.barangay}, ${accident.municipal}<br>
                        <strong>Type:</strong> ${accident.incident_type}<br>
                        <strong>Casualties:</strong> ${accident.victim_count}
                    </div>
                `);

                markers.addLayer(marker);
            }
        });

        map.addLayer(markers);

        console.log('Map loaded successfully with ' + accidentsInCircle + ' accidents inside circle (out of ' + accidents.length + ' total)');
    } catch (error) {
        console.error('Map initialization error:', error);
    }
});

function createTrendChart() {
    const ctx = document.getElementById('trendChart');
    
    if (!ctx) {
        console.error('Trend chart canvas not found');
        return;
    }
    
    const labels = {{ month_labels|safe }};
    const data = {{ month_data|safe }};
    
    // Check if we have data
    if (!labels || labels.length === 0 || !data || data.length === 0) {
        console.warn('No chart data available');
        ctx.getContext('2d').font = '16px Arial';
        ctx.getContext('2d').fillText('No data available for the past 12 months', 50, 150);
        return;
    }
    
    console.log('Chart Labels:', labels);
    console.log('Chart Data:', data);
    
    try {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Accidents per Month',
                    data: data,
                    borderColor: '#DC143C',
                    backgroundColor: 'rgba(220, 20, 60, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: '#DC143C',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return 'Accidents: ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            precision: 0
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
        
        console.log('Chart created successfully');
    } catch (error) {
        console.error('Error creating chart:', error);
    }
}

// Table Sorting Function
let sortDirection = {};

function sortTable(columnIndex) {
    const table = document.getElementById('accidentsTable');
    const tbody = document.getElementById('accidentsTableBody');
    const rows = Array.from(tbody.getElementsByTagName('tr'));

    // Skip if no data rows
    if (rows.length === 0 || rows[0].cells.length === 0) return;

    // Toggle sort direction
    sortDirection[columnIndex] = !sortDirection[columnIndex];
    const ascending = sortDirection[columnIndex];

    rows.sort((rowA, rowB) => {
        let cellA = rowA.cells[columnIndex].textContent.trim();
        let cellB = rowB.cells[columnIndex].textContent.trim();

        // Special handling for different columns
        if (columnIndex === 0) {
            // Date column - use data attribute
            cellA = rowA.getAttribute('data-date');
            cellB = rowB.getAttribute('data-date');
        } else if (columnIndex === 4) {
            // Casualties column - use data attribute
            cellA = parseInt(rowA.getAttribute('data-casualties')) || 0;
            cellB = parseInt(rowB.getAttribute('data-casualties')) || 0;
            return ascending ? cellA - cellB : cellB - cellA;
        }

        // String comparison for other columns
        if (cellA < cellB) return ascending ? -1 : 1;
        if (cellA > cellB) return ascending ? 1 : -1;
        return 0;
    });

    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));

    // Visual feedback - update header arrows
    const headers = table.querySelectorAll('th');
    headers.forEach((header, index) => {
        const arrow = header.querySelector('span');
        if (arrow) {
            if (index === columnIndex) {
                arrow.textContent = ascending ? '‚ñº' : '‚ñ≤';
                arrow.style.opacity = '1';
            } else {
                arrow.textContent = '‚ñº‚ñ≤';
                arrow.style.opacity = '0.5';
            }
        }
    });
}

// Export Accidents to CSV
function exportAccidents() {
    const accidents = {{ accidents_export|safe }};

    if (!accidents || accidents.length === 0) {
        alert('No accidents data to export');
        return;
    }

    // Convert to CSV
    const headers = Object.keys(accidents[0]);
    const csvRows = [headers.join(',')];

    for (const row of accidents) {
        const values = headers.map(header => {
            const value = row[header];
            // Escape quotes and wrap in quotes if contains comma
            const escaped = ('' + value).replace(/"/g, '""');
            return `"${escaped}"`;
        });
        csvRows.push(values.join(','));
    }

    const csvString = csvRows.join('\n');

    // Create download link
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', 'hotspot_{{ hotspot.cluster_id }}_accidents.csv');
    link.style.visibility = 'hidden';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    console.log('Exported ' + accidents.length + ' accidents to CSV');
}
</script>
{% endblock %}