{% extends 'base.html' %}
{% load static %}

{% block title %}Profile - PNP Caraga{% endblock %}

{% block extra_css %}
<style>
    .profile-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .profile-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .profile-header {
        border-bottom: 2px solid #003087;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
    }

    .profile-header h2 {
        color: #003087;
        margin: 0;
        font-size: 1.8rem;
    }

    .profile-field {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }

    .profile-field:hover {
        background: #f8f9fa;
    }

    .profile-field:last-child {
        border-bottom: none;
    }

    .field-label {
        flex: 0 0 150px;
        font-weight: 600;
        color: #555;
    }

    .field-value {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .field-value input {
        flex: 1;
        padding: 0.5rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s;
    }

    .field-value input:focus {
        outline: none;
        border-color: #003087;
    }

    .field-value input:disabled {
        background: transparent;
        border: 2px solid transparent;
        cursor: default;
    }

    .field-value-text {
        flex: 1;
        font-size: 1rem;
        color: #333;
    }

    .edit-icon {
        cursor: pointer;
        color: #003087;
        font-size: 1.1rem;
        padding: 0.5rem;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .edit-icon:hover {
        background: #003087;
        color: white;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-save {
        background: #28a745;
        color: white;
    }

    .btn-save:hover {
        background: #218838;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
    }

    .btn-cancel:hover {
        background: #5a6268;
    }

    /* Password Confirmation Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 9998;
        animation: fadeIn 0.2s;
    }

    .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        animation: slideUp 0.3s;
        position: relative;
        z-index: 9999;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        color: #003087;
    }

    .modal-header i {
        font-size: 1.5rem;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.3rem;
    }

    .modal-body {
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #555;
    }

    .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        box-sizing: border-box;
    }

    .form-group input:focus {
        outline: none;
        border-color: #003087;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    .alert {
        padding: 0.75rem 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
    }

    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .change-info {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 1rem;
        color: #856404;
    }

    .reports-section {
        margin-top: 2rem;
    }

    .report-item {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 0.75rem;
        border-left: 4px solid #003087;
    }

    .report-item .date {
        font-weight: 600;
        color: #003087;
    }

    .report-item .status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    .status-pending { background: #ffeaa7; color: #856404; }
    .status-verified { background: #d4edda; color: #155724; }
    .status-investigating { background: #cce5ff; color: #004085; }
    .status-resolved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-card">
        <div class="profile-header">
            <h2><i class="fas fa-user-circle"></i> My Profile</h2>
        </div>

        <!-- Username Field -->
        <div class="profile-field">
            <div class="field-label">
                <i class="fas fa-user"></i> Username
            </div>
            <div class="field-value">
                <input
                    type="text"
                    id="usernameInput"
                    value="{{ user.username }}"
                    disabled
                >
                <div id="usernameActions" style="display: none;" class="action-buttons">
                    <button type="button" class="btn btn-save" onclick="saveUsername()">
                        <i class="fas fa-check"></i> Save
                    </button>
                    <button type="button" class="btn btn-cancel" onclick="cancelEdit()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
                <i class="fas fa-edit edit-icon" id="editIcon" onclick="enableEdit()" title="Edit username"></i>
            </div>
        </div>

        <!-- Email Field -->
        <div class="profile-field">
            <div class="field-label">
                <i class="fas fa-envelope"></i> Email
            </div>
            <div class="field-value">
                <span class="field-value-text">{{ user.email|default:"Not set" }}</span>
            </div>
        </div>

        <!-- Full Name -->
        <div class="profile-field">
            <div class="field-label">
                <i class="fas fa-id-card"></i> Full Name
            </div>
            <div class="field-value">
                <span class="field-value-text">{{ user.get_full_name|default:"Not set" }}</span>
            </div>
        </div>

        <!-- Profile Info -->
        {% if user.userprofile %}
        <div class="profile-field">
            <div class="field-label">
                <i class="fas fa-shield-alt"></i> Badge Number
            </div>
            <div class="field-value">
                <span class="field-value-text">{{ user.userprofile.badge_number|default:"Not set" }}</span>
            </div>
        </div>

        <div class="profile-field">
            <div class="field-label">
                <i class="fas fa-star"></i> Rank
            </div>
            <div class="field-value">
                <span class="field-value-text">{{ user.userprofile.get_rank_display|default:"Not set" }}</span>
            </div>
        </div>

        <div class="profile-field">
            <div class="field-label">
                <i class="fas fa-building"></i> Station
            </div>
            <div class="field-value">
                <span class="field-value-text">{{ user.userprofile.station|default:"Not set" }}</span>
            </div>
        </div>

        <div class="profile-field">
            <div class="field-label">
                <i class="fas fa-map-marker-alt"></i> Province
            </div>
            <div class="field-value">
                <span class="field-value-text">{{ user.userprofile.province|default:"Not set" }}</span>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- My Reports Section -->
    {% if user_reports %}
    <div class="profile-card reports-section">
        <div class="profile-header">
            <h2><i class="fas fa-file-alt"></i> My Reports</h2>
        </div>
        {% for report in user_reports %}
        <div class="report-item">
            <span class="date">{{ report.incident_date }}</span>
            <span class="status status-{{ report.status }}">{{ report.get_status_display }}</span>
            <p style="margin: 0.5rem 0 0 0; color: #666;">{{ report.incident_description|truncatewords:20 }}</p>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Password Confirmation Modal -->
<div class="modal-overlay" id="passwordModal">
    <div class="modal-content">
        <div class="modal-header">
            <i class="fas fa-lock"></i>
            <h3>Confirm Password</h3>
        </div>
        <div class="modal-body">
            <div class="change-info">
                <strong><i class="fas fa-info-circle"></i> Username Change</strong><br>
                Changing from: <strong id="oldUsername"></strong><br>
                Changing to: <strong id="newUsername"></strong>
            </div>

            <div id="errorMessage" style="display: none;" class="alert alert-danger"></div>

            <form id="passwordForm" onsubmit="return false;">
                {% csrf_token %}
                <div class="form-group">
                    <label for="currentPassword">
                        <i class="fas fa-key"></i> Enter your password to confirm
                    </label>
                    <input
                        type="password"
                        id="currentPassword"
                        name="password"
                        required
                        placeholder="Your current password"
                        autocomplete="current-password"
                    >
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-cancel" onclick="closeModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button type="button" class="btn btn-save" onclick="confirmChange()">
                <i class="fas fa-check"></i> Confirm Change
            </button>
        </div>
    </div>
</div>

<script>
    let originalUsername = "{{ user.username }}";
    let newUsernameValue = "";

    function enableEdit() {
        const input = document.getElementById('usernameInput');
        const actions = document.getElementById('usernameActions');
        const editIcon = document.getElementById('editIcon');

        input.disabled = false;
        input.focus();
        input.select();
        actions.style.display = 'flex';
        editIcon.style.display = 'none';
    }

    function cancelEdit() {
        const input = document.getElementById('usernameInput');
        const actions = document.getElementById('usernameActions');
        const editIcon = document.getElementById('editIcon');

        input.value = originalUsername;
        input.disabled = true;
        actions.style.display = 'none';
        editIcon.style.display = 'block';
    }

    function saveUsername() {
        const input = document.getElementById('usernameInput');
        newUsernameValue = input.value.trim();

        // Validation
        if (!newUsernameValue) {
            alert('Username cannot be empty');
            return;
        }

        if (newUsernameValue === originalUsername) {
            cancelEdit();
            return;
        }

        if (newUsernameValue.length < 3) {
            alert('Username must be at least 3 characters long');
            return;
        }

        if (!/^[a-zA-Z0-9_]+$/.test(newUsernameValue)) {
            alert('Username can only contain letters, numbers, and underscores');
            return;
        }

        // Show password confirmation modal
        document.getElementById('oldUsername').textContent = originalUsername;
        document.getElementById('newUsername').textContent = newUsernameValue;
        document.getElementById('currentPassword').value = '';
        document.getElementById('errorMessage').style.display = 'none';
        showModal();
    }

    function showModal() {
        const modal = document.getElementById('passwordModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        document.getElementById('currentPassword').focus();

        // Close on Escape key
        document.addEventListener('keydown', escapeHandler);
    }

    function closeModal() {
        const modal = document.getElementById('passwordModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
        document.removeEventListener('keydown', escapeHandler);
        cancelEdit();
    }

    function escapeHandler(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    }

    // Close modal when clicking outside
    document.getElementById('passwordModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    async function confirmChange() {
        const password = document.getElementById('currentPassword').value;
        const errorDiv = document.getElementById('errorMessage');

        if (!password) {
            errorDiv.textContent = 'Please enter your password';
            errorDiv.style.display = 'block';
            return;
        }

        // Show loading state
        const confirmBtn = event.target;
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirming...';
        confirmBtn.disabled = true;

        try {
            const response = await fetch('{% url "change_username" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    new_username: newUsernameValue,
                    password: password
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // Success - reload page
                alert('Username changed successfully! You will be logged out.');
                window.location.href = '{% url "login" %}';
            } else {
                // Show error
                errorDiv.textContent = data.error || 'Failed to change username';
                errorDiv.style.display = 'block';
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        } catch (error) {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.style.display = 'block';
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        }
    }

    // Allow Enter key to submit password
    document.getElementById('currentPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            confirmChange();
        }
    });
</script>
{% endblock %}
