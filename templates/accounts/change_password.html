{% extends 'base.html' %}
{% load static %}

{% block title %}Change Password{% endblock %}

{% block content %}
<div class="container" style="max-width: 600px; margin: 4rem auto; padding: 2rem;">
    <div class="card" style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 2.5rem;">
        <div style="text-align: center; margin-bottom: 2rem;">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #003087 0%, #001F3F 100%); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-key" style="font-size: 2rem; color: white;"></i>
            </div>
            <h1 style="margin: 0; font-size: 1.75rem; color: #003087; font-weight: 700;">Change Password</h1>
            {% if user.profile.must_change_password %}
            <p style="margin: 0.5rem 0 0; color: #dc3545; font-weight: 600;">
                <i class="fas fa-exclamation-triangle"></i> You must change your password before continuing
            </p>
            {% else %}
            <p style="margin: 0.5rem 0 0; color: #6c757d;">Update your password for security</p>
            {% endif %}
        </div>

        <form method="post" id="changePasswordForm">
            {% csrf_token %}

            <!-- Current Password -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="current_password" style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem;">
                    <i class="fas fa-lock"></i> Current Password
                </label>
                <input type="password" name="current_password" id="current_password" required
                       style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1rem; transition: all 0.3s;"
                       onfocus="this.style.borderColor='#003087'"
                       onblur="this.style.borderColor='#dee2e6'">
            </div>

            <!-- New Password -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="new_password" style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem;">
                    <i class="fas fa-key"></i> New Password
                </label>
                <input type="password" name="new_password" id="new_password" required minlength="8"
                       style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1rem; transition: all 0.3s;"
                       onfocus="this.style.borderColor='#003087'"
                       onblur="this.style.borderColor='#dee2e6'"
                       oninput="checkPasswordStrength()">
                <small style="display: block; margin-top: 0.5rem; color: #6c757d;">
                    <i class="fas fa-info-circle"></i> Minimum 8 characters
                </small>
                <div id="password-strength" style="margin-top: 0.5rem; display: none;">
                    <div style="height: 4px; background: #dee2e6; border-radius: 2px; overflow: hidden;">
                        <div id="strength-bar" style="height: 100%; width: 0%; transition: all 0.3s;"></div>
                    </div>
                    <small id="strength-text" style="display: block; margin-top: 0.25rem;"></small>
                </div>
            </div>

            <!-- Confirm Password -->
            <div class="form-group" style="margin-bottom: 2rem;">
                <label for="confirm_password" style="display: block; font-weight: 600; color: #333; margin-bottom: 0.5rem;">
                    <i class="fas fa-check-double"></i> Confirm New Password
                </label>
                <input type="password" name="confirm_password" id="confirm_password" required minlength="8"
                       style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1rem; transition: all 0.3s;"
                       onfocus="this.style.borderColor='#003087'"
                       onblur="this.style.borderColor='#dee2e6'"
                       oninput="checkPasswordMatch()">
                <small id="match-message" style="display: block; margin-top: 0.5rem;"></small>
            </div>

            <!-- Submit Button -->
            <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #003087 0%, #001F3F 100%); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(0,48,135,0.3);"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,48,135,0.4)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,48,135,0.3)'">
                <i class="fas fa-save"></i> Change Password
            </button>

            {% if not user.profile.must_change_password %}
            <a href="{% url 'dashboard' %}" style="display: block; text-align: center; margin-top: 1rem; color: #6c757d; text-decoration: none;">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            {% endif %}
        </form>
    </div>
</div>

<script>
function checkPasswordStrength() {
    const password = document.getElementById('new_password').value;
    const strengthDiv = document.getElementById('password-strength');
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');

    if (password.length === 0) {
        strengthDiv.style.display = 'none';
        return;
    }

    strengthDiv.style.display = 'block';

    let strength = 0;
    let feedback = [];

    // Length check
    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;

    // Character variety checks
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^a-zA-Z0-9]/.test(password)) strength++;

    // Set color and width based on strength
    if (strength <= 1) {
        strengthBar.style.width = '20%';
        strengthBar.style.background = '#dc3545';
        strengthText.innerHTML = '<span style="color: #dc3545;">Weak</span>';
    } else if (strength <= 3) {
        strengthBar.style.width = '50%';
        strengthBar.style.background = '#ffc107';
        strengthText.innerHTML = '<span style="color: #ffc107;">Medium</span>';
    } else {
        strengthBar.style.width = '100%';
        strengthBar.style.background = '#28a745';
        strengthText.innerHTML = '<span style="color: #28a745;">Strong</span>';
    }
}

function checkPasswordMatch() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const matchMessage = document.getElementById('match-message');
    const confirmInput = document.getElementById('confirm_password');

    if (confirmPassword.length === 0) {
        matchMessage.innerHTML = '';
        confirmInput.style.borderColor = '#dee2e6';
        return;
    }

    if (newPassword === confirmPassword) {
        matchMessage.innerHTML = '<span style="color: #28a745;"><i class="fas fa-check-circle"></i> Passwords match</span>';
        confirmInput.style.borderColor = '#28a745';
    } else {
        matchMessage.innerHTML = '<span style="color: #dc3545;"><i class="fas fa-times-circle"></i> Passwords do not match</span>';
        confirmInput.style.borderColor = '#dc3545';
    }
}

// Form validation before submit
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;

    if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert('Passwords do not match!');
        return false;
    }

    if (newPassword.length < 8) {
        e.preventDefault();
        alert('Password must be at least 8 characters long!');
        return false;
    }
});
</script>

<style>
.form-group input:focus {
    outline: none;
}
</style>
{% endblock %}
