{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block breadcrumb_items %}
<span> / Dashboard</span>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Real-time Alert Banner -->
    {% if critical_alerts %}
    <div class="alerts-container">
        {% for alert in critical_alerts %}
        <div class="alert-banner alert-{{ alert.type }}" data-alert-type="{{ alert.type }}">
            <div class="alert-icon">
                {{ alert.icon }}
            </div>
            <div class="alert-content">
                <div class="alert-title">{{ alert.title }}</div>
                <div class="alert-message">{{ alert.message }}</div>
            </div>
            <div class="alert-actions">
                {% if alert.action_url %}
                <a href="{{ alert.action_url }}" class="btn-alert">View Details</a>
                {% endif %}
                <button class="btn-alert-close" onclick="dismissAlert(this)" title="Dismiss">
                    √ó
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <!-- Page Header -->
<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; padding: 0;">
    <div class="header-content">
        <h2 style="color: #003087; margin-bottom: 0.5rem; font-size: 1.8rem; font-weight: 700;">üöî PNP Caraga - Command Center Dashboard</h2>
        <p style="color: #666; margin: 0;">Real-time accident monitoring and hotspot detection | <span id="currentDateTime">{{ current_time|date:"F d, Y - h:i A" }}</span></p>
    </div>
    <div class="dashboard-actions" style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="window.location.href='{% url 'report_accident' %}'" style="padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; border: 2px solid #DC143C; background: #DC143C; color: white; cursor: pointer; text-decoration: none; box-shadow: 0 2px 8px rgba(220, 20, 60, 0.3);">
            <span>üö®</span> Report Accident
        </button>
        <button class="btn btn-outline" onclick="window.location.href='{% url 'hotspots' %}'" style="padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; border: 2px solid #003087; background: transparent; color: #003087; cursor: pointer; text-decoration: none;">
            <span>üó∫Ô∏è</span> View Hotspots
        </button>
        <button class="btn btn-outline" onclick="AGNESSystem.printPage()" style="padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; border: 2px solid #666; background: transparent; color: #666; cursor: pointer; text-decoration: none;">
            <span>üñ®Ô∏è</span> Print
        </button>
    </div>
</div>

    <!-- Real-Time Operational Stats -->
    <div class="operational-stats-section" style="background: linear-gradient(135deg, #003087 0%, #0056b3 100%); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; color: white; box-shadow: 0 4px 15px rgba(0, 48, 135, 0.2);">
        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 600; opacity: 0.95;">üìä OPERATIONAL SUMMARY</h3>
        <div class="time-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <!-- TODAY -->
            <div class="time-stat-card" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border-radius: 8px; padding: 1rem; border: 1px solid rgba(255, 255, 255, 0.2);">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.5rem;">üìÖ</span>
                    <span style="font-weight: 600; font-size: 0.9rem; opacity: 0.9;">TODAY</span>
                </div>
                <div style="font-size: 2rem; font-weight: 700; margin: 0.5rem 0;">{{ today_total }}</div>
                <div style="display: flex; gap: 1rem; font-size: 0.85rem; opacity: 0.95;">
                    <span>üíÄ {{ today_fatal }} Fatal</span>
                    <span>üè• {{ today_injury }} Injury</span>
                </div>
            </div>

            <!-- THIS WEEK -->
            <div class="time-stat-card" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border-radius: 8px; padding: 1rem; border: 1px solid rgba(255, 255, 255, 0.2);">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.5rem;">üìÜ</span>
                    <span style="font-weight: 600; font-size: 0.9rem; opacity: 0.9;">THIS WEEK</span>
                </div>
                <div style="font-size: 2rem; font-weight: 700; margin: 0.5rem 0;">{{ week_total }}</div>
                <div style="display: flex; gap: 1rem; font-size: 0.85rem; opacity: 0.95;">
                    <span>üíÄ {{ week_fatal }} Fatal</span>
                    <span>üè• {{ week_injury }} Injury</span>
                </div>
            </div>

            <!-- THIS MONTH -->
            <div class="time-stat-card" style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border-radius: 8px; padding: 1rem; border: 1px solid rgba(255, 255, 255, 0.2);">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.5rem;">üìä</span>
                    <span style="font-weight: 600; font-size: 0.9rem; opacity: 0.9;">THIS MONTH</span>
                </div>
                <div style="font-size: 2rem; font-weight: 700; margin: 0.5rem 0;">{{ month_total }}</div>
                <div style="display: flex; gap: 1rem; font-size: 0.85rem; opacity: 0.95;">
                    <span>üíÄ {{ month_fatal }} Fatal</span>
                    <span>üè• {{ month_injury }} Injury</span>
                </div>
            </div>

            <!-- CRITICAL HOTSPOTS -->
            <div class="time-stat-card" style="background: rgba(220, 20, 60, 0.9); backdrop-filter: blur(10px); border-radius: 8px; padding: 1rem; border: 1px solid rgba(255, 255, 255, 0.3);">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.5rem;">üî¥</span>
                    <span style="font-weight: 600; font-size: 0.9rem;">ACTIVE HOTSPOTS</span>
                </div>
                <div style="font-size: 2rem; font-weight: 700; margin: 0.5rem 0;">{{ total_hotspots }}</div>
                <div style="font-size: 0.85rem; opacity: 0.95;">
                    <span>‚ö†Ô∏è Requires attention</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background-color: #DC143C;">üöó</div>
            <div class="stat-content">
                <h3>{{ total_accidents|default:0 }}</h3>
                <p>Total Accidents</p>
                <span class="stat-trend">üìà +{{ recent_increase|default:0 }}% this month</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background-color: #FFA500;">‚öïÔ∏è</div>
            <div class="stat-content">
                <h3>{{ total_casualties|default:0 }}</h3>
                <p>Total Casualties</p>
                <span class="stat-trend">
                    {{ killed|default:0 }} killed, {{ injured|default:0 }} injured
                </span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background-color: #28A745;">üìù</div>
            <div class="stat-content">
                <h3>{{ pending_reports|default:0 }}</h3>
                <p>Pending Reports</p>
                <span class="stat-trend">‚è≥ Awaiting verification</span>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-row">
            <!-- Accidents Over Time -->
            <div class="chart-container">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Accidents Over Time (Last 12 Months)</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="accidentsTimeChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Accidents by Province -->
            <div class="chart-container">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Accidents by Province</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="provinceChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-row">
            <!-- Accidents by Type -->
            <div class="chart-container">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Accident Types Distribution</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="accidentTypeChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Time of Day Analysis -->
            <div class="chart-container">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Accidents by Time of Day</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="timeOfDayChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Recent Accidents & Top Hotspots -->
    <div class="data-tables-section">
        <div class="table-row">
            <!-- Enhanced Recent Accidents -->
            <div class="table-container">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üö® Recent Accidents</h3>
                        <div class="header-actions">
                            <button class="btn btn-outline btn-sm" onclick="filterRecentAccidents('all')">All</button>
                            <button class="btn btn-outline btn-sm" onclick="filterRecentAccidents('fatal')">Fatal</button>
                            <button class="btn btn-outline btn-sm" onclick="filterRecentAccidents('injury')">Injury</button>
                            <a href="{% url 'accident_list' %}" class="btn btn-outline btn-sm">View All</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="data-table enhanced-table" id="recentAccidentsTable">
                                <thead>
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Location</th>
                                        <th>Type</th>
                                        <th>Casualties</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for accident in recent_accidents %}
                                    <tr class="accident-row {% if accident.victim_killed %}fatal{% elif accident.victim_injured %}injury{% else %}property{% endif %}" 
                                        data-severity="{% if accident.victim_killed %}fatal{% elif accident.victim_injured %}injury{% else %}property{% endif %}">
                                        <td>
                                            <div class="datetime-cell">
                                                <strong>{{ accident.date_committed|date:"M d, Y" }}</strong>
                                                <small>{{ accident.time_committed|time:"H:i" }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="location-cell">
                                                <strong>{{ accident.barangay }}</strong>
                                                <span>{{ accident.municipal }}, {{ accident.province }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="incident-type" title="{{ accident.incident_type }}">
                                                {{ accident.incident_type|truncatewords:3 }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="casualty-indicator {% if accident.victim_killed %}fatal{% elif accident.victim_injured %}injury{% else %}property{% endif %}">
                                                <span class="casualty-count">{{ accident.victim_count }}</span>
                                                {% if accident.victim_killed %}
                                                <span class="casualty-icon">üíÄ</span>
                                                {% elif accident.victim_injured %}
                                                <span class="casualty-icon">üè•</span>
                                                {% else %}
                                                <span class="casualty-icon">üöó</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge status-{{ accident.case_status|lower|cut:' ' }}">
                                                {{ accident.case_status }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="btn-icon view-btn" onclick="viewAccident({{ accident.id }})" title="View Details">
                                                    üëÅÔ∏è
                                                </button>
                                                <button class="btn-icon map-btn" onclick="showOnMap({{ accident.latitude }}, {{ accident.longitude }})" title="Show on Map">
                                                    üó∫Ô∏è
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center no-data">
                                            <div class="empty-state">
                                                <span class="empty-icon">üìä</span>
                                                <p>No recent accidents</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Top Hotspots -->
            <div class="table-container">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üî¥ Top Accident Hotspots</h3>
                        <div class="header-actions">
                            <button class="btn btn-outline btn-sm" onclick="filterHotspots('all')">All</button>
                            <button class="btn btn-outline btn-sm" onclick="filterHotspots('critical')">Critical</button>
                            <button class="btn btn-outline btn-sm" onclick="filterHotspots('high')">High</button>
                            <a href="{% url 'hotspots' %}" class="btn btn-outline btn-sm">View All</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="data-table enhanced-table" id="hotspotsTable">
                                <thead>
                                    <tr>
                                        <th>Hotspot</th>
                                        <th>Location</th>
                                        <th>Accidents</th>
                                        <th>Severity</th>
                                        <th>Risk Level</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for hotspot in top_hotspots %}
                                    <tr class="hotspot-row" data-severity="{{ hotspot.severity_score }}">
                                        <td>
                                            <div class="hotspot-info">
                                                <span class="hotspot-badge cluster-{{ hotspot.cluster_id }}">
                                                    #{{ hotspot.cluster_id }}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="location-cell">
                                                <strong>{{ hotspot.primary_location }}</strong>
                                                <span>
                                                    {% for municipal in hotspot.municipalities|slice:":2" %}
                                                        {{ municipal }}{% if not forloop.last %}, {% endif %}
                                                    {% endfor %}
                                                    {% if hotspot.municipalities|length > 2 %}
                                                        +{{ hotspot.municipalities|length|add:"-2" }} more
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="accident-count">
                                                <strong>{{ hotspot.accident_count }}</strong>
                                                <small>accidents</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="severity-meter">
                                                <div class="severity-track">
                                                    <div class="severity-progress" style="width: {{ hotspot.severity_score }}%">
                                                        <span class="severity-value">{{ hotspot.severity_score|floatformat:1 }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="risk-level risk-{% if hotspot.severity_score >= 80 %}critical{% elif hotspot.severity_score >= 60 %}high{% elif hotspot.severity_score >= 40 %}medium{% else %}low{% endif %}">
                                                {% if hotspot.severity_score >= 80 %}CRITICAL
                                                {% elif hotspot.severity_score >= 60 %}HIGH
                                                {% elif hotspot.severity_score >= 40 %}MEDIUM
                                                {% else %}LOW{% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="btn-icon analyze-btn" onclick="analyzeHotspot({{ hotspot.cluster_id }})" title="Analyze Hotspot">
                                                    üìà
                                                </button>
                                                <button class="btn-icon map-btn" onclick="showHotspotOnMap({{ hotspot.cluster_id }})" title="Show on Map">
                                                    üó∫Ô∏è
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center no-data">
                                            <div class="empty-state">
                                                <span class="empty-icon">üîç</span>
                                                <p>No hotspots detected</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>   <!-- Recent Accidents & Top Hotspots -->

{% endblock %}

{% block extra_css %}
<style>
    
        /* Real-time Alert Banner Styles */
    .alerts-container {
        margin-bottom: 1.5rem;
    }

    .alert-banner {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.65rem 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 3px solid;
        animation: slideDown 0.5s ease-out;
        transition: all 0.3s ease;
    }

    .alert-banner:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    .alert-critical {
        background: linear-gradient(135deg, #fff5f5, #fed7d7);
        border-left-color: #e53e3e;
        color: #742a2a;
    }

    .alert-danger {
        background: linear-gradient(135deg, #fff5f5, #fed7d7);
        border-left-color: #f56565;
        color: #742a2a;
    }

    .alert-warning {
        background: linear-gradient(135deg, #fffaf0, #feebc8);
        border-left-color: #ed8936;
        color: #744210;
    }

    .alert-info {
        background: linear-gradient(135deg, #f0fff4, #c6f6d5);
        border-left-color: #38a169;
        color: #22543d;
    }

    .alert-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .alert-content {
        flex: 1;
    }

    .alert-title {
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }

    .alert-message {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .alert-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-shrink: 0;
    }

    .btn-alert {
        padding: 0.5rem 1rem;
        background: rgba(255,255,255,0.3);
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 6px;
        color: inherit;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.2s ease;
    }

    .btn-alert:hover {
        background: rgba(255,255,255,0.5);
        transform: translateY(-1px);
    }

    .btn-alert-close {
        background: none;
        border: none;
        font-size: 1.25rem;
        font-weight: bold;
        color: inherit;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.2s ease;
        opacity: 0.7;
    }

    .btn-alert-close:hover {
        opacity: 1;
        background: rgba(0,0,0,0.1);
    }

    /* Alert animations */
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Alert counter badge for header */
    .alert-counter {
        background: #e53e3e;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
        margin-left: 0.5rem;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    /* Responsive alerts */
    @media (max-width: 768px) {
        .alert-banner {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .alert-actions {
            align-self: flex-end;
        }
    }

    .data-tables-section {
        margin-bottom: 2rem;
    }

    .table-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
        gap: 1.25rem;
    }

    .table-container .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.8rem 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .header-actions {
        display: flex;
        gap: 0.3rem;
        align-items: center;
    }

    /* Compact Table Styles Only */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.82rem;
    }

    .data-table thead {
        background: #f8f9fa;
    }

    .data-table th {
        padding: 0.6rem 0.8rem;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .data-table td {
        padding: 0.5rem 0.8rem;
        border-bottom: 1px solid #e9ecef;
        vertical-align: middle;
    }

    .data-table tbody tr {
        height: 45px;
    }

    .data-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    /* Compact Badges */
    .badge {
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 500;
    }

    .hotspot-badge {
        background-color: #FFF0F0;
        color: #DC143C;
        padding: 0.2rem 0.6rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.75rem;
    }

    /* Compact Severity Bar */
    .severity-bar {
        background-color: #E9ECEF;
        border-radius: 4px;
        height: 18px;
        position: relative;
        overflow: hidden;
    }

    .severity-fill {
        background: linear-gradient(90deg, #FFA500, #DC143C);
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.65rem;
        font-weight: 600;
    }

    /* Compact Buttons for Tables Only */
    .table-container .btn {
        padding: 0.3rem 0.7rem;
        border-radius: 5px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 0.75rem;
    }

    .table-container .btn-outline {
        background: transparent;
        color: #007bff;
        border-color: #007bff;
    }

    .table-container .btn-outline:hover {
        background: #007bff;
        color: white;
    }

    .table-container .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
    }

    /* ===== ENHANCED FLAT & CLEAN STYLING ===== */

    /* Recent Accidents - Clean Row Styling */
    .accident-row {
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
    }

    .accident-row:hover {
        background-color: #f8f9fa !important;
        border-left-color: #0052CC;
        transform: translateX(2px);
    }

    .accident-row.fatal {
        border-left-color: #ff4757;
        background-color: #fff5f6;
    }

    .accident-row.injury {
        border-left-color: #ffa502;
        background-color: #fff8f0;
    }

    .accident-row.property {
        border-left-color: #70a1ff;
        background-color: #f0f5ff;
    }

    /* DateTime Cell - Flat Clean Design */
    .datetime-cell {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .datetime-cell strong {
        color: #2c3e50;
        font-size: 0.8rem;
    }

    .datetime-cell small {
        color: #95a5a6;
        font-size: 0.7rem;
        font-weight: 500;
    }

    /* Location Cell - Clean Typography */
    .location-cell {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .location-cell strong {
        color: #2c3e50;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .location-cell span {
        color: #7f8c8d;
        font-size: 0.7rem;
    }

    /* Incident Type Badge */
    .incident-type {
        color: #5f6368;
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* Casualty Indicator - Flat Modern Design */
    .casualty-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.65rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .casualty-indicator.fatal {
        background: linear-gradient(135deg, #ffe5e5, #ffd0d0);
        color: #c0392b;
        border: 1px solid #ffb3b3;
    }

    .casualty-indicator.injury {
        background: linear-gradient(135deg, #fff4e5, #ffe8cc);
        color: #d68910;
        border: 1px solid #ffd699;
    }

    .casualty-indicator.property {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        color: #1565c0;
        border: 1px solid #90caf9;
    }

    .casualty-count {
        font-size: 0.85rem;
        font-weight: 700;
    }

    .casualty-icon {
        font-size: 1rem;
    }

    /* Status Badge - Clean Flat Colors */
    .status-badge {
        display: inline-block;
        padding: 0.3rem 0.7rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .status-investigated,
    .status-under_investigation {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        color: #2e7d32;
        border: 1px solid #a5d6a7;
    }

    .status-pending {
        background: linear-gradient(135deg, #fff9e6, #ffecb3);
        color: #f57c00;
        border: 1px solid #ffd54f;
    }

    .status-closed {
        background: linear-gradient(135deg, #e0e0e0, #bdbdbd);
        color: #424242;
        border: 1px solid #9e9e9e;
    }

    /* Action Buttons - Modern Flat Design */
    .action-buttons {
        display: flex;
        gap: 0.3rem;
    }

    .btn-icon {
        background: #f5f6fa;
        border: 1px solid #dfe4ea;
        border-radius: 6px;
        padding: 0.35rem 0.5rem;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-icon:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .view-btn:hover {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-color: #2196f3;
    }

    .map-btn:hover {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        border-color: #4caf50;
    }

    .analyze-btn:hover {
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        border-color: #ff9800;
    }

    /* Hotspot Row - Clean Design */
    .hotspot-row {
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
    }

    .hotspot-row:hover {
        background-color: #f8f9fa !important;
        border-left-color: #ff6348;
        transform: translateX(2px);
    }

    .hotspot-row[data-severity] {
        position: relative;
    }

    /* Hotspot Badge - Flat Modern */
    .hotspot-badge {
        background: linear-gradient(135deg, #fff0f0, #ffe0e0);
        color: #d32f2f;
        padding: 0.3rem 0.7rem;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.75rem;
        border: 1px solid #ffcdd2;
        display: inline-block;
    }

    /* Accident Count - Clean Display */
    .accident-count {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.1rem;
    }

    .accident-count strong {
        font-size: 1.1rem;
        color: #2c3e50;
        font-weight: 700;
    }

    .accident-count small {
        font-size: 0.65rem;
        color: #95a5a6;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    /* Severity Meter - Flat Progress Bar */
    .severity-meter {
        width: 100%;
    }

    .severity-track {
        background: #e9ecef;
        border-radius: 8px;
        height: 24px;
        overflow: hidden;
        position: relative;
        border: 1px solid #dee2e6;
    }

    .severity-progress {
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 50%, #ffa502 80%, #ff4757 100%);
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 0.5rem;
        transition: all 0.5s ease;
        position: relative;
    }

    .severity-value {
        color: white;
        font-size: 0.7rem;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    /* Risk Level Badges - Clean Flat Colors */
    .risk-level {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .risk-critical {
        background: linear-gradient(135deg, #ffe5e5, #ffcccc);
        color: #c0392b;
        border: 1.5px solid #ff9999;
    }

    .risk-high {
        background: linear-gradient(135deg, #fff4e5, #ffe8cc);
        color: #d68910;
        border: 1.5px solid #ffd699;
    }

    .risk-medium {
        background: linear-gradient(135deg, #fff9e6, #ffecb3);
        color: #f39c12;
        border: 1.5px solid #ffd54f;
    }

    .risk-low {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        color: #27ae60;
        border: 1.5px solid #a5d6a7;
    }

    /* Empty State - Clean Design */
    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
    }

    .empty-icon {
        font-size: 3rem;
        display: block;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state p {
        color: #95a5a6;
        font-size: 0.9rem;
        margin: 0;
    }

    /* Card Header Enhanced */
    .table-container .card-header {
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        border-bottom: 2px solid #e9ecef;
    }

    .card-title {
        color: #2c3e50;
        font-weight: 700;
        font-size: 1.1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .casualty-indicator,
        .risk-level,
        .status-badge {
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
        }

        .accident-count strong {
            font-size: 0.95rem;
        }
    }

    /* Keep your existing dashboard styles for other sections */
    .dashboard-container {
        max-width: 100%;
    }

    .page-header {
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-header h2 {
        font-size: 2rem;
        color: var(--primary-blue);
        margin-bottom: 0.25rem;
    }

    .page-header p {
        color: var(--text-medium);
    }

    .dashboard-actions {
        display: flex;
        gap: 1rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 992px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        gap: 1rem;
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
    }

    .stat-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-3px);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
    }

    .stat-content h3 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.25rem;
    }

    .stat-content p {
        color: var(--text-medium);
        margin-bottom: 0.5rem;
    }

    .stat-trend {
        font-size: 0.85rem;
        color: #666;
        font-weight: 500;
    }

    .charts-section {
        margin-bottom: 2rem;
    }

    .chart-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .chart-container {
        min-height: 350px;
    }

    @media (max-width: 768px) {
        .chart-row,
        .table-row {
            grid-template-columns: 1fr;
        }

        .table-container .card-header {
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-start;
        }

        .header-actions {
            width: 100%;
            justify-content: flex-start;
        }

        /* Mobile responsiveness for new operational stats */
        .page-header {
            flex-direction: column !important;
            gap: 1rem;
        }

        .page-header h2 {
            font-size: 1.3rem !important;
        }

        .page-header p {
            font-size: 0.85rem !important;
        }

        .dashboard-actions {
            width: 100%;
            justify-content: flex-start !important;
        }

        .dashboard-actions button {
            flex: 1;
            min-width: auto !important;
            padding: 0.5rem 0.8rem !important;
            font-size: 0.85rem !important;
        }

        .operational-stats-section {
            padding: 1rem !important;
        }

        .operational-stats-section h3 {
            font-size: 0.95rem !important;
        }

        .time-stats-grid {
            grid-template-columns: 1fr !important;
            gap: 0.75rem !important;
        }

        .time-stat-card {
            padding: 0.75rem !important;
        }

        .time-stat-card > div:nth-child(2) {
            font-size: 1.5rem !important;
        }

        .stats-grid {
            grid-template-columns: 1fr !important;
        }
    }

    @media (max-width: 480px) {
        .page-header h2 {
            font-size: 1.1rem !important;
        }

        .time-stat-card > div:nth-child(2) {
            font-size: 1.3rem !important;
        }

        .dashboard-actions button span:first-child {
            display: none;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Sample data for charts - Replace with actual data from backend
    document.addEventListener('DOMContentLoaded', function() {
        // Accidents Over Time Chart
        const timeLabels = {{ time_labels|safe }};
        const timeData = {{ time_data|safe }};
        AGNESSystem.createLineChart(
            'accidentsTimeChart',
            timeLabels,
            timeData,
            'Number of Accidents'
        );

        // Province Chart
        const provinceLabels = {{ province_labels|safe }};
        const provinceData = {{ province_data|safe }};
        AGNESSystem.createBarChart(
            'provinceChart',
            provinceLabels,
            provinceData,
            'Accidents by Province'
        );

        // Accident Type Chart
        const typeLabels = {{ type_labels|safe }};
        const typeData = {{ type_data|safe }};
        AGNESSystem.createPieChart(
            'accidentTypeChart',
            typeLabels,
            typeData
        );

        // Time of Day Chart
        const todLabels = ['Night (12AM-6AM)', 'Morning (6AM-12PM)', 'Afternoon (12PM-6PM)', 'Evening (6PM-12AM)'];
        const todData = {{ time_of_day_data|safe }};
        AGNESSystem.createBarChart(
            'timeOfDayChart',
            todLabels,
            todData,
            'Accidents by Time Period',
            ['#001F3F', '#003087', '#0052CC', '#4A90E2']
        );
    });

function refreshDashboardData() {
    console.log('Refreshing dashboard data...');
    
    // Show loading indicator
    showNotification('üîÑ Updating dashboard data...', 'info');
    
    // Use Fetch API to get updated data without page reload
    fetch(window.location.href, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Create temporary DOM parser to extract updated elements
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Update statistics cards
        updateStatisticsCards(doc);
        
        // Update recent accidents table
        updateRecentAccidents(doc);
        
        // Update hotspots table
        updateHotspots(doc);
        
        showNotification('‚úÖ Dashboard updated successfully', 'success');
    })
    .catch(error => {
        console.error('Refresh failed:', error);
        showNotification('‚ùå Failed to update dashboard', 'error');
    });
}

function updateStatisticsCards(newDoc) {
    const statCards = newDoc.querySelectorAll('.stat-card');
    const currentCards = document.querySelectorAll('.stat-card');
    
    statCards.forEach((newCard, index) => {
        if (currentCards[index]) {
            const newValue = newCard.querySelector('h3')?.textContent;
            const currentValue = currentCards[index].querySelector('h3')?.textContent;
            
            if (newValue && newValue !== currentValue) {
                // Animate value change
                animateValueChange(currentCards[index].querySelector('h3'), currentValue, newValue);
            }
        }
    });
}

function updateRecentAccidents(newDoc) {
    const newTable = newDoc.querySelector('.data-table tbody');
    const currentTable = document.querySelector('.data-table tbody');
    
    if (newTable && currentTable && newTable.innerHTML !== currentTable.innerHTML) {
        currentTable.innerHTML = newTable.innerHTML;
    }
}

function updateHotspots(newDoc) {
    const hotspotTables = newDoc.querySelectorAll('.table-container .data-table tbody');
    const currentHotspotTables = document.querySelectorAll('.table-container .data-table tbody');
    
    hotspotTables.forEach((newTable, index) => {
        if (currentHotspotTables[index] && newTable.innerHTML !== currentHotspotTables[index].innerHTML) {
            currentHotspotTables[index].innerHTML = newTable.innerHTML;
        }
    });
}

function animateValueChange(element, oldValue, newValue) {
    element.style.color = '#007bff';
    element.style.transition = 'color 0.5s ease';
    
    setTimeout(() => {
        element.textContent = newValue;
        setTimeout(() => {
            element.style.color = '';
        }, 1000);
    }, 300);
}

function showNotification(message, type) {
    // Remove existing notification
    const existingNotification = document.querySelector('.dashboard-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `dashboard-notification alert alert-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button class="alert-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    // Add styles for notification
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 1000;
        max-width: 300px;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 3000);
}

// Add CSS animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .dashboard-notification {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
`;
document.head.appendChild(style);


// Enhanced Table Functionality
function filterRecentAccidents(filter) {
    const rows = document.querySelectorAll('#recentAccidentsTable .accident-row');
    
    rows.forEach(row => {
        if (filter === 'all') {
            row.style.display = '';
        } else {
            const severity = row.getAttribute('data-severity');
            if (severity === filter) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
    
    // Update active filter button
    document.querySelectorAll('#recentAccidentsTable ~ .card .header-actions .btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline');
    });
    event.target.classList.remove('btn-outline');
    event.target.classList.add('btn-primary');
}

function filterHotspots(filter) {
    const rows = document.querySelectorAll('#hotspotsTable .hotspot-row');
    
    rows.forEach(row => {
        const severity = parseFloat(row.getAttribute('data-severity'));
        
        if (filter === 'all') {
            row.style.display = '';
        } else if (filter === 'critical' && severity >= 80) {
            row.style.display = '';
        } else if (filter === 'high' && severity >= 60 && severity < 80) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update active filter button
    document.querySelectorAll('#hotspotsTable ~ .card .header-actions .btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline');
    });
    event.target.classList.remove('btn-outline');
    event.target.classList.add('btn-primary');
}

// Action Functions
function viewAccident(accidentId) {
    window.location.href = `/accidents/${accidentId}/`;
}

function showOnMap(latitude, longitude) {
    // This would open the map view with the accident location
    window.location.href = `/map/?lat=${latitude}&lng=${longitude}&zoom=15`;
}

function analyzeHotspot(clusterId) {
    window.location.href = `/hotspots/${clusterId}/`;
}

function showHotspotOnMap(clusterId) {
    window.location.href = `/map/?cluster=${clusterId}`;
}

// Initialize table functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects
    const tables = document.querySelectorAll('.enhanced-table');
    tables.forEach(table => {
        table.addEventListener('mouseover', function(e) {
            if (e.target.tagName === 'TD') {
                e.target.parentElement.style.backgroundColor = '#f8f9fa';
            }
        });
        
        table.addEventListener('mouseout', function(e) {
            if (e.target.tagName === 'TD') {
                e.target.parentElement.style.backgroundColor = '';
            }
        });
    });
});

// Alert Banner Functionality
function dismissAlert(button) {
    const alertBanner = button.closest('.alert-banner');
    alertBanner.style.animation = 'slideUp 0.3s ease-out';
    setTimeout(() => {
        alertBanner.remove();
        updateAlertCounter();
    }, 300);
}

function updateAlertCounter() {
    const remainingAlerts = document.querySelectorAll('.alert-banner').length;
    const counter = document.querySelector('.alert-counter');
    
    if (counter) {
        if (remainingAlerts > 0) {
            counter.textContent = remainingAlerts;
        } else {
            counter.remove();
        }
    }
}

// Auto-dismiss non-critical alerts after 8 seconds, show only on first load after login
document.addEventListener('DOMContentLoaded', function() {
    // Check if this is first load after login using sessionStorage
    const alertsShownKey = 'dashboard_alerts_shown';
    const alertsAlreadyShown = sessionStorage.getItem(alertsShownKey);

    // If alerts were already shown this session, hide them immediately
    if (alertsAlreadyShown === 'true') {
        const allAlerts = document.querySelectorAll('.alert-banner');
        allAlerts.forEach(alert => {
            alert.style.display = 'none';
        });
        return; // Exit early, don't show alerts again
    }

    // Mark that alerts have been shown for this session
    sessionStorage.setItem(alertsShownKey, 'true');

    // Auto-dismiss non-critical alerts after 8 seconds
    const nonCriticalAlerts = document.querySelectorAll('.alert-banner:not(.alert-critical)');

    nonCriticalAlerts.forEach(alert => {
        setTimeout(() => {
            if (alert.parentElement) {
                alert.style.animation = 'slideUp 0.3s ease-out';
                setTimeout(() => {
                    if (alert.parentElement) {
                        alert.remove();
                        updateAlertCounter();
                    }
                }, 300);
            }
        }, 8000); // 8 seconds (reduced from 30)
    });
});

// Add slideUp animation
const alertStyle = document.createElement('style');
alertStyle.textContent = `
    @keyframes slideUp {
        from {
            opacity: 1;
            transform: translateY(0);
            max-height: 100px;
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
            max-height: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
    }
`;
document.head.appendChild(alertStyle);





</script>
{% endblock %}