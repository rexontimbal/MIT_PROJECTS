{% extends 'base.html' %}
{% load static %}

{% block title %}Interactive Accident Map{% endblock %}

{% block breadcrumb_items %}
<span> / Map View</span>
{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .page-header h2 {
        margin: 0;
        color: var(--primary-blue);
        font-size: 1.5rem;
    }

    .page-header p {
        margin: 0.25rem 0 0 0;
        color: var(--text-medium);
        font-size: 0.9rem;
    }

    .dashboard-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* Map Wrapper */
    .map-wrapper {
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .map-container {
        height: calc(100vh - 280px);
        min-height: 600px;
        position: relative;
    }

    #mainMap {
        height: 100%;
        width: 100%;
    }

    /* Enhanced Toggle Buttons */
    .map-toggle-buttons {
        position: absolute;
        top: 50%;
        left: 15px;
        transform: translateY(-50%);
        z-index: 999;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .toggle-icon-btn {
        width: 48px;
        height: 48px;
        background: white;
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        transition: all 0.3s ease;
        position: relative;
    }

    .toggle-icon-btn:hover {
        background: var(--light-blue);
        transform: scale(1.1);
    }

    .toggle-icon-btn.active {
        background: var(--primary-blue);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 48, 135, 0.3);
    }

    /* Tooltip for buttons */
    .toggle-icon-btn::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 58px;
        background: var(--dark-navy);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 10;
    }

    .toggle-icon-btn:hover::after {
        opacity: 1;
    }

    /* Stats Box */
    .map-stats {
        position: absolute;
        top: 20px;
        left: 80px;
        z-index: 900;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        transform: translateX(-120%);
        opacity: 0;
        pointer-events: none;
        width: 260px; 
        cursor: text;
        user-select: none;
    }

    .map-stats.show {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
    }

    .stats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.9rem 1.1rem;
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
        border-radius: 12px 12px 0 0;
        font-weight: 700;
        font-size: 0.9rem;
        cursor: grab;
        user-select: none;
    }

    .stats-header span {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .stats-content {
        padding: 10px;
        user-select: none;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.85rem;
        padding: 3px 0;
        border-bottom: 1px solid #E9ECEF;
    }

    .stat-item:last-child {
        margin-bottom: 0;
        border-bottom: none;
    }

    .stat-label {
        color: #666;
        font-weight: 500;
    }

    .stat-value {
        font-weight: 700;
        color: #003087;
        font-size: 0.8rem;
    }

    /* Map Controls Panel */
    .map-controls {
        position: absolute;
        top: 20px;
        left: 80px;
        z-index: 900;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        width: 260px;
        max-width: 260px;
        transition: all 0.3s ease;
        transform: translateX(-100%);
        opacity: 0;
        pointer-events: none;
    }

    .map-controls.show {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
    }

    .controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.9rem 1.1rem;
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
        border-radius: 10px 10px 0 0;
        cursor: grab;
        user-select: none;
    }

    .controls-header h3 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .controls-body {
        padding: 1.1rem;
        max-height: 500px;
        overflow-y: auto;
    }

    body.fullscreen-mode .controls-body {
        max-height: calc(100vh - 80px);  
    }

    .control-section {
        margin-bottom: 1.3rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .control-section:last-child {
        margin-bottom: 0;
        border-bottom: none;
    }

    .control-section h4 {
        margin: 0 0 0.9rem 0;
        color: var(--primary-blue);
        font-size: 0.85rem;
        font-weight: 600;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--light-blue);
    }

    .control-group {
        margin-bottom: 0.9rem;
    }

    .control-group:last-child {
        margin-bottom: 0;
    }

    .control-group label {
        display: block;
        margin-bottom: 0.4rem;
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.8rem;
    }

    .control-group select, 
    .control-group input {
        width: 100%;
        padding: 0.55rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.85rem;
        background: white;
        transition: border-color 0.2s;
    }

    .control-group select:focus,
    .control-group input:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08);
    }

    .control-group button {
        width: 100%;
        padding: 0.6rem;
        font-size: 0.85rem;
    }

    /* Layer Toggles */
    .layer-toggle {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        padding: 0.65rem 0.75rem;
        cursor: pointer;
        border-radius: 6px;
        transition: background 0.2s;
        margin-bottom: 0.4rem;
    }

    .layer-toggle:last-child {
        margin-bottom: 0;
    }

    .layer-toggle:hover {
        background-color: var(--light-blue);
    }

    .layer-toggle input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
        margin: 0;
    }

    .layer-toggle span {
        font-size: 0.85rem;
        color: var(--text-dark);
    }

    /* Enhanced Legend */
    .map-legend {
        position: absolute;
        bottom: 20px;
        left: 80px;
        z-index: 900;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        transform: translateX(-120%);
        opacity: 0;
        pointer-events: none;
        width: 260px; 
        max-height: calc(100vh - 300px);
        overflow: hidden;
        cursor: text;
        user-select: none;
    }

    .map-legend.show {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
    }

    .legend-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.9rem 1.1rem;
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        border-radius: 12px 12px 0 0;
        font-weight: 700;
        font-size: 0.9rem;
        border-bottom: 2px solid var(--light-blue);
        cursor: grab;
        user-select: none;
    }

    .legend-header h4 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
        color: white;
    }

    .legend-content {
        padding: 15px;
        max-height: calc(100vh - 350px);
        overflow-y: auto;
        user-select: none;
    }

    .legend-category {
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 1px solid #E9ECEF;
    }

    .legend-category:last-child {
        margin-bottom: 0;
        border-bottom: none;
        padding-bottom: 0;
    }

    .legend-category-title {
        font-weight: 700;
        font-size: 0.75rem;
        color: #003087;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        font-size: 0.75rem;
        color: #333;
        line-height: 1.3;
    }

    .legend-item:last-child {
        margin-bottom: 0;
    }

    /* Close Buttons */
    .stats-close-btn,
    .legend-close-btn,
    .controls-close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
        margin-left: 10px;
    }

    .stats-close-btn:hover,
    .legend-close-btn:hover,
    .controls-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    /* Time Filter Badge */
    .time-filter-badge {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary-blue);
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 600;
        z-index: 800;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: none;
        align-items: center;
        gap: 12px;
        transition: all 0.3s ease;
        white-space: nowrap;
        max-width: 500px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .time-filter-badge.show {
        display: flex;
    }

    .time-filter-badge .close-banner {
        background: rgba(255,255,255,0.3);
        border: none;
        color: white;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
        font-weight: bold;
    }

    .time-filter-badge .close-banner:hover {
        background: rgba(255,255,255,0.5);
        transform: scale(1.1);
    }

    /* Search Active Banner */
    .search-active-banner {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #FFA500, #FF8C00);
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 600;
        z-index: 800;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: none;
        align-items: center;
        gap: 12px;
        transition: all 0.3s ease;
        white-space: nowrap;
        max-width: 500px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .search-active-banner.show {
        display: flex;
    }

    .search-active-banner .close-banner {
        background: rgba(255,255,255,0.3);
        border: none;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .search-active-banner .close-banner:hover {
        background: rgba(255,255,255,0.5);
        transform: scale(1.1);
    }

    /* Enhanced Popup Styling */
    .leaflet-popup-content-wrapper {
        border-radius: 10px;
        padding: 0;
    }

    .marker-popup {
        min-width: 280px;
    }

    .popup-header {
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
        padding: 0.9rem;
        border-radius: 10px 10px 0 0;
        margin: -20px -20px 0 -20px;
    }

    .popup-header h4 {
        margin: 0;
        font-size: 0.95rem;
    }

    .popup-body {
        padding: 0.9rem;
    }

    .popup-body p {
        margin: 0.4rem 0;
        font-size: 0.85rem;
    }

    .popup-footer {
        padding: 0 0.9rem 0.9rem 0.9rem;
        display: flex;
        gap: 0.5rem;
    }

    .popup-footer a {
        display: inline-block;
        padding: 0.45rem 0.9rem;
        background-color: var(--primary-blue);
        color: white;
        border-radius: 5px;
        text-decoration: none;
        font-size: 0.8rem;
        transition: background 0.2s;
    }

    .popup-footer a:hover {
        background-color: var(--secondary-blue);
    }

    /* Search System */
    .floating-search-btn {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        z-index: 1000;
        width: 48px;
        height: 48px;
        background: white;
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        transition: all 0.3s ease;
    }

    .floating-search-btn:hover {
        background: var(--light-blue);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .floating-search-btn.active {
        background: var(--primary-blue);
        color: white;
    }

    .map-search-container {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-120%);
        z-index: 1000;
        width: 90%;
        max-width: 600px;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .map-search-container.active {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .search-bar {
        display: flex;
        gap: 0.5rem;
        background: white;
        padding: 0.5rem;
        border-radius: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border: 2px solid var(--primary-blue);
    }

    .search-bar input {
        flex: 1;
        border: none;
        padding: 0.7rem 1.2rem;
        font-size: 0.9rem;
        outline: none;
        background: transparent;
        color: var(--text-dark);
    }

    .search-bar input::placeholder {
        color: var(--text-light);
    }

    .search-btn {
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 0.5rem 1.5rem;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .search-btn:hover {
        background: var(--secondary-blue);
        transform: scale(1.05);
    }

    .close-search-btn {
        background: #DC143C;
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .close-search-btn:hover {
        background: #8B0000;
        transform: rotate(90deg);
    }

    /* Search Suggestions */
    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        z-index: 1001;
        margin-top: 0.5rem;
        border: 1px solid var(--border-color);
    }

    body.fullscreen-mode .search-suggestions {
        max-height: calc(100vh - 150px);
    }

    .suggestion-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s ease;
        gap: 0.75rem;
    }

    .suggestion-item:hover {
        background: var(--light-blue);
        padding-left: 1.25rem;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-icon {
        font-size: 1.1rem;
        width: 24px;
        text-align: center;
        flex-shrink: 0;
    }

    .suggestion-text {
        flex: 1;
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .suggestion-type {
        background: var(--bg-light);
        color: var(--text-medium);
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Search History */
    .search-history {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        z-index: 1001;
        margin-top: 0.5rem;
        border: 1px solid var(--border-color);
    }

    body.fullscreen-mode .search-history {
        max-height: calc(100vh - 150px);
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--bg-light);
        border-bottom: 1px solid var(--border-color);
        border-radius: 12px 12px 0 0;
    }

    .history-header span {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .clear-history {
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.2s;
    }

    .clear-history:hover {
        background: var(--secondary-blue);
    }

    .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.9rem 1rem;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s;
    }

    .history-item:hover {
        background: var(--light-blue);
    }

    .history-item:last-child {
        border-bottom: none;
    }

    .history-query {
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.85rem;
    }

    .history-time {
        color: var(--text-light);
        font-size: 0.75rem;
    }

    .history-remove {
        background: #DC143C;
        color: white;
        border: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        margin-left: 0.5rem;
    }

    .history-remove:hover {
        background: #8B0000;
        transform: scale(1.1);
    }

    /* Quick Search Tags */
    .quick-search-tags {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
        flex-wrap: wrap;
        justify-content: center;
        animation: fadeIn 0.5s ease 0.2s both;
    }

    .tag-btn {
        background: white;
        border: 1px solid var(--border-color);
        padding: 0.4rem 0.9rem;
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-dark);
    }

    .tag-btn:hover {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    /* Search Info Panel */
    .search-info-panel {
        position: absolute;
        top: 40px;
        right: 80px;
        width: 260px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 900;
        max-height: calc(100vh - 100px);
        overflow: hidden;
        animation: slideInRight 0.3s ease;
    }

    body.fullscreen-mode .search-info-panel {
        max-height: calc(100vh - 50px);
    }

    .search-info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
    }

    .search-info-header h4 {
        margin: 0;
        font-size: 0.95rem;
    }

    .search-info-header button {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s;
    }

    .search-info-header button:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }

    .search-info-body {
        padding: 1rem;
        overflow-y: auto;
        max-height: calc(100vh - 200px);
    }

    body.fullscreen-mode .search-info-body {
        max-height: calc(100vh - 150px);
    }

    .search-stat-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        background: var(--bg-light);
        border-radius: 8px;
        margin-bottom: 0.75rem;
    }

    .search-stat-label {
        font-size: 0.85rem;
        color: var(--text-medium);
    }

    .search-stat-value {
        font-size: 1rem;
        font-weight: 700;
        color: var(--primary-blue);
    }

    /* Loading and Empty States */
    .suggestions-loading,
    .no-suggestions {
        padding: 2rem;
        text-align: center;
        color: var(--text-medium);
    }

    .suggestions-loading-spinner {
        width: 30px;
        height: 30px;
        border: 3px solid var(--light-blue);
        border-top-color: var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    .no-suggestions-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        opacity: 0.5;
    }

    .no-suggestions-text {
        font-size: 0.85rem;
    }

    /* Fullscreen Button */
    .fullscreen-btn {
        position: absolute;
        top: calc(50% + 60px);
        right: 15px;
        z-index: 1000;
        width: 48px;
        height: 48px;
        background: white;
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        transition: all 0.3s ease;
    }

    .fullscreen-btn:hover {
        background: var(--light-blue);
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .fullscreen-btn.active {
        background: var(--primary-blue);
        color: white;
    }

    .fullscreen-btn::after {
        content: attr(data-tooltip);
        position: absolute;
        right: 58px;
        background: var(--dark-navy);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 10;
    }

    .fullscreen-btn:hover::after {
        opacity: 1;
    }

    /* Back to List Button */
    .back-to-list-btn {
        position: absolute;
        top: calc(50% + 120px);
        right: 15px;
        z-index: 1000;
        width: 48px;
        height: 48px;
        background: white;
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        transition: all 0.3s ease;
    }

    .back-to-list-btn:hover {
        background: var(--light-blue);
        transform: scale(1.1);
    }

    /* Fullscreen Mode */
    body.fullscreen-mode {
        overflow: hidden;
    }

    body.fullscreen-mode .map-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        border-radius: 0;
        margin: 0;
    }

    body.fullscreen-mode .map-container {
        height: 100vh !important;
        border-radius: 0;
    }

    body.fullscreen-mode #mainMap {
        height: 100vh !important;
    }

    body.fullscreen-mode .breadcrumb,
    body.fullscreen-mode .page-header {
        display: none;
    }

    /* Scrollbar Styling */
    .controls-body::-webkit-scrollbar,
    .search-suggestions::-webkit-scrollbar,
    .search-history::-webkit-scrollbar {
        width: 6px;
    }

    .controls-body::-webkit-scrollbar-track,
    .search-suggestions::-webkit-scrollbar-track,
    .search-history::-webkit-scrollbar-track {
        background: var(--bg-light);
        border-radius: 10px;
    }

    .controls-body::-webkit-scrollbar-thumb,
    .search-suggestions::-webkit-scrollbar-thumb,
    .search-history::-webkit-scrollbar-thumb {
        background: var(--primary-blue);
        border-radius: 10px;
    }

    .controls-body::-webkit-scrollbar-thumb:hover,
    .search-suggestions::-webkit-scrollbar-thumb:hover,
    .search-history::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-blue);
    }

    /* Animations */
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.7; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .map-toggle-buttons {
            left: 10px;
            top: 10px;
            transform: none;
        }

        .toggle-icon-btn {
            width: 42px;
            height: 42px;
            font-size: 1.2rem;
        }

        .map-container {
            height: 500px;
        }

        .map-stats,
        .map-legend {
            left: 10px;
            width: calc(100vw - 85px);
            max-width: 220px;
        }
        
        .map-legend {
            bottom: 10px;
            max-height: 50vh;
        }

        .map-search-container {
            width: 95%;
            max-width: none;
        }
        
        .search-bar input {
            font-size: 0.85rem;
            padding: 0.6rem 1rem;
        }
        
        .search-btn {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        
        .quick-search-tags {
            gap: 0.35rem;
        }
        
        .tag-btn {
            padding: 0.35rem 0.7rem;
            font-size: 0.75rem;
        }
        
        .floating-search-btn,
        .fullscreen-btn {
            width: 42px;
            height: 42px;
            font-size: 1.2rem;
        }

        .search-suggestions,
        .search-history {
            max-height: calc(100vh - 120px);
        }
        
        .search-info-panel {
            width: 90%;
            right: 5%;
            left: 5%;
            max-height: calc(100vh - 80px);
        }

        .time-filter-badge,
        .search-active-banner {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            max-width: 300px;
            gap: 8px;
        }

        /* Hide tooltips on mobile */
        .floating-search-btn::after,
        .fullscreen-btn::after,
        .toggle-icon-btn::after {
            display: none;
        }
    }

    /* Performance Optimizations */
    .map-stats.dragging,
    .map-legend.dragging {
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        opacity: 0.95;
    }
</style>
{% endblock %}

{% block content %}
<!-- Map Wrapper -->
<div class="map-wrapper">
    <div class="map-container">
        <div id="mainMap"></div>

        <!-- Filter Badges -->
        <div class="time-filter-badge" id="timeFilterBadge">
            <span>üìÖ All Time Periods</span>
            <button class="close-banner" onclick="clearTimeFilterBadge()">√ó</button>
        </div>

        <div class="search-active-banner" id="searchActiveBanner">
            <span>üîç Search Active: <strong id="searchBannerText">""</strong></span>
            <button class="close-banner" onclick="clearSearchFromBanner()">√ó</button>
        </div>

        <!-- Control Buttons -->
        <div class="map-toggle-buttons">
            <button class="toggle-icon-btn" id="statsToggle" data-tooltip="Statistics" onclick="toggleStats()">üìä</button>
            <button class="toggle-icon-btn" id="legendToggle" data-tooltip="Legend" onclick="toggleLegend()">üó∫Ô∏è</button>
            <button class="toggle-icon-btn" id="controlsToggle" data-tooltip="Map Controls" onclick="toggleMapControls()">‚öôÔ∏è</button>
        </div>

        <!-- Search System -->
        <div class="floating-search-btn" id="floatingSearchBtn" onclick="toggleSearchBar()" data-tooltip="Search Accidents">üîç</div>

        <div class="map-search-container" id="mapSearchContainer" style="display: none;">
            <div class="search-bar">
                <input 
                    type="text" 
                    id="mapSearchInput" 
                    placeholder="üîç Search location, incident type, or keyword..."
                    autocomplete="off"
                    onkeyup="handleSearchInput(event)"
                    onkeypress="handleEnterKey(event)"
                >
                <button class="search-btn" onclick="performSearch()">Search</button>
                <button class="history-btn" id="historyBtn" onclick="toggleSearchHistory()" title="Search History">üìö</button>
                <button class="close-search-btn" onclick="closeSearchBar()">‚úï</button>
            </div>
            
            <div class="search-suggestions" id="searchSuggestions" style="display: none;"></div>
            
            <div class="search-history" id="searchHistory" style="display: none;">
                <div class="history-header">
                    <span>üìö Recent Searches</span>
                    <button class="clear-history" onclick="clearSearchHistory()">Clear All</button>
                </div>
                <div class="history-items" id="historyItems"></div>
            </div>
            
            <div class="quick-search-tags">
                <button class="tag-btn" onclick="quickSearch('fatal')">üíÄ Fatal</button>
                <button class="tag-btn" onclick="quickSearch('injury')">üöë Injury</button>
                <button class="tag-btn" onclick="quickSearch('motorcycle')">üèçÔ∏è Motorcycle</button>
                <button class="tag-btn" onclick="quickSearch('tricycle')">üõ∫ Tricycle</button>
                <button class="tag-btn" onclick="quickSearch('car')">üöó Car</button>
                <button class="tag-btn" onclick="quickSearch('pick-up')">üöô Pick-up</button>
            </div>
        </div>

        <!-- Search Results Panel -->
        <div class="search-info-panel" id="searchInfoPanel" style="display: none;">
            <div class="search-info-header">
                <h4>üîç Search Results</h4>
                <button onclick="closeSearchInfo()">‚úï</button>
            </div>
            <div class="search-info-body" id="searchInfoBody"></div>
        </div>

        <!-- Utility Buttons -->
        <div class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()" data-tooltip="Fullscreen Mode">‚õ∂</div>
        <div class="back-to-list-btn" id="backToListBtn" onclick="goBackToList()" data-tooltip="Back to Accident List" style="display: none;">üìã</div>

        <!-- Stats Panel -->
        <div class="map-stats" id="statsBox">
            <div class="stats-header" id="statsHeader">
                <span>üìä Statistics</span>
                <button class="stats-close-btn" onclick="toggleStats()">√ó</button>
            </div>
            <div class="stats-content">
                <div class="stat-item">
                    <span class="stat-label">Total Accidents:</span>
                    <span class="stat-value" id="statsTotalAccidents">{{ total_accidents }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Hotspots:</span>
                    <span class="stat-value" id="statsTotalHotspots">{{ total_hotspots }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Visible:</span>
                    <span class="stat-value" id="statsVisibleMarkers">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Time Range:</span>
                    <span class="stat-value" id="statsTimeRange">All Time</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Fatal Accidents:</span>
                    <span class="stat-value" style="color: #DC143C;" id="statsFatalAccidents">0</span>
                </div>
            </div>
        </div>

        <!-- Map Controls Panel -->
        <div class="map-controls" id="mapControls">
            <div class="controls-header" id="controlsHeader">
                <h3>üó∫Ô∏è Advanced Map Controls</h3>
                <button class="controls-close-btn" onclick="toggleMapControls()">√ó</button>
            </div>
            
            <div class="controls-body">
                <!-- Time-Based Filters -->
                <div class="control-section">
                    <h4>üìÖ Time-Based Filtering</h4>
                    
                    <div class="control-group">
                        <label for="timeRange">Time Period</label>
                        <select id="timeRange" onchange="applyTimeFilter()">
                            <option value="all">All Time</option>
                            <option value="current_year">Current Year</option>
                            <option value="last_year">Last Year</option>
                            <option value="last_6_months">Last 6 Months</option>
                            <option value="last_3_months">Last 3 Months</option>
                            <option value="last_month">Last Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>

                    <div class="control-group" id="customDateRange" style="display: none;">
                        <label for="startDate">From Date</label>
                        <input type="date" id="startDate" onchange="updateCustomRange()">
                        <label for="endDate" style="margin-top: 0.5rem;">To Date</label>
                        <input type="date" id="endDate" onchange="updateCustomRange()">
                    </div>

                    <div class="control-group">
                        <label for="timeOfDay">Time of Day</label>
                        <select id="timeOfDay" onchange="applyTimeFilter()">
                            <option value="all">All Day</option>
                            <option value="morning">Morning (6AM-12PM)</option>
                            <option value="afternoon">Afternoon (12PM-6PM)</option>
                            <option value="evening">Evening (6PM-12AM)</option>
                            <option value="night">Night (12AM-6AM)</option>
                        </select>
                    </div>
                </div>

                <!-- Data Filters -->
                <div class="control-section">
                    <h4>üîç Data Filters</h4>
                    
                    <div class="control-group">
                        <label for="provinceFilter">Province</label>
                        <select id="provinceFilter" onchange="applyFilters()">
                            <option value="">All Provinces</option>
                            {% for province in provinces %}
                            <option value="{{ province }}">{{ province }}</option>
                            {% empty %}
                            <option value="AGUSAN DEL NORTE">Agusan del Norte</option>
                            <option value="AGUSAN DEL SUR">Agusan del Sur</option>
                            <option value="SURIGAO DEL NORTE">Surigao del Norte</option>
                            <option value="SURIGAO DEL SUR">Surigao del Sur</option>
                            <option value="DINAGAT ISLANDS">Dinagat Islands</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="severityFilter">Minimum Severity</label>
                        <select id="severityFilter" onchange="applyFilters()">
                            <option value="0">All Severities</option>
                            <option value="30">Medium (30+)</option>
                            <option value="50">High (50+)</option>
                            <option value="70">Critical (70+)</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <button class="btn btn-outline" style="width: 100%;" onclick="clearAllFilters()">üóëÔ∏è Clear All Filters</button>
                    </div>
                </div>

                <!-- Map Layers -->
                <div class="control-section">
                    <h4>üóÇÔ∏è Map Layers & Visualization</h4>
                    
                    <label class="layer-toggle">
                        <input type="checkbox" id="showAccidents" checked onchange="toggleLayer('accidents')">
                        <span>üìç Accident Markers</span>
                    </label>

                    <label class="layer-toggle">
                        <input type="checkbox" id="showHotspots" checked onchange="toggleLayer('hotspots')">
                        <span>üî¥ Hotspot Areas</span>
                    </label>

                    <label class="layer-toggle">
                        <input type="checkbox" id="showClusters" onchange="toggleLayer('clusters')">
                        <span>üìä Cluster Markers</span>
                    </label>

                    <label class="layer-toggle">
                        <input type="checkbox" id="showHeatmap" onchange="toggleLayer('heatmap')">
                        <span>üî• Heatmap Layer</span>
                    </label>

                    <div class="control-group" style="margin-top: 1rem;">
                        <label for="clusterIntensity">Cluster Intensity: <span id="clusterIntensityValue">50</span>%</label>
                        <input type="range" id="clusterIntensity" min="1" max="100" value="50" 
                            oninput="updateClusterIntensityLive(this.value)" 
                            onchange="updateClusterIntensity()">
                    </div>

                    <div class="control-group">
                        <label for="heatmapIntensity">Heatmap Intensity</label>
                        <input type="range" id="heatmapIntensity" min="1" max="100" value="25" onchange="updateHeatmapIntensity()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="map-legend" id="legendBox">
            <div class="legend-header" id="legendHeader">
                <h4>üó∫Ô∏è Map Legend</h4>
                <button class="legend-close-btn" onclick="toggleLegend()">√ó</button>
            </div>
        
            <div class="legend-content">
                <!-- Accident Markers Section -->
                <div class="legend-category">
                    <div class="legend-category-title">üöó Accident Markers</div>
                    
                    <div class="legend-item">
                        <div class="legend-marker" style="background: #8B0000; width: 14px; height: 14px; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                        <span>Fatal Accident (with deaths)</span>
                    </div>
                    
                    <div class="legend-item">
                        <div class="legend-marker" style="background: #FFA500; width: 13px; height: 13px; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                        <span>Injury Accident</span>
                    </div>
                    
                    <div class="legend-item">
                        <div class="legend-marker" style="background: #DC143C; width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                        <span>Property Damage Only</span>
                    </div>
                </div>
                
                <!-- Hotspot Areas Section -->
                <div class="legend-category">
                    <div class="legend-category-title">üî• Hotspot Areas</div>
                    
                    <div class="legend-item">
                        <div class="legend-hotspot" style="background: rgba(220, 20, 60, 0.2); border: 2px solid #DC143C; width: 20px; height: 20px; border-radius: 50%;"></div>
                        <span>Critical Hotspot (70+)</span>
                    </div>
                    
                    <div class="legend-item">
                        <div class="legend-hotspot" style="background: rgba(255, 165, 0, 0.2); border: 2px solid #FFA500; width: 20px; height: 20px; border-radius: 50%;"></div>
                        <span>High Hotspot (50-69)</span>
                    </div>
                    
                    <div class="legend-item">
                        <div class="legend-hotspot" style="background: rgba(40, 167, 69, 0.2); border: 2px solid #28A745; width: 20px; height: 20px; border-radius: 50%;"></div>
                        <span>Medium Hotspot (30-49)</span>
                    </div>
                </div>
                
                <!-- Map Features Section -->
                <div class="legend-category">
                    <div class="legend-category-title">üìç Map Features</div>
                    
                    <div class="legend-item">
                        <div class="legend-cluster-icon">
                            <span style="background: #FFA500; color: white; padding: 2px 6px; border-radius: 50%; font-size: 0.7rem; font-weight: bold;">5</span>
                        </div>
                        <span>Clustered Markers</span>
                    </div>
                    
                    <div class="legend-item">
                        <div class="legend-heatmap" style="background: linear-gradient(to right, #0000FF, #FFFF00, #FF0000); width: 30px; height: 10px; border-radius: 3px;"></div>
                        <span>Heatmap Intensity</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 12px; text-align: center;">
        <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 1rem;"></div>
        <p>Loading map data...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet Markercluster Plugin -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Leaflet Heatmap Plugin -->
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
// ============================================================================
// ENHANCED MAP SYSTEM - COMPLETE WORKING VERSION
// ============================================================================

// Core Map Variables
let map;
let accidentMarkers = [];
let hotspotCircles = [];
let clusterMarkers = [];
let markerClusterGroup;
let heatmapLayer;
let allAccidents = {{ accidents_json|safe }};
let allHotspots = {{ hotspots_json|safe }};

// Search System Variables
let searchTimeout;
let searchHistory = JSON.parse(localStorage.getItem('accidentSearchHistory')) || [];

// Current filter state
let currentFilters = {
    timeRange: 'all',
    timeOfDay: 'all',
    province: '',
    severity: 0,
    searchQuery: ''
};

// Active markers (currently visible on map)
let activeMarkers = [];

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing Enhanced Map System...');
    
    validateData();
    initializeEnhancedMap();
    loadAllAccidentMarkers();
    loadAllHotspotCircles();
    setupTimeFilters();
    
    initializeSearchHistory();
    activeMarkers = [...accidentMarkers];
    updateAllStatistics();
    
    // Initialize draggable panels
    makePanelDraggable('statsBox', 'statsHeader');
    makePanelDraggable('legendBox', 'legendHeader');
    
    checkURLParametersAndJump();
});

function validateData() {
    console.log('üîç Validating accident data...');
    
    let valid = 0;
    let invalid = 0;
    
    allAccidents.forEach((accident, index) => {
        if (!accident.latitude || !accident.longitude || 
            isNaN(parseFloat(accident.latitude)) || isNaN(parseFloat(accident.longitude))) {
            console.warn(`‚ö†Ô∏è Invalid coordinates at index ${index}:`, accident.latitude, accident.longitude);
            invalid++;
            return;
        }
        valid++;
    });
    
    console.log(`‚úÖ Validation complete: ${valid} valid, ${invalid} invalid`);
    return valid > 0;
}

function initializeEnhancedMap() {
    try {
        // Center on Caraga Region
        map = L.map('mainMap').setView([9.0, 125.5], 9);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 18,
            minZoom: 7
        }).addTo(map);

        // Initialize cluster group
        initializeClusterGroup(50);

        console.log('‚úÖ Map initialized successfully');
        
        // Force map to recalculate size
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
        
    } catch (error) {
        console.error('‚ùå Map initialization failed:', error);
        alert('Error loading map. Please refresh the page.');
    }
}

function initializeClusterGroup(intensity) {
    markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: function(zoom) {
            const baseRadius = 40 + (intensity / 100 * 60);
            return zoom > 12 ? baseRadius * 0.7 : baseRadius;
        },
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        chunkedLoading: true,
        disableClusteringAtZoom: 18
    });
}

// ============================================================================
// MARKER MANAGEMENT
// ============================================================================

function loadAllAccidentMarkers() {
    console.log('üìç Loading accident markers...');
    
    accidentMarkers = [];
    markerClusterGroup.clearLayers();

    allAccidents.forEach((accident, index) => {
        try {
            const marker = createAccidentMarker(accident);
            if (marker) {
                accidentMarkers.push(marker);
                markerClusterGroup.addLayer(marker);
            }
        } catch (error) {
            console.warn(`‚ö†Ô∏è Failed to create marker for accident ${index}:`, error);
        }
    });

    map.addLayer(markerClusterGroup);
    activeMarkers = [...accidentMarkers];
    
    console.log(`‚úÖ Loaded ${accidentMarkers.length} accident markers`);
    updateAllStatistics();
}

function createAccidentMarker(accident) {
    let markerColor = '#DC143C';
    let markerSize = 12;
    
    if (accident.victim_killed) {
        markerColor = '#8B0000';
        markerSize = 14;
    } else if (accident.victim_injured) {
        markerColor = '#FFA500';
        markerSize = 13;
    }

    const icon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="
            background-color: ${markerColor}; 
            width: ${markerSize}px; 
            height: ${markerSize}px; 
            border-radius: 50%; 
            border: 2px solid white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
        "></div>`,
        iconSize: [markerSize + 4, markerSize + 4],
        iconAnchor: [(markerSize + 4) / 2, (markerSize + 4) / 2]
    });

    const marker = L.marker([accident.latitude, accident.longitude], { 
        icon: icon,
        title: accident.incident_type || 'Accident'
    });

    const popupContent = `
        <div class="marker-popup">
            <div class="popup-header">
                <h4>${accident.incident_type || 'Traffic Accident'}</h4>
            </div>
            <div class="popup-body">
                <p><strong>üìç Location:</strong> ${accident.barangay || 'N/A'}, ${accident.municipal || 'N/A'}</p>
                <p><strong>üèõÔ∏è Province:</strong> ${accident.province || 'N/A'}</p>
                <p><strong>üìÖ Date:</strong> ${accident.date_committed || 'N/A'}</p>
                <p><strong>üë• Casualties:</strong> ${accident.victim_count || 0}</p>
                ${accident.victim_killed ? '<p style="color: #DC143C; font-weight: bold;">üíÄ FATAL ACCIDENT</p>' : ''}
                ${accident.victim_injured && !accident.victim_killed ? '<p style="color: #FFA500; font-weight: bold;">‚ö†Ô∏è INJURY ACCIDENT</p>' : ''}
            </div>
            <div class="popup-footer">
                <a href="/accidents/${accident.id}/">View Details</a>
            </div>
        </div>
    `;

    marker.accidentData = accident;
    marker.bindPopup(popupContent, {
        maxWidth: 320,
        className: 'custom-popup'
    });
    
    return marker;
}

function loadAllHotspotCircles() {
    console.log('üéØ Loading hotspot circles...');
    
    hotspotCircles = [];
    
    allHotspots.forEach((hotspot, index) => {
        try {
            const circle = L.circle(
                [hotspot.center_latitude, hotspot.center_longitude],
                {
                    color: '#DC143C',
                    fillColor: '#DC143C',
                    fillOpacity: 0.2,
                    radius: 500,
                    weight: 2
                }
            );
            
            const popupContent = `
                <div class="marker-popup">
                    <div class="popup-header">
                        <h4>üî¥ Hotspot Cluster #${hotspot.cluster_id}</h4>
                    </div>
                    <div class="popup-body">
                        <p><strong>üìç Location:</strong> ${hotspot.primary_location}</p>
                        <p><strong>üìä Accidents:</strong> ${hotspot.accident_count}</p>
                        <p><strong>‚ö° Severity:</strong> ${hotspot.severity_score.toFixed(1)}/100</p>
                    </div>
                    <div class="popup-footer">
                        <a href="/hotspots/${hotspot.cluster_id}/">View Details</a>
                    </div>
                </div>
            `;
            
            circle.bindPopup(popupContent, { maxWidth: 300 });
            circle.addTo(map);
            
            hotspotCircles.push({
                circle: circle,
                hotspot: hotspot
            });
            
        } catch (error) {
            console.warn(`‚ö†Ô∏è Failed to create hotspot ${index}:`, error);
        }
    });

    console.log(`‚úÖ Loaded ${hotspotCircles.length} hotspot circles`);
}

// ============================================================================
// FILTER SYSTEM
// ============================================================================

function applyAllFilters() {
    console.log('üîç Applying filters...');
    showLoading();
    
    currentFilters.timeRange = document.getElementById('timeRange').value;
    currentFilters.timeOfDay = document.getElementById('timeOfDay').value;
    currentFilters.province = document.getElementById('provinceFilter').value;
    currentFilters.severity = parseInt(document.getElementById('severityFilter').value);
    
    setTimeout(() => {
        filterAndDisplayMarkers();
        updateTimeFilterBadge();
        updateAllStatistics();
        
        hideLoading();
        
        const visibleCount = activeMarkers.length;
        if (visibleCount === 0) {
            showNotification('No accidents match your filters', 'info');
        } else {
            showNotification(`Showing ${visibleCount} accidents`, 'success');
        }
    }, 100);
}

function filterAndDisplayMarkers() {
    markerClusterGroup.clearLayers();
    activeMarkers = [];
    
    accidentMarkers.forEach(marker => {
        if (!marker.accidentData) return;
        
        const accident = marker.accidentData;
        
        if (passesAllFilters(accident)) {
            markerClusterGroup.addLayer(marker);
            activeMarkers.push(marker);
        }
    });
    
    if (!map.hasLayer(markerClusterGroup)) {
        map.addLayer(markerClusterGroup);
    }
    
    updateAllStatistics();
}

function passesAllFilters(accident) {
    // Basic filter checks
    if (currentFilters.province && currentFilters.province !== '' && accident.province !== currentFilters.province) {
        return false;
    }
    
    if (currentFilters.searchQuery) {
        if (!passesSearchFilter(accident, currentFilters.searchQuery)) {
            return false;
        }
    }
    
    return true;
}

function passesSearchFilter(accident, query) {
    if (!query || query.trim() === '') return true;
    
    const searchLower = query.toLowerCase().trim();
    
    // Cluster ID search
    if (searchLower.startsWith('cluster ') || /^#?\d+$/.test(searchLower)) {
        const clusterMatch = searchLower.match(/(?:cluster\s+)?#?(\d+)/);
        if (clusterMatch) {
            const searchClusterId = parseInt(clusterMatch[1]);
            return accident.cluster_id === searchClusterId;
        }
    }
    
    // Quick search categories
    const quickSearches = {
        'fatal': () => accident.victim_killed === true,
        'injury': () => accident.victim_injured === true && !accident.victim_killed,
        'property': () => !accident.victim_killed && !accident.victim_injured
    };
    
    if (quickSearches[searchLower]) {
        return quickSearches[searchLower]();
    }
    
    // General text search
    const searchFields = [
        accident.barangay, accident.municipal, accident.province,
        accident.vehicle_kind, accident.incident_type, accident.street
    ].filter(field => field && field.toString().trim() !== '');
    
    return searchFields.some(field => field.toString().toLowerCase().includes(searchLower));
}

// ============================================================================
// SEARCH SYSTEM
// ============================================================================

function toggleSearchBar() {
    const container = document.getElementById('mapSearchContainer');
    const btn = document.getElementById('floatingSearchBtn');
    
    if (container.style.display === 'none' || !container.classList.contains('active')) {
        container.style.display = 'block';
        setTimeout(() => {
            container.classList.add('active');
            btn.classList.add('active');
        }, 10);
        
        setTimeout(() => {
            const input = document.getElementById('mapSearchInput');
            if (input) input.focus();
        }, 400);
    } else {
        closeSearchBar();
    }
}

function closeSearchBar() {
    const container = document.getElementById('mapSearchContainer');
    const btn = document.getElementById('floatingSearchBtn');
    
    container.classList.remove('active');
    btn.classList.remove('active');
    
    hideSearchSuggestions();
    hideSearchHistory();
    
    setTimeout(() => {
        container.style.display = 'none';
    }, 400);
    
    updateBadgePositions();
}

function handleSearchInput(event) {
    const query = event.target.value.trim();
    
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    hideSearchSuggestions();
    
    if (query.length === 0) {
        return;
    }
    
    if (query.length < 2) {
        return;
    }
    
    searchTimeout = setTimeout(() => {
        generateSearchSuggestions(query);
    }, 300);
}

function handleEnterKey(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        performSearch();
    }
}

function performSearch() {
    const input = document.getElementById('mapSearchInput');
    if (!input) return;
    
    const query = input.value.trim();
    
    if (query.length < 2) {
        showNotification('Please enter at least 2 characters', 'error');
        return;
    }
    
    console.log('üîç Performing search for:', query);
    showLoading();
    
    addToSearchHistory(query);
    hideSearchSuggestions();
    hideSearchHistory();
    
    currentFilters.searchQuery = query;
    applyAllFilters();
    updateTimeFilterBadge();
    updateAllStatistics();
    showSearchResultsSummary(query);
    
    const banner = document.getElementById('searchActiveBanner');
    const bannerText = document.getElementById('searchBannerText');
    if (banner && bannerText) {
        bannerText.textContent = `"${query}"`;
        banner.classList.add('show');
    }
    
    setTimeout(updateBadgePositions, 10);

    // Auto-zoom to search results
    setTimeout(() => {
        if (activeMarkers.length > 0) {
            const bounds = L.latLngBounds();
            activeMarkers.forEach(marker => bounds.extend(marker.getLatLng()));
            
            map.fitBounds(bounds, {
                padding: [60, 60],
                maxZoom: 13,
                duration: 1.5
            });
            
            console.log('üó∫Ô∏è Map adjusted to show', activeMarkers.length, 'search results');
        } else {
            showNotification('No results found for your search', 'error');
        }
        
        hideLoading();
    }, 500);
}

function quickSearch(keyword) {
    console.log('üîç Quick search:', keyword);
    const input = document.getElementById('mapSearchInput');
    if (input) {
        input.value = keyword;
        performSearch();
    }
}

// ============================================================================
// UI CONTROLS
// ============================================================================

function toggleStats() {
    const statsBox = document.getElementById('statsBox');
    const toggle = document.getElementById('statsToggle');
    if (statsBox && toggle) {
        const isShowing = statsBox.classList.contains('show');
        
        if (!isShowing) {
            statsBox.classList.add('show');
            toggle.classList.add('active');
            bringToFront('statsBox');
        } else {
            statsBox.classList.remove('show');
            toggle.classList.remove('active');
        }
    }
}

function toggleLegend() {
    const legendBox = document.getElementById('legendBox');
    const toggle = document.getElementById('legendToggle');
    if (legendBox && toggle) {
        const isShowing = legendBox.classList.contains('show');
        
        if (!isShowing) {
            legendBox.classList.add('show');
            toggle.classList.add('active');
            bringToFront('legendBox');
        } else {
            legendBox.classList.remove('show');
            toggle.classList.remove('active');
        }
    }
}

function toggleMapControls() {
    const controls = document.getElementById('mapControls');
    const toggle = document.getElementById('controlsToggle');
    if (controls && toggle) {
        const isShowing = controls.classList.contains('show');
        
        if (!isShowing) {
            controls.classList.add('show');
            toggle.classList.add('active');
            bringToFront('mapControls');
        } else {
            controls.classList.remove('show');
            toggle.classList.remove('active');
        }
        
        setTimeout(updateBadgePositions, 300);
    }
}

function bringToFront(panelId) {
    const panels = ['statsBox', 'legendBox', 'mapControls'];
    
    panels.forEach(id => {
        const panel = document.getElementById(id);
        if (panel) {
            panel.style.zIndex = '900';
        }
    });
    
    const activePanel = document.getElementById(panelId);
    if (activePanel) {
        activePanel.style.zIndex = '950';
    }
}

function toggleFullscreen() {
    const body = document.body;
    const btn = document.getElementById('fullscreenBtn');
    
    if (!body.classList.contains('fullscreen-mode')) {
        body.classList.add('fullscreen-mode');
        if (btn) {
            btn.classList.add('active');
        }
        
        setTimeout(() => {
            if (map) map.invalidateSize();
        }, 100);
        
        showNotification('Fullscreen mode enabled', 'success');
    } else {
        body.classList.remove('fullscreen-mode');
        if (btn) {
            btn.classList.remove('active');
        }
        
        setTimeout(() => {
            if (map) map.invalidateSize();
        }, 100);
        
        showNotification('Fullscreen mode disabled', 'success');
    }
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function setupTimeFilters() {
    const today = new Date();
    const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    const endDateInput = document.getElementById('endDate');
    const startDateInput = document.getElementById('startDate');
    
    if (endDateInput) endDateInput.value = today.toISOString().split('T')[0];
    if (startDateInput) startDateInput.value = oneMonthAgo.toISOString().split('T')[0];
}

function applyTimeFilter() {
    applyAllFilters();
}

function applyFilters() {
    applyAllFilters();
}

function clearAllFilters() {
    console.log('üóëÔ∏è Clearing all filters...');
    
    document.getElementById('timeRange').value = 'all';
    document.getElementById('timeOfDay').value = 'all';
    document.getElementById('provinceFilter').value = '';
    document.getElementById('severityFilter').value = '0';
    
    const searchInput = document.getElementById('mapSearchInput');
    if (searchInput) searchInput.value = '';
    
    currentFilters = {
        timeRange: 'all',
        timeOfDay: 'all',
        province: '',
        severity: 0,
        searchQuery: ''
    };
    
    const timeBadge = document.getElementById('timeFilterBadge');
    if (timeBadge) timeBadge.classList.remove('show');
    
    const searchBanner = document.getElementById('searchActiveBanner');
    if (searchBanner) searchBanner.classList.remove('show');
    
    updateBadgePositions();
    applyAllFilters();
}

function updateTimeFilterBadge() {
    const badge = document.getElementById('timeFilterBadge');
    if (!badge) return;
    
    const timeRange = document.getElementById('timeRange').value;
    const province = document.getElementById('provinceFilter').value;
    
    let text = 'üìÖ ';
    switch(timeRange) {
        case 'current_year': text += 'Current Year'; break;
        case 'last_year': text += 'Last Year'; break;
        case 'last_6_months': text += 'Last 6 Months'; break;
        case 'last_3_months': text += 'Last 3 Months'; break;
        case 'last_month': text += 'Last Month'; break;
        case 'custom': text += 'Custom Range'; break;
        default: text += 'All Time';
    }

    if (province !== '') {
        text += ` ‚Ä¢ ${province}`;
    }
    
    const textElement = badge.querySelector('span');
    if (textElement) {
        textElement.textContent = text;
    }
    
    const shouldShow = timeRange !== 'all' || province !== '';
    badge.classList.toggle('show', shouldShow);
    
    setTimeout(updateBadgePositions, 10);
}

function updateAllStatistics() {
    const stats = {
        total: activeMarkers.length,
        fatal: activeMarkers.filter(m => m.accidentData && m.accidentData.victim_killed).length,
        injury: activeMarkers.filter(m => m.accidentData && m.accidentData.victim_injured && !m.accidentData.victim_killed).length
    };
    
    updateStatisticsDisplay(stats);
}

function updateStatisticsDisplay(stats) {
    const totalEl = document.getElementById('statsVisibleMarkers');
    const fatalEl = document.getElementById('statsFatalAccidents');
    
    if (totalEl) totalEl.textContent = stats.total;
    if (fatalEl) fatalEl.textContent = stats.fatal;
}

function showLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'flex';
    }
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28A745' : type === 'error' ? '#DC143C' : '#007BFF'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-size: 0.9rem;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 3000);
}

// ============================================================================
// SEARCH SUGGESTIONS & HISTORY
// ============================================================================

function generateSearchSuggestions(query) {
    const suggestions = [];
    const queryLower = query.toLowerCase();
    
    // Simple suggestions based on query
    if (queryLower.includes('fatal') || queryLower.includes('death')) {
        suggestions.push({
            text: 'üíÄ Fatal Accidents',
            type: 'severity',
            query: 'fatal'
        });
    }
    
    if (queryLower.includes('injury') || queryLower.includes('hurt')) {
        suggestions.push({
            text: 'üöë Injury Accidents',
            type: 'severity', 
            query: 'injury'
        });
    }
    
    if (queryLower.includes('cluster') || /^\d+$/.test(queryLower)) {
        suggestions.push({
            text: 'üéØ Search Cluster ID',
            type: 'cluster',
            query: 'cluster ' + queryLower.replace(/\D/g, '')
        });
    }
    
    displaySearchSuggestions(suggestions, query);
}

function displaySearchSuggestions(suggestions, originalQuery) {
    const container = document.getElementById('searchSuggestions');
    if (!container) return;
    
    if (suggestions.length === 0) {
        container.innerHTML = `
            <div class="no-suggestions">
                <div class="no-suggestions-text">No suggestions found</div>
            </div>
        `;
    } else {
        container.innerHTML = suggestions.map(suggestion => `
            <div class="suggestion-item" onclick="selectSuggestion('${suggestion.query.replace(/'/g, "\\'")}')">
                <span class="suggestion-text">${suggestion.text}</span>
                <span class="suggestion-type">${suggestion.type}</span>
            </div>
        `).join('');
    }
    
    container.style.display = 'block';
}

function selectSuggestion(query) {
    const input = document.getElementById('mapSearchInput');
    if (input) {
        input.value = query;
    }
    hideSearchSuggestions();
    performSearch();
}

function hideSearchSuggestions() {
    const container = document.getElementById('searchSuggestions');
    if (container) {
        container.style.display = 'none';
    }
}

function initializeSearchHistory() {
    updateHistoryDisplay();
}

function addToSearchHistory(query) {
    if (!query || query.trim().length < 2) return;
    
    const historyItem = {
        query: query.trim(),
        timestamp: new Date().toLocaleTimeString()
    };
    
    searchHistory = searchHistory.filter(item => 
        item.query.toLowerCase() !== query.toLowerCase()
    );
    
    searchHistory.unshift(historyItem);
    searchHistory = searchHistory.slice(0, 10);
    
    localStorage.setItem('accidentSearchHistory', JSON.stringify(searchHistory));
    updateHistoryDisplay();
}

function updateHistoryDisplay() {
    const container = document.getElementById('historyItems');
    if (!container) return;
    
    if (searchHistory.length === 0) {
        container.innerHTML = `
            <div class="no-suggestions">
                <div class="no-suggestions-text">No search history yet</div>
            </div>
        `;
    } else {
        container.innerHTML = searchHistory.map((item, index) => `
            <div class="history-item">
                <span class="history-query">${item.query}</span>
                <button class="history-remove" onclick="removeFromHistory(${index})">√ó</button>
            </div>
        `).join('');
    }
}

function toggleSearchHistory() {
    const historyContainer = document.getElementById('searchHistory');
    if (!historyContainer) return;
    
    if (historyContainer.style.display === 'block') {
        hideSearchHistory();
    } else {
        hideSearchSuggestions();
        historyContainer.style.display = 'block';
        updateHistoryDisplay();
    }
}

function hideSearchHistory() {
    const container = document.getElementById('searchHistory');
    if (container) {
        container.style.display = 'none';
    }
}

function removeFromHistory(index) {
    event.stopPropagation();
    
    if (index >= 0 && index < searchHistory.length) {
        searchHistory.splice(index, 1);
        localStorage.setItem('accidentSearchHistory', JSON.stringify(searchHistory));
        updateHistoryDisplay();
    }
}

function clearSearchHistory() {
    if (confirm('Clear all search history?')) {
        searchHistory = [];
        localStorage.removeItem('accidentSearchHistory');
        updateHistoryDisplay();
    }
}

function showSearchResultsSummary(query) {
    const panel = document.getElementById('searchInfoPanel');
    const body = document.getElementById('searchInfoBody');
    
    if (!panel || !body) return;

    const stats = {
        total: activeMarkers.length,
        fatal: activeMarkers.filter(m => m.accidentData && m.accidentData.victim_killed).length,
        injury: activeMarkers.filter(m => m.accidentData && m.accidentData.victim_injured && !m.accidentData.victim_killed).length
    };
    
    body.innerHTML = `
        <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--light-blue); border-radius: 8px;">
            <strong>Search Query:</strong><br>
            <span>"${query}"</span>
        </div>
        
        <div class="search-stat-item">
            <span class="search-stat-label">üìä Total Results:</span>
            <span class="search-stat-value">${stats.total}</span>
        </div>
        
        <div class="search-stat-item">
            <span class="search-stat-label">üíÄ Fatal:</span>
            <span class="search-stat-value" style="color: #DC143C;">${stats.fatal}</span>
        </div>
        
        <div class="search-stat-item">
            <span class="search-stat-label">üöë Injury:</span>
            <span class="search-stat-value" style="color: #FFA500;">${stats.injury}</span>
        </div>
        
        <button onclick="clearSearchFilter()" style="
            width: 100%; padding: 0.7rem; margin-top: 1rem;
            background: #DC143C; color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: 600;
        ">Clear Search</button>
    `;
    
    panel.style.display = 'block';
}

function closeSearchInfo() {
    const panel = document.getElementById('searchInfoPanel');
    if (panel) {
        panel.style.display = 'none';
    }
}

function clearSearchFilter() {
    const input = document.getElementById('mapSearchInput');
    if (input) {
        input.value = '';
    }
    
    currentFilters.searchQuery = '';
    applyAllFilters();
    closeSearchInfo();
    
    const banner = document.getElementById('searchActiveBanner');
    if (banner) {
        banner.classList.remove('show');
    }
    
    showNotification('Search cleared', 'success');
}

function clearTimeFilterBadge() {
    clearAllFilters();
}

function clearSearchFromBanner() {
    clearSearchFilter();
}

// ============================================================================
// DRAGGABLE PANELS
// ============================================================================

let draggedPanel = null;
let dragOffset = { x: 0, y: 0 };

function makePanelDraggable(panelId, handleId) {
    const panel = document.getElementById(panelId);
    const handle = document.getElementById(handleId);
    
    if (!panel || !handle) return;
    
    handle.addEventListener('mousedown', startDrag);
    
    function startDrag(e) {
        e.preventDefault();
        draggedPanel = panel;
        
        const rect = panel.getBoundingClientRect();
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
        
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', stopDrag);
    }
    
    function onDrag(e) {
        if (!draggedPanel) return;
        
        const x = e.clientX - dragOffset.x;
        const y = e.clientY - dragOffset.y;
        
        const maxX = window.innerWidth - panel.offsetWidth;
        const maxY = window.innerHeight - panel.offsetHeight;
        
        const boundedX = Math.max(10, Math.min(x, maxX - 10));
        const boundedY = Math.max(10, Math.min(y, maxY - 10));
        
        panel.style.left = boundedX + 'px';
        panel.style.top = boundedY + 'px';
        panel.style.transform = 'none';
    }
    
    function stopDrag() {
        if (draggedPanel) {
            draggedPanel = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }
    }
}

function updateBadgePositions() {
    const timeBadge = document.getElementById('timeFilterBadge');
    const searchBanner = document.getElementById('searchActiveBanner');
    
    if (!timeBadge || !searchBanner) return;
    
    const timeVisible = timeBadge.classList.contains('show');
    const searchVisible = searchBanner.classList.contains('show');
    
    if (timeVisible && searchVisible) {
        timeBadge.style.top = '20px';
        searchBanner.style.top = '70px';
    } else {
        timeBadge.style.top = '20px';
        searchBanner.style.top = '20px';
    }
}

function checkURLParametersAndJump() {
    const urlParams = new URLSearchParams(window.location.search);
    const lat = urlParams.get('lat');
    const lng = urlParams.get('lng');
    
    if (lat && lng) {
        const latitude = parseFloat(lat);
        const longitude = parseFloat(lng);
        
        setTimeout(() => {
            map.flyTo([latitude, longitude], 16, {
                duration: 2
            });
        }, 500);
    }
}

function goBackToList() {
    window.location.href = "{% url 'accident_list' %}";
}

// Layer toggles
function toggleLayer(layerType) {
    const checkbox = document.getElementById(`show${layerType.charAt(0).toUpperCase() + layerType.slice(1)}`);
    if (!checkbox) return;
    
    const isChecked = checkbox.checked;
    
    switch(layerType) {
        case 'accidents':
            if (isChecked) {
                map.addLayer(markerClusterGroup);
            } else {
                map.removeLayer(markerClusterGroup);
            }
            break;
        case 'hotspots':
            hotspotCircles.forEach(item => {
                if (isChecked) {
                    item.circle.addTo(map);
                } else {
                    item.circle.remove();
                }
            });
            break;
    }
}

// Initialize cluster intensity
function updateClusterIntensity() {
    const intensityInput = document.getElementById('clusterIntensity');
    if (!intensityInput) return;
    
    const intensity = parseInt(intensityInput.value);
    console.log('Updating cluster intensity to:', intensity);
}

function updateClusterIntensityLive(value) {
    const valueDisplay = document.getElementById('clusterIntensityValue');
    if (valueDisplay) {
        valueDisplay.textContent = value;
    }
}

// Heatmap functionality
function createHeatmap() {
    if (heatmapLayer) {
        map.removeLayer(heatmapLayer);
    }

    const heatData = activeMarkers.map(marker => [
        marker.getLatLng().lat,
        marker.getLatLng().lng,
        1
    ]);

    if (heatData.length === 0) return;

    heatmapLayer = L.heatLayer(heatData, {
        radius: 25,
        blur: 15,
        maxZoom: 13
    }).addTo(map);
}

function updateHeatmapIntensity() {
    // Heatmap intensity update logic
}

// Event listeners
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const body = document.body;
        if (body.classList.contains('fullscreen-mode')) {
            toggleFullscreen();
        }
        
        const container = document.getElementById('mapSearchContainer');
        if (container && container.classList.contains('active')) {
            closeSearchBar();
        }
    }
});

document.addEventListener('click', function(event) {
    const searchContainer = document.getElementById('mapSearchContainer');
    const searchBtn = document.getElementById('floatingSearchBtn');
    
    if (searchContainer && searchBtn) {
        const isClickInside = searchContainer.contains(event.target) || searchBtn.contains(event.target);
        
        if (!isClickInside) {
            hideSearchSuggestions();
            hideSearchHistory();
        }
    }
});

console.log('‚úÖ Map system loaded successfully');
</script>
{% endblock %}