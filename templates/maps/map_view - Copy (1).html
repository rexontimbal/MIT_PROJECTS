{% extends 'base.html' %}
{% load static %}

{% block title %}Interactive Accident Map{% endblock %}

{% block breadcrumb_items %}
<span> / Map View</span>
{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .page-header h2 {
        margin: 0;
        color: var(--primary-blue);
        font-size: 1.5rem;
    }

    .page-header p {
        margin: 0.25rem 0 0 0;
        color: var(--text-medium);
        font-size: 0.9rem;
    }

    .dashboard-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* Map Wrapper */
    .map-wrapper {
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .map-container {
        height: calc(100vh - 280px);
        min-height: 600px;
        position: relative;
    }

    #mainMap {
        height: 100%;
        width: 100%;
    }

    /* Enhanced Toggle Buttons */
    .map-toggle-buttons {
        position: absolute;
        top: 50%;
        left: 15px;
        transform: translateY(-50%);
        z-index: 999;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .toggle-icon-btn {
        width: 48px;
        height: 48px;
        background: white;
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        transition: all 0.3s ease;
        position: relative;
    }

    .toggle-icon-btn:hover {
        background: var(--light-blue);
        transform: scale(1.1);
    }

    .toggle-icon-btn.active {
        background: var(--primary-blue);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 48, 135, 0.3);
    }

    /* Tooltip for buttons */
    .toggle-icon-btn::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 58px;
        background: var(--dark-navy);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 10;
    }

    .toggle-icon-btn:hover::after {
        opacity: 1;
    }

    .map-stats {
        position: absolute;
        top: 20px;
        left: 80px;
        z-index: 900;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        transform: translateX(-120%);
        opacity: 0;
        pointer-events: none;
        width: 260px; 
    }

    .map-stats.show {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
    }

    /* Stats Header (match legend header) */
.stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.9rem 1.1rem;
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
    color: white;
    border-radius: 12px 12px 0 0;
    font-weight: 700;
    font-size: 0.9rem;
}

.stats-header span {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
}

    /* Stats Content */
    .stats-content {
        padding: 10px;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.85rem;
        padding: 3px 0;
        border-bottom: 1px solid #E9ECEF;
    }

    .stat-item:last-child {
        margin-bottom: 0;
        border-bottom: none;
    }

    .stat-label {
        color: #666;
        font-weight: 500;
    }

    .stat-value {
        font-weight: 700;
        color: #003087;
        font-size: 0.8rem;
    }

    /* Enhanced Map Controls Panel */
    .map-controls {
        position: absolute;
        top: 20px;
        left: 80px;
        z-index: 900;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        width: 260px;
        max-width: 260px;
        transition: all 0.3s ease;
        transform: translateX(-100%);
        opacity: 0;
        pointer-events: none;
    }

    .map-controls.show {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
    }

    .controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.9rem 1.1rem;
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
        border-radius: 10px 10px 0 0;
    }

    .controls-header h3 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .close-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
    }

    .close-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    .controls-body {
        padding: 1.1rem;
        max-height: 500px;
        overflow-y: auto;
    }

    body.fullscreen-mode .controls-body {
        max-height: calc(100vh - 80px);  
    }

    .control-section {
        margin-bottom: 1.3rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .control-section:last-child {
        margin-bottom: 0;
        border-bottom: none;
    }

    .control-section h4 {
        margin: 0 0 0.9rem 0;
        color: var(--primary-blue);
        font-size: 0.85rem;
        font-weight: 600;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--light-blue);
    }

    .control-group {
        margin-bottom: 0.9rem;
    }

    .control-group:last-child {
        margin-bottom: 0;
    }

    .control-group label {
        display: block;
        margin-bottom: 0.4rem;
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.8rem;
    }

    .control-group select, 
    .control-group input {
        width: 100%;
        padding: 0.55rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.85rem;
        background: white;
        transition: border-color 0.2s;
    }

    .control-group select:focus,
    .control-group input:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 48, 135, 0.08);
    }

    .control-group button {
        width: 100%;
        padding: 0.6rem;
        font-size: 0.85rem;
    }

    /* Time Range Slider */
    .time-range-slider {
        margin: 1rem 0;
    }

    .time-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--text-light);
        margin-top: 0.25rem;
    }

    /* Enhanced Layer Toggles */
    .layer-toggle {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        padding: 0.65rem 0.75rem;
        cursor: pointer;
        border-radius: 6px;
        transition: background 0.2s;
        margin-bottom: 0.4rem;
    }

    .layer-toggle:last-child {
        margin-bottom: 0;
    }

    .layer-toggle:hover {
        background-color: var(--light-blue);
    }

    .layer-toggle input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
        margin: 0;
    }

    .layer-toggle span {
        font-size: 0.85rem;
        color: var(--text-dark);
    }

    /* Enhanced Legend */
    .map-legend {
        position: absolute;
        bottom: 20px;
        left: 80px;
        z-index: 900;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        transform: translateX(-120%);
        opacity: 0;
        pointer-events: none;
        width: 260px; 
        max-height: calc(100vh - 300px); /* Don't overlap with stats */
        overflow: hidden;
    }

    .map-legend.show {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
    }

    .map-legend h4 {
        margin: 0 0 0.65rem 0;
        font-size: 0.85rem;
        color: var(--text-dark);
        font-weight: 600;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        margin-bottom: 0.45rem;
        font-size: 0.8rem;
    }

    .legend-item:last-child {
        margin-bottom: 0;
    }

    .legend-icon {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .legend-icon.accident {
        background-color: #DC143C;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .legend-icon.hotspot {
        background-color: #FFA500;
        opacity: 0.6;
        border: 2px solid #FFA500;
    }

    .legend-icon.cluster {
        background-color: #FFA500;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 7px;
        font-weight: bold;
        color: white;
    }

    .legend-icon.heat-high { background-color: #FF0000; }
    .legend-icon.heat-medium { background-color: #FFFF00; }
    .legend-icon.heat-low { background-color: #0000FF; }

    /* Time Filter Badge */
.time-filter-badge {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--primary-blue);
    color: white;
    padding: 0.6rem 1.2rem;
    border-radius: 25px;
    font-size: 0.85rem;
    font-weight: 600;
    z-index: 800;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    display: none;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    white-space: nowrap;
    max-width: 5000px; /* Limit maximum width */
    overflow: hidden;
    text-overflow: ellipsis;
}

.time-filter-badge.show {
    display: flex;
}
.time-filter-badge .close-banner,
.search-active-banner .close-banner {
    background: rgba(255,255,255,0.3);
    border: none;
    color: white;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
    font-weight: bold;
    flex-shrink: 0 !important;
    margin-left: auto !important;
}
.time-filter-badge.show:only-child {
    transform: translateX(-50%);
}
.search-active-banner.show:only-child {
    transform: translateX(-50%);
}

.time-filter-badge .close-banner:hover,
.search-active-banner .close-banner:hover {
    background: rgba(255,255,255,0.5);
    transform: scale(1.1);
}

    /* Cluster Animation */
    .cluster-pulse {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Scrollbar Styling */
    .controls-body::-webkit-scrollbar {
        width: 5px;
    }

    .controls-body::-webkit-scrollbar-track {
        background: var(--bg-light);
        border-radius: 10px;
    }

    .controls-body::-webkit-scrollbar-thumb {
        background: var(--primary-blue);
        border-radius: 10px;
    }

    /* Enhanced Popup Styling */
    .leaflet-popup-content-wrapper {
        border-radius: 10px;
        padding: 0;
    }

    .marker-popup {
        min-width: 280px;
    }

    .popup-header {
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
        padding: 0.9rem;
        border-radius: 10px 10px 0 0;
        margin: -20px -20px 0 -20px;
    }

    .popup-header h4 {
        margin: 0;
        font-size: 0.95rem;
    }

    .popup-body {
        padding: 0.9rem;
    }

    .popup-body p {
        margin: 0.4rem 0;
        font-size: 0.85rem;
    }

    .popup-footer {
        padding: 0 0.9rem 0.9rem 0.9rem;
        display: flex;
        gap: 0.5rem;
    }

    .popup-footer a {
        display: inline-block;
        padding: 0.45rem 0.9rem;
        background-color: var(--primary-blue);
        color: white;
        border-radius: 5px;
        text-decoration: none;
        font-size: 0.8rem;
        transition: background 0.2s;
    }

    .popup-footer a:hover {
        background-color: var(--secondary-blue);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .map-toggle-buttons {
            left: 10px;
            top: 10px;
            transform: none;
        }

        .toggle-icon-btn {
            width: 42px;
            height: 42px;
            font-size: 1.2rem;
        }

        .map-container {
            height: 500px;
        }
    }

    /* ============================================================================
       MINIMALIST SEARCH SYSTEM - NON-INTRUSIVE UX
       ============================================================================ */

    /* Floating Search Button (Always Visible) */
    .floating-search-btn {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        z-index: 1000;
        width: 48px;
        height: 48px;
        background: white;
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        transition: all 0.3s ease;
    }

    .floating-search-btn:hover {
        background: var(--light-blue);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .floating-search-btn.active {
        background: var(--primary-blue);
        color: white;
    }

    /* Tooltip for floating buttons */
    .floating-search-btn::after,
    .fullscreen-btn::after {
        content: attr(data-tooltip);
        position: absolute;
        right: 58px;
        background: var(--dark-navy);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 10;
    }

    .floating-search-btn:hover::after,
    .fullscreen-btn:hover::after {
        opacity: 1;
    }

    /* Search Bar Container (Slides in from top) */
    .map-search-container {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-120%);
        z-index: 1000;
        width: 90%;
        max-width: 600px;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .map-search-container.active {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .search-bar {
        display: flex;
        gap: 0.5rem;
        background: white;
        padding: 0.5rem;
        border-radius: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border: 2px solid var(--primary-blue);
    }

    .search-bar input {
        flex: 1;
        border: none;
        padding: 0.7rem 1.2rem;
        font-size: 0.9rem;
        outline: none;
        background: transparent;
        color: var(--text-dark);
    }

    .search-bar input::placeholder {
        color: var(--text-light);
    }

    .search-btn {
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 0.5rem 1.5rem;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .search-btn:hover {
        background: var(--secondary-blue);
        transform: scale(1.05);
    }

.close-search-btn {
    background: #DC143C;
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.close-search-btn:hover {
    background: #8B0000;
    transform: rotate(90deg);
}

    /* Search Results Dropdown */
    .search-results {
        position: absolute;
        top: 60px;
        left: 0;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        max-height: 500px;
        overflow-y: auto;
        z-index: 1001;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .search-result-item {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s;
    }

    .search-result-item:hover {
        background: var(--light-blue);
        padding-left: 1.5rem;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-title {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }

    .search-result-details {
        font-size: 0.8rem;
        color: var(--text-medium);
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
    }

    .search-result-badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-fatal {
        background: #FFE5E5;
        color: #DC143C;
    }

    .badge-injury {
        background: #FFF3E0;
        color: #FFA500;
    }

    .badge-property {
        background: #E8F5E9;
        color: #28A745;
    }

    /* Quick Search Tags */
    .quick-search-tags {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
        flex-wrap: wrap;
        justify-content: center;
        animation: fadeIn 0.5s ease 0.2s both;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .tag-btn {
        background: white;
        border: 1px solid var(--border-color);
        padding: 0.4rem 0.9rem;
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-dark);
    }

    .tag-btn:hover {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    /* Search Info Panel */
    .search-info-panel {
        position: absolute;
        top: 40px;
        right: 80px;
        width: 260px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 900;
        max-height: 600px;
        overflow: hidden;
        animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .search-info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
    }

    .search-info-header h4 {
        margin: 0;
        font-size: 0.95rem;
    }

    .search-info-header button {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s;
    }

    .search-info-header button:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }

    .search-info-body {
        padding: 1rem;
        overflow-y: auto;
        max-height: 600px;
    }

    .search-stat-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        background: var(--bg-light);
        border-radius: 8px;
        margin-bottom: 0.75rem;
    }

    .search-stat-label {
        font-size: 0.85rem;
        color: var(--text-medium);
    }

    .search-stat-value {
        font-size: 1rem;
        font-weight: 700;
        color: var(--primary-blue);
    }

    /* No Results State */
    .no-results {
        padding: 2rem;
        text-align: center;
        color: var(--text-medium);
    }

    .no-results-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .no-results-text {
        font-size: 0.9rem;
    }

    /* Loading State */
    .search-loading {
        padding: 2rem;
        text-align: center;
    }

    .search-loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--light-blue);
        border-top-color: var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    /* Fullscreen Button */
    .fullscreen-btn {
        position: absolute;
        top: calc(50% + 60px);
        right: 15px;
        z-index: 1000;
        width: 48px;
        height: 48px;
        background: white;
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        transition: all 0.3s ease;
    }

    .fullscreen-btn:hover {
        background: var(--light-blue);
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .fullscreen-btn.active {
        background: var(--primary-blue);
        color: white;
    }

    /* Fullscreen Mode Styles */
    body.fullscreen-mode {
        overflow: hidden;
    }

    body.fullscreen-mode .map-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        border-radius: 0;
        margin: 0;
    }

    body.fullscreen-mode .map-container {
        height: 100vh !important;
        border-radius: 0;
    }

    body.fullscreen-mode #mainMap {
        height: 100vh !important;
    }

    /* Hide other elements in fullscreen */
    body.fullscreen-mode .breadcrumb,
    body.fullscreen-mode .page-header {
        display: none;
    }

    /* Responsive Search */
    @media (max-width: 768px) {
        .map-search-container {
            width: 95%;
            max-width: none;
        }
        
        .search-bar input {
            font-size: 0.85rem;
            padding: 0.6rem 1rem;
        }
        
        .search-btn {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        
        .quick-search-tags {
            gap: 0.35rem;
        }
        
        .tag-btn {
            padding: 0.35rem 0.7rem;
            font-size: 0.75rem;
        }
        
        .search-info-panel {
            width: 90%;
            right: 5%;
            left: 5%;
        }
        
        .floating-search-btn,
        .fullscreen-btn {
            width: 42px;
            height: 42px;
            font-size: 1.2rem;
        }
        
        /* Hide tooltips on mobile */
        .floating-search-btn::after,
        .fullscreen-btn::after {
            display: none;
        }
    }

    /* Scrollbar for search results */
    .search-results::-webkit-scrollbar {
        width: 6px;
    }

    .search-results::-webkit-scrollbar-track {
        background: var(--bg-light);
    }

    .search-results::-webkit-scrollbar-thumb {
        background: var(--primary-blue);
        border-radius: 3px;
    }

    .search-results::-webkit-scrollbar-thumb:hover {
        background: var(--secondary-blue);
    }

    .back-to-list-btn {
        position: absolute;
        top: calc(50% + 120px);
        right: 15px;
        z-index: 1000;
        width: 48px;
        height: 48px;
        background: white;
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        transition: all 0.3s ease;
    }

    .back-to-list-btn:hover {
        background: var(--light-blue);
        transform: scale(1.1);
    }

    /* ============================================================================
       ENHANCED LEGEND STYLING
       ============================================================================ */

.legend-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.9rem 1.1rem;
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
    border-radius: 12px 12px 0 0;
    font-weight: 700;
    font-size: 0.9rem;
    border-bottom: 2px solid var(--light-blue);
}

.legend-header h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: white;
}
.legend-close-btn:hover {
    background: rgba(0, 0, 0, 0.2);
    transform: scale(1.1);
}


.stats-close-btn,
.legend-close-btn {
    background: rgba(0, 0, 0, 0.1);
    border: none;
    color: var(--primary-blue);
    width: 24px;
    height: 24px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
    margin-left: 10px;
}

.stats-close-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

.stats-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.legend-content {
    padding: 15px;
    max-height: calc(100vh - 350px);
    overflow-y: auto;
}

.legend-category {
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 1px solid #E9ECEF;
}

.legend-category:last-child {
    margin-bottom: 0;
    border-bottom: none;
    padding-bottom: 0;
}

.legend-category-title {
    font-weight: 700;
    font-size: 0.75rem;
    color: #003087;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 0.75rem;
    color: #333;
    line-height: 1.3;
}

.legend-item:last-child {
    margin-bottom: 0;
}

.legend-marker,
.legend-hotspot,
.legend-cluster-icon,
.legend-heatmap {
    flex-shrink: 0;
}

    .legend-hotspot {
        flex-shrink: 0;
    }

    .legend-cluster-icon {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .legend-heatmap {
        flex-shrink: 0;
    }

    /* Responsive stat and legend*/
    @media (max-width: 768px) {
        .map-stats,
        .map-legend {
            left: 10px;
            width: calc(100vw - 85px);
            max-width: 220px;
        }
        
        .map-legend {
            bottom: 10px;
            max-height: 50vh;
        }
    }

/* Responsive adjustments for mobile */
@media (max-width: 768px) {
    .time-filter-badge,
    .search-active-banner {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        max-width: 300px;
        gap: 8px;
    }
    
    .time-filter-badge.show {
        transform: translateX(calc(-50% - 80px));
    }
    
    .search-active-banner.show {
        transform: translateX(calc(-50% + 80px));
    }
}

@media (max-width: 480px) {
    .time-filter-badge.show {
        transform: translateX(-50%) !important;
        top: 20px !important;
    }
    
    .search-active-banner.show {
        transform: translateX(-50%) !important;
        top: 70px !important;
    }
}
    /* ============================================================================
       SEARCH ACTIVE BANNER
       ============================================================================ */

.search-active-banner {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #FFA500, #FF8C00);
    color: white;
    padding: 0.6rem 1.2rem;
    border-radius: 25px;
    font-size: 0.85rem;
    font-weight: 600;
    z-index: 800;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    display: none;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    white-space: nowrap;
    max-width: 500px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.search-active-banner.show {
    display: flex;
}


.search-active-banner .close-banner {
    background: rgba(255,255,255,0.3);
    border: none;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.search-active-banner .close-banner:hover {
    background: rgba(255,255,255,0.5);
    transform: scale(1.1);
}
</style>
{% endblock %}

{% block content %}
<!-- Map Wrapper -->
<div class="map-wrapper">
    <div class="map-container">
        <div id="mainMap"></div>

        <div class="time-filter-badge" id="timeFilterBadge">
            <span>üìÖ All Time Periods</span>
            <button class="close-banner" onclick="clearTimeFilterBadge()">√ó</button>
        </div>

        <!-- Search Active Banner -->
        <div class="search-active-banner" id="searchActiveBanner">
            <span>üîç Search Active: <strong id="searchBannerText">""</strong></span>
            <button class="close-banner" onclick="clearSearchFromBanner()">√ó</button>
        </div>

        <!-- Toggle Buttons - Left Side -->
        <div class="map-toggle-buttons">
            <button class="toggle-icon-btn" id="statsToggle" data-tooltip="Statistics" onclick="toggleStats()">
                üìä
            </button>
            <button class="toggle-icon-btn" id="legendToggle" data-tooltip="Legend" onclick="toggleLegend()">
                üó∫Ô∏è
            </button>
            <button class="toggle-icon-btn" id="controlsToggle" data-tooltip="Map Controls" onclick="toggleMapControls()">
                ‚öôÔ∏è
            </button>
        </div>

        <!-- INTELLIGENT SEARCH BAR -->
        <div class="floating-search-btn" id="floatingSearchBtn" onclick="toggleSearchBar()" data-tooltip="Search Accidents">
            üîç
        </div>

        <!-- Search Bar (Hidden by default) -->
        <div class="map-search-container" id="mapSearchContainer" style="display: none;">
            <div class="search-bar">
                <input 
                    type="text" 
                    id="mapSearchInput" 
                    placeholder="üîç Search location, incident type, or keyword..."
                    autocomplete="off"
                    onkeyup="handleSearchInput(event)"
                >
                <button class="search-btn" onclick="performSearch()">
                    Search
                </button>
                <!-- MAKE SURE THIS CLOSE BUTTON EXISTS -->
                <button class="close-search-btn" onclick="closeSearchBar()">
                    ‚úï
                </button>
            </div>
            
            <!-- Search Results Dropdown -->
            <div class="search-results" id="searchResults" style="display: none;"></div>
            
            <!-- Quick Search Filters -->
            <div class="quick-search-tags">
                <button class="tag-btn" onclick="quickSearch('fatal')">üíÄ Fatal</button>
                <button class="tag-btn" onclick="quickSearch('injury')">üöë Injury</button>
                <button class="tag-btn" onclick="quickSearch('motorcycle')">üèçÔ∏è Motorcycle</button>
                <button class="tag-btn" onclick="quickSearch('tricycle')">üõ∫ Tricycle</button>
                <button class="tag-btn" onclick="quickSearch('car')">üöó Car</button>
                <button class="tag-btn" onclick="quickSearch('pick-up')">üöô Pick-up</button>
            </div>
        </div>
        

        <!-- Search Info Panel (Results Summary) -->
        <div class="search-info-panel" id="searchInfoPanel" style="display: none;">
            <div class="search-info-header">
                <h4>üîç Search Results</h4>
                <button onclick="closeSearchInfo()">‚úï</button>
            </div>
            <div class="search-info-body" id="searchInfoBody"></div>
        </div>

        <!-- Fullscreen/Maximize Button -->
        <div class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()" data-tooltip="Fullscreen Mode">
            ‚õ∂
        </div>

        <!-- Back to List Button -->
        <div class="back-to-list-btn" id="backToListBtn" onclick="goBackToList()" data-tooltip="Back to Accident List" style="display: none;">
            üìã
        </div>

        <!-- Stats Box -->
            <div class="map-stats" id="statsBox">
                <div class="stats-header">
                    <span>üìä Statistics</span>
                    <button class="stats-close-btn" onclick="toggleStats()">√ó</button>
                </div>
                <div class="stats-content">
                <div class="stat-item">
                    <span class="stat-label">Total Accidents:</span>
                    <span class="stat-value" id="statsTotalAccidents">{{ total_accidents }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Hotspots:</span>
                    <span class="stat-value" id="statsTotalHotspots">{{ total_hotspots }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Visible:</span>
                    <span class="stat-value" id="statsVisibleMarkers">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Time Range:</span>
                    <span class="stat-value" id="statsTimeRange">All Time</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Fatal Accidents:</span>
                    <span class="stat-value" style="color: #DC143C;" id="statsFatalAccidents">0</span>
                </div>
            </div>
        </div>

        <!-- Enhanced Map Controls Panel -->
        <div class="map-controls" id="mapControls">
            <div class="controls-header">
                <h3>üó∫Ô∏è Advanced Map Controls</h3>
                <button class="close-btn" onclick="toggleLegend()">√ó</button>
            </div>
            
            <div class="controls-body">
                <!-- Time-Based Filters -->
                <div class="control-section">
                    <h4>üìÖ Time-Based Filtering</h4>
                    
                    <div class="control-group">
                        <label for="timeRange">Time Period</label>
                        <select id="timeRange" onchange="applyTimeFilter()">
                            <option value="all">All Time</option>
                            <option value="current_year">Current Year</option>
                            <option value="last_year">Last Year</option>
                            <option value="last_6_months">Last 6 Months</option>
                            <option value="last_3_months">Last 3 Months</option>
                            <option value="last_month">Last Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>

                    <div class="control-group" id="customDateRange" style="display: none;">
                        <label for="startDate">From Date</label>
                        <input type="date" id="startDate" onchange="updateCustomRange()">
                        <label for="endDate" style="margin-top: 0.5rem;">To Date</label>
                        <input type="date" id="endDate" onchange="updateCustomRange()">
                    </div>

                    <div class="control-group">
                        <label for="timeOfDay">Time of Day</label>
                        <select id="timeOfDay" onchange="applyTimeFilter()">
                            <option value="all">All Day</option>
                            <option value="morning">Morning (6AM-12PM)</option>
                            <option value="afternoon">Afternoon (12PM-6PM)</option>
                            <option value="evening">Evening (6PM-12AM)</option>
                            <option value="night">Night (12AM-6AM)</option>
                        </select>
                    </div>
                </div>

                <!-- Data Filters -->
                <div class="control-section">
                    <h4>üîç Data Filters</h4>
                    
                    <div class="control-group">
                        <label for="provinceFilter">Province</label>
                        <select id="provinceFilter" onchange="applyFilters()">
                            <option value="">All Provinces</option>
                            {% for province in provinces %}
                            <option value="{{ province }}">{{ province }}</option>
                            {% empty %}
                            <!-- Fallback options if no provinces in database -->
                            <option value="AGUSAN DEL NORTE">Agusan del Norte</option>
                            <option value="AGUSAN DEL SUR">Agusan del Sur</option>
                            <option value="SURIGAO DEL NORTE">Surigao del Norte</option>
                            <option value="SURIGAO DEL SUR">Surigao del Sur</option>
                            <option value="DINAGAT ISLANDS">Dinagat Islands</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="severityFilter">Minimum Severity</label>
                        <select id="severityFilter" onchange="applyFilters()">
                            <option value="0">All Severities</option>
                            <option value="30">Medium (30+)</option>
                            <option value="50">High (50+)</option>
                            <option value="70">Critical (70+)</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <button class="btn btn-outline" style="width: 100%;" onclick="clearAllFilters()">
                            üóëÔ∏è Clear All Filters
                        </button>
                    </div>
                </div>

                <!-- Map Layers -->
                <div class="control-section">
                    <h4>üóÇÔ∏è Map Layers & Visualization</h4>
                    
                    <label class="layer-toggle">
                        <input type="checkbox" id="showAccidents" checked onchange="toggleLayer('accidents')">
                        <span>üìç Accident Markers</span>
                    </label>

                    <label class="layer-toggle">
                        <input type="checkbox" id="showHotspots" checked onchange="toggleLayer('hotspots')">
                        <span>üî¥ Hotspot Areas</span>
                    </label>

                    <label class="layer-toggle">
                        <input type="checkbox" id="showClusters" onchange="toggleLayer('clusters')">
                        <span>üìä Cluster Markers</span>
                    </label>

                    <label class="layer-toggle">
                        <input type="checkbox" id="showHeatmap" onchange="toggleLayer('heatmap')">
                        <span>üî• Heatmap Layer</span>
                    </label>

                    <div class="control-group" style="margin-top: 1rem;">
                        <label for="clusterIntensity">
                            Cluster Intensity: <span id="clusterIntensityValue">50</span>%
                        </label>
                        <input type="range" id="clusterIntensity" min="1" max="100" value="50" 
                            oninput="updateClusterIntensityLive(this.value)" 
                            onchange="updateClusterIntensity()">
                    </div>

                    <div class="control-group">
                        <label for="heatmapIntensity">Heatmap Intensity</label>
                        <input type="range" id="heatmapIntensity" min="1" max="100" value="25" onchange="updateHeatmapIntensity()">
                    </div>
                </div>
            </div>
        </div>

<!-- Enhanced Legend -->
<div class="map-legend" id="legendBox">
    <div class="legend-header">
        <h4>üó∫Ô∏è Map Legend</h4>
        <button class="legend-close-btn" onclick="toggleLegend()">√ó</button>
    </div>
    
    <div class="legend-content">
        <!-- Accident Markers Section -->
        <div class="legend-category">
            <div class="legend-category-title">üöó Accident Markers</div>
            
            <div class="legend-item">
                <div class="legend-marker" style="background: #8B0000; width: 14px; height: 14px; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                <span>Fatal Accident (with deaths)</span>
            </div>
            
            <div class="legend-item">
                <div class="legend-marker" style="background: #FFA500; width: 13px; height: 13px; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                <span>Injury Accident</span>
            </div>
            
            <div class="legend-item">
                <div class="legend-marker" style="background: #DC143C; width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                <span>Property Damage Only</span>
            </div>
        </div>
        
        <!-- Hotspot Areas Section -->
        <div class="legend-category">
            <div class="legend-category-title">üî• Hotspot Areas</div>
            
            <div class="legend-item">
                <div class="legend-hotspot" style="background: rgba(220, 20, 60, 0.2); border: 2px solid #DC143C; width: 20px; height: 20px; border-radius: 50%;"></div>
                <span>Critical Hotspot (70+)</span>
            </div>
            
            <div class="legend-item">
                <div class="legend-hotspot" style="background: rgba(255, 165, 0, 0.2); border: 2px solid #FFA500; width: 20px; height: 20px; border-radius: 50%;"></div>
                <span>High Hotspot (50-69)</span>
            </div>
            
            <div class="legend-item">
                <div class="legend-hotspot" style="background: rgba(40, 167, 69, 0.2); border: 2px solid #28A745; width: 20px; height: 20px; border-radius: 50%;"></div>
                <span>Medium Hotspot (30-49)</span>
            </div>
        </div>
        
        <!-- Map Features Section -->
        <div class="legend-category">
            <div class="legend-category-title">üìç Map Features</div>
            
            <div class="legend-item">
                <div class="legend-cluster-icon">
                    <span style="background: #FFA500; color: white; padding: 2px 6px; border-radius: 50%; font-size: 0.7rem; font-weight: bold;">5</span>
                </div>
                <span>Clustered Markers</span>
            </div>
            
            <div class="legend-item">
                <div class="legend-heatmap" style="background: linear-gradient(to right, #0000FF, #FFFF00, #FF0000); width: 30px; height: 10px; border-radius: 3px;"></div>
                <span>Heatmap Intensity</span>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 2rem; border-radius: 12px; text-align: center;">
        <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 1rem;"></div>
        <p>Loading map data...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet Markercluster Plugin -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Leaflet Heatmap Plugin -->
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>


<script>
    // ============================================================================
    // ENHANCED MAP SYSTEM - COMPLETE WORKING VERSION
    // Fixed: Hotspots now filter by ALL filters (time, province, severity, time of day, search)
    // ============================================================================

    // Core Map Variables
    let map;
    let accidentMarkers = [];
    let hotspotCircles = [];
    let clusterMarkers = [];
    let markerClusterGroup;
    let heatmapLayer;
    let allAccidents = {{ accidents_json|safe }};
    let allHotspots = {{ hotspots_json|safe }};
    
    // Current filter state
    let currentFilters = {
        timeRange: 'all',
        timeOfDay: 'all',
        province: '',
        severity: 0,
        searchQuery: ''
    };

    // Active markers (currently visible on map)
    let activeMarkers = [];

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Initializing Enhanced Map System...');
        console.log('üìä Total accidents loaded:', allAccidents.length);
        console.log('üéØ Total hotspots loaded:', allHotspots.length);
        
        validateData();
        initializeEnhancedMap();
        loadAllAccidentMarkers();
        loadAllHotspotCircles();
        setupTimeFilters();
        
        // Initialize statistics with all accidents
        activeMarkers = [...accidentMarkers];
        updateAllStatistics();
        
        console.log('‚úÖ Map system initialized successfully');
        console.log('üìä Active markers:', activeMarkers.length);
        
        // Check for URL parameters to jump to specific location
        checkURLParametersAndJump();
    });

    // ============================================================================
    // DATA VALIDATION
    // ============================================================================
    
function validateData() {
    console.log('üîç Validating accident data...');
    
    let valid = 0;
    let invalid = 0;
    let fatalCount = 0;
    let injuryCount = 0;
    
    // Enhanced validation with better error reporting
    allAccidents.forEach((accident, index) => {
        // Check required coordinates with better validation
        if (!accident.latitude || !accident.longitude || 
            isNaN(parseFloat(accident.latitude)) || isNaN(parseFloat(accident.longitude)) ||
            Math.abs(accident.latitude) > 90 || Math.abs(accident.longitude) > 180) {
            console.warn(`‚ö†Ô∏è Invalid coordinates at index ${index}:`, accident.latitude, accident.longitude);
            invalid++;
            return;
        }
        
        // Enhanced date validation
        let accidentDate;
        try {
            accidentDate = new Date(accident.date_committed);
            if (isNaN(accidentDate.getTime()) || accidentDate > new Date()) {
                console.warn(`‚ö†Ô∏è Invalid date at index ${index}:`, accident.date_committed);
                invalid++;
                return;
            }
        } catch (error) {
            console.warn(`‚ö†Ô∏è Date parsing error at index ${index}:`, error);
            invalid++;
            return;
        }
        
        // Validate required fields
        if (!accident.incident_type || !accident.province) {
            console.warn(`‚ö†Ô∏è Missing required fields at index ${index}:`, accident);
            invalid++;
            return;
        }
        
        valid++;
        if (accident.victim_killed) fatalCount++;
        if (accident.victim_injured) injuryCount++;
    });
    
    console.log(`‚úÖ Validation complete: ${valid} valid, ${invalid} invalid`);
    console.log(`üíÄ Fatal accidents: ${fatalCount}`);
    console.log(`üöë Injury accidents: ${injuryCount}`);
    console.log(`üöó Property damage: ${valid - fatalCount - injuryCount}`);
    
    return valid > 0;
}

    // ============================================================================
    // MAP INITIALIZATION
    // ============================================================================
    
    function initializeEnhancedMap() {
        try {
            // Center on Caraga Region (approximate center)
            map = L.map('mainMap').setView([9.0, 125.5], 9);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 18,
                minZoom: 7
            }).addTo(map);

            // Initialize cluster group with default settings
            initializeClusterGroup(50);

            console.log('‚úÖ Map initialized successfully');
            
            // Force map to recalculate size
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
            
        } catch (error) {
            console.error('‚ùå Map initialization failed:', error);
            alert('Error loading map. Please refresh the page.');
        }
    }

    function initializeClusterGroup(intensity) {
        markerClusterGroup = L.markerClusterGroup({
            maxClusterRadius: function(zoom) {
                const baseRadius = 40 + (intensity / 100 * 60);
                return zoom > 12 ? baseRadius * 0.7 : baseRadius;
            },
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            chunkedLoading: true,
            chunkInterval: 200,
            chunkDelay: 50,
            disableClusteringAtZoom: intensity > 80 ? 16 : 18,
            animate: true,
            animateAddingMarkers: false,
            zoomToBoundsOnClick: true,
            removeOutsideVisibleBounds: true,
            spiderLegPolylineOptions: { 
                weight: 1.5, 
                color: '#222', 
                opacity: 0.5 
            }
        });
    }

    // ============================================================================
    // MARKER CREATION
    // ============================================================================
    
    function loadAllAccidentMarkers() {
        console.log('üìç Loading accident markers...');
        
        accidentMarkers = [];
        markerClusterGroup.clearLayers();

        allAccidents.forEach((accident, index) => {
            try {
                const marker = createAccidentMarker(accident);
                if (marker) {
                    accidentMarkers.push(marker);
                }
            } catch (error) {
                console.warn(`‚ö†Ô∏è Failed to create marker for accident ${index}:`, error);
            }
        });

        // Add all markers to cluster group
        accidentMarkers.forEach(marker => {
            markerClusterGroup.addLayer(marker);
        });

        map.addLayer(markerClusterGroup);
        
        // Set activeMarkers to all markers initially
        activeMarkers = [...accidentMarkers];
        
        console.log(`‚úÖ Loaded ${accidentMarkers.length} accident markers`);
        updateAllStatistics();
    }

function createAccidentMarker(accident) {
    // Enhanced marker color determination
    let markerColor = '#DC143C'; // Default crimson red
    let markerSize = 12;
    
    if (accident.victim_killed) {
        markerColor = '#8B0000'; // Dark red for fatal
        markerSize = 14;
    } else if (accident.victim_injured) {
        markerColor = '#FFA500'; // Orange for injury
        markerSize = 13;
    }

    const icon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="
            background-color: ${markerColor}; 
            width: ${markerSize}px; 
            height: ${markerSize}px; 
            border-radius: 50%; 
            border: 2px solid white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
        "></div>`,
        iconSize: [markerSize + 4, markerSize + 4],
        iconAnchor: [(markerSize + 4) / 2, (markerSize + 4) / 2]
    });

    const marker = L.marker([accident.latitude, accident.longitude], { 
        icon: icon,
        title: accident.incident_type || 'Accident'
    });

    // Enhanced popup content with more details
    const vehicleInfo = accident.vehicle_kind ? `
        <p><strong>üöó Vehicles:</strong> ${accident.vehicle_kind}</p>
    ` : '';
    
    const clusterInfo = accident.cluster_id ? `
        <p><strong>üî¥ Hotspot:</strong> Cluster #${accident.cluster_id}</p>
    ` : '';

    const popupContent = `
        <div class="marker-popup">
            <div class="popup-header">
                <h4>${accident.incident_type || 'Traffic Accident'}</h4>
            </div>
            <div class="popup-body">
                <p><strong>üìç Location:</strong> ${accident.barangay || 'N/A'}, ${accident.municipal || 'N/A'}</p>
                <p><strong>üèõÔ∏è Province:</strong> ${accident.province || 'N/A'}</p>
                <p><strong>üìÖ Date:</strong> ${accident.date_committed || 'N/A'}</p>
                <p><strong>üïê Time:</strong> ${accident.time_committed || 'N/A'}</p>
                <p><strong>üë• Casualties:</strong> ${accident.victim_count || 0}</p>
                ${vehicleInfo}
                ${clusterInfo}
                ${accident.victim_killed ? '<p style="color: #DC143C; font-weight: bold; background: #FFE5E5; padding: 5px; border-radius: 3px;">üíÄ FATAL ACCIDENT</p>' : ''}
                ${accident.victim_injured && !accident.victim_killed ? '<p style="color: #FFA500; font-weight: bold; background: #FFF3E0; padding: 5px; border-radius: 3px;">‚ö†Ô∏è INJURY ACCIDENT</p>' : ''}
                ${!accident.victim_killed && !accident.victim_injured ? '<p style="color: #28A745; font-weight: bold; background: #E8F5E9; padding: 5px; border-radius: 3px;">üöó PROPERTY DAMAGE ONLY</p>' : ''}
            </div>
            <div class="popup-footer">
                <a href="/accidents/${accident.id}/">View Details</a>
                ${accident.cluster_id ? `<a href="/hotspots/${accident.cluster_id}/" style="background: #FFA500;">View Hotspot</a>` : ''}
            </div>
        </div>
    `;

    // Lazy popup binding for better performance
    marker.accidentData = accident;
    marker.on('click', function() {
        if (!this.getPopup()) {
            this.bindPopup(popupContent, {
                maxWidth: 320,
                className: 'custom-popup'
            });
        }
    });
    
    return marker;
}

function loadAllHotspotCircles() {
    console.log('üéØ Loading initial hotspot circles with exact coverage...');
    
    hotspotCircles = [];
    
    // Create a map of cluster_id to ALL accidents (not filtered yet)
    const clusterMap = new Map();
    allAccidents.forEach(acc => {
        if (acc.cluster_id) {
            if (!clusterMap.has(acc.cluster_id)) {
                clusterMap.set(acc.cluster_id, []);
            }
            clusterMap.get(acc.cluster_id).push(acc);
        }
    });

    // Create hotspot circles with EXACT coverage and LIGHT COLORS
    allHotspots.forEach((hotspot, index) => {
        try {
            const hotspotAccidents = clusterMap.get(hotspot.cluster_id) || [];
            
            if (hotspotAccidents.length === 0) {
                console.warn(`‚ö†Ô∏è Hotspot ${hotspot.cluster_id} has no accidents`);
                return;
            }
            
            // Calculate EXACT radius
            const maxDistance = calculateMaxDistance(
                hotspot.center_latitude,
                hotspot.center_longitude,
                hotspotAccidents
            );
            
            const radius = maxDistance * 1.2; // 20% padding
            
            // CONSISTENT LIGHT COLORS - Same as updateHotspotDisplay
            let fillColor, borderColor;
            if (hotspot.severity_score >= 70) {
                fillColor = '#DC143C';
                borderColor = '#DC143C';
            } else if (hotspot.severity_score >= 50) {
                fillColor = '#FFA500';
                borderColor = '#FFA500';
            } else {
                fillColor = '#28A745';
                borderColor = '#28A745';
            }
            
            const circle = L.circle(
                [hotspot.center_latitude, hotspot.center_longitude],
                {
                    color: borderColor,
                    fillColor: fillColor,
                    fillOpacity: 0.2, // LIGHT OPACITY
                    radius: radius,
                    weight: 2 // Consistent weight
                }
            );
            
            const popupContent = `
                <div class="marker-popup">
                    <div class="popup-header" style="background: linear-gradient(135deg, ${fillColor}, ${fillColor}99);">
                        <h4>üî¥ ${getRiskLevel(hotspot.severity_score)} HOTSPOT</h4>
                    </div>
                    <div class="popup-body">
                        <p><strong>üìç Location:</strong> ${hotspot.primary_location}</p>
                        <p><strong>üìä Accidents:</strong> ${hotspotAccidents.length}</p>
                        <p><strong>üë• Casualties:</strong> ${hotspot.total_casualties}</p>
                        <p><strong>‚ö° Severity:</strong> ${hotspot.severity_score.toFixed(1)}/100</p>
                        <p><strong>üìè Coverage:</strong> ${radius.toFixed(0)}m radius</p>
                        <p><strong>üÜî Cluster ID:</strong> #${hotspot.cluster_id}</p>
                    </div>
                    <div class="popup-footer">
                        <a href="/hotspots/${hotspot.cluster_id}/">View Details</a>
                        <a href="javascript:void(0)" onclick="zoomToHotspotArea(${hotspot.cluster_id}, ${hotspot.center_latitude}, ${hotspot.center_longitude})" style="background: #FFA500;">üîç Zoom to Area</a>
                    </div>
                </div>
            `;
            
            circle.bindPopup(popupContent, { maxWidth: 300 });
            
            // Add hover effects
            circle.on('mouseover', function() {
                this.setStyle({
                    fillOpacity: 0.35,
                    weight: 3
                });
            });
            
            circle.on('mouseout', function() {
                this.setStyle({
                    fillOpacity: 0.2,
                    weight: 2
                });
            });
            
            // Only add to map if hotspots layer is enabled
            const hotspotsEnabled = document.getElementById('showHotspots')?.checked;
            if (hotspotsEnabled) {
                circle.addTo(map);
            }
            hotspotCircles.push(circle);
            
        } catch (error) {
            console.warn(`‚ö†Ô∏è Failed to create hotspot ${index}:`, error);
        }
    });

    console.log(`‚úÖ Loaded ${hotspotCircles.length} hotspot circles with exact coverage`);
}

    function createHotspotCircle(hotspot) {
        // Calculate radius based on accident count and severity
        const baseRadius = 300;
        const severityMultiplier = hotspot.severity_score / 100;
        const countMultiplier = Math.sqrt(hotspot.accident_count) / 3;
        const radius = baseRadius * countMultiplier * (1 + severityMultiplier);

        // Determine color based on severity
        let fillColor, borderColor;
        if (hotspot.severity_score >= 70) {
            fillColor = '#DC143C';
            borderColor = '#DC143C';
        } else if (hotspot.severity_score >= 50) {
            fillColor = '#FFA500';
            borderColor = '#FFA500';
        } else {
            fillColor = '#28A745';
            borderColor = '#28A745';
        }

        const circle = L.circle(
            [hotspot.center_latitude, hotspot.center_longitude], 
            {
                color: borderColor,
                fillColor: fillColor,
                fillOpacity: 0.2,
                radius: radius,
                weight: 2
            }
        );

        const popupContent = `
            <div class="marker-popup">
                <div class="popup-header" style="background: linear-gradient(135deg, ${fillColor}, ${fillColor}99);">
                    <h4>üî¥ ${getRiskLevel(hotspot.severity_score)} HOTSPOT</h4>
                </div>
                <div class="popup-body">
                    <p><strong>üìç Location:</strong> ${hotspot.primary_location}</p>
                    <p><strong>üìä Accidents:</strong> ${hotspot.accident_count}</p>
                    <p><strong>üë• Casualties:</strong> ${hotspot.total_casualties}</p>
                    <p><strong>‚ö° Severity:</strong> ${hotspot.severity_score.toFixed(1)}/100</p>
                    <p><strong>üÜî Cluster ID:</strong> #${hotspot.cluster_id}</p>
                </div>
                <div class="popup-footer">
                    <a href="/hotspots/${hotspot.cluster_id}/">View Details</a>
                    <a href="javascript:void(0)" onclick="zoomToHotspotArea(${hotspot.cluster_id}, ${hotspot.center_latitude}, ${hotspot.center_longitude})" style="background: #FFA500;">üîç Zoom to Area</a>
                </div>
            </div>
        `;

        circle.bindPopup(popupContent, { maxWidth: 300 });
        circle.hotspotData = hotspot;
        
        return circle;
    }

    function getRiskLevel(severity) {
        if (severity >= 70) return 'CRITICAL';
        if (severity >= 50) return 'HIGH';
        if (severity >= 30) return 'MEDIUM';
        return 'LOW';
    }

    // Calculate maximum distance from hotspot center to its accidents
function calculateMaxDistance(centerLat, centerLng, accidents) {
    let maxDistance = 0;
    
    accidents.forEach(accident => {
        if (!accident.latitude || !accident.longitude) return;
        
        // Calculate distance using Haversine formula
        const R = 6371000; // Earth's radius in meters
        const lat1 = centerLat * Math.PI / 180;
        const lat2 = accident.latitude * Math.PI / 180;
        const deltaLat = (accident.latitude - centerLat) * Math.PI / 180;
        const deltaLng = (accident.longitude - centerLng) * Math.PI / 180;
        
        const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                  Math.cos(lat1) * Math.cos(lat2) *
                  Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        if (distance > maxDistance) {
            maxDistance = distance;
        }
    });
    
    return maxDistance;
}

    // ============================================================================
    // UNIFIED FILTER SYSTEM - ENHANCED FOR ALL FILTERS
    // ============================================================================
    
function applyAllFilters() {
    console.log('üîç Applying unified filters...');
    showLoading();
    
    // Get filter values
    currentFilters.timeRange = document.getElementById('timeRange').value;
    currentFilters.timeOfDay = document.getElementById('timeOfDay').value;
    currentFilters.province = document.getElementById('provinceFilter').value;
    currentFilters.severity = parseInt(document.getElementById('severityFilter').value);
    
    // Show/hide custom date range
    const customRange = document.getElementById('customDateRange');
    if (customRange) {
        customRange.style.display = currentFilters.timeRange === 'custom' ? 'block' : 'none';
    }
    
    // Enhanced filtering with better performance
    setTimeout(() => {
        filterAndDisplayMarkers();
        
        // Update UI
        updateTimeFilterBadge();
        updateAllStatistics();
        
        // Update heatmap if active
        if (document.getElementById('showHeatmap') && document.getElementById('showHeatmap').checked) {
            createHeatmap();
        }
        
        // AUTO-REFRESH SEARCH BANNER IF SEARCH IS ACTIVE
        const searchInput = document.getElementById('mapSearchInput');
        const searchBanner = document.getElementById('searchActiveBanner');
        const bannerText = document.getElementById('searchBannerText');
        
        if (currentFilters.searchQuery && searchBanner && bannerText) {
            // Update search banner - JUST SHOW THE QUERY, NO RESULT COUNT
            bannerText.textContent = `"${currentFilters.searchQuery}"`; // REMOVED: - ${stats.total} results
            searchBanner.classList.add('show');
            
            // Update search info panel if open (this shows the detailed results)
            const searchPanel = document.getElementById('searchInfoPanel');
            if (searchPanel && searchPanel.style.display !== 'none') {
                showSearchResultsSummary(currentFilters.searchQuery);
            }
        }
        
        hideLoading();
        console.log('‚úÖ All filters applied successfully');
        
        // Show filter summary
        const visibleCount = activeMarkers.length;
        if (visibleCount === 0) {
            showNotification('No accidents match your filters', 'info');
        } else {
            showNotification(`Showing ${visibleCount} accidents with current filters`, 'success');
        }
    }, 100);
}

function filterAndDisplayMarkers() {
    const { startDate, endDate } = getDateRange();
    
    console.log('üîÑ Filtering markers with search query:', currentFilters.searchQuery);
    console.log('üéØ Current filters:', currentFilters);
    
    // Remove ALL markers first
    markerClusterGroup.clearLayers();
    activeMarkers = [];
    
    let stats = { total: 0, fatal: 0, injury: 0, property: 0 };
    
    // Enhanced filtering with better performance
    accidentMarkers.forEach(marker => {
        if (!marker.accidentData) return;
        
        const accident = marker.accidentData;
        
        // Apply all filters (including search)
        if (passesAllFilters(accident, startDate, endDate)) {
            // ONLY add matching markers
            markerClusterGroup.addLayer(marker);
            activeMarkers.push(marker);
            
            stats.total++;
            if (accident.victim_killed) stats.fatal++;
            else if (accident.victim_injured) stats.injury++;
            else stats.property++;
        }
    });
    
    // Enhanced hotspot display with unified filtering
    updateHotspotDisplay(startDate, endDate);
    
    console.log('=== FILTER RESULTS ===');
    console.log('Search query:', currentFilters.searchQuery);
    console.log('Filtered accidents:', stats);
    console.log('Active markers on map:', activeMarkers.length);
    console.log('Hotspots displayed:', hotspotCircles.length);
    
    // Make sure cluster group is visible
    if (!map.hasLayer(markerClusterGroup)) {
        map.addLayer(markerClusterGroup);
        console.log('‚úÖ Added cluster group to map');
    }
    
    updateAllStatistics();
}

function updateHotspotDisplay(startDate, endDate) {
    console.log('üéØ Updating hotspot display with unified filtering...');
    
    // Remove all existing hotspot circles
    hotspotCircles.forEach(circle => {
        if (circle && circle.remove) circle.remove();
    });
    hotspotCircles = [];
    
    // Create cluster map with FILTERED accidents only
    const clusterMap = new Map();
    activeMarkers.forEach(marker => {
        const accident = marker.accidentData;
        if (accident && accident.cluster_id) {
            if (!clusterMap.has(accident.cluster_id)) {
                clusterMap.set(accident.cluster_id, []);
            }
            clusterMap.get(accident.cluster_id).push(accident);
        }
    });
    
    // Create hotspot circles only for clusters with visible accidents
    allHotspots.forEach(hotspot => {
        const hotspotAccidents = clusterMap.get(hotspot.cluster_id) || [];
        
        if (hotspotAccidents.length === 0) {
            console.log(`‚ùå Hotspot ${hotspot.cluster_id} filtered out - no visible accidents`);
            return;
        }
        
        // Calculate dynamic radius based on actual accident spread
        const radius = calculateMaxDistance(
            hotspot.center_latitude,
            hotspot.center_longitude,
            hotspotAccidents
        ) * 1.3; // 30% padding
        
        // CONSISTENT LIGHT COLORS - Always use light opacity
        let fillColor, borderColor;
        if (hotspot.severity_score >= 70) {
            fillColor = '#DC143C';
            borderColor = '#DC143C';
        } else if (hotspot.severity_score >= 50) {
            fillColor = '#FFA500';
            borderColor = '#FFA500';
        } else {
            fillColor = '#28A745';
            borderColor = '#28A745';
        }
        
        const circle = L.circle(
            [hotspot.center_latitude, hotspot.center_longitude],
            {
                color: borderColor,
                fillColor: fillColor,
                fillOpacity: 0.2, // ALWAYS LIGHT OPACITY
                radius: Math.max(radius, 300), // Ensure minimum radius
                weight: 2, // Consistent weight
                opacity: 0.7
            }
        );
        
        // Enhanced popup with real-time statistics
        const fatalCount = hotspotAccidents.filter(a => a.victim_killed).length;
        const injuryCount = hotspotAccidents.filter(a => a.victim_injured && !a.victim_killed).length;
        const riskLevel = getRiskLevel(hotspot.severity_score);
        
        const popupContent = `
            <div class="marker-popup">
                <div class="popup-header" style="background: linear-gradient(135deg, ${borderColor}, ${fillColor});">
                    <h4>üî¥ ${riskLevel} RISK HOTSPOT</h4>
                </div>
                <div class="popup-body">
                    <p><strong>üìç Location:</strong> ${hotspot.primary_location}</p>
                    <p><strong>üìä Visible Accidents:</strong> ${hotspotAccidents.length}</p>
                    <p><strong>üíÄ Fatal:</strong> <span style="color: #DC143C;">${fatalCount}</span></p>
                    <p><strong>üöë Injury:</strong> <span style="color: #FFA500;">${injuryCount}</span></p>
                    <p><strong>‚ö° Severity:</strong> ${hotspot.severity_score.toFixed(1)}/100</p>
                    <p><strong>üìè Coverage:</strong> ${Math.round(radius)}m radius</p>
                    <p><strong>üÜî Cluster ID:</strong> #${hotspot.cluster_id}</p>
                </div>
                <div class="popup-footer">
                    <a href="/hotspots/${hotspot.cluster_id}/">View Details</a>
                    <a href="javascript:void(0)" onclick="zoomToHotspotArea(${hotspot.cluster_id}, ${hotspot.center_latitude}, ${hotspot.center_longitude})" style="background: #FFA500;">üîç Zoom to Area</a>
                </div>
            </div>
        `;
        
        circle.bindPopup(popupContent, { maxWidth: 350 });
        
        // Add hover effects - only on hover make it darker
        circle.on('mouseover', function() {
            this.setStyle({
                fillOpacity: 0.35, // Darker on hover
                weight: 3
            });
        });
        
        circle.on('mouseout', function() {
            this.setStyle({
                fillOpacity: 0.2, // Back to light color
                weight: 2
            });
        });
        
        // Only add to map if hotspots layer is enabled
        const hotspotsEnabled = document.getElementById('showHotspots')?.checked;
        if (hotspotsEnabled && circle) {
            circle.addTo(map);
        }
        hotspotCircles.push(circle);
    });
    
    console.log(`‚úÖ Displayed ${hotspotCircles.length} filtered hotspot circles`);
    updateHotspotStatistics(hotspotCircles.length);
}

    function updateHotspotStatistics(hotspotCount) {
        const statsElement = document.getElementById('statsTotalHotspots');
        if (statsElement) {
            statsElement.textContent = hotspotCount;
        }
    }

    function passesAllFilters(accident, startDate, endDate) {
        // Date filter
        let accidentDate;
        try {
            accidentDate = new Date(accident.date_committed);
            if (isNaN(accidentDate.getTime())) return false;
        } catch (error) {
            return false;
        }
        
        if (accidentDate < startDate || accidentDate > endDate) {
            return false;
        }
        
        // Time of day filter
        if (currentFilters.timeOfDay !== 'all') {
            if (!passesTimeOfDayFilter(accident.time_committed, currentFilters.timeOfDay)) {
                return false;
            }
        }
        
        // Province filter
        if (currentFilters.province && currentFilters.province !== '') {
            if (!accident.province || accident.province !== currentFilters.province) {
                return false;
            }
        }
        
        // Severity filter
        if (currentFilters.severity > 0) {
            if (!passesSeverityFilter(accident, currentFilters.severity)) {
                return false;
            }
        }
        
        // Search query filter
        if (currentFilters.searchQuery) {
            if (!passesSearchFilter(accident, currentFilters.searchQuery)) {
                return false;
            }
        }
        
        return true;
    }

    function getDateRange() {
        const now = new Date();
        let startDate, endDate = new Date(now);
        
        switch(currentFilters.timeRange) {
            case 'current_year':
                startDate = new Date(now.getFullYear(), 0, 1);
                break;
            case 'last_year':
                startDate = new Date(now.getFullYear() - 1, 0, 1);
                endDate = new Date(now.getFullYear(), 0, 0);
                break;
            case 'last_6_months':
                startDate = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                break;
            case 'last_3_months':
                startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                break;
            case 'last_month':
                startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                break;
            case 'custom':
                const startInput = document.getElementById('startDate');
                const endInput = document.getElementById('endDate');
                startDate = startInput && startInput.value ? new Date(startInput.value) : new Date(now.getFullYear() - 1, 0, 1);
                endDate = endInput && endInput.value ? new Date(endInput.value) : now;
                break;
            default: // 'all'
                startDate = new Date(2000, 0, 1);
                endDate = new Date(2100, 0, 1);
        }
        
        return { startDate, endDate };
    }

    function passesTimeOfDayFilter(timeString, timeOfDay) {
        if (!timeString) return true;
        
        const timeParts = timeString.toString().split(':');
        const hour = timeParts.length > 0 ? parseInt(timeParts[0]) : 12;
        
        switch(timeOfDay) {
            case 'morning':
                return hour >= 6 && hour < 12;
            case 'afternoon':
                return hour >= 12 && hour < 18;
            case 'evening':
                return hour >= 18 && hour < 24;
            case 'night':
                return hour >= 0 && hour < 6;
            default:
                return true;
        }
    }

    function passesSeverityFilter(accident, severityLevel) {
        switch(severityLevel) {
            case 70: // Fatal only
                return accident.victim_killed === true;
            case 50: // Injury only
                return accident.victim_injured === true && !accident.victim_killed;
            case 30: // Property damage only
                return !accident.victim_killed && !accident.victim_injured;
            default:
                return true;
        }
    }

function passesSearchFilter(accident, query) {
    if (!query || query.trim() === '') return true;
    
    const searchLower = query.toLowerCase().trim();
    
    // Enhanced severity keywords
    if (searchLower === 'fatal' || searchLower === 'fatal accident' || searchLower === 'death' || searchLower === 'killed') {
        return accident.victim_killed === true;
    }
    
    if (searchLower === 'injury' || searchLower === 'injured' || searchLower === 'injury accident' || searchLower === 'hurt') {
        return accident.victim_injured === true && !accident.victim_killed;
    }
    
    if (searchLower === 'property' || searchLower === 'property only' || searchLower === 'property damage' || searchLower === 'damage only') {
        return accident.victim_killed === false && accident.victim_injured === false;
    }
    
    // Enhanced vehicle type keywords
    if (searchLower === 'motorcycle' || searchLower === 'motorcyle' || 
        searchLower === 'motorbike' || searchLower === 'motor' ||
        searchLower === 'bike' || searchLower === 'mc' || searchLower === 'moto') {
        
        if (accident.vehicle_kind) {
            const vehicleLower = accident.vehicle_kind.toLowerCase();
            return vehicleLower.includes('motorcycle') || vehicleLower.includes('moto') || vehicleLower.includes('bike');
        }
        return false;
    }
    
    if (searchLower === 'tricycle' || searchLower === 'trike' || searchLower === 'trikes') {
        if (accident.vehicle_kind) {
            const vehicleLower = accident.vehicle_kind.toLowerCase();
            return vehicleLower.includes('tricycle') || vehicleLower.includes('trike');
        }
        return false;
    }
    
    if (searchLower === 'car' || searchLower === 'automobile' || searchLower === 'sedan' || searchLower === 'cars') {
        if (accident.vehicle_kind) {
            const vehicleLower = accident.vehicle_kind.toLowerCase();
            return vehicleLower.includes('car') || vehicleLower.includes('sedan') || vehicleLower.includes('auto');
        }
        return false;
    }
    
    if (searchLower === 'pickup' || searchLower === 'pick-up' || 
        searchLower === 'truck' || searchLower === 'lorry' || searchLower === 'pick up') {
        if (accident.vehicle_kind) {
            const vehicleLower = accident.vehicle_kind.toLowerCase();
            return vehicleLower.includes('pick-up') || vehicleLower.includes('truck') || vehicleLower.includes('lorry');
        }
        return false;
    }
    
    // Enhanced general text search with more fields
    const searchFields = [
        accident.barangay,
        accident.municipal,
        accident.province,
        accident.date_committed,
        accident.vehicle_kind,
        accident.incident_type,
        accident.street
    ].filter(field => field && field.toString().trim() !== '');
    
    return searchFields.some(field => 
        field.toString().toLowerCase().includes(searchLower)
    );
}
    // ============================================================================
    // STATISTICS UPDATE
    // ============================================================================
    
    function updateAllStatistics() {
        const stats = {
            total: activeMarkers.length,
            fatal: 0,
            injury: 0,
            property: 0
        };
        
        activeMarkers.forEach(marker => {
            if (!marker.accidentData) return;
            
            const accident = marker.accidentData;
            if (accident.victim_killed) {
                stats.fatal++;
            } else if (accident.victim_injured) {
                stats.injury++;
            } else {
                stats.property++;
            }
        });
        
        updateStatisticsDisplay(stats);
    }

    function updateStatisticsDisplay(stats) {
        // Update statistics panel
        const totalEl = document.getElementById('statsVisibleMarkers');
        const fatalEl = document.getElementById('statsFatalAccidents');
        const timeRangeEl = document.getElementById('statsTimeRange');
        
        if (totalEl) totalEl.textContent = stats.total;
        if (fatalEl) fatalEl.textContent = stats.fatal;
        
        if (timeRangeEl) {
            const timeRange = document.getElementById('timeRange');
            if (timeRange) {
                const selectedOption = timeRange.options[timeRange.selectedIndex];
                timeRangeEl.textContent = selectedOption ? selectedOption.text : 'All';
            }
        }
        
        console.log('üìä Statistics updated:', stats);
    }

    // ============================================================================
    // TIME FILTER SETUP
    // ============================================================================
    
    function setupTimeFilters() {
        const today = new Date();
        const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
        
        const endDateInput = document.getElementById('endDate');
        const startDateInput = document.getElementById('startDate');
        
        if (endDateInput) endDateInput.value = today.toISOString().split('T')[0];
        if (startDateInput) startDateInput.value = oneMonthAgo.toISOString().split('T')[0];
        
        console.log('üìÖ Time filters initialized');
    }

    function applyTimeFilter() {
        applyAllFilters();
    }

    function updateCustomRange() {
        if (document.getElementById('timeRange').value === 'custom') {
            applyAllFilters();
        }
    }

function updateTimeFilterBadge() {
    const badge = document.getElementById('timeFilterBadge');
    if (!badge) return;
    
    const timeRange = document.getElementById('timeRange').value;
    const timeOfDay = document.getElementById('timeOfDay').value;
    const province = document.getElementById('provinceFilter').value;
    const severity = document.getElementById('severityFilter').value;
    
    let text = 'üìÖ ';
    switch(timeRange) {
        case 'current_year': text += 'Current Year'; break;
        case 'last_year': text += 'Last Year'; break;
        case 'last_6_months': text += 'Last 6 Months'; break;
        case 'last_3_months': text += 'Last 3 Months'; break;
        case 'last_month': text += 'Last Month'; break;
        case 'custom': text += 'Custom Range'; break;
        default: text += 'All Time';
    }

    if (timeOfDay !== 'all') {
        text += ` ‚Ä¢ ${timeOfDay.charAt(0).toUpperCase() + timeOfDay.slice(1)}`;
    }

    if (province !== '') {
        text += ` ‚Ä¢ ${province}`;
    }

    if (severity !== '0') {
        text += ` ‚Ä¢ Severity ${severity}+`;
    }
    
    // Update the text content
    const textElement = badge.querySelector('span') || document.createElement('span');
    if (!badge.querySelector('span')) {
        textElement.textContent = text;
        badge.insertBefore(textElement, badge.querySelector('.close-banner'));
    } else {
        textElement.textContent = text;
    }
    
    // Show badge if any filter is active (not "all")
    const shouldShow = timeRange !== 'all' || timeOfDay !== 'all' || province !== '' || severity !== '0';
    badge.classList.toggle('show', shouldShow);
    
    // Update badge positions with delay to allow DOM to update
    setTimeout(updateBadgePositions, 10);
    
    console.log('üïí Time filter badge updated:', { text, shouldShow });
}

    function applyFilters() {
        applyAllFilters();
    }

function clearAllFilters() {
    console.log('üóëÔ∏è Clearing all filters...');
    
    // Reset filter controls
    document.getElementById('timeRange').value = 'all';
    document.getElementById('timeOfDay').value = 'all';
    document.getElementById('provinceFilter').value = '';
    document.getElementById('severityFilter').value = '0';
    
    const customRange = document.getElementById('customDateRange');
    if (customRange) customRange.style.display = 'none';
    
    // Reset cluster intensity
    const clusterIntensity = document.getElementById('clusterIntensity');
    if (clusterIntensity) {
        clusterIntensity.value = '50';
        const valueDisplay = document.getElementById('clusterIntensityValue');
        if (valueDisplay) valueDisplay.textContent = '50';
    }
    
    // Reset heatmap intensity
    const heatmapIntensity = document.getElementById('heatmapIntensity');
    if (heatmapIntensity) heatmapIntensity.value = '25';
    
    // Clear search input
    const searchInput = document.getElementById('mapSearchInput');
    if (searchInput) searchInput.value = '';
    
    // Reset filter state
    currentFilters = {
        timeRange: 'all',
        timeOfDay: 'all',
        province: '',
        severity: 0,
        searchQuery: ''
    };
    
    // Hide time filter badge
    const timeBadge = document.getElementById('timeFilterBadge');
    if (timeBadge) timeBadge.classList.remove('show');
    
    // Hide search banner
    const searchBanner = document.getElementById('searchActiveBanner');
    if (searchBanner) searchBanner.classList.remove('show');
    
    // Update badge positions
    updateBadgePositions();
    
    // Apply filters
    applyAllFilters();
    
    // Reset hotspot display with light colors
    setTimeout(() => {
        updateClusterIntensity();
        // Force reload hotspots with light colors
        const { startDate, endDate } = getDateRange();
        updateHotspotDisplay(startDate, endDate);
    }, 300);
        
    console.log('‚úÖ All filters cleared');
}

    // ============================================================================
    // LAYER MANAGEMENT
    // ============================================================================
    
    function toggleLayer(layerType) {
        const checkbox = document.getElementById(`show${layerType.charAt(0).toUpperCase() + layerType.slice(1)}`);
        if (!checkbox) return;
        
        const isChecked = checkbox.checked;
        
        switch(layerType) {
            case 'accidents':
                if (isChecked) {
                    map.addLayer(markerClusterGroup);
                } else {
                    map.removeLayer(markerClusterGroup);
                }
                break;

            case 'hotspots':
                if (isChecked) {
                    // Reload hotspots with current filters
                    const { startDate, endDate } = getDateRange();
                    updateHotspotDisplay(startDate, endDate);
                } else {
                    // Remove all hotspots
                    hotspotCircles.forEach(circle => {
                        if (circle && circle.remove) {
                            circle.remove();
                        }
                    });
                    hotspotCircles = [];
                    updateHotspotStatistics(0);
                }
                break;

            case 'heatmap':
                if (isChecked) {
                    createHeatmap();
                } else if (heatmapLayer) {
                    map.removeLayer(heatmapLayer);
                }
                break;

            case 'clusters':
                if (isChecked) {
                    createClusterMarkers();
                } else {
                    removeClusterMarkers();
                }
                break;
        }
        
        updateAllStatistics();
    }

    // ============================================================================
    // HEATMAP FUNCTIONALITY
    // ============================================================================
    
    function createHeatmap() {
        if (heatmapLayer) {
            map.removeLayer(heatmapLayer);
        }

        const heatData = activeMarkers.map(marker => {
            const accident = marker.accidentData;
            return [
                marker.getLatLng().lat,
                marker.getLatLng().lng,
                accident.victim_count || 1
            ];
        });

        if (heatData.length === 0) {
            console.warn('‚ö†Ô∏è No data for heatmap');
            return;
        }

        const intensityInput = document.getElementById('heatmapIntensity');
        const intensity = intensityInput ? parseInt(intensityInput.value) / 100 : 0.25;

        heatmapLayer = L.heatLayer(heatData, {
            radius: 25,
            blur: 15,
            maxZoom: 13,
            gradient: {
                0.0: 'blue',
                0.5: 'yellow',
                1.0: 'red'
            },
            max: intensity
        }).addTo(map);

        console.log('üî• Heatmap created with', heatData.length, 'points');
    }

    function updateHeatmapIntensity() {
        const checkbox = document.getElementById('showHeatmap');
        if (heatmapLayer && checkbox && checkbox.checked) {
            createHeatmap();
        }
    }

    // ============================================================================
    // CLUSTER INTENSITY MANAGEMENT
    // ============================================================================
    
    function updateClusterIntensity() {
        const intensityInput = document.getElementById('clusterIntensity');
        if (!intensityInput) return;
        
        const intensity = parseInt(intensityInput.value);
        console.log('üéØ Updating cluster intensity to:', intensity);
        
        showClusterIntensityFeedback(intensity);
        
        // Remove current clustering
        if (markerClusterGroup) {
            map.removeLayer(markerClusterGroup);
        }
        
        // Create new clustering with updated settings
        initializeClusterGroup(intensity);
        
        // Re-add active markers only
        activeMarkers.forEach(marker => {
            markerClusterGroup.addLayer(marker);
        });
        
        // Add back to map if accidents layer is enabled
        const checkbox = document.getElementById('showAccidents');
        if (checkbox && checkbox.checked) {
            map.addLayer(markerClusterGroup);
        }
        
        // Force cluster refresh
        setTimeout(() => {
            if (markerClusterGroup) {
                markerClusterGroup.refreshClusters();
                console.log(`‚úÖ Cluster intensity updated to ${intensity}%`);
            }
        }, 200);
    }

    function updateClusterIntensityLive(value) {
        const valueDisplay = document.getElementById('clusterIntensityValue');
        if (valueDisplay) {
            valueDisplay.textContent = value;
        }
    }

    function showClusterIntensityFeedback(intensity) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--primary-blue);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = `üéØ Cluster Intensity: ${intensity}%`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 1500);
    }

    // ============================================================================
    // CLUSTER MARKERS
    // ============================================================================
    
    function createClusterMarkers() {
        removeClusterMarkers();
        
        allHotspots.forEach(hotspot => {
            const clusterIcon = L.divIcon({
                className: 'cluster-marker',
                html: `
                    <div style="
                        background-color: #FFA500; 
                        width: 24px; 
                        height: 24px; 
                        border-radius: 50%; 
                        border: 3px solid white; 
                        box-shadow: 0 3px 8px rgba(0,0,0,0.4);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 11px;
                        color: white;
                    ">
                        ${hotspot.cluster_id}
                    </div>
                `,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            const marker = L.marker(
                [hotspot.center_latitude, hotspot.center_longitude], 
                {
                    icon: clusterIcon,
                    title: `Hotspot Cluster #${hotspot.cluster_id}`
                }
            );

            const popupContent = `
                <div class="marker-popup">
                    <div class="popup-header" style="background: linear-gradient(135deg, #FFA500, #FF8C00);">
                        <h4>üìä Cluster #${hotspot.cluster_id}</h4>
                    </div>
                    <div class="popup-body">
                        <p><strong>üìç Location:</strong> ${hotspot.primary_location}</p>
                        <p><strong>üìä Accidents:</strong> ${hotspot.accident_count}</p>
                        <p><strong>üë• Casualties:</strong> ${hotspot.total_casualties}</p>
                        <p><strong>‚ö° Severity:</strong> ${hotspot.severity_score.toFixed(1)}/100</p>
                        <p><strong>üéØ Risk Level:</strong> ${getRiskLevel(hotspot.severity_score)}</p>
                    </div>
                    <div class="popup-footer">
                        <a href="/hotspots/${hotspot.cluster_id}/">View Hotspot Details</a>
                    </div>
                </div>
            `;

            marker.bindPopup(popupContent, { maxWidth: 300 });
            marker.addTo(map);
            clusterMarkers.push(marker);
        });

        console.log(`‚úÖ Created ${clusterMarkers.length} cluster markers`);
    }

    function removeClusterMarkers() {
        clusterMarkers.forEach(marker => marker.remove());
        clusterMarkers = [];
    }

    // ============================================================================
    // UI TOGGLE FUNCTIONS
    // ============================================================================
    
    function toggleStats() {
        const statsBox = document.getElementById('statsBox');
        const toggle = document.getElementById('statsToggle');
        if (statsBox && toggle) {
            statsBox.classList.toggle('show');
            toggle.classList.toggle('active');
            
            if (statsBox.classList.contains('show')) {
                bringToFront('statsBox');
            }
        }
    }

    function toggleLegend() {
        const legendBox = document.getElementById('legendBox');
        const toggle = document.getElementById('legendToggle');
        if (legendBox && toggle) {
            legendBox.classList.toggle('show');
            toggle.classList.toggle('active');
            
            if (legendBox.classList.contains('show')) {
                bringToFront('legendBox');
            }
        }
    }

function toggleMapControls() {
    const controls = document.getElementById('mapControls');
    const toggle = document.getElementById('controlsToggle');
    if (controls && toggle) {
        controls.classList.toggle('show');
        toggle.classList.toggle('active');
        
        if (controls.classList.contains('show')) {
            bringToFront('mapControls');
        }
        
        // Update badge positions after animation
        setTimeout(updateBadgePositions, 300);
    }
}
    // Bring panel to front by managing z-index
    function bringToFront(panelId) {
        const panels = ['statsBox', 'legendBox', 'mapControls'];
        
        // Reset all panels to base z-index
        panels.forEach(id => {
            const panel = document.getElementById(id);
            if (panel) {
                panel.style.zIndex = '900';
            }
        });
        
        // Bring clicked panel to front
        const activePanel = document.getElementById(panelId);
        if (activePanel) {
            activePanel.style.zIndex = '950';
        }
    }

    // ============================================================================
    // LOADING STATES
    // ============================================================================
    
    function showLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'flex';
        }
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }

    // ============================================================================
    // HOTSPOT ZOOM FUNCTIONALITY
    // ============================================================================

    function zoomToHotspot(latitude, longitude) {
        if (map && latitude && longitude) {
            map.flyTo([latitude, longitude], 15, {
                duration: 1.5
            });
            
            // Show notification
            showNotification('Zoomed to hotspot area! üîç', 'success');
        }
    }

    // ============================================================================
    // EXPORT FUNCTIONALITY
    // ============================================================================
    
    function exportMapData() {
        const dataToExport = activeMarkers.map(marker => ({
            Date: marker.accidentData.date_committed,
            Time: marker.accidentData.time_committed,
            Location: `${marker.accidentData.barangay}, ${marker.accidentData.municipal}, ${marker.accidentData.province}`,
            Latitude: marker.accidentData.latitude,
            Longitude: marker.accidentData.longitude,
            Type: marker.accidentData.incident_type,
            Casualties: marker.accidentData.victim_count,
            Fatal: marker.accidentData.victim_killed ? 'Yes' : 'No',
            Injured: marker.accidentData.victim_injured ? 'Yes' : 'No'
        }));

        // Convert to CSV
        const csvContent = convertToCSV(dataToExport);
        downloadCSV(csvContent, 'filtered_accident_data.csv');
        
        // Show notification
        showNotification('Filtered map data exported successfully!', 'success');
    }

    function convertToCSV(data) {
        if (data.length === 0) return '';
        
        const headers = Object.keys(data[0]);
        const csvRows = [];
        
        // Add headers
        csvRows.push(headers.join(','));
        
        // Add data
        for (const row of data) {
            const values = headers.map(header => {
                const value = row[header];
                // Escape quotes and wrap in quotes if contains comma
                return typeof value === 'string' && value.includes(',') 
                    ? `"${value.replace(/"/g, '""')}"` 
                    : value;
            });
            csvRows.push(values.join(','));
        }
        
        return csvRows.join('\n');
    }

    function downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#28A745' : type === 'error' ? '#DC143C' : '#007BFF'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // ============================================================================
    // ADD ANIMATION STYLES
    // ============================================================================
    
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);

    // ============================================================================
    // CONSOLE HELPER FUNCTIONS (for debugging)
    // ============================================================================
    
    window.debugMap = function() {
        console.log('=== MAP DEBUG INFO ===');
        console.log('Total accidents loaded:', allAccidents.length);
        console.log('Total hotspots loaded:', allHotspots.length);
        console.log('Accident markers created:', accidentMarkers.length);
        console.log('Active (visible) markers:', activeMarkers.length);
        console.log('Current filters:', currentFilters);
        console.log('Marker cluster group:', markerClusterGroup);
        
        // Statistics
        const stats = {
            fatal: activeMarkers.filter(m => m.accidentData && m.accidentData.victim_killed).length,
            injury: activeMarkers.filter(m => m.accidentData && m.accidentData.victim_injured && !m.accidentData.victim_killed).length,
            property: activeMarkers.filter(m => m.accidentData && !m.accidentData.victim_killed && !m.accidentData.victim_injured).length
        };
        console.log('Statistics:', stats);
    };

    window.testFilters = function() {
        console.log('=== TESTING FILTERS ===');
        applyAllFilters();
    };

    window.resetMap = function() {
        console.log('=== RESETTING MAP ===');
        clearAllFilters();
        map.setView([9.0, 125.5], 9);
    };

    // ============================================================================
    // INTELLIGENT SEARCH SYSTEM
    // ============================================================================
    
    let searchTimeout;
    let isSearching = false;

    function toggleSearchBar() {
        const container = document.getElementById('mapSearchContainer');
        const btn = document.getElementById('floatingSearchBtn');
        const input = document.getElementById('mapSearchInput');
        
        if (container.style.display === 'none' || !container.classList.contains('active')) {
            // Show search bar
            container.style.display = 'block';
            setTimeout(() => {
                container.classList.add('active');
                btn.classList.add('active');
            }, 10);
            
            // Focus on input
            setTimeout(() => {
                if (input) input.focus();
            }, 400);
        } else {
            // Hide search bar
            closeSearchBar();
        }
    }

function closeSearchBar() {
    const container = document.getElementById('mapSearchContainer');
    const btn = document.getElementById('floatingSearchBtn');
    const results = document.getElementById('searchResults');
    
    container.classList.remove('active');
    btn.classList.remove('active');
    
    setTimeout(() => {
        container.style.display = 'none';
        if (results) results.style.display = 'none';
    }, 400);
    
    // Clear search input if no results selected
    const input = document.getElementById('mapSearchInput');
    if (input && !currentFilters.searchQuery) {
        input.value = '';
    }
    
    // Update badge positions
    updateBadgePositions();
}

function performSearch() {
    const input = document.getElementById('mapSearchInput');
    if (!input) return;
    
    const query = input.value.trim();
    
    if (query.length < 2) {
        showNotification('Please enter at least 2 characters', 'error');
        return;
    }
    
    console.log('üîç Performing search for:', query);
    showLoading();
    
    // FORCE SHOW ACCIDENT MARKERS LAYER
    const accidentsCheckbox = document.getElementById('showAccidents');
    if (accidentsCheckbox && !accidentsCheckbox.checked) {
        console.log('‚ö†Ô∏è Accidents layer was hidden, enabling it...');
        accidentsCheckbox.checked = true;
    }
    
    // Make sure cluster group is on map
    if (!map.hasLayer(markerClusterGroup)) {
        console.log('‚ö†Ô∏è Cluster group not on map, adding it...');
        map.addLayer(markerClusterGroup);
    }
    
    // Set search query in filters
    currentFilters.searchQuery = query;
    
    // Apply ALL filters (including current province, time, severity filters) + search
    applyAllFilters();
    
    // Update UI
    updateTimeFilterBadge();
    updateAllStatistics();
    
    // Show enhanced search results summary
    showSearchResultsSummary(query);
    
    // Hide search dropdown
    hideSearchResults();
    
    // Show search active banner - WITHOUT RESULT COUNT (just the query)
    const banner = document.getElementById('searchActiveBanner');
    const bannerText = document.getElementById('searchBannerText');
    if (banner && bannerText) {
        bannerText.textContent = `"${query}"`; // REMOVED: - ${stats.total} results
        banner.classList.add('show');
    }
    
    // Update badge positions with delay to allow DOM to update
    setTimeout(updateBadgePositions, 10);
    
    // Auto-zoom to show all results
    setTimeout(() => {
        if (activeMarkers.length > 0) {
            const bounds = L.latLngBounds();
            activeMarkers.forEach(marker => {
                bounds.extend(marker.getLatLng());
            });
            
            // Include hotspots in bounds
            hotspotCircles.forEach(circle => {
                bounds.extend(circle.getLatLng());
            });
            
            map.fitBounds(bounds, {
                padding: [60, 60],
                maxZoom: 13,
                duration: 1.5
            });
            
            console.log('üó∫Ô∏è Map adjusted to show', activeMarkers.length, 'search results');
        } else {
            showNotification('No results found for your search with current filters', 'error');
        }
        hideLoading();
    }, 500);
}

    // Zoom map to fit all visible markers
    function fitMapToMarkers() {
        if (activeMarkers.length === 0) {
            showNotification('No results to display on map', 'error');
            return;
        }
        
        // Create bounds from all active markers
        const bounds = L.latLngBounds();
        
        activeMarkers.forEach(marker => {
            bounds.extend(marker.getLatLng());
        });
        
        // Fit map to show all markers
        map.fitBounds(bounds, {
            padding: [50, 50],
            maxZoom: 13
        });
        
        console.log('üó∫Ô∏è Map adjusted to show', activeMarkers.length, 'results');
    }

    function showSearchSuggestions(query) {
        const results = document.getElementById('searchResults');
        if (!results) return;
        
        const searchLower = query.toLowerCase().trim();
        let matches = [];
        
        // Smart filtering based on keywords
        if (searchLower === 'fatal' || searchLower.includes('fatal')) {
            matches = allAccidents.filter(acc => acc.victim_killed === true).slice(0, 10);
        } 
        else if (searchLower === 'injury' || searchLower.includes('injury')) {
            matches = allAccidents.filter(acc => acc.victim_injured === true && !acc.victim_killed).slice(0, 10);
        } 
        else if (searchLower.includes('motorcycle') || searchLower.includes('motor')) {
            matches = allAccidents.filter(acc => {
                return acc.vehicle_kind && acc.vehicle_kind.toLowerCase().includes('motorcycle');
            }).slice(0, 10);
        }
        else if (searchLower.includes('tricycle')) {
            matches = allAccidents.filter(acc => {
                return acc.vehicle_kind && acc.vehicle_kind.toLowerCase().includes('tricycle');
            }).slice(0, 10);
        }
        else if (searchLower.includes('car')) {
            matches = allAccidents.filter(acc => {
                return acc.vehicle_kind && acc.vehicle_kind.toLowerCase().includes('car');
            }).slice(0, 10);
        }
        else if (searchLower.includes('pick')) {
            matches = allAccidents.filter(acc => {
                return acc.vehicle_kind && acc.vehicle_kind.toLowerCase().includes('pick-up');
            }).slice(0, 10);
        }
        else {
            // General text search
            matches = allAccidents.filter(accident => {
                const searchFields = [
                    accident.barangay,
                    accident.municipal,
                    accident.province,
                    accident.date_committed,
                    accident.vehicle_kind
                ].filter(field => field);
                
                return searchFields.some(field => 
                    field.toString().toLowerCase().includes(searchLower)
                );
            }).slice(0, 10);
        }
        
        if (matches.length === 0) {
            results.innerHTML = `
                <div class="no-results">
                    <div class="no-results-icon">üîç</div>
                    <div class="no-results-text">
                        No results found for "${query}"<br>
                        <small style="color: var(--text-light); margin-top: 0.5rem; display: block;">
                            Try: "fatal", "injury", "motorcycle", "tricycle", "car", or location names
                        </small>
                    </div>
                </div>
            `;
        } else {
            results.innerHTML = matches.map(accident => {
                // Display vehicle types nicely
                const vehicles = accident.vehicle_kind ? accident.vehicle_kind : 'Not specified';
                
                return `
                    <div class="search-result-item" onclick='selectSearchResult(${JSON.stringify(accident).replace(/'/g, "\\'")} )'>
                        <div class="search-result-title">
                            ${accident.incident_type}
                        </div>
                        <div class="search-result-details">
                            <span>üìç ${accident.barangay}, ${accident.municipal}</span>
                            <span>üìÖ ${accident.date_committed}</span>
                            <span>üöó ${vehicles}</span>
                            ${accident.victim_killed ? '<span class="search-result-badge badge-fatal">üíÄ Fatal</span>' : ''}
                            ${accident.victim_injured && !accident.victim_killed ? '<span class="search-result-badge badge-injury">üöë Injury</span>' : ''}
                            ${!accident.victim_killed && !accident.victim_injured ? '<span class="search-result-badge badge-property">Property Only</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        results.style.display = 'block';
    }

    function selectSearchResult(accident) {
        console.log('üìç Selected accident:', accident);
        
        // Close search results
        hideSearchResults();
        
        // Fly to location on map
        if (map && accident.latitude && accident.longitude) {
            map.flyTo([accident.latitude, accident.longitude], 16, {
                duration: 1.5
            });
            
            // Find and open the marker popup
            setTimeout(() => {
                const marker = accidentMarkers.find(m => 
                    m.accidentData && m.accidentData.id === accident.id
                );
                
                if (marker) {
                    marker.openPopup();
                    
                    // Highlight the marker temporarily
                    const markerElement = marker.getElement();
                    if (markerElement) {
                        markerElement.style.animation = 'pulse 1s ease 3';
                    }
                }
            }, 1500);
        }
        
        showNotification('Location found on map!', 'success');
    }

    function hideSearchResults() {
        const results = document.getElementById('searchResults');
        if (results) {
            results.style.display = 'none';
        }
    }

    function quickSearch(keyword) {
        console.log('üîç Quick search:', keyword);
        const input = document.getElementById('mapSearchInput');
        if (input) {
            input.value = keyword;
            performSearch();
        }
    }

    function showSearchResultsSummary(query) {
        const panel = document.getElementById('searchInfoPanel');
        const body = document.getElementById('searchInfoBody');
        
        if (!panel || !body) return;
        
        // Calculate statistics from active markers
        const stats = {
            total: activeMarkers.length,
            fatal: activeMarkers.filter(m => m.accidentData && m.accidentData.victim_killed).length,
            injury: activeMarkers.filter(m => m.accidentData && m.accidentData.victim_injured && !m.accidentData.victim_killed).length,
            property: activeMarkers.filter(m => m.accidentData && !m.accidentData.victim_killed && !m.accidentData.victim_injured).length
        };
        
        body.innerHTML = `
            <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--light-blue); border-radius: 8px;">
                <strong style="color: var(--primary-blue);">Search Query:</strong><br>
                <span style="font-size: 0.9rem;">"${query}"</span>
            </div>
            
            <div class="search-stat-item">
                <span class="search-stat-label">üìä Total Results:</span>
                <span class="search-stat-value">${stats.total}</span>
            </div>
            
            <div class="search-stat-item">
                <span class="search-stat-label">üíÄ Fatal:</span>
                <span class="search-stat-value" style="color: #DC143C;">${stats.fatal}</span>
            </div>
            
            <div class="search-stat-item">
                <span class="search-stat-label">üöë Injury:</span>
                <span class="search-stat-value" style="color: #FFA500;">${stats.injury}</span>
            </div>
            
            <div class="search-stat-item">
                <span class="search-stat-label">üöó Property Only:</span>
                <span class="search-stat-value" style="color: #28A745;">${stats.property}</span>
            </div>
            
            <button onclick="clearSearchFilter()" style="
                width: 100%;
                padding: 0.7rem;
                margin-top: 1rem;
                background: #DC143C;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s;
            " onmouseover="this.style.background='#8B0000'" onmouseout="this.style.background='#DC143C'">
                Clear Search
            </button>
        `;
        
        panel.style.display = 'block';
    }

    function closeSearchInfo() {
        const panel = document.getElementById('searchInfoPanel');
        if (panel) {
            panel.style.display = 'none';
        }
    }

function clearTimeFilterBadge() {
    console.log('üóëÔ∏è Clearing ALL filters from badge...');
    
    // Reset ALL filter controls, not just time
    document.getElementById('timeRange').value = 'all';
    document.getElementById('timeOfDay').value = 'all';
    document.getElementById('provinceFilter').value = '';
    document.getElementById('severityFilter').value = '0';
    
    // Hide custom date range if visible
    const customRange = document.getElementById('customDateRange');
    if (customRange) {
        customRange.style.display = 'none';
    }
    
    // Update current filters to reset everything
    currentFilters.timeRange = 'all';
    currentFilters.timeOfDay = 'all';
    currentFilters.province = '';
    currentFilters.severity = 0;
    
    // Hide the badge
    const badge = document.getElementById('timeFilterBadge');
    if (badge) {
        badge.classList.remove('show');
    }
    
    // Update badge positions for stacking
    updateBadgePositions();
    
    // Re-apply filters to update the map (this will clear everything)
    applyAllFilters();
    
    // Show confirmation
    showNotification('All filters cleared - Showing all data', 'success');
    
    console.log('‚úÖ ALL filters cleared from badge');
}

function clearSearchFromBanner() {
    console.log('üóëÔ∏è Clearing search from banner...');
    
    // Clear the search input
    const input = document.getElementById('mapSearchInput');
    if (input) {
        input.value = '';
    }
    
    // Clear the search query in filters
    currentFilters.searchQuery = '';
    
    // Re-apply all filters to reset the view
    applyAllFilters();
    
    // Hide the banner
    const banner = document.getElementById('searchActiveBanner');
    if (banner) {
        banner.classList.remove('show');
    }
    
    // Close search info panel if open
    closeSearchInfo();
    
    // Update badge positions
    updateBadgePositions();
    
    // Show confirmation
    showNotification('Search cleared', 'success');
    
    console.log('‚úÖ Search banner cleared');
}

function clearSearchFilter() {
    console.log('üóëÔ∏è Clearing search filter...');
    
    // Clear the search input
    const input = document.getElementById('mapSearchInput');
    if (input) {
        input.value = '';
    }
    
    // Clear the search query in filters
    currentFilters.searchQuery = '';
    
    // Re-apply all filters to reset the view completely
    applyAllFilters();
    
    // Close search info panel
    closeSearchInfo();
    
    // Hide search banner
    const banner = document.getElementById('searchActiveBanner');
    if (banner) {
        banner.classList.remove('show');
    }
    
    // Update badge positions
    updateBadgePositions();
    
    // Show notification
    showNotification('Search cleared - View reset to all data', 'success');
    
    // IMPORTANT: Reload hotspots with original light colors
    setTimeout(() => {
        const { startDate, endDate } = getDateRange();
        updateHotspotDisplay(startDate, endDate);
    }, 100);
    
    console.log('‚úÖ Search filter cleared');
}
    // ============================================================================
    // FULLSCREEN FUNCTIONALITY
    // ============================================================================
    
    function toggleFullscreen() {
        const body = document.body;
        const btn = document.getElementById('fullscreenBtn');
        
        if (!body.classList.contains('fullscreen-mode')) {
            // Enter fullscreen
            body.classList.add('fullscreen-mode');
            if (btn) {
                btn.classList.add('active');
                btn.innerHTML = '‚õ∂'; // Exit fullscreen icon
                btn.setAttribute('data-tooltip', 'Exit Fullscreen');
            }
            
            // Force map to recalculate size
            setTimeout(() => {
                if (map) map.invalidateSize();
            }, 100);
            
            showNotification('Fullscreen mode enabled', 'success');
        } else {
            // Exit fullscreen
            body.classList.remove('fullscreen-mode');
            if (btn) {
                btn.classList.remove('active');
                btn.innerHTML = '‚õ∂'; // Fullscreen icon
                btn.setAttribute('data-tooltip', 'Fullscreen Mode');
            }
            
            // Force map to recalculate size
            setTimeout(() => {
                if (map) map.invalidateSize();
            }, 100);
            
            showNotification('Fullscreen mode disabled', 'success');
        }
    }

    // ESC key to exit fullscreen
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const body = document.body;
            if (body.classList.contains('fullscreen-mode')) {
                toggleFullscreen();
            }
            
            // Also close search if open
            const container = document.getElementById('mapSearchContainer');
            if (container && container.classList.contains('active')) {
                closeSearchBar();
            }
        }
    });

    // Click outside to close search results
    document.addEventListener('click', function(event) {
        const searchContainer = document.getElementById('mapSearchContainer');
        const searchBtn = document.getElementById('floatingSearchBtn');
        const results = document.getElementById('searchResults');
        
        if (searchContainer && results && searchBtn) {
            const isClickInside = searchContainer.contains(event.target) || 
                                  searchBtn.contains(event.target);
            
            if (!isClickInside && results.style.display === 'block') {
                hideSearchResults();
            }
        }
    });

    // Add pulse animation for highlighted markers
    const pulseStyle = document.createElement('style');
    pulseStyle.textContent = `
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
        }
    `;
    document.head.appendChild(pulseStyle);

    // ============================================================================
    // URL PARAMETER HANDLING - Jump to Specific Location
    // ============================================================================
    
    function checkURLParametersAndJump() {
        const urlParams = new URLSearchParams(window.location.search);
        const lat = urlParams.get('lat');
        const lng = urlParams.get('lng');
        const zoom = urlParams.get('zoom');
        const accidentId = urlParams.get('accident_id');
        
        // Show back button if URL has parameters (came from accident detail/list)
        if (lat && lng) {
            const backBtn = document.getElementById('backToListBtn');
            if (backBtn) backBtn.style.display = 'flex';
            
            const latitude = parseFloat(lat);
            const longitude = parseFloat(lng);
            const zoomLevel = zoom ? parseInt(zoom) : 16;
            
            console.log('üéØ Jumping to location from URL:', latitude, longitude);
            
            // Fly to the location with animation
            setTimeout(() => {
                map.flyTo([latitude, longitude], zoomLevel, {
                    duration: 2,
                    easeLinearity: 0.5
                });
                
                // Find and open the marker popup if accident_id provided
                if (accidentId) {
                    setTimeout(() => {
                        const targetMarker = accidentMarkers.find(m => 
                            m.accidentData && m.accidentData.id == accidentId
                        );
                        
                        if (targetMarker) {
                            targetMarker.openPopup();
                            
                            // Highlight the marker with animation
                            const markerElement = targetMarker.getElement();
                            if (markerElement) {
                                markerElement.style.animation = 'pulse 2s ease 5';
                            }
                            
                            showNotification('Location found! üéØ', 'success');
                        }
                    }, 2000); // Wait for fly animation to complete
                }
            }, 500); // Small delay to ensure map is fully loaded
        }
    }
    
    function goBackToList() {
        window.location.href = "{% url 'accident_list' %}";
    }


    // Zoom to hotspot and show all its accidents
function zoomToHotspotArea(hotspotId, centerLat, centerLng) {
    console.log('üîç Zooming to hotspot area:', hotspotId);
    
    // Find all accidents in this hotspot
    const hotspotAccidents = allAccidents.filter(acc => acc.cluster_id === hotspotId);
    
    if (hotspotAccidents.length === 0) {
        showNotification('No accidents found in this hotspot', 'error');
        return;
    }
    
    // Create bounds from all accidents in this hotspot
    const bounds = L.latLngBounds();
    hotspotAccidents.forEach(acc => {
        if (acc.latitude && acc.longitude) {
            bounds.extend([acc.latitude, acc.longitude]);
        }
    });
    
    // Add center point to ensure it's included
    bounds.extend([centerLat, centerLng]);
    
    // Fit map to show all accidents with padding
    map.flyToBounds(bounds, {
        padding: [80, 80],
        maxZoom: 15,
        duration: 1.5
    });
    
    showNotification(`Zoomed to ${hotspotAccidents.length} accidents in hotspot #${hotspotId}`, 'success');
}

function updateBadgePositions() {
    const timeBadge = document.getElementById('timeFilterBadge');
    const searchBanner = document.getElementById('searchActiveBanner');
    
    if (!timeBadge || !searchBanner) return;
    
    const timeVisible = timeBadge.classList.contains('show');
    const searchVisible = searchBanner.classList.contains('show');
    
    // Reset positions first
    timeBadge.style.transform = 'translateX(-50%)';
    searchBanner.style.transform = 'translateX(-50%)';
    timeBadge.style.top = '20px';
    searchBanner.style.top = '20px';
    
    if (timeVisible && searchVisible) {
        // Calculate required spacing based on content width
        const timeWidth = timeBadge.offsetWidth;
        const searchWidth = searchBanner.offsetWidth;
        
        // Calculate minimum spacing needed (20px gap between badges)
        const totalWidth = timeWidth + searchWidth + 20;
        const maxAllowedWidth = window.innerWidth * 0.8; // 80% of screen width
        
        if (totalWidth <= maxAllowedWidth) {
            // Enough space - position side by side
            const spacing = (timeWidth + searchWidth) / 2 + 20;
            timeBadge.style.transform = `translateX(calc(-50% - ${spacing / 2}px))`;
            searchBanner.style.transform = `translateX(calc(-50% + ${spacing / 2}px))`;
            console.log('üìã Enough space - badges side by side');
        } else {
            // Not enough space - stack vertically
            timeBadge.style.transform = 'translateX(-50%)';
            timeBadge.style.top = '20px';
            searchBanner.style.transform = 'translateX(-50%)';
            searchBanner.style.top = '70px';
            console.log('üìã Not enough space - badges stacked vertically');
        }
    } else if (timeVisible) {
        // Only time badge - center it
        timeBadge.style.transform = 'translateX(-50%)';
        timeBadge.style.top = '20px';
        console.log('üïí Only time badge visible - centered');
    } else if (searchVisible) {
        // Only search banner - center it
        searchBanner.style.transform = 'translateX(-50%)';
        searchBanner.style.top = '20px';
        console.log('üîç Only search banner visible - centered');
    }
}


</script>
{% endblock %}