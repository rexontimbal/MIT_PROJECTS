{% extends 'base.html' %}
{% load static %}

{% block title %}Advanced Analytics{% endblock %}

{% block breadcrumb_items %}
<span> / Analytics</span>
{% endblock %}

{% block extra_css %}
<style>
    {% if request.GET %}
    /* Hide page initially when filters present - prevent flash */
    body {
        visibility: hidden;
    }
    {% endif %}

    html {
        scroll-behavior: auto;
    }

    :root {
        --analytics-primary: #6B46C1;
        --analytics-secondary: #14B8A6;
        --analytics-accent: #8B5CF6;
        --analytics-light: #F3E8FF;
        --text-dark: #1F2937;
        --text-secondary: #6B7280;
        --border-light: #E5E7EB;
    }

    #filter-controls {
        scroll-margin-top: 100px;
    }

    .analytics-container {
        max-width: 100%;
    }

    /* Compact Modern Header */
    .analytics-header {
        background: linear-gradient(135deg, var(--analytics-primary) 0%, var(--analytics-secondary) 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(107, 70, 193, 0.2);
    }

    .analytics-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 0.25rem 0;
    }

    .analytics-header p {
        margin: 0;
        font-size: 0.875rem;
        opacity: 0.95;
    }

    /* Compact Horizontal Date Inputs */
    .date-range-selector {
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
        margin-top: 1rem;
    }

    .date-inputs {
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    /* Compact Horizontal Filter Bar */
    .analytics-controls {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        border: 1px solid var(--border-light);
        margin-bottom: 1.5rem;
    }

    .analytics-controls h3 {
        color: var(--analytics-primary);
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0 0.75rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .control-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
    }

    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    /* Flat Modern Chart Cards */
    .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        border: 1px solid var(--border-light);
        overflow: hidden;
        transition: all 0.2s ease;
        padding: 1.25rem;
    }

    .chart-card:hover {
        box-shadow: 0 4px 12px rgba(107, 70, 193, 0.08);
        border-color: var(--analytics-primary);
    }

    .chart-card h3 {
        margin: 0 0 1rem 0;
        color: var(--analytics-primary);
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chart-title {
        flex: 1;
    }

    .chart-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .chart-btn {
        background: transparent;
        border: 1px solid var(--border-light);
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8125rem;
        color: var(--analytics-primary);
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    .chart-btn:hover {
        background: var(--analytics-primary);
        color: white;
        border-color: var(--analytics-primary);
    }

    .chart-card canvas {
        max-height: 300px;
        width: 100% !important;
        height: 300px !important;
    }

    .chart-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--analytics-light);
    }

    .chart-header h3 {
        margin: 0;
        color: var(--analytics-primary);
        font-size: 1rem;
        font-weight: 600;
    }

    .chart-actions {
        display: flex;
        gap: 0.5rem;
    }

    .chart-body {
        padding: 1.25rem;
        height: 300px;
        position: relative;
    }

    /* Modern Predictive Insights with Purple/Teal */
    .predictive-insights {
        background: linear-gradient(135deg, var(--analytics-primary) 0%, var(--analytics-secondary) 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(107, 70, 193, 0.2);
    }

    .predictive-insights h3 {
        color: white;
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0 0 1rem 0;
    }

    .insight-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
    }

    .insight-card {
        background: rgba(255, 255, 255, 0.25);
        padding: 1.25rem;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.2s ease;
    }

    .insight-card:hover {
        background: rgba(255, 255, 255, 0.35);
        transform: translateY(-2px);
    }

    .insight-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        line-height: 1;
        color: white;
    }

    .insight-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: white;
    }

    .trend-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.375rem 0.625rem;
        border-radius: 12px;
        font-size: 0.75rem;
        margin-top: 0.5rem;
        font-weight: 600;
    }

    .trend-up {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .trend-down {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .trend-neutral {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .comparison-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    /* Flat Modern Stat Boxes */
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-box {
        background: white;
        padding: 1.25rem 1rem;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        border-left: 4px solid var(--analytics-primary);
        border-top: 1px solid var(--border-light);
        border-right: 1px solid var(--border-light);
        border-bottom: 1px solid var(--border-light);
        text-align: center;
        transition: all 0.2s ease;
    }

    .stat-box:hover {
        box-shadow: 0 4px 12px rgba(107, 70, 193, 0.1);
        transform: translateY(-2px);
        border-left-color: var(--analytics-secondary);
    }

    .stat-box h3 {
        font-size: 2.25rem;
        color: var(--analytics-primary);
        margin-bottom: 0.5rem;
        font-weight: 700;
        line-height: 1;
    }

    .stat-box p {
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 600;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Flat Table Styling */
    .severity-table {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        border: 1px solid var(--border-light);
        margin-bottom: 1.5rem;
    }

    .severity-table h3 {
        color: var(--analytics-primary);
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0 0 1rem 0;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        overflow-x: auto;
    }

    .data-table thead {
        background: var(--analytics-light);
    }

    .data-table th {
        padding: 0.875rem 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--analytics-primary);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--analytics-primary);
    }

    .data-table td {
        padding: 0.875rem 1rem;
        border-bottom: 1px solid var(--border-light);
        color: var(--text-dark);
        font-size: 0.875rem;
    }

    .data-table tbody tr {
        transition: all 0.2s ease;
    }

    .data-table tbody tr:hover {
        background-color: var(--analytics-light);
    }

    .form-group {
        margin-bottom: 0;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.375rem;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.813rem;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: white;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--analytics-primary);
        box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.1);
    }

    .form-control:hover {
        border-color: var(--analytics-accent);
    }

    /* Chart Modal Styles */
    .chart-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.75);
        z-index: 10000;
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
    }

    .chart-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chart-modal-content {
        background: white;
        border-radius: 16px;
        padding: 0;
        width: 85%;
        max-width: 1000px;
        height: 95vh;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        overflow: hidden;
        animation: slideUp 0.4s ease;
        display: flex;
        flex-direction: column;
    }

    .chart-modal-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        flex-shrink: 0;
    }

    .chart-modal-header h3 {
        margin: 0;
        color: var(--analytics-primary);
        font-size: 1.125rem;
        font-weight: 600;
        flex: 1;
    }

    .chart-modal-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-right: 1rem;
    }

    .chart-modal-close {
        background: white;
        border: 1px solid var(--border-light);
        width: 36px;
        height: 36px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.25rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-weight: 300;
    }

    .chart-modal-close:hover {
        background: #DC143C;
        border-color: #DC143C;
        color: white;
    }

    .chart-modal-body {
        padding: 1.5rem;
        flex: 1;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 0;
    }

    .chart-modal-canvas-container {
        width: 100%;
        height: 100%;
        max-height: calc(95vh - 100px);
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chart-modal-canvas-container canvas {
        max-width: 100%;
        max-height: 100%;
    }

    /* Filter Help Modal */
    .filter-help-body {
        padding: 1.5rem;
        max-height: calc(95vh - 80px);
        overflow-y: auto;
    }

    .filter-help-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-light);
    }

    .filter-help-section:last-of-type {
        border-bottom: none;
    }

    .filter-help-section h4 {
        color: var(--analytics-primary);
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .filter-description {
        color: var(--text-secondary);
        font-size: 0.9375rem;
        margin-bottom: 1rem;
        font-style: italic;
    }

    .filter-options {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .filter-option {
        background: var(--analytics-light);
        padding: 0.875rem 1rem;
        border-radius: 8px;
        border-left: 3px solid var(--analytics-primary);
        font-size: 0.9375rem;
        line-height: 1.6;
    }

    .filter-option strong {
        color: var(--analytics-primary);
        font-weight: 600;
    }

    .filter-help-tip {
        background: linear-gradient(135deg, #FFF7ED 0%, #FEF3C7 100%);
        border-left: 4px solid #F59E0B;
        padding: 1rem 1.25rem;
        border-radius: 8px;
        margin-top: 1rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .filter-help-tip i {
        color: #F59E0B;
        font-size: 1.25rem;
        flex-shrink: 0;
        margin-top: 0.125rem;
    }

    .filter-help-tip strong {
        color: #92400E;
    }

    /* Date Selection Modal - Ultra Compact */
    #dateModal .chart-modal-content {
        width: 90%;
        max-width: 520px;
        height: auto;
    }

    .date-modal-body {
        padding: 0.75rem;
    }

    /* Date Range Tabs - Mini Size */
    .date-range-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.6rem;
    }

    .date-tab {
        flex: 1;
        background: var(--bg-light);
        border: 2px solid var(--border-light);
        border-radius: 6px;
        padding: 0.35rem 0.6rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.1rem;
    }

    .date-tab:hover {
        border-color: var(--analytics-primary);
        background: white;
    }

    .date-tab.active {
        background: var(--analytics-primary);
        border-color: var(--analytics-primary);
        color: white;
    }

    .tab-label {
        font-size: 0.625rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        opacity: 0.85;
        line-height: 1;
    }

    .tab-value {
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        line-height: 1.2;
    }

    /* Calendar Container - Compact */
    .calendar-container {
        background: white;
        border-radius: 8px;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.4rem;
        gap: 0.4rem;
    }

    .calendar-nav {
        background: var(--bg-light);
        border: none;
        width: 26px;
        height: 26px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--analytics-primary);
        transition: all 0.2s ease;
        font-size: 0.75rem;
        flex-shrink: 0;
    }

    .calendar-nav:hover {
        background: var(--analytics-primary);
        color: white;
        transform: scale(1.05);
    }

    .calendar-title {
        display: flex;
        gap: 0.4rem;
        flex: 1;
    }

    .calendar-select {
        flex: 1;
        padding: 0.3rem 0.4rem;
        border: 2px solid var(--border-light);
        border-radius: 5px;
        font-weight: 600;
        color: var(--analytics-primary);
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
    }

    .calendar-select:hover {
        border-color: var(--analytics-primary);
    }

    .calendar-select:focus {
        outline: none;
        border-color: var(--analytics-primary);
        box-shadow: 0 0 0 2px rgba(107, 70, 193, 0.1);
    }

    /* Calendar Grid - Compact */
    .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.15rem;
        margin-bottom: 0.25rem;
    }

    .weekday {
        text-align: center;
        font-size: 0.625rem;
        font-weight: 600;
        color: var(--text-secondary);
        padding: 0.2rem 0;
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.15rem;
    }

    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 5px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
        border: 2px solid transparent;
        min-height: 30px;
        max-height: 38px;
    }

    .calendar-day:hover {
        background: var(--bg-light);
        border-color: var(--analytics-primary);
    }

    .calendar-day.other-month {
        color: var(--text-secondary);
        opacity: 0.25;
    }

    .calendar-day.selected {
        background: var(--analytics-primary);
        color: white;
        border-color: var(--analytics-primary);
        font-weight: 600;
    }

    .calendar-day.today {
        border-color: var(--analytics-primary);
        font-weight: 600;
    }

    .calendar-day.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .calendar-day.disabled:hover {
        background: white;
        border-color: transparent;
    }

    /* Modal Actions - Mini Buttons */
    .date-modal-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.5rem;
        border-top: 1px solid var(--border-light);
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--analytics-primary);
        color: white;
        border: 2px solid var(--analytics-primary);
        padding: 0.35rem 0.9rem;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
    }

    .btn-primary:hover {
        background: #5a3aa0;
        border-color: #5a3aa0;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(107, 70, 193, 0.3);
    }

    .btn-outline {
        background: white;
        color: var(--analytics-primary);
        border: 2px solid var(--border-light);
        padding: 0.35rem 0.9rem;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
    }

    .btn-outline:hover {
        border-color: var(--analytics-primary);
        background: var(--bg-light);
    }

    /* Responsive adjustments for smaller screens */
    @media (max-width: 768px) {
        #dateModal .chart-modal-content {
            width: 95%;
            max-width: 100%;
        }

        .date-modal-body {
            padding: 0.75rem;
        }

        .date-tab {
            padding: 0.5rem;
            min-height: 55px;
        }

        .tab-label {
            font-size: 0.65rem;
        }

        .tab-value {
            font-size: 0.8rem;
        }

        .calendar-container {
            padding: 0.5rem;
        }

        .calendar-day {
            font-size: 0.8rem;
            min-height: 32px;
        }

        .weekday {
            font-size: 0.65rem;
            padding: 0.25rem 0;
        }

        .btn-primary, .btn-outline {
            font-size: 0.7rem;
            padding: 0.3rem 0.75rem;
        }

        .calendar-select {
            font-size: 0.8rem;
            padding: 0.4rem;
        }

        .calendar-nav {
            width: 28px;
            height: 28px;
            font-size: 0.75rem;
        }
    }

    @media (max-height: 700px) {
        #dateModal .chart-modal-content {
            max-height: 95vh;
        }

        .date-modal-body {
            padding: 0.5rem;
        }

        .date-range-tabs {
            margin-bottom: 0.5rem;
        }

        .calendar-container {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
        }

        .calendar-header {
            margin-bottom: 0.4rem;
        }

        .date-modal-actions {
            padding-top: 0.4rem;
        }

        .calendar-day {
            min-height: 28px;
            font-size: 0.7rem;
        }
    }

    /* Mini Buttons */
    .expand-btn {
        background: white;
        border: 1px solid var(--border-light);
        color: var(--analytics-primary);
        cursor: pointer;
        padding: 0.375rem 0.5rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .expand-btn:hover {
        background: var(--analytics-primary);
        border-color: var(--analytics-primary);
        color: white;
    }

    .btn {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        font-size: 0.813rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        line-height: 1.5;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--analytics-primary) 0%, var(--analytics-secondary) 100%);
        color: white;
        border: none;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(107, 70, 193, 0.3);
    }

    .btn-outline {
        background: white;
        color: var(--analytics-primary);
        border: 1px solid var(--analytics-primary);
    }

    .btn-outline:hover {
        background: var(--analytics-primary);
        color: white;
        transform: translateY(-2px);
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.813rem;
        border-radius: 6px;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            transform: translateY(100px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    /* Active Filters Display */
    .active-filters-banner {
        background: var(--analytics-light);
        border-left: 4px solid var(--analytics-primary);
        padding: 0.875rem 1.25rem;
        border-radius: 8px;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-right: 1px solid var(--border-light);
        border-bottom: 1px solid var(--border-light);
    }

    .filter-tags {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-tag {
        background: #F3E8FF;
        color: #6B46C1;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        border: 1px solid #E9D5FF;
    }

    .filter-tag button {
        background: none;
        border: none;
        color: var(--analytics-primary);
        cursor: pointer;
        font-weight: 600;
        font-size: 1.125rem;
        line-height: 1;
        padding: 0;
        margin-left: 0.25rem;
        border-radius: 4px;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .filter-tag button:hover {
        background: var(--analytics-primary);
        color: white;
        transform: scale(1.2) rotate(90deg);
        box-shadow: 0 2px 6px rgba(107, 70, 193, 0.3);
    }

    /* Modern Export Section */
    .export-section {
        background: linear-gradient(135deg, var(--analytics-primary) 0%, var(--analytics-secondary) 100%);
        color: white;
        border-radius: 12px;
        padding: 1.25rem 1.5rem;
        margin-top: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 12px rgba(107, 70, 193, 0.2);
    }

    .export-section h3 {
        color: white;
        margin-bottom: 0.375rem;
        font-size: 1rem;
        font-weight: 600;
    }

    .export-section p {
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 1rem;
        font-size: 0.8125rem;
    }

    .export-options {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .export-btn-enhanced {
        padding: 0.4rem 0.875rem;
        border-radius: 6px;
        font-weight: 500;
        border: 1.5px solid white;
        background: white;
        color: var(--analytics-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 110px;
        font-size: 0.8125rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.375rem;
    }

    .export-btn-enhanced:hover {
        background: transparent;
        color: white;
        transform: translateY(-2px);
    }

    @media (max-width: 768px) {
        .analytics-grid {
            grid-template-columns: 1fr;
        }

        .control-row {
            grid-template-columns: 1fr;
        }

        .date-inputs {
            flex-direction: column;
            width: 100%;
        }

        .analytics-header {
            padding: 1.25rem;
        }

        .stat-box {
            padding: 1rem;
        }

        .chart-card {
            margin-bottom: 1rem;
        }

        .export-options {
            flex-direction: column;
        }

        .export-btn-enhanced {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Compact Header -->
    <div class="analytics-header">
        <div>
            <h2>üìà Advanced Accident Analytics</h2>
            <p>Comprehensive analysis and predictive insights for traffic accidents in Caraga Region</p>
        </div>
    </div>

    <!-- Predictive Insights -->
    <div class="predictive-insights">
        <h3>üîÆ Predictive Insights & Trends</h3>
        <div class="insight-grid">
            <div class="insight-card">
                <div class="insight-value">{{ predicted_next_month }}</div>
                <div class="insight-label">Predicted Accidents (Next Month)</div>
                <div class="trend-indicator {% if trend_direction == 'increasing' %}trend-up{% else %}trend-down{% endif %}">
                    {% if trend_direction == 'increasing' %}
                        ‚¨ÜÔ∏è +{{ trend_percentage }}% vs last period
                    {% else %}
                        ‚¨áÔ∏è -{{ trend_percentage }}% vs last period
                    {% endif %}
                </div>
            </div>
            
            <div class="insight-card">
                <div class="insight-value" style="font-size: 1.8rem;">{{ risk_level }}</div>
                <div class="insight-label">Current Risk Level</div>
                <div class="trend-indicator {% if risk_level == 'CRITICAL' %}trend-up{% elif risk_level == 'LOW' %}trend-down{% else %}trend-neutral{% endif %}">
                    {% if risk_level == 'CRITICAL' %}
                        üö® Immediate action required
                    {% elif risk_level == 'HIGH' %}
                        ‚ö†Ô∏è High priority monitoring
                    {% elif risk_level == 'MEDIUM' %}
                        ‚ö° Regular monitoring
                    {% else %}
                        ‚úÖ Under control
                    {% endif %}
                </div>
            </div>
            
            <div class="insight-card">
                <div class="insight-value" style="font-size: 1.5rem;">{{ peak_hours }}</div>
                <div class="insight-label">Peak Accident Hours</div>
                <div class="trend-indicator trend-neutral">
                    üïê Highest risk period
                </div>
            </div>
            
            <div class="insight-card">
                <div class="insight-value">{{ fatality_rate|floatformat:1 }}%</div>
                <div class="insight-label">Fatality Rate</div>
                <div class="trend-indicator {% if fatality_rate >= 10 %}trend-up{% else %}trend-down{% endif %}">
                    {{ fatal_count }} fatal / {{ total_accidents }} total
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Controls -->
    <div class="analytics-controls" id="filter-controls">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0;">üéõÔ∏è Filter Controls</h3>
            <a href="{% url 'analytics' %}" class="btn btn-outline btn-sm">
                <i class="fas fa-redo"></i> Reset Filters
            </a>
        </div>

        <div class="control-row">
            <div class="form-group">
                <label for="analysisType">Analysis Type</label>
                <select id="analysisType" name="analysis_type" class="form-control" onchange="updateCharts()">
                    <option value="overview" {% if current_analysis_type == 'overview' %}selected{% endif %}>Overview</option>
                    <option value="temporal" {% if current_analysis_type == 'temporal' %}selected{% endif %}>Temporal Analysis</option>
                    <option value="spatial" {% if current_analysis_type == 'spatial' %}selected{% endif %}>Spatial Analysis</option>
                    <option value="severity" {% if current_analysis_type == 'severity' %}selected{% endif %}>Severity Analysis</option>
                </select>
            </div>

            <div class="form-group">
                <label for="timeGranularity">Time Granularity</label>
                <select id="timeGranularity" name="granularity" class="form-control" onchange="updateCharts()">
                    <option value="daily" {% if current_time_granularity == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if current_time_granularity == 'weekly' %}selected{% endif %}>Weekly</option>
                    <option value="monthly" {% if current_time_granularity == 'monthly' %}selected{% endif %}>Monthly</option>
                    <option value="quarterly" {% if current_time_granularity == 'quarterly' %}selected{% endif %}>Quarterly</option>
                </select>
            </div>

            <div class="form-group">
                <label for="severityFilter">Severity Filter</label>
                <select id="severityFilter" name="severity" class="form-control" onchange="updateCharts()">
                    <option value="all" {% if current_severity_filter == 'all' %}selected{% endif %}>All Severities</option>
                    <option value="fatal" {% if current_severity_filter == 'fatal' %}selected{% endif %}>Fatal Only</option>
                    <option value="injury" {% if current_severity_filter == 'injury' %}selected{% endif %}>Injury Only</option>
                    <option value="property" {% if current_severity_filter == 'property' %}selected{% endif %}>Property Damage Only</option>
                </select>
            </div>

            <div class="form-group">
                <label for="provinceFilter">Province Filter</label>
                <select id="provinceFilter" name="province" class="form-control" onchange="updateCharts()">
                    <option value="all" {% if current_province_filter == 'all' %}selected{% endif %}>All Provinces</option>
                    {% for province in provinces %}
                    <option value="{{ province }}" {% if current_province_filter == province %}selected{% endif %}>{{ province }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" style="display: flex; gap: 0.75rem; align-items: flex-end;">
                <div style="flex: 1;">
                    <label for="from_date" style="font-size: 0.875rem; margin-bottom: 0.25rem;">From</label>
                    <input type="text" readonly class="form-control date-selector" id="from_date_display" placeholder="Start date" onclick="openDateModal('from')" style="cursor: pointer; background: white; font-size: 0.875rem;">
                    <input type="hidden" name="from_date" id="from_date">
                </div>
                <div style="flex: 1;">
                    <label for="to_date" style="font-size: 0.875rem; margin-bottom: 0.25rem;">To</label>
                    <input type="text" readonly class="form-control date-selector" id="to_date_display" placeholder="End date" onclick="openDateModal('to')" style="cursor: pointer; background: white; font-size: 0.875rem;">
                    <input type="hidden" name="to_date" id="to_date">
                </div>
            </div>
        </div>

        <!-- Active Filters Display -->
        <div id="activeFiltersList" class="filter-tags" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-light);">
            <!-- Active filter tags will be inserted here -->
        </div>
    </div>

    {% if request.GET %}
    <script>
        // Immediate scroll positioning - runs as soon as filter-controls element exists
        (function() {
            const filterControls = document.getElementById('filter-controls');
            if (filterControls) {
                // Calculate position with offset
                const rect = filterControls.getBoundingClientRect();
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const elementTop = rect.top + scrollTop;
                const offsetPosition = elementTop - 100;

                // Scroll immediately
                window.scrollTo(0, offsetPosition);

                // Show page
                document.body.style.visibility = 'visible';
            }
        })();
    </script>
    {% else %}
    <script>
        // No filters - show page immediately
        document.body.style.visibility = 'visible';
    </script>
    {% endif %}

    <!-- Key Metrics -->
    <div class="stats-overview">
        <div class="stat-box">
            <h3>{{ total_accidents }}</h3>
            <p>Total Accidents</p>
            {% if total_in_database > 0 %}
            <small style="color: #6C757D; font-size: 0.8rem;">
                {% widthratio total_accidents total_in_database 100 %}% of database
            </small>
            {% endif %}
        </div>
        <div class="stat-box">
            <h3>{{ fatal_count }}</h3>
            <p>Fatal Accidents</p>
            {% if total_accidents > 0 %}
            <small style="color: #DC3545; font-size: 0.8rem;">
                {% widthratio fatal_count total_accidents 100 %}%
            </small>
            {% endif %}
        </div>
        <div class="stat-box">
            <h3>{{ injury_count }}</h3>
            <p>Injury Accidents</p>
            {% if total_accidents > 0 %}
            <small style="color: #FFA500; font-size: 0.8rem;">
                {% widthratio injury_count total_accidents 100 %}%
            </small>
            {% endif %}
        </div>
        <div class="stat-box">
            <h3>{{ fatality_rate|floatformat:1 }}%</h3>
            <p>Fatality Rate</p>
            <small style="color: #6C757D; font-size: 0.8rem;">
                {{ fatal_count }} fatal / {{ total_accidents }} total
            </small>
        </div>
        <div class="stat-box">
            <h3 id="avgMonthly">--</h3>
            <p>Avg Monthly</p>
            <small style="color: #6C757D; font-size: 0.8rem;">Calculating...</small>
        </div>
    </div>

    <!-- Main Charts Grid -->
    {% if current_analysis_type == 'overview' or current_analysis_type == 'temporal' %}
    <div class="analytics-grid">
        <!-- Accident Trends Over Time (Temporal & Overview) -->
        <div class="chart-card">
            <h3>
                <span class="chart-title">Accident Trends Over Time</span>
                <div class="chart-actions">
                    <button class="chart-btn" onclick="expandChart('trendChart', 'Accident Trends Over Time')" title="Expand chart">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="chart-btn" onclick="exportChart('trendChart', 'accident-trends')" title="Export as image">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </h3>
            <canvas id="trendChart"></canvas>
        </div>

        {% if current_analysis_type == 'overview' or current_analysis_type == 'severity' %}
        <!-- Severity Distribution (Severity & Overview) -->
        <div class="chart-card">
            <h3>
                <span class="chart-title">Accident Severity Distribution</span>
                <div class="chart-actions">
                    <button class="chart-btn" onclick="expandChart('severityChart', 'Accident Severity Distribution')" title="Expand chart">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="chart-btn" onclick="exportChart('severityChart', 'severity-distribution')" title="Export as image">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </h3>
            <canvas id="severityChart"></canvas>
        </div>
        {% endif %}

        {% if current_analysis_type == 'overview' %}
        <!-- Vehicle Type Analysis (Overview only) -->
        <div class="chart-card">
            <h3>
                <span class="chart-title">Vehicle Types Involved</span>
                <div class="chart-actions">
                    <button class="chart-btn" onclick="expandChart('vehicleChart', 'Vehicle Types Involved')" title="Expand chart">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="chart-btn" onclick="exportChart('vehicleChart', 'vehicle-types')" title="Export as image">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </h3>
            <canvas id="vehicleChart"></canvas>
        </div>
        {% endif %}

        {% if current_analysis_type == 'overview' or current_analysis_type == 'temporal' %}
        <!-- Day of Week Analysis (Temporal & Overview) -->
        <div class="chart-card">
            <h3>
                <span class="chart-title">Day of Week Analysis</span>
                <div class="chart-actions">
                    <button class="chart-btn" onclick="expandChart('dowChart', 'Day of Week Analysis')" title="Expand chart">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="chart-btn" onclick="exportChart('dowChart', 'day-of-week')" title="Export as image">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </h3>
            <canvas id="dowChart"></canvas>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Full Width Charts -->
    {% if current_analysis_type == 'overview' or current_analysis_type == 'temporal' %}
    <div class="analytics-grid" style="grid-template-columns: 1fr;">
        <!-- Hourly Pattern Analysis (Temporal & Overview) -->
        <div class="chart-card">
            <h3>
                <span class="chart-title">Hourly Accident Patterns</span>
                <div class="chart-actions">
                    <button class="chart-btn" onclick="expandChart('hourlyChart', 'Hourly Accident Patterns')" title="Expand chart">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="chart-btn" onclick="exportChart('hourlyChart', 'hourly-patterns')" title="Export as image">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </h3>
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- NEW ADVANCED CHARTS -->
    <!-- Province Comparison Chart (Spatial, Severity & Overview) -->
    {% if current_analysis_type == 'overview' or current_analysis_type == 'spatial' or current_analysis_type == 'severity' %}
    <div class="analytics-grid" style="grid-template-columns: 1fr;">
        <div class="chart-card">
            <h3>
                <span class="chart-title">Province Comparison - Fatal vs Injury Accidents</span>
                <div class="chart-actions">
                    <button class="chart-btn" onclick="expandChart('provinceComparisonChart', 'Province Comparison')" title="Expand chart">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="chart-btn" onclick="exportChart('provinceComparisonChart', 'province-comparison')" title="Export as image">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </h3>
            <canvas id="provinceComparisonChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Incident Type Distribution & Trend Comparison -->
    <div class="analytics-grid">
        {% if current_analysis_type == 'overview' %}
        <!-- Incident Type (Overview only) -->
        <div class="chart-card">
            <h3>
                <span class="chart-title">Top 5 Incident Types</span>
                <div class="chart-actions">
                    <button class="chart-btn" onclick="expandChart('incidentTypeChart', 'Top 5 Incident Types')" title="Expand chart">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="chart-btn" onclick="exportChart('incidentTypeChart', 'incident-types')" title="Export as image">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </h3>
            <canvas id="incidentTypeChart"></canvas>
        </div>
        {% endif %}

        {% if current_analysis_type == 'overview' or current_analysis_type == 'severity' %}
        <!-- Time Series Trend (Severity & Overview) -->
        <div class="chart-card">
            <h3>
                <span class="chart-title">Accident Trends - Fatal vs Injury Over Time</span>
                <div class="chart-actions">
                    <button class="chart-btn" onclick="expandChart('trendComparisonChart', 'Trend Comparison')" title="Expand chart">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="chart-btn" onclick="exportChart('trendComparisonChart', 'trend-comparison')" title="Export as image">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </h3>
            <canvas id="trendComparisonChart"></canvas>
        </div>
        {% endif %}
    </div>

    <!-- Comparison Section (Temporal & Overview) -->
    {% if current_analysis_type == 'overview' or current_analysis_type == 'temporal' %}
    <div class="comparison-section">
        <!-- Monthly Comparison -->
        <div class="chart-card">
            <h3>
                <span class="chart-title">Monthly Comparison</span>
                <div class="chart-actions">
                    <button class="chart-btn" onclick="expandChart('comparisonChart', 'Monthly Comparison')" title="Expand chart">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="chart-btn" onclick="exportChart('comparisonChart', 'monthly-comparison')" title="Export as image">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </h3>
            <canvas id="comparisonChart"></canvas>
        </div>

        <!-- Predictive Forecast -->
        <div class="chart-card">
            <h3>
                <span class="chart-title">30-Day Accident Forecast</span>
                <div class="chart-actions">
                    <button class="chart-btn" onclick="expandChart('forecastChart', '30-Day Forecast')" title="Expand chart">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button class="chart-btn" onclick="exportChart('forecastChart', 'forecast')" title="Export as image">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </h3>
            <canvas id="forecastChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Severity by Location Table (Spatial & Overview) -->
    {% if current_analysis_type == 'overview' or current_analysis_type == 'spatial' %}
    <div class="severity-table">
        <h3>üèôÔ∏è Top 10 Municipalities by Accident Severity</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Municipality</th>
                    <th>Province</th>
                    <th>Total Accidents</th>
                    <th>Fatal</th>
                    <th>Injury</th>
                    <th>Fatality Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for loc in severity_locations %}
                <tr>
                    <td><strong>#{{ forloop.counter }}</strong></td>
                    <td>{{ loc.municipal }}</td>
                    <td>{{ loc.province }}</td>
                    <td><strong>{{ loc.total }}</strong></td>
                    <td style="color: var(--danger-red);">{{ loc.killed }}</td>
                    <td style="color: var(--warning-orange);">{{ loc.injured }}</td>
                    <td>
                        {% widthratio loc.killed loc.total 100 as rate %}
                        <span style="{% if rate >= 20 %}color: var(--danger-red); font-weight: 700;{% elif rate >= 10 %}color: var(--warning-orange); font-weight: 600;{% endif %}">
                            {{ rate }}%
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Export Section -->
    <div class="export-section">
        <h3>üì§ Export Analytics Data</h3>
        <p>Download comprehensive analytics data for further analysis</p>
        <div class="export-options">
            <button class="export-btn-enhanced" onclick="exportAnalytics()">
                <i class="fas fa-file-csv"></i> Export as CSV
            </button>
            <button class="export-btn-enhanced" onclick="exportAsExcelRegular()">
                <i class="fas fa-file-excel"></i> Export as Excel
            </button>
            <button class="export-btn-enhanced" onclick="generateSummaryReport()">
                <i class="fas fa-file-alt"></i> Summary Report
            </button>
            <button class="export-btn-enhanced" onclick="window.print()">
                <i class="fas fa-print"></i> Print Report
            </button>
        </div>
    </div>

    <!-- Chart Expand Modal -->
    <div class="chart-modal" id="chartModal">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <h3 id="modalChartTitle">Chart View</h3>
                <div class="chart-modal-actions">
                    <button class="chart-btn" onclick="exportModalChart()" title="Export chart as HD image">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
                <button class="chart-modal-close" onclick="closeChartModal()">
                    √ó
                </button>
            </div>
            <div class="chart-modal-body">
                <div class="chart-modal-canvas-container">
                    <canvas id="modalChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Help Modal -->
    <div class="chart-modal" id="filterHelpModal">
        <div class="chart-modal-content" style="max-width: 800px;">
            <div class="chart-modal-header">
                <h3>üìö Filter Guide & Help</h3>
                <button class="chart-modal-close" onclick="closeFilterHelp()">√ó</button>
            </div>
            <div class="filter-help-body">
                <div class="filter-help-section">
                    <h4><i class="fas fa-chart-line"></i> Analysis Type</h4>
                    <p class="filter-description">Choose the focus of your analysis to view specific charts and insights.</p>
                    <div class="filter-options">
                        <div class="filter-option">
                            <strong>Overview:</strong> Shows ALL charts - complete dashboard with trends, severity, hourly patterns, province comparisons, forecasts, and municipality data.
                        </div>
                        <div class="filter-option">
                            <strong>Temporal Analysis:</strong> Shows only TIME-related charts:<br>
                            ‚Ä¢ Accident Trends Over Time<br>
                            ‚Ä¢ Day of Week Analysis<br>
                            ‚Ä¢ Hourly Accident Patterns<br>
                            ‚Ä¢ Monthly Comparison<br>
                            ‚Ä¢ 30-Day Forecast
                        </div>
                        <div class="filter-option">
                            <strong>Spatial Analysis:</strong> Shows only LOCATION-related charts:<br>
                            ‚Ä¢ Province Comparison Chart<br>
                            ‚Ä¢ Top 10 Municipalities by Severity (Table)
                        </div>
                        <div class="filter-option">
                            <strong>Severity Analysis:</strong> Shows only SEVERITY-related charts:<br>
                            ‚Ä¢ Accident Severity Distribution<br>
                            ‚Ä¢ Province Comparison - Fatal vs Injury<br>
                            ‚Ä¢ Accident Trends - Fatal vs Injury Over Time
                        </div>
                    </div>
                </div>

                <div class="filter-help-section">
                    <h4><i class="fas fa-clock"></i> Time Granularity</h4>
                    <p class="filter-description">Control the time interval for trend charts and temporal analysis.</p>
                    <div class="filter-options">
                        <div class="filter-option">
                            <strong>Daily:</strong> View accident patterns day by day for detailed short-term analysis.
                        </div>
                        <div class="filter-option">
                            <strong>Weekly:</strong> Aggregate data by week to identify weekly patterns and trends.
                        </div>
                        <div class="filter-option">
                            <strong>Monthly:</strong> Monthly summaries ideal for long-term trend identification.
                        </div>
                        <div class="filter-option">
                            <strong>Quarterly:</strong> Three-month intervals for high-level strategic planning.
                        </div>
                    </div>
                </div>

                <div class="filter-help-section">
                    <h4><i class="fas fa-exclamation-triangle"></i> Severity Filter</h4>
                    <p class="filter-description">Filter accidents by their severity level to focus on specific incident types.</p>
                    <div class="filter-options">
                        <div class="filter-option">
                            <strong>All Severities:</strong> Include all accident types in the analysis.
                        </div>
                        <div class="filter-option">
                            <strong>Fatal Only:</strong> Show only accidents that resulted in fatalities.
                        </div>
                        <div class="filter-option">
                            <strong>Injury Only:</strong> Display accidents where people were injured but no fatalities occurred.
                        </div>
                        <div class="filter-option">
                            <strong>Property Damage Only:</strong> Focus on accidents with property damage but no injuries or fatalities.
                        </div>
                    </div>
                </div>

                <div class="filter-help-section">
                    <h4><i class="fas fa-map-marker-alt"></i> Province Filter</h4>
                    <p class="filter-description">Narrow down analysis to specific provinces in the Caraga Region.</p>
                    <div class="filter-options">
                        <div class="filter-option">
                            <strong>All Provinces:</strong> Include data from all provinces in Caraga Region.
                        </div>
                        <div class="filter-option">
                            <strong>Specific Province:</strong> Focus analysis on selected province for localized insights and targeted interventions.
                        </div>
                    </div>
                </div>

                <div class="filter-help-section">
                    <h4><i class="fas fa-calendar-alt"></i> Date Range</h4>
                    <p class="filter-description">Define the time period for your analysis.</p>
                    <div class="filter-options">
                        <div class="filter-option">
                            <strong>From Date:</strong> Start date of the analysis period. Leave empty to include all historical data from the beginning.
                        </div>
                        <div class="filter-option">
                            <strong>To Date:</strong> End date of the analysis period. Leave empty to include data up to the most recent date.
                        </div>
                        <div class="filter-option">
                            <strong>Auto-Apply:</strong> Charts automatically update when you select dates - no need to click a button.
                        </div>
                    </div>
                </div>

                <div class="filter-help-tip">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Tip:</strong> Combine multiple filters to create custom views. For example, select "Fatal Only" + specific province + date range to analyze fatal accidents in a particular area and time period.
                </div>
            </div>
        </div>
    </div>

    <!-- Date Selection Modal -->
    <div class="chart-modal" id="dateModal">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <h3>üìÖ Select Date Range</h3>
                <button class="chart-modal-close" onclick="closeDateModal()">√ó</button>
            </div>
            <div class="date-modal-body">
                <!-- Date Range Tabs -->
                <div class="date-range-tabs">
                    <button class="date-tab active" onclick="switchDateTab('from')" id="fromTab">
                        <span class="tab-label">From Date</span>
                        <span class="tab-value" id="fromTabValue">Not set</span>
                    </button>
                    <button class="date-tab" onclick="switchDateTab('to')" id="toTab">
                        <span class="tab-label">To Date</span>
                        <span class="tab-value" id="toTabValue">Not set</span>
                    </button>
                </div>

                <!-- Calendar Container -->
                <div class="calendar-container">
                    <!-- Calendar Header (Month/Year Selector) -->
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="calendar-title">
                            <select id="calendarMonth" class="calendar-select" onchange="renderCalendar()">
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                            <select id="calendarYear" class="calendar-select" onchange="renderCalendar()">
                                <!-- Years will be populated by JavaScript -->
                            </select>
                        </div>
                        <button class="calendar-nav" onclick="changeMonth(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="calendar-weekdays">
                        <div class="weekday">Su</div>
                        <div class="weekday">Mo</div>
                        <div class="weekday">Tu</div>
                        <div class="weekday">We</div>
                        <div class="weekday">Th</div>
                        <div class="weekday">Fr</div>
                        <div class="weekday">Sa</div>
                    </div>
                    <div class="calendar-days" id="calendarDays">
                        <!-- Days will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Modal Actions -->
                <div class="date-modal-actions">
                    <button class="btn btn-outline" onclick="clearAllDates()">
                        <i class="fas fa-eraser"></i> Clear All
                    </button>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-outline" onclick="closeDateModal()">
                            Cancel
                        </button>
                        <button class="btn btn-primary" onclick="applyDates()">
                            <i class="fas fa-check"></i> Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    // Chart instances - Store in window for global access
    window.charts = {};
    let trendChart, severityChart, hourlyChart, vehicleChart, dowChart, comparisonChart, forecastChart;
    let provinceComparisonChart, incidentTypeChart, trendComparisonChart;

    document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing analytics...');

    // Populate date inputs from URL parameters ONLY
    populateDateInputsFromURL();

    // Initialize charts and content
    initializeCharts();
    loadPredictiveInsights();
    displayActiveFilters();
});

    function populateDateInputsFromURL() {
        const params = new URLSearchParams(window.location.search);

        // Helper to format date for display
        function formatForDisplay(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
        }

        // Only set date values if they exist in URL
        const fromDate = params.get('from_date');
        const toDate = params.get('to_date');

        if (fromDate) {
            document.getElementById('from_date').value = fromDate;
            document.getElementById('from_date_display').value = formatForDisplay(fromDate);
        }

        if (toDate) {
            document.getElementById('to_date').value = toDate;
            document.getElementById('to_date_display').value = formatForDisplay(toDate);
        }
    }

    function initializeCharts() {
    console.log('üìä Starting chart initialization...');
    
    // ============================================================================
    // GET DATA FROM DJANGO WITH FALLBACKS FOR EMPTY DATA
    // ============================================================================
    const rawTrendLabels = {{ trend_labels|safe }};
    const rawTrendTotal = {{ trend_total|safe }};
    const rawTrendFatal = {{ trend_fatal|safe }};
    const rawTrendInjury = {{ trend_injury|safe }};
    
    const rawVehicleLabels = {{ vehicle_labels|safe }};
    const rawVehicleData = {{ vehicle_data|safe }};
    
    const rawHourlyLabels = {{ hourly_labels|safe }};
    const rawHourlyData = {{ hourly_data|safe }};
    
    const rawDowData = {{ dow_data|safe }};
    
    const rawProvinceLabels = {{ province_labels|safe }};
    const rawProvinceTotal = {{ province_total|safe }};
    const rawProvinceFatal = {{ province_fatal|safe }};
    const rawProvinceInjury = {{ province_injury|safe }};
    
    const rawIncidentLabels = {{ incident_labels|safe }};
    const rawIncidentData = {{ incident_data|safe }};
    
    // Check if data is empty and provide fallbacks
    const hasData = rawTrendLabels && rawTrendLabels.length > 0;
    
    console.log('üìä Data Check:', {
        hasData: hasData,
        trendLabels: rawTrendLabels ? rawTrendLabels.length : 0,
        totalAccidents: {{ total_accidents }}
    });
    
    // Use actual data or sample data
    const trendLabels = hasData ? rawTrendLabels : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    const trendTotal = hasData ? rawTrendTotal : [45, 52, 48, 60, 55, 58];
    const trendFatal = hasData ? rawTrendFatal : [5, 8, 6, 9, 7, 8];
    const trendInjury = hasData ? rawTrendInjury : [20, 25, 22, 28, 26, 27];
    
    const vehicleLabels = (rawVehicleLabels && rawVehicleLabels.length > 0) ? rawVehicleLabels : ['Motorcycle', 'Car', 'Truck', 'Bus'];
    const vehicleData = (rawVehicleData && rawVehicleData.length > 0) ? rawVehicleData : [85, 72, 45, 28];
    
    const hourlyLabels = rawHourlyLabels;
    const hourlyData = rawHourlyData;
    
    const dowData = (rawDowData && rawDowData.length > 0) ? rawDowData : [45, 52, 48, 55, 58, 72, 65];
    
    const provinceLabels = (rawProvinceLabels && rawProvinceLabels.length > 0) ? rawProvinceLabels : ['Province 1', 'Province 2'];
    const provinceTotal = (rawProvinceTotal && rawProvinceTotal.length > 0) ? rawProvinceTotal : [100, 80];
    const provinceFatal = (rawProvinceFatal && rawProvinceFatal.length > 0) ? rawProvinceFatal : [10, 8];
    const provinceInjury = (rawProvinceInjury && rawProvinceInjury.length > 0) ? rawProvinceInjury : [40, 35];
    
    const incidentLabels = (rawIncidentLabels && rawIncidentLabels.length > 0) ? rawIncidentLabels : ['Type A', 'Type B', 'Type C'];
    const incidentData = (rawIncidentData && rawIncidentData.length > 0) ? rawIncidentData : [120, 95, 80];
    
    // ============================================================================
    // CHART 1: TREND CHART
    // ============================================================================
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        console.log('üé® Creating Trend Chart...');
        try {
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Total Accidents',
                        data: trendTotal,
                        borderColor: '#003087',
                        backgroundColor: 'rgba(0, 48, 135, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            window.charts.trendChart = trendChart;
            console.log('‚úÖ Trend Chart created successfully');
        } catch (error) {
            console.error('‚ùå Trend Chart error:', error);
        }
    } else {
        console.error('‚ùå Trend Chart canvas not found!');
    }

    // ============================================================================
    // CHART 2: SEVERITY CHART (DOUGHNUT)
    // ============================================================================
    const severityCtx = document.getElementById('severityChart');
    if (severityCtx) {
        console.log('üé® Creating Severity Chart...');
        try {
            const totalAcc = {{ total_accidents }};
            const fatalAcc = {{ fatal_count }};
            const injuryAcc = {{ injury_count }};
            const propertyDamage = Math.max(0, totalAcc - fatalAcc - injuryAcc);
            
            severityChart = new Chart(severityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Fatal', 'Injury', 'Property Damage'],
                    datasets: [{
                        data: [fatalAcc, injuryAcc, propertyDamage],
                        backgroundColor: ['#DC143C', '#FFA500', '#003087']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            window.charts.severityChart = severityChart;
            console.log('‚úÖ Severity Chart created successfully');
        } catch (error) {
            console.error('‚ùå Severity Chart error:', error);
        }
    }

    // ============================================================================
    // CHART 3: HOURLY CHART
    // ============================================================================
    const hourlyCtx = document.getElementById('hourlyChart');
    if (hourlyCtx) {
        console.log('üé® Creating Hourly Chart...');
        try {
            hourlyChart = new Chart(hourlyCtx, {
                type: 'bar',
                data: {
                    labels: hourlyLabels,
                    datasets: [{
                        label: 'Accidents by Hour',
                        data: hourlyData,
                        backgroundColor: '#003087'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            window.charts.hourlyChart = hourlyChart;
            console.log('‚úÖ Hourly Chart created successfully');
        } catch (error) {
            console.error('‚ùå Hourly Chart error:', error);
        }
    }

    // ============================================================================
    // CHART 4: VEHICLE CHART
    // ============================================================================
    const vehicleCtx = document.getElementById('vehicleChart');
    if (vehicleCtx) {
        console.log('üé® Creating Vehicle Chart...');
        try {
            vehicleChart = new Chart(vehicleCtx, {
                type: 'bar',
                data: {
                    labels: vehicleLabels,
                    datasets: [{
                        label: 'Accidents by Vehicle Type',
                        data: vehicleData,
                        backgroundColor: '#003087'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            window.charts.vehicleChart = vehicleChart;
            console.log('‚úÖ Vehicle Chart created successfully');
        } catch (error) {
            console.error('‚ùå Vehicle Chart error:', error);
        }
    }

    // ============================================================================
    // CHART 5: DAY OF WEEK CHART
    // ============================================================================
    const dowCtx = document.getElementById('dowChart');
    if (dowCtx) {
        console.log('üé® Creating Day of Week Chart...');
        try {
            dowChart = new Chart(dowCtx, {
                type: 'bar',
                data: {
                    labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                    datasets: [{
                        label: 'Accidents by Day',
                        data: dowData,
                        backgroundColor: '#003087'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            window.charts.dowChart = dowChart;
            console.log('‚úÖ Day of Week Chart created successfully');
        } catch (error) {
            console.error('‚ùå Day of Week Chart error:', error);
        }
    }

    // ============================================================================
    // CHART 6: COMPARISON CHART
    // ============================================================================
    const comparisonCtx = document.getElementById('comparisonChart');
    if (comparisonCtx) {
        console.log('üé® Creating Comparison Chart...');
        try {
            const lastSix = trendLabels.slice(-6);
            const lastSixData = trendTotal.slice(-6);
            
            comparisonChart = new Chart(comparisonCtx, {
                type: 'line',
                data: {
                    labels: lastSix,
                    datasets: [{
                        label: 'Current Period',
                        data: lastSixData,
                        borderColor: '#003087',
                        backgroundColor: 'rgba(0, 48, 135, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            window.charts.comparisonChart = comparisonChart;
            console.log('‚úÖ Comparison Chart created successfully');
        } catch (error) {
            console.error('‚ùå Comparison Chart error:', error);
        }
    }

    // ============================================================================
    // CHART 7: FORECAST CHART
    // ============================================================================
    const forecastCtx = document.getElementById('forecastChart');
    if (forecastCtx) {
        console.log('üé® Creating Forecast Chart...');
        try {
            const predictedValue = {{ predicted_next_month }};
            const lastFive = trendLabels.slice(-5);
            const lastFiveData = trendTotal.slice(-5);
            
            forecastChart = new Chart(forecastCtx, {
                type: 'line',
                data: {
                    labels: [...lastFive, 'Next Period'],
                    datasets: [{
                        label: 'Historical',
                        data: [...lastFiveData, null],
                        borderColor: '#003087',
                        borderDash: [5, 5],
                        tension: 0.4
                    }, {
                        label: 'Forecast',
                        data: [null, null, null, null, lastFiveData[lastFiveData.length - 1], predictedValue],
                        borderColor: '#DC143C',
                        backgroundColor: 'rgba(220, 20, 60, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            window.charts.forecastChart = forecastChart;
            console.log('‚úÖ Forecast Chart created successfully');
        } catch (error) {
            console.error('‚ùå Forecast Chart error:', error);
        }
    }

    // ============================================================================
    // CHART 8: PROVINCE COMPARISON CHART (STACKED BAR)
    // ============================================================================
    const provinceCompCtx = document.getElementById('provinceComparisonChart');
    if (provinceCompCtx) {
        console.log('üé® Creating Province Comparison Chart...');
        try {
            provinceComparisonChart = new Chart(provinceCompCtx, {
                type: 'bar',
                data: {
                    labels: provinceLabels,
                    datasets: [
                        {
                            label: 'Fatal Accidents',
                            data: provinceFatal,
                            backgroundColor: '#DC143C',
                            borderColor: '#DC143C',
                            borderWidth: 1
                        },
                        {
                            label: 'Injury Accidents',
                            data: provinceInjury,
                            backgroundColor: '#FFA500',
                            borderColor: '#FFA500',
                            borderWidth: 1
                        },
                        {
                            label: 'Property Damage Only',
                            data: provinceLabels.map((_, i) => Math.max(0, provinceTotal[i] - provinceFatal[i] - provinceInjury[i])),
                            backgroundColor: '#003087',
                            borderColor: '#003087',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            window.charts.provinceComparisonChart = provinceComparisonChart;
            console.log('‚úÖ Province Comparison Chart created successfully');
        } catch (error) {
            console.error('‚ùå Province Comparison Chart error:', error);
        }
    }

    // ============================================================================
    // CHART 9: INCIDENT TYPE CHART (HORIZONTAL BAR)
    // ============================================================================
    const incidentTypeCtx = document.getElementById('incidentTypeChart');
    if (incidentTypeCtx) {
        console.log('üé® Creating Incident Type Chart...');
        try {
            incidentTypeChart = new Chart(incidentTypeCtx, {
                type: 'bar',
                data: {
                    labels: incidentLabels,
                    datasets: [{
                        label: 'Accidents',
                        data: incidentData,
                        backgroundColor: [
                            '#DC143C',
                            '#FF6B6B',
                            '#FFA500',
                            '#FFD700',
                            '#003087'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
            window.charts.incidentTypeChart = incidentTypeChart;
            console.log('‚úÖ Incident Type Chart created successfully');
        } catch (error) {
            console.error('‚ùå Incident Type Chart error:', error);
        }
    }

    // ============================================================================
    // CHART 10: TREND COMPARISON CHART (MULTI-LINE)
    // ============================================================================
    const trendCompCtx = document.getElementById('trendComparisonChart');
    if (trendCompCtx) {
        console.log('üé® Creating Trend Comparison Chart...');
        try {
            trendComparisonChart = new Chart(trendCompCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [
                        {
                            label: 'Total Accidents',
                            data: trendTotal,
                            borderColor: '#003087',
                            backgroundColor: 'rgba(0, 48, 135, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: 'Fatal',
                            data: trendFatal,
                            borderColor: '#DC143C',
                            backgroundColor: 'rgba(220, 20, 60, 0.1)',
                            tension: 0.4,
                            fill: false,
                            borderWidth: 2,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Injury',
                            data: trendInjury,
                            borderColor: '#FFA500',
                            backgroundColor: 'rgba(255, 165, 0, 0.1)',
                            tension: 0.4,
                            fill: false,
                            borderWidth: 2,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            window.charts.trendComparisonChart = trendComparisonChart;
            console.log('‚úÖ Trend Comparison Chart created successfully');
        } catch (error) {
            console.error('‚ùå Trend Comparison Chart error:', error);
        }
    }

    console.log('‚úÖ ALL CHARTS INITIALIZED SUCCESSFULLY');
}

    function loadPredictiveInsights() {
        console.log('üîÆ Loading predictive insights...');
        
        setTimeout(() => {
            try {
                // Calculate average monthly
                const totalAccidents = {{ total_accidents }};
                const avgMonthly = Math.round(totalAccidents / 12);
                const avgElement = document.getElementById('avgMonthly');
                
                if (avgElement) {
                    avgElement.textContent = isNaN(avgMonthly) || avgMonthly === 0 ? '--' : avgMonthly;
                    console.log('‚úÖ Average monthly calculated:', avgMonthly);
                }
            } catch (error) {
                console.error('‚ùå Error calculating insights:', error);
            }
        }, 500);
    }

    // ============================================================================
    // FILTER FUNCTIONS
    // ============================================================================
    function updateCharts() {
    console.log('üîÑ Updating charts with filters...');

    // Get current filter values
    const analysisType = document.getElementById('analysisType').value;
    const timeGranularity = document.getElementById('timeGranularity').value;
    const severityFilter = document.getElementById('severityFilter').value;
    const provinceFilter = document.getElementById('provinceFilter').value;

    // Get current date range
    const fromDate = document.querySelector('input[name="from_date"]')?.value || '';
    const toDate = document.querySelector('input[name="to_date"]')?.value || '';

    console.log('üìä Applied Filters:', {
        analysisType,
        timeGranularity,
        severityFilter,
        provinceFilter,
        fromDate,
        toDate
    });

    // Build URL with all parameters
    const params = new URLSearchParams();

    // Add filters
    if (analysisType && analysisType !== 'overview') {
        params.append('analysis_type', analysisType);
    }

    if (timeGranularity && timeGranularity !== 'monthly') {
        params.append('granularity', timeGranularity);
    }

    if (severityFilter && severityFilter !== 'all') {
        params.append('severity', severityFilter);
    }

    if (provinceFilter && provinceFilter !== 'all') {
        params.append('province', provinceFilter);
    }

    // Add date range
    if (fromDate) {
        params.append('from_date', fromDate);
    }

    if (toDate) {
        params.append('to_date', toDate);
    }

    // Reload page with filters and scroll to filter controls
    const newUrl = window.location.pathname + '?' + params.toString() + '#filter-controls';
    console.log('üîó Navigating to:', newUrl);
    window.location.href = newUrl;
}

    function showLoadingOverlay() {
        // Create loading overlay if it doesn't exist
        let overlay = document.getElementById('filterLoadingOverlay');

        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'filterLoadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            overlay.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,0.2);">
                    <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 1rem; border: 3px solid #E5E7EB; border-top: 3px solid var(--analytics-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin: 0; color: #374151; font-weight: 500;">Updating analytics...</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        overlay.style.display = 'flex';
    }

    function displayActiveFilters() {
        const params = new URLSearchParams(window.location.search);
        const list = document.getElementById('activeFiltersList');
        let activeFiltersHTML = '';

        // Check each filter and create dismissible tags
        if (params.get('from_date')) {
            activeFiltersHTML += `<span class="filter-tag">
                From: ${params.get('from_date')}
                <button onclick="removeFilter('from_date')" style="background: none; border: none; color: var(--analytics-primary); cursor: pointer; font-weight: 600; font-size: 1.125rem; line-height: 1; padding: 0; margin-left: 0.25rem;">√ó</button>
            </span>`;
        }

        if (params.get('to_date')) {
            activeFiltersHTML += `<span class="filter-tag">
                To: ${params.get('to_date')}
                <button onclick="removeFilter('to_date')" style="background: none; border: none; color: var(--analytics-primary); cursor: pointer; font-weight: 600; font-size: 1.125rem; line-height: 1; padding: 0; margin-left: 0.25rem;">√ó</button>
            </span>`;
        }

        if (params.get('severity') && params.get('severity') !== 'all') {
            const severityMap = {
                'fatal': 'Fatal Only',
                'injury': 'Injury Only',
                'property': 'Property Damage Only'
            };
            activeFiltersHTML += `<span class="filter-tag">
                Severity: ${severityMap[params.get('severity')] || params.get('severity')}
                <button onclick="removeFilter('severity')" style="background: none; border: none; color: var(--analytics-primary); cursor: pointer; font-weight: 600; font-size: 1.125rem; line-height: 1; padding: 0; margin-left: 0.25rem;">√ó</button>
            </span>`;
        }

        if (params.get('province') && params.get('province') !== 'all') {
            activeFiltersHTML += `<span class="filter-tag">
                Province: ${params.get('province')}
                <button onclick="removeFilter('province')" style="background: none; border: none; color: var(--analytics-primary); cursor: pointer; font-weight: 600; font-size: 1.125rem; line-height: 1; padding: 0; margin-left: 0.25rem;">√ó</button>
            </span>`;
        }

        if (params.get('granularity') && params.get('granularity') !== 'monthly') {
            const granularityMap = {
                'daily': 'Daily',
                'weekly': 'Weekly',
                'quarterly': 'Quarterly'
            };
            activeFiltersHTML += `<span class="filter-tag">
                Time: ${granularityMap[params.get('granularity')] || params.get('granularity')}
                <button onclick="removeFilter('granularity')" style="background: none; border: none; color: var(--analytics-primary); cursor: pointer; font-weight: 600; font-size: 1.125rem; line-height: 1; padding: 0; margin-left: 0.25rem;">√ó</button>
            </span>`;
        }

        if (params.get('analysis_type') && params.get('analysis_type') !== 'overview') {
            activeFiltersHTML += `<span class="filter-tag">
                Analysis: ${params.get('analysis_type')}
                <button onclick="removeFilter('analysis_type')" style="background: none; border: none; color: var(--analytics-primary); cursor: pointer; font-weight: 600; font-size: 1.125rem; line-height: 1; padding: 0; margin-left: 0.25rem;">√ó</button>
            </span>`;
        }

        // Display active filters
        if (activeFiltersHTML) {
            list.innerHTML = activeFiltersHTML;
            list.style.display = 'flex';
        } else {
            list.style.display = 'none';
        }
    }

    function removeFilter(filterName) {
        // Get current URL parameters
        const params = new URLSearchParams(window.location.search);

        // Remove the specific filter
        params.delete(filterName);

        // Clear the corresponding input field
        if (filterName === 'from_date' || filterName === 'to_date') {
            const input = document.getElementById(filterName);
            if (input) input.value = '';
        }

        // Redirect to updated URL with scroll to filter controls if filters remain
        const queryString = params.toString();
        const newUrl = window.location.pathname + (queryString ? '?' + queryString + '#filter-controls' : '');
        window.location.href = newUrl;
    }

    function clearAllFilters() {
        console.log('üóëÔ∏è Clearing all filters...');

        // Redirect to base URL without any parameters
        window.location.href = window.location.pathname;
    }

    // ============================================================================
    // EXPORT FUNCTIONS
    // ============================================================================
    function exportChart(chartId, filename) {
        const chart = window.charts[chartId];
        if (!chart) {
            alert('Chart not available for export. Please wait for charts to load.');
            console.error('‚ùå Chart not found:', chartId, 'Available charts:', Object.keys(window.charts));
            return;
        }

        try {
            // Get the original canvas
            const originalCanvas = chart.canvas;

            // Create HD canvas (3x resolution for high quality)
            const scale = 3;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = originalCanvas.width * scale;
            tempCanvas.height = originalCanvas.height * scale;
            const ctx = tempCanvas.getContext('2d');

            // Enable high quality rendering
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // Fill with white background
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            // Scale and draw the chart on top of white background
            ctx.scale(scale, scale);
            ctx.drawImage(originalCanvas, 0, 0);

            // Export as HD PNG
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().split('T')[0];
            link.download = `${filename || chartId}_${timestamp}_HD.png`;
            link.href = tempCanvas.toDataURL('image/png', 1.0);
            link.click();

            console.log(`‚úÖ Exported HD chart (${tempCanvas.width}x${tempCanvas.height}): ${filename || chartId}`);
        } catch (error) {
            console.error('‚ùå Error exporting chart:', error);
            alert('Error exporting chart. Please try again.');
        }
    }

    function exportAnalytics() {
        console.log('üìä Exporting analytics data...');
        
        const csvData = [];
        
        // Header
        csvData.push(['ANALYTICS SUMMARY REPORT']);
        csvData.push(['Generated', new Date().toLocaleString()]);
        csvData.push(['Date Range', '{{ from_date }}', 'to', '{{ to_date }}']);
        csvData.push([]);
        
        // Summary Statistics
        csvData.push(['SUMMARY STATISTICS']);
        csvData.push(['Total Accidents', '{{ total_accidents }}']);
        csvData.push(['Fatal Accidents', '{{ fatal_count }}']);
        csvData.push(['Injury Accidents', '{{ injury_count }}']);
        csvData.push(['Fatality Rate', '{{ fatality_rate|floatformat:1 }}%']);
        csvData.push(['Risk Level', '{{ risk_level }}']);
        csvData.push(['Peak Hours', '{{ peak_hours }}']);
        csvData.push([]);
        
        // Severity by Location
        csvData.push(['TOP MUNICIPALITIES BY SEVERITY']);
        csvData.push(['Rank', 'Municipality', 'Province', 'Total', 'Fatal', 'Injury', 'Fatality Rate']);
        
        {% for loc in severity_locations %}
        csvData.push([
            '{{ forloop.counter }}',
            '{{ loc.municipal }}',
            '{{ loc.province }}',
            '{{ loc.total }}',
            '{{ loc.killed }}',
            '{{ loc.injured }}',
            '{% widthratio loc.killed loc.total 100 %}%'
        ]);
        {% endfor %}
        
        // Convert to CSV string
        const csvContent = csvData.map(row => 
            row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
        ).join('\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `analytics_report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('‚úÖ CSV exported successfully');
    }

    function exportAsExcelRegular() {
        console.log('üìä Exporting analytics data as Excel...');

        const timestamp = new Date().toISOString().split('T')[0];

        // Create workbook
        const wb = XLSX.utils.book_new();

        // Summary Sheet
        const summaryData = [
            ['AGNES HOTSPOT DETECTION SYSTEM'],
            ['ANALYTICS SUMMARY REPORT'],
            [''],
            ['Generated:', new Date().toLocaleString()],
            ['Date Range:', '{{ from_date }} to {{ to_date }}'],
            [''],
            ['SUMMARY STATISTICS'],
            ['Metric', 'Value'],
            ['Total Accidents', {{ total_accidents }}],
            ['Fatal Accidents', {{ fatal_count }}],
            ['Injury Accidents', {{ injury_count }}],
            ['Fatality Rate', '{{ fatality_rate|floatformat:1 }}%'],
            ['Risk Level', '{{ risk_level }}'],
            ['Peak Hours', '{{ peak_hours }}'],
            [''],
            ['TOP MUNICIPALITIES BY SEVERITY'],
            ['Rank', 'Municipality', 'Province', 'Total', 'Fatal', 'Injury', 'Fatality Rate'],
            {% for loc in severity_locations %}
            [{{ forloop.counter }}, '{{ loc.municipal }}', '{{ loc.province }}', {{ loc.total }}, {{ loc.killed }}, {{ loc.injured }}, '{% widthratio loc.killed loc.total 100 %}%'],
            {% endfor %}
        ];

        const ws = XLSX.utils.aoa_to_sheet(summaryData);

        // Set column widths
        ws['!cols'] = [{ wch: 25 }, { wch: 30 }, { wch: 20 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 15 }];

        XLSX.utils.book_append_sheet(wb, ws, 'Analytics Summary');

        // Download
        XLSX.writeFile(wb, `analytics_report_${timestamp}.xlsx`);

        console.log('‚úÖ Excel exported successfully');
    }

function generateSummaryReport() {
    console.log('üìã Generating summary report...');
    
    try {
        // Calculate property damage in JavaScript
        const totalAccidents = {{ total_accidents }};
        const fatalCount = {{ fatal_count }};
        const injuryCount = {{ injury_count }};
        const propertyDamage = totalAccidents - fatalCount - injuryCount;
        
        const reportContent = `
AGNES HOTSPOT DETECTION SYSTEM
ANALYTICS SUMMARY REPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Generated: ${new Date().toLocaleString()}
Date Range: {{ from_date }} to {{ to_date }}

SUMMARY STATISTICS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total Accidents:        ${totalAccidents}
Fatal Accidents:        ${fatalCount}
Injury Accidents:       ${injuryCount}
Property Damage:        ${propertyDamage}
Fatality Rate:          {{ fatality_rate|floatformat:1 }}%

PREDICTIVE INSIGHTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Risk Level:             {{ risk_level }}
Predicted Next Month:   {{ predicted_next_month }} accidents
Trend Direction:        {{ trend_direction|upper }}
Trend Change:           {{ trend_percentage }}%
Peak Hours:             {{ peak_hours }}

ACTIVE FILTERS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Severity Filter:        {{ current_severity_filter|default:"All" }}
Province Filter:        {{ current_province_filter|default:"All" }}
Time Granularity:       {{ current_time_granularity|default:"Monthly" }}
Analysis Type:          {{ current_analysis_type|default:"Overview" }}

TOP MUNICIPALITIES BY SEVERITY
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{% for loc in severity_locations %}{{ forloop.counter }}. {{ loc.municipal }}, {{ loc.province }}
   Total: {{ loc.total }} | Fatal: {{ loc.killed }} | Injured: {{ loc.injured }}
{% endfor %}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Report generated by AGNES Hotspot Detection System
Philippine National Police - Caraga Region
        `;
        
        // Create text file download
        const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `analytics_summary_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('‚úÖ Summary report generated successfully');
    } catch (error) {
        console.error('‚ùå Error generating report:', error);
        alert('Error generating report. Check console for details.');
    }
}

// Make filters sticky when scrolling
window.addEventListener('scroll', function() {
    const controls = document.querySelector('.analytics-controls');
    if (controls) {
        if (window.scrollY > 200) {
            controls.classList.add('scrolled');
        } else {
            controls.classList.remove('scrolled');
        }
    }
});

// Chart Modal Functions
let modalChartInstance = null;
let currentModalChartTitle = '';

function expandChart(chartId, chartTitle) {
    const modal = document.getElementById('chartModal');
    const modalTitle = document.getElementById('modalChartTitle');
    const modalCanvas = document.getElementById('modalChart');

    // Set title and store for export
    modalTitle.textContent = chartTitle;
    currentModalChartTitle = chartTitle;

    // Show modal with animation
    modal.classList.add('show');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling

    // Get the original chart instance
    const originalChart = window.charts[chartId];

    if (!originalChart) {
        console.error('Chart not found:', chartId);
        return;
    }

    // Destroy previous modal chart if exists
    if (modalChartInstance) {
        modalChartInstance.destroy();
    }

    // Clone the chart configuration
    const config = {
        type: originalChart.config.type,
        data: JSON.parse(JSON.stringify(originalChart.config.data)),
        options: JSON.parse(JSON.stringify(originalChart.config.options))
    };

    // Enhance options for larger view
    if (config.options) {
        config.options.maintainAspectRatio = false;
        config.options.responsive = true;
        if (config.options.plugins) {
            if (config.options.plugins.legend) {
                config.options.plugins.legend.labels = config.options.plugins.legend.labels || {};
                config.options.plugins.legend.labels.font = { size: 14 };
            }
            if (config.options.plugins.title) {
                config.options.plugins.title.font = { size: 18, weight: 'bold' };
            }
        }
        if (config.options.scales) {
            Object.keys(config.options.scales).forEach(scale => {
                if (config.options.scales[scale].ticks) {
                    config.options.scales[scale].ticks.font = { size: 12 };
                }
            });
        }
    }

    // Create new chart in modal
    setTimeout(() => {
        const ctx = modalCanvas.getContext('2d');
        modalChartInstance = new Chart(ctx, config);
    }, 100);
}

function closeChartModal() {
    const modal = document.getElementById('chartModal');

    // Hide modal with animation
    modal.classList.remove('show');
    document.body.style.overflow = ''; // Restore scrolling

    // Destroy modal chart
    if (modalChartInstance) {
        modalChartInstance.destroy();
        modalChartInstance = null;
    }
}

function exportModalChart() {
    if (!modalChartInstance) {
        alert('No chart available to export');
        return;
    }

    try {
        // Get the modal canvas
        const originalCanvas = modalChartInstance.canvas;

        // Create HD canvas (3x resolution for high quality)
        const scale = 3;
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = originalCanvas.width * scale;
        tempCanvas.height = originalCanvas.height * scale;
        const ctx = tempCanvas.getContext('2d');

        // Enable high quality rendering
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        // Fill with white background
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

        // Scale and draw the chart on top of white background
        ctx.scale(scale, scale);
        ctx.drawImage(originalCanvas, 0, 0);

        // Export as HD PNG
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().split('T')[0];
        const filename = currentModalChartTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        link.download = `${filename}_${timestamp}_HD.png`;
        link.href = tempCanvas.toDataURL('image/png', 1.0);
        link.click();

        console.log(`‚úÖ Exported modal chart (${tempCanvas.width}x${tempCanvas.height}): ${filename}`);
    } catch (error) {
        console.error('‚ùå Error exporting modal chart:', error);
        alert('Error exporting chart. Please try again.');
    }
}

// Filter Help Modal Functions
function openFilterHelp() {
    const modal = document.getElementById('filterHelpModal');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeFilterHelp() {
    const modal = document.getElementById('filterHelpModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

// Date Selection Modal Variables
let currentEditingDate = 'from'; // 'from' or 'to'
let tempFromDate = null;
let tempToDate = null;
let currentCalendarMonth = new Date().getMonth();
let currentCalendarYear = new Date().getFullYear();

// Date Selection Modal Functions
function openDateModal(dateType = 'from') {
    const modal = document.getElementById('dateModal');
    currentEditingDate = dateType;

    // Load current values
    const fromDate = document.getElementById('from_date').value;
    const toDate = document.getElementById('to_date').value;

    tempFromDate = fromDate ? new Date(fromDate) : null;
    tempToDate = toDate ? new Date(toDate) : null;

    // Update tab display
    updateTabDisplay();

    // Set active tab
    switchDateTab(dateType);

    // Initialize calendar
    const now = new Date();
    currentCalendarMonth = now.getMonth();
    currentCalendarYear = now.getFullYear();

    // Populate year dropdown
    populateYearDropdown();

    // Render calendar
    renderCalendar();

    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeDateModal() {
    const modal = document.getElementById('dateModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

function switchDateTab(dateType) {
    currentEditingDate = dateType;

    // Update tab styling
    document.getElementById('fromTab').classList.toggle('active', dateType === 'from');
    document.getElementById('toTab').classList.toggle('active', dateType === 'to');

    // Re-render calendar to show correct selection
    renderCalendar();
}

function updateTabDisplay() {
    const fromTabValue = document.getElementById('fromTabValue');
    const toTabValue = document.getElementById('toTabValue');

    fromTabValue.textContent = tempFromDate ? formatDate(tempFromDate) : 'Not set';
    toTabValue.textContent = tempToDate ? formatDate(tempToDate) : 'Not set';
}

function formatDate(date) {
    if (!date) return '';
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function formatDisplayDate(date) {
    if (!date) return '';
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
}

function populateYearDropdown() {
    const yearSelect = document.getElementById('calendarYear');
    yearSelect.innerHTML = '';

    const currentYear = new Date().getFullYear();
    for (let year = currentYear - 10; year <= currentYear + 5; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentCalendarYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
}

function renderCalendar() {
    const monthSelect = document.getElementById('calendarMonth');
    const yearSelect = document.getElementById('calendarYear');

    currentCalendarMonth = parseInt(monthSelect.value);
    currentCalendarYear = parseInt(yearSelect.value);

    const daysContainer = document.getElementById('calendarDays');
    daysContainer.innerHTML = '';

    // Get first day of month
    const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
    const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
    const prevLastDay = new Date(currentCalendarYear, currentCalendarMonth, 0);

    const firstDayOfWeek = firstDay.getDay();
    const daysInMonth = lastDay.getDate();
    const daysInPrevMonth = prevLastDay.getDate();

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Previous month days
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const dayElement = createDayElement(day, true);
        daysContainer.appendChild(dayElement);
    }

    // Current month days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDate = new Date(currentCalendarYear, currentCalendarMonth, day);
        const dayElement = createDayElement(day, false, dayDate);
        daysContainer.appendChild(dayElement);
    }

    // Next month days to fill grid
    const totalCells = daysContainer.children.length;
    const remainingCells = 42 - totalCells; // 6 rows * 7 days
    for (let day = 1; day <= remainingCells; day++) {
        const dayElement = createDayElement(day, true);
        daysContainer.appendChild(dayElement);
    }
}

function createDayElement(day, isOtherMonth, fullDate = null) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    dayElement.textContent = day;

    if (isOtherMonth) {
        dayElement.classList.add('other-month');
        return dayElement;
    }

    if (fullDate) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Check if today
        if (fullDate.getTime() === today.getTime()) {
            dayElement.classList.add('today');
        }

        // Check if selected
        const selectedDate = currentEditingDate === 'from' ? tempFromDate : tempToDate;
        if (selectedDate) {
            const selected = new Date(selectedDate);
            selected.setHours(0, 0, 0, 0);
            if (fullDate.getTime() === selected.getTime()) {
                dayElement.classList.add('selected');
            }
        }

        // Add click handler
        dayElement.addEventListener('click', () => selectDate(fullDate));
    }

    return dayElement;
}

function selectDate(date) {
    if (currentEditingDate === 'from') {
        tempFromDate = date;
    } else {
        tempToDate = date;
    }

    updateTabDisplay();
    renderCalendar();
}

function changeMonth(delta) {
    currentCalendarMonth += delta;

    if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
    } else if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
    }

    document.getElementById('calendarMonth').value = currentCalendarMonth;
    document.getElementById('calendarYear').value = currentCalendarYear;

    renderCalendar();
}

function setToday() {
    selectDate(new Date());
}

function setThisMonth() {
    const now = new Date();
    if (currentEditingDate === 'from') {
        tempFromDate = new Date(now.getFullYear(), now.getMonth(), 1);
    } else {
        tempToDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    }
    updateTabDisplay();
    renderCalendar();
}

function setThisYear() {
    const now = new Date();
    if (currentEditingDate === 'from') {
        tempFromDate = new Date(now.getFullYear(), 0, 1);
    } else {
        tempToDate = new Date(now.getFullYear(), 11, 31);
    }
    updateTabDisplay();
    renderCalendar();
}

function clearCurrentDate() {
    if (currentEditingDate === 'from') {
        tempFromDate = null;
    } else {
        tempToDate = null;
    }
    updateTabDisplay();
    renderCalendar();
}

function clearAllDates() {
    tempFromDate = null;
    tempToDate = null;
    updateTabDisplay();
    renderCalendar();
}

function applyDates() {
    // Update hidden inputs
    document.getElementById('from_date').value = tempFromDate ? formatDate(tempFromDate) : '';
    document.getElementById('to_date').value = tempToDate ? formatDate(tempToDate) : '';

    // Update display inputs
    document.getElementById('from_date_display').value = tempFromDate ? formatDisplayDate(tempFromDate) : '';
    document.getElementById('to_date_display').value = tempToDate ? formatDisplayDate(tempToDate) : '';

    // Close modal
    closeDateModal();

    // Update charts
    updateCharts();
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeChartModal();
        closeFilterHelp();
        closeDateModal();
    }
});

// Close chart modal on background click
document.getElementById('chartModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeChartModal();
    }
});

// Close filter help modal on background click
document.getElementById('filterHelpModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeFilterHelp();
    }
});

// Close date modal on background click
document.getElementById('dateModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeDateModal();
    }
});
</script>
{% endblock %}