{% extends 'base.html' %}
{% load static %}

{% block title %}Advanced Analytics - AGNES Hotspot Detection{% endblock %}

{% block extra_css %}
<style>
    .analytics-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .analytics-header {
        border-bottom: 3px solid #4CAF50;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }

    .metric-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        text-align: center;
    }

    .metric-box.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .metric-box.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .metric-box.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .metric-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 5px;
    }

    .metric-value {
        font-size: 32px;
        font-weight: bold;
    }

    .metric-unit {
        font-size: 16px;
        opacity: 0.8;
    }

    .stat-row {
        border-bottom: 1px solid #eee;
        padding: 10px 0;
    }

    .stat-row:last-child {
        border-bottom: none;
    }

    .stat-label {
        font-weight: 600;
        color: #555;
    }

    .stat-value {
        float: right;
        color: #333;
        font-weight: 500;
    }

    .badge-critical { background: #f44336; color: white; padding: 4px 12px; border-radius: 12px; }
    .badge-high { background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; }
    .badge-moderate { background: #2196F3; color: white; padding: 4px 12px; border-radius: 12px; }
    .badge-low { background: #4CAF50; color: white; padding: 4px 12px; border-radius: 12px; }

    .trend-up {
        color: #f44336;
    }

    .trend-down {
        color: #4CAF50;
    }

    .filter-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 24px;
        font-weight: 700;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }

    .section-icon {
        margin-right: 10px;
        font-size: 28px;
    }

    .mode-toggle-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .mode-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: 600;
        backdrop-filter: blur(10px);
    }

    .mode-badge.active {
        background: white;
        color: #667eea;
    }

    .loading-placeholder {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #ffc107;
        margin: 10px 0;
    }

    .switch-mode-btn {
        background: white;
        color: #667eea;
        border: none;
        padding: 10px 25px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .switch-mode-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    table.analytics-table {
        width: 100%;
        border-collapse: collapse;
    }

    table.analytics-table th {
        background: #667eea;
        color: white;
        padding: 12px;
        text-align: left;
    }

    table.analytics-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #eee;
    }

    table.analytics-table tr:hover {
        background: #f5f5f5;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .mode-toggle-section {
            flex-direction: column;
            gap: 15px;
        }

        .mode-toggle-section > div {
            width: 100%;
        }

        .switch-mode-btn {
            width: 100%;
        }

        .metric-box {
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 24px;
        }

        .section-title {
            font-size: 18px;
        }

        .analytics-table {
            font-size: 12px;
        }

        .analytics-table th,
        .analytics-table td {
            padding: 8px 6px;
        }

        .stat-row {
            flex-direction: column;
            align-items: flex-start !important;
        }

        .stat-value {
            float: none;
            margin-top: 5px;
        }

        .filter-section .row {
            gap: 10px;
        }

        h1 {
            font-size: 24px;
        }
    }

    @media (max-width: 480px) {
        .metric-value {
            font-size: 20px;
        }

        .section-title {
            font-size: 16px;
        }

        .mode-badge {
            padding: 6px 12px;
            font-size: 12px;
        }
    }

    /* Export Button Enhancements */
    .export-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .export-btn {
        flex: 1;
        min-width: 120px;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }

    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .export-btn.csv {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }

    .export-btn.excel {
        background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
        color: white;
    }

    .export-btn.pdf {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    @media (max-width: 768px) {
        .export-buttons {
            flex-direction: column;
        }

        .export-btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-chart-line"></i> Advanced Analytics Dashboard
            </h1>

            <!-- Mode Toggle Section -->
            <div class="mode-toggle-section">
                <div>
                    <h4 class="mb-2"><i class="fas fa-bolt"></i> Analysis Mode</h4>
                    <p class="mb-0" style="opacity: 0.9; font-size: 14px;">
                        {% if simple_mode %}
                        <span class="mode-badge active">‚ö° FAST MODE</span>
                        <span class="mode-badge">üî¨ FULL MODE</span>
                        <br><small>Currently showing essential metrics (loads in &lt;2 seconds)</small>
                        {% else %}
                        <span class="mode-badge">‚ö° FAST MODE</span>
                        <span class="mode-badge active">üî¨ FULL MODE</span>
                        <br><small>Complete statistical analysis with all tests enabled</small>
                        {% endif %}
                    </p>
                </div>
                <div>
                    {% if simple_mode %}
                    <button class="switch-mode-btn" onclick="switchToFullMode()">
                        <i class="fas fa-microscope"></i> Load Full Analysis
                    </button>
                    {% else %}
                    <button class="switch-mode-btn" onclick="switchToFastMode()">
                        <i class="fas fa-bolt"></i> Switch to Fast Mode
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Filter Section -->
            <div class="filter-section">
                <form method="GET" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Province</label>
                        <select name="province" class="form-control">
                            <option value="all" {% if current_province == 'all' %}selected{% endif %}>All Provinces</option>
                            {% for province in provinces %}
                            <option value="{{ province }}" {% if current_province == province %}selected{% endif %}>{{ province }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date From</label>
                        <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date To</label>
                        <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                    </div>
                </form>
            </div>

            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-box">
                        <div class="metric-label">Total Accidents Analyzed</div>
                        <div class="metric-value">{{ total_accidents|default:0 }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box info">
                        <div class="metric-label">Hotspot Concentration</div>
                        <div class="metric-value">
                            {{ analytics.spatial_analysis.hotspot_effectiveness.hotspot_percentage|default:0 }}
                            <span class="metric-unit">%</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box warning">
                        <div class="metric-label">Severity Index</div>
                        <div class="metric-value">{{ analytics.severity_analysis.severity_index.severity_index|default:0 }}</div>
                        <div class="metric-unit">{{ analytics.severity_analysis.severity_index.severity_category|default:"N/A" }}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-box success">
                        <div class="metric-label">Trend Confidence</div>
                        <div class="metric-value">
                            {{ analytics.predictive_analysis.trend.confidence_percentage|default:0 }}
                            <span class="metric-unit">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Spatial Analysis Section -->
    <div class="row">
        <div class="col-md-6">
            <div class="analytics-card">
                <div class="section-title">
                    <span class="section-icon">üó∫Ô∏è</span>
                    Spatial Analysis
                </div>

                <h5>Hotspot Effectiveness</h5>
                {% with hotspot=analytics.spatial_analysis.hotspot_effectiveness %}
                <div class="stat-row">
                    <span class="stat-label">Hotspot Accidents:</span>
                    <span class="stat-value">{{ hotspot.hotspot_accidents|default:0 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Non-Hotspot Accidents:</span>
                    <span class="stat-value">{{ hotspot.non_hotspot_accidents|default:0 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Concentration Ratio:</span>
                    <span class="stat-value">{{ hotspot.hotspot_concentration_ratio|default:0 }}:1</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Hotspot Fatality Rate:</span>
                    <span class="stat-value">{{ hotspot.hotspot_fatality_rate|default:0 }}%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Severity Differential:</span>
                    <span class="stat-value {% if hotspot.severity_differential > 0 %}trend-up{% else %}trend-down{% endif %}">
                        {{ hotspot.severity_differential|default:0 }}%
                    </span>
                </div>
                {% endwith %}

                <hr>

                <h5>Spatial Concentration</h5>
                {% with spatial=analytics.spatial_analysis.spatial_concentration %}
                {% if spatial.concentration_level == 'Loading...' %}
                <div class="loading-placeholder">
                    <i class="fas fa-info-circle"></i> <strong>Advanced metric:</strong>
                    This metric requires full analysis mode.
                    <a href="?simple=false{% if current_province != 'all' %}&province={{ current_province }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                        Load Full Analysis
                    </a> to view Gini coefficient and spatial concentration.
                </div>
                {% else %}
                <div class="stat-row">
                    <span class="stat-label">Gini Coefficient:</span>
                    <span class="stat-value">{{ spatial.gini_coefficient|default:0 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Concentration Level:</span>
                    <span class="stat-value">
                        <span class="badge-{{ spatial.concentration_level|lower }}">{{ spatial.concentration_level|default:"N/A" }}</span>
                    </span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Top 10 Municipalities:</span>
                    <span class="stat-value">{{ spatial.top_10_percentage|default:0 }}% of accidents</span>
                </div>
                {% endif %}
                {% endwith %}
            </div>
        </div>

        <div class="col-md-6">
            <div class="analytics-card">
                <div class="section-title">
                    <span class="section-icon">üïê</span>
                    Temporal Analysis
                </div>

                <h5>Rush Hour Analysis</h5>
                {% with rush=analytics.temporal_analysis.rush_hour %}
                <div class="stat-row">
                    <span class="stat-label">Rush Hour Accidents:</span>
                    <span class="stat-value">{{ rush.rush_hour_accidents|default:0 }} ({{ rush.rush_hour_percentage|default:0 }}%)</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Risk Multiplier:</span>
                    <span class="stat-value">{{ rush.rush_hour_risk_multiplier|default:1 }}x</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">High Risk Period:</span>
                    <span class="stat-value">
                        {% if rush.is_rush_hour_high_risk %}
                        <span class="badge-high">Yes - Rush Hour</span>
                        {% else %}
                        <span class="badge-low">No</span>
                        {% endif %}
                    </span>
                </div>
                {% endwith %}

                <hr>

                <h5>Weekend vs Weekday</h5>
                {% with weekend=analytics.temporal_analysis.weekend_vs_weekday %}
                {% if weekend.higher_risk_period == 'Loading...' %}
                <div class="loading-placeholder">
                    <i class="fas fa-info-circle"></i> <strong>Advanced metric:</strong>
                    Weekend vs weekday analysis available in full mode.
                </div>
                {% else %}
                <div class="stat-row">
                    <span class="stat-label">Weekday Daily Avg:</span>
                    <span class="stat-value">{{ weekend.weekday_daily_average|default:0 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Weekend Daily Avg:</span>
                    <span class="stat-value">{{ weekend.weekend_daily_average|default:0 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Weekend Risk Ratio:</span>
                    <span class="stat-value">{{ weekend.weekend_risk_ratio|default:0 }}x</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Higher Risk Period:</span>
                    <span class="stat-value">
                        <strong>{{ weekend.higher_risk_period|default:"Unknown" }}</strong>
                    </span>
                </div>
                {% endif %}
                {% endwith %}
            </div>
        </div>
    </div>

    <!-- Severity Analysis -->
    <div class="row">
        <div class="col-md-12">
            <div class="analytics-card">
                <div class="section-title">
                    <span class="section-icon">‚ö†Ô∏è</span>
                    Severity & Risk Analysis
                </div>

                <div class="row">
                    <div class="col-md-4">
                        {% with severity=analytics.severity_analysis.severity_index %}
                        <h5>Severity Breakdown</h5>
                        <div class="stat-row">
                            <span class="stat-label">Fatal Accidents:</span>
                            <span class="stat-value">{{ severity.fatal_accidents|default:0 }} ({{ severity.fatal_rate|default:0 }}%)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Injury Accidents:</span>
                            <span class="stat-value">{{ severity.injury_accidents|default:0 }} ({{ severity.injury_rate|default:0 }}%)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Property Only:</span>
                            <span class="stat-value">{{ severity.property_only_accidents|default:0 }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Casualties:</span>
                            <span class="stat-value"><strong>{{ severity.total_casualties|default:0 }}</strong></span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Casualties/Accident:</span>
                            <span class="stat-value">{{ severity.average_casualties_per_accident|default:0 }}</span>
                        </div>
                        {% endwith %}
                    </div>

                    <div class="col-md-8">
                        <h5>High-Risk Combinations</h5>
                        {% with combos=analytics.severity_analysis.high_risk_combinations.high_risk_combinations %}
                        {% if combos %}
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>Time Slot</th>
                                    <th>Location</th>
                                    <th>Accidents</th>
                                    <th>Fatal</th>
                                    <th>Risk Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for combo in combos %}
                                <tr>
                                    <td>{{ combo.time_slot }}</td>
                                    <td>{{ combo.location }}</td>
                                    <td>{{ combo.accidents }}</td>
                                    <td>{{ combo.fatal }}</td>
                                    <td><strong>{{ combo.risk_score }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p class="text-muted">No high-risk combinations identified with current filters.</p>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Predictive Analysis -->
    <div class="row">
        <div class="col-md-6">
            <div class="analytics-card">
                <div class="section-title">
                    <span class="section-icon">üìà</span>
                    Predictive Analytics
                </div>

                {% with trend=analytics.predictive_analysis.trend %}
                <h5>Trend Analysis</h5>
                <div class="stat-row">
                    <span class="stat-label">Trend Direction:</span>
                    <span class="stat-value">
                        <span class="badge-{% if trend.trend == 'INCREASING' %}high{% elif trend.trend == 'DECREASING' %}low{% else %}moderate{% endif %}">
                            {{ trend.trend|default:"UNKNOWN" }}
                        </span>
                    </span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Confidence Level:</span>
                    <span class="stat-value">{{ trend.confidence_percentage|default:0 }}%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">R¬≤ Value:</span>
                    <span class="stat-value">{{ trend.r_squared|default:0 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">P-Value:</span>
                    <span class="stat-value">{{ trend.p_value|default:"N/A" }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Statistical Significance:</span>
                    <span class="stat-value">
                        {% if trend.is_significant %}
                        <span class="badge-high">Significant</span>
                        {% else %}
                        <span class="badge-moderate">Not Significant</span>
                        {% endif %}
                    </span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Predicted Next Month:</span>
                    <span class="stat-value"><strong>{{ trend.prediction_next_month|default:0 }} accidents</strong></span>
                </div>
                {% endwith %}
            </div>
        </div>

        <div class="col-md-6">
            <div class="analytics-card">
                <div class="section-title">
                    <span class="section-icon">üîç</span>
                    Anomaly Detection
                </div>

                {% with anomalies=analytics.predictive_analysis.anomalies %}
                <div class="stat-row">
                    <span class="stat-label">Anomalies Detected:</span>
                    <span class="stat-value"><strong>{{ anomalies.anomalies_detected|default:0 }}</strong></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Mean Accidents:</span>
                    <span class="stat-value">{{ anomalies.mean|default:0 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Std Deviation:</span>
                    <span class="stat-value">{{ anomalies.std_dev|default:0 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Anomaly Threshold:</span>
                    <span class="stat-value">{{ anomalies.threshold|default:0 }}</span>
                </div>

                {% if anomalies.anomalies %}
                <hr>
                <h6>Detected Anomalies:</h6>
                {% for anomaly in anomalies.anomalies %}
                <div class="alert alert-warning">
                    <strong>{{ anomaly.month }}</strong>: {{ anomaly.count }} accidents
                    ({{ anomaly.percentage_above_normal }}% above normal, œÉ={{ anomaly.deviation }})
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}
            </div>
        </div>
    </div>

    <!-- Statistical Tests -->
    <div class="row">
        <div class="col-md-6">
            <div class="analytics-card">
                <div class="section-title">
                    <span class="section-icon">üìä</span>
                    Statistical Tests
                </div>

                <h5>Provincial Variance (ANOVA)</h5>
                {% with anova=analytics.statistical_tests.provincial_variance %}
                {% if anova.test_performed %}
                <div class="stat-row">
                    <span class="stat-label">F-Statistic:</span>
                    <span class="stat-value">{{ anova.f_statistic|default:"N/A" }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">P-Value:</span>
                    <span class="stat-value">{{ anova.p_value|default:"N/A" }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Significance:</span>
                    <span class="stat-value">
                        {% if anova.is_significant %}
                        <span class="badge-high">Significant (p < 0.05)</span>
                        {% else %}
                        <span class="badge-moderate">Not Significant</span>
                        {% endif %}
                    </span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Provinces Tested:</span>
                    <span class="stat-value">{{ anova.provinces_tested|default:0 }}</span>
                </div>
                <div class="alert alert-info mt-3">
                    {{ anova.conclusion|default:"No conclusion available" }}
                </div>
                {% else %}
                <p class="text-muted">{{ anova.reason|default:"Test could not be performed" }}</p>
                {% endif %}
                {% endwith %}
            </div>
        </div>

        <div class="col-md-6">
            <div class="analytics-card">
                <div class="section-title">
                    <span class="section-icon">üîó</span>
                    Correlation Analysis
                </div>

                <h5>Time vs Severity Correlation</h5>
                {% with corr=analytics.statistical_tests.correlations %}
                <div class="stat-row">
                    <span class="stat-label">Pearson Coefficient (r):</span>
                    <span class="stat-value">{{ corr.time_severity_correlation|default:"N/A" }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">P-Value:</span>
                    <span class="stat-value">{{ corr.p_value|default:"N/A" }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Significance:</span>
                    <span class="stat-value">
                        {% if corr.is_significant %}
                        <span class="badge-high">Significant</span>
                        {% else %}
                        <span class="badge-moderate">Not Significant</span>
                        {% endif %}
                    </span>
                </div>
                <div class="alert alert-info mt-3">
                    <strong>Interpretation:</strong> {{ corr.interpretation|default:"N/A" }}
                </div>
                {% endwith %}
            </div>
        </div>
    </div>

    <!-- Seasonal Analysis -->
    <div class="row">
        <div class="col-md-12">
            <div class="analytics-card">
                <div class="section-title">
                    <span class="section-icon">üìÖ</span>
                    Seasonal Patterns
                </div>

                {% with seasonal=analytics.temporal_analysis.seasonal %}
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="stat-row">
                            <span class="stat-label">Highest Risk Quarter:</span>
                            <span class="stat-value"><strong>{{ seasonal.highest_risk_quarter|default:"N/A" }}</strong></span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Accidents:</span>
                            <span class="stat-value">{{ seasonal.highest_risk_count|default:0 }}</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-row">
                            <span class="stat-label">Lowest Risk Quarter:</span>
                            <span class="stat-value"><strong>{{ seasonal.lowest_risk_quarter|default:"N/A" }}</strong></span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Accidents:</span>
                            <span class="stat-value">{{ seasonal.lowest_risk_count|default:0 }}</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-row">
                            <span class="stat-label">Seasonal Variation:</span>
                            <span class="stat-value">{{ seasonal.seasonal_variation|default:0 }}%</span>
                        </div>
                    </div>
                </div>

                {% if seasonal.quarterly_breakdown %}
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>Quarter</th>
                            <th>Total Accidents</th>
                            <th>Fatal Accidents</th>
                            <th>Fatality Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for quarter in seasonal.quarterly_breakdown %}
                        <tr>
                            <td><strong>{{ quarter.quarter }}</strong></td>
                            <td>{{ quarter.total }}</td>
                            <td>{{ quarter.fatal }}</td>
                            <td>{{ quarter.fatality_rate }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
                {% endwith %}
            </div>
        </div>
    </div>

    <!-- Export Section -->
    <div class="row">
        <div class="col-12">
            <div class="analytics-card">
                <div class="section-title">
                    <span class="section-icon">üì§</span>
                    Export Analytics Data
                </div>
                <p class="text-muted mb-4">Download this analytics report for further analysis or thesis documentation.</p>
                <div class="export-buttons">
                    <button class="export-btn csv" onclick="exportAsCSV()">
                        <i class="fas fa-file-csv"></i> Export as CSV
                    </button>
                    <button class="export-btn excel" onclick="exportAsExcel()">
                        <i class="fas fa-file-excel"></i> Export as Excel
                    </button>
                    <button class="export-btn pdf" onclick="exportAsPDF()">
                        <i class="fas fa-file-pdf"></i> Export as PDF
                    </button>
                    <button class="export-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
// Export as CSV
function exportAsCSV() {
    const data = {{ analytics_json|safe }};
    const timestamp = new Date().toISOString().split('T')[0];

    let csv = 'AGNES HOTSPOT DETECTION SYSTEM - ADVANCED ANALYTICS REPORT\n';
    csv += `Generated: ${new Date().toLocaleString()}\n`;
    csv += `Province: {{ current_province }}\n`;
    csv += `Total Accidents: {{ total_accidents }}\n\n`;

    // Spatial Analysis
    csv += 'SPATIAL ANALYSIS\n';
    csv += 'Metric,Value\n';
    csv += `Hotspot Accidents,${data.spatial_analysis.hotspot_effectiveness.hotspot_accidents}\n`;
    csv += `Non-Hotspot Accidents,${data.spatial_analysis.hotspot_effectiveness.non_hotspot_accidents}\n`;
    csv += `Concentration Ratio,${data.spatial_analysis.hotspot_effectiveness.hotspot_concentration_ratio}\n`;
    csv += `Hotspot Fatality Rate,${data.spatial_analysis.hotspot_effectiveness.hotspot_fatality_rate}%\n`;
    csv += '\n';

    // Severity Analysis
    csv += 'SEVERITY ANALYSIS\n';
    csv += 'Metric,Value\n';
    csv += `Fatal Accidents,${data.severity_analysis.severity_index.fatal_accidents}\n`;
    csv += `Injury Accidents,${data.severity_analysis.severity_index.injury_accidents}\n`;
    csv += `Severity Index,${data.severity_analysis.severity_index.severity_index}\n`;
    csv += `Severity Category,${data.severity_analysis.severity_index.severity_category}\n`;
    csv += '\n';

    // Predictive Analysis
    csv += 'PREDICTIVE ANALYSIS\n';
    csv += 'Metric,Value\n';
    csv += `Trend Direction,${data.predictive_analysis.trend.trend}\n`;
    csv += `Confidence,${data.predictive_analysis.trend.confidence_percentage}%\n`;
    csv += `Predicted Next Month,${data.predictive_analysis.trend.prediction_next_month}\n`;

    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `advanced_analytics_${timestamp}.csv`;
    link.click();
}

// Export as Excel
function exportAsExcel() {
    const data = {{ analytics_json|safe }};
    const timestamp = new Date().toISOString().split('T')[0];

    // Create workbook
    const wb = XLSX.utils.book_new();

    // Summary Sheet
    const summaryData = [
        ['AGNES HOTSPOT DETECTION SYSTEM'],
        ['Advanced Analytics Report'],
        [''],
        ['Generated:', new Date().toLocaleString()],
        ['Province:', '{{ current_province }}'],
        ['Total Accidents:', {{ total_accidents }}],
        [''],
        ['SPATIAL ANALYSIS'],
        ['Metric', 'Value'],
        ['Hotspot Accidents', data.spatial_analysis.hotspot_effectiveness.hotspot_accidents],
        ['Non-Hotspot Accidents', data.spatial_analysis.hotspot_effectiveness.non_hotspot_accidents],
        ['Concentration Ratio', data.spatial_analysis.hotspot_effectiveness.hotspot_concentration_ratio],
        ['Hotspot Fatality Rate', data.spatial_analysis.hotspot_effectiveness.hotspot_fatality_rate + '%'],
        [''],
        ['SEVERITY ANALYSIS'],
        ['Metric', 'Value'],
        ['Fatal Accidents', data.severity_analysis.severity_index.fatal_accidents],
        ['Injury Accidents', data.severity_analysis.severity_index.injury_accidents],
        ['Severity Index', data.severity_analysis.severity_index.severity_index],
        ['Severity Category', data.severity_analysis.severity_index.severity_category],
        [''],
        ['PREDICTIVE ANALYSIS'],
        ['Metric', 'Value'],
        ['Trend Direction', data.predictive_analysis.trend.trend],
        ['Confidence', data.predictive_analysis.trend.confidence_percentage + '%'],
        ['R¬≤ Value', data.predictive_analysis.trend.r_squared],
        ['Predicted Next Month', data.predictive_analysis.trend.prediction_next_month],
    ];

    const ws = XLSX.utils.aoa_to_sheet(summaryData);

    // Set column widths
    ws['!cols'] = [{ wch: 30 }, { wch: 20 }];

    XLSX.utils.book_append_sheet(wb, ws, 'Analytics Summary');

    // Download
    XLSX.writeFile(wb, `advanced_analytics_${timestamp}.xlsx`);
}

// Export as PDF
function exportAsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const data = {{ analytics_json|safe }};
    const timestamp = new Date().toLocaleString();

    // Title
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('AGNES HOTSPOT DETECTION SYSTEM', 105, 20, { align: 'center' });

    doc.setFontSize(14);
    doc.text('Advanced Analytics Report', 105, 28, { align: 'center' });

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Generated: ${timestamp}`, 14, 40);
    doc.text(`Province: {{ current_province }}`, 14, 46);
    doc.text(`Total Accidents: {{ total_accidents }}`, 14, 52);

    let yPos = 62;

    // Spatial Analysis
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('SPATIAL ANALYSIS', 14, yPos);
    yPos += 8;

    doc.autoTable({
        startY: yPos,
        head: [['Metric', 'Value']],
        body: [
            ['Hotspot Accidents', data.spatial_analysis.hotspot_effectiveness.hotspot_accidents],
            ['Non-Hotspot Accidents', data.spatial_analysis.hotspot_effectiveness.non_hotspot_accidents],
            ['Concentration Ratio', data.spatial_analysis.hotspot_effectiveness.hotspot_concentration_ratio + ':1'],
            ['Hotspot Fatality Rate', data.spatial_analysis.hotspot_effectiveness.hotspot_fatality_rate + '%'],
        ],
        theme: 'grid',
        headStyles: { fillColor: [102, 126, 234] },
    });

    yPos = doc.lastAutoTable.finalY + 10;

    // Severity Analysis
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('SEVERITY ANALYSIS', 14, yPos);
    yPos += 8;

    doc.autoTable({
        startY: yPos,
        head: [['Metric', 'Value']],
        body: [
            ['Fatal Accidents', data.severity_analysis.severity_index.fatal_accidents],
            ['Injury Accidents', data.severity_analysis.severity_index.injury_accidents],
            ['Severity Index', data.severity_analysis.severity_index.severity_index],
            ['Severity Category', data.severity_analysis.severity_index.severity_category],
            ['Total Casualties', data.severity_analysis.severity_index.total_casualties],
        ],
        theme: 'grid',
        headStyles: { fillColor: [102, 126, 234] },
    });

    yPos = doc.lastAutoTable.finalY + 10;

    // Predictive Analysis
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('PREDICTIVE ANALYSIS', 14, yPos);
    yPos += 8;

    doc.autoTable({
        startY: yPos,
        head: [['Metric', 'Value']],
        body: [
            ['Trend Direction', data.predictive_analysis.trend.trend],
            ['Confidence', data.predictive_analysis.trend.confidence_percentage + '%'],
            ['R¬≤ Value', data.predictive_analysis.trend.r_squared],
            ['Predicted Next Month', data.predictive_analysis.trend.prediction_next_month + ' accidents'],
        ],
        theme: 'grid',
        headStyles: { fillColor: [102, 126, 234] },
    });

    // Download
    const filename = `advanced_analytics_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
}

function switchToFullMode() {
    const url = new URL(window.location.href);
    url.searchParams.set('simple', 'false');
    window.location.href = url.toString();
}

function switchToFastMode() {
    const url = new URL(window.location.href);
    url.searchParams.set('simple', 'true');
    window.location.href = url.toString();
}
</script>
{% endblock %}
